"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TypstDomDocument = exports.provideDomDoc = void 0;
const internal_types_mjs_1 = require("./internal.types.cjs");
const typst_doc_mjs_1 = require("./contrib/dom/typst-doc.cjs");
const typst_cancel_mjs_1 = require("./contrib/dom/typst-cancel.cjs");
const animationFrame = () => new Promise(resolve => requestAnimationFrame(resolve));
class DomPage {
    dispose() { }
}
var TrackMode;
(function (TrackMode) {
    TrackMode[TrackMode["Doc"] = 0] = "Doc";
    TrackMode[TrackMode["Pages"] = 1] = "Pages";
})(TrackMode || (TrackMode = {}));
var RepaintStage;
(function (RepaintStage) {
    RepaintStage[RepaintStage["Layout"] = 0] = "Layout";
    RepaintStage[RepaintStage["Svg"] = 1] = "Svg";
    RepaintStage[RepaintStage["Semantics"] = 2] = "Semantics";
    RepaintStage[RepaintStage["PrepareCanvas"] = 3] = "PrepareCanvas";
    RepaintStage[RepaintStage["Canvas"] = 4] = "Canvas";
})(RepaintStage || (RepaintStage = {}));
function provideDomDoc(Base) {
    return class DomDocument extends Base {
        /// The template element for creating DOM by string.
        tmpl = document.createElement('template');
        /// The stub element for replacing an invisible element.
        stub = this.createElement('<stub></stub>');
        /// Typescript side of lib.
        plugin;
        /// Rust side of kernel.
        docKernel;
        /// The element to track.
        resourceHeader = undefined;
        /// Expected exact state of the current DOM.
        /// Initially it is empty meaning no any page is rendered.
        pages = [];
        /// The virtual scale of the document.
        domScale = 1;
        /// Track mode.
        track_mode = TrackMode.Doc;
        /// Current executing task.
        current_task = undefined;
        /// The currently maintained viewport.
        viewport;
        constructor(...args) {
            super(...args);
            this.registerMode('dom');
            this.disposeList.push(() => {
                this.dispose();
            });
            this.plugin = this.opts.renderer;
            if (this.opts.domScale !== undefined) {
                if (this.opts.domScale <= 0) {
                    throw new Error('domScale must be positive');
                }
                this.domScale = this.opts.domScale;
            }
        }
        dispose() {
            for (const page of this.pages) {
                page.dispose();
            }
            if (this.docKernel) {
                this.docKernel.free();
            }
        }
        createElement(tmpl) {
            this.tmpl.innerHTML = tmpl;
            return this.tmpl.content.firstElementChild;
        }
        async mountDom(pixelPerPt) {
            console.log('mountDom', pixelPerPt);
            if (this.docKernel) {
                throw new Error('already mounted');
            }
            // create typst-svg-resources by string
            this.hookedElem.innerHTML = `<svg class="typst-svg-resources" viewBox="0 0 0 0" width="0" height="0" style="opacity: 0; position: absolute;"></svg>`;
            this.resourceHeader = this.hookedElem.querySelector('.typst-svg-resources');
            this.docKernel = await this.plugin.renderer.mount_dom(this.kModule[internal_types_mjs_1.kObject], this.hookedElem);
            this.docKernel.bind_functions({
                populateGlyphs: (data) => {
                    let svg = this.createElement(data);
                    console.log('populateGlyphs', svg);
                    let content = svg.firstElementChild;
                    this.resourceHeader.append(content);
                },
            });
        }
        async cancelAnyway$dom() {
            console.log('cancelAnyway$dom');
            if (this.current_task) {
                const task = this.current_task;
                this.current_task = undefined;
                await task.cancel();
            }
        }
        retrieveDOMPages() {
            return Array.from(this.hookedElem.querySelectorAll('.typst-dom-page'));
        }
        // doesn't need to postRender
        postRender$dom() { }
        // doesn't need to rescale
        rescale$dom() { }
        getDomViewport(cachedWindow, cachedBoundingRect) {
            const left = cachedBoundingRect.left;
            const top = -cachedBoundingRect.top;
            const right = cachedBoundingRect.right;
            const bottom = cachedWindow.innerHeight - cachedBoundingRect.top;
            const rect = {
                x: 0,
                y: top / this.domScale,
                width: Math.max(right - left, 0) / this.domScale,
                height: Math.max(bottom - top, 0) / this.domScale,
            };
            if (rect.width <= 0 || rect.height <= 0) {
                rect.x = rect.y = rect.width = rect.height = 0;
            }
            // console.log('ccc', basePos, appPos, rect);
            return rect;
        }
        // fast mode
        async rerender$dom() {
            const domState = this.retrieveDOMState();
            // const l = domState.boundingRect.left;
            const { x, y, width, height } = this.getDomViewport(domState.window, domState.boundingRect);
            let dirty = await this.docKernel.relayout(x, y, width, height);
            if (!dirty) {
                return;
            }
            const cancel = new typst_cancel_mjs_1.TypstCancellationToken();
            this.doRender$dom(cancel);
            this.current_task = cancel;
        }
        async doRender$dom(ctx) {
            const condOrExit = (needFrame, cb) => {
                if (needFrame && !ctx.isCancelRequested() && cb) {
                    return cb();
                }
            };
            const pages = this.retrieveDOMPages().map(page => {
                const { innerWidth, innerHeight } = window;
                const browserBBox = page.getBoundingClientRect();
                // any part of the page is in the window
                return {
                    inWindow: !(browserBBox.left > innerWidth ||
                        browserBBox.right < 0 ||
                        browserBBox.top > innerHeight ||
                        browserBBox.bottom < 0),
                    page,
                };
            });
            const renderPage = async (i) => {
                await animationFrame();
                if (ctx.isCancelRequested()) {
                    console.log('cancel stage', RepaintStage.Layout, i);
                    return undefined;
                }
                const page = pages[i].page;
                const browserBBox = page.getBoundingClientRect();
                const v = this.getDomViewport(window, browserBBox);
                const needCalc = (stage) => this.docKernel.need_repaint(i, v.x, v.y, v.width, v.height, stage);
                const repaint = (stage) => this.docKernel.repaint(i, v.x, v.y, v.width, v.height, stage);
                const calc = (stage) => {
                    if (ctx.isCancelRequested()) {
                        return undefined;
                    }
                    return condOrExit(needCalc(stage), () => repaint(stage));
                };
                await calc(RepaintStage.Layout);
                const wScale = (browserBBox.width
                    ? Number.parseFloat(page.getAttribute('data-width')) / browserBBox.width
                    : 1) * this.domScale;
                const hScale = (browserBBox.height
                    ? Number.parseFloat(page.getAttribute('data-height')) / browserBBox.height
                    : 1) * this.domScale;
                v.x *= wScale;
                v.y *= hScale;
                v.y -= 100;
                v.width *= wScale;
                v.height *= hScale;
                v.height += 200;
                await calc(RepaintStage.Svg);
                await calc(RepaintStage.Semantics);
                if (ctx.isCancelRequested()) {
                    console.log('cancel stage', RepaintStage.Semantics, i);
                    return undefined;
                }
                if (needCalc(RepaintStage.PrepareCanvas)) {
                    const calcCanvasAfterPreparing = async () => {
                        await repaint(RepaintStage.PrepareCanvas);
                        if (ctx.isCancelRequested()) {
                            return undefined;
                        }
                        return calc(RepaintStage.Canvas);
                    };
                    calcCanvasAfterPreparing();
                }
                else {
                    await calc(RepaintStage.Canvas);
                }
            };
            const renderPages = async (inWindow) => {
                for (let idx = 0; idx < pages.length; ++idx) {
                    if (ctx.isCancelRequested()) {
                        console.log('cancel page', RepaintStage.Layout, idx);
                        return;
                    }
                    if (pages[idx].inWindow === inWindow) {
                        await renderPage(idx);
                    }
                }
            };
            this.cancelAnyway$dom();
            await renderPages(true);
            await renderPages(false);
            if (ctx.isCancelRequested()) {
                return;
            }
            console.log('finished', RepaintStage.Layout);
        }
    };
}
exports.provideDomDoc = provideDomDoc;
class TypstDomDocument extends (0, typst_doc_mjs_1.provideDoc)((0, typst_doc_mjs_1.composeDoc)(typst_doc_mjs_1.TypstDocumentContext, provideDomDoc)) {
}
exports.TypstDomDocument = TypstDomDocument;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kb20ubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDZEQUFxRDtBQUVyRCwrREFLcUM7QUFDckMscUVBQXdFO0FBRXhFLE1BQU0sY0FBYyxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztBQUVwRixNQUFNLE9BQU87SUFDWCxPQUFPLEtBQUksQ0FBQztDQUNiO0FBRUQsSUFBVyxTQUdWO0FBSEQsV0FBVyxTQUFTO0lBQ2xCLHVDQUFHLENBQUE7SUFDSCwyQ0FBSyxDQUFBO0FBQ1AsQ0FBQyxFQUhVLFNBQVMsS0FBVCxTQUFTLFFBR25CO0FBRUQsSUFBVyxZQU1WO0FBTkQsV0FBVyxZQUFZO0lBQ3JCLG1EQUFVLENBQUE7SUFDViw2Q0FBTyxDQUFBO0lBQ1AseURBQWEsQ0FBQTtJQUNiLGlFQUFpQixDQUFBO0lBQ2pCLG1EQUFVLENBQUE7QUFDWixDQUFDLEVBTlUsWUFBWSxLQUFaLFlBQVksUUFNdEI7QUFlRCxTQUFnQixhQUFhLENBQzNCLElBQVc7SUFFWCxPQUFPLE1BQU0sV0FBWSxTQUFRLElBQUk7UUFDbkMsb0RBQW9EO1FBQ3BELElBQUksR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzFDLHdEQUF3RDtRQUN4RCxJQUFJLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUMzQywyQkFBMkI7UUFDM0IsTUFBTSxDQUFzQjtRQUM1Qix3QkFBd0I7UUFDeEIsU0FBUyxDQUFtQjtRQUM1Qix5QkFBeUI7UUFDekIsY0FBYyxHQUFlLFNBQVUsQ0FBQztRQUN4Qyw0Q0FBNEM7UUFDNUMsMERBQTBEO1FBQzFELEtBQUssR0FBYyxFQUFFLENBQUM7UUFDdEIsc0NBQXNDO1FBQ3RDLFFBQVEsR0FBRyxD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Qzt3QkFDckQsT0FBTztxQkFDUjtvQkFDRCxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO3dCQUNwQyxNQUFNLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztxQkFDdkI7aUJBQ0Y7WUFDSCxDQUFDLENBQUM7WUFFRixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUV4QixNQUFNLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN4QixNQUFNLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN6QixJQUFJLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxFQUFFO2dCQUMzQixPQUFPO2FBQ1I7WUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDL0MsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDO0FBMU9ELHNDQTBPQztBQUVELE1BQWEsZ0JBQWlCLFNBQVEsSUFBQSwwQkFBVSxFQUM5QyxJQUFBLDBCQUFVLEVBQ1Isb0NBQTBFLEVBQzFFLGFBQWEsQ0FDZCxDQUNGO0NBQUc7QUFMSiw0Q0FLSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgSW5jckRvbURvY0NsaWVudCB9IGZyb20gJ0BteXJpYWRkcmVhbWluL3R5cHN0LXRzLXJlbmRlcmVyJztcclxuaW1wb3J0IHsgUmVjdCwga09iamVjdCB9IGZyb20gJy4vaW50ZXJuYWwudHlwZXMubWpzJztcclxuaW1wb3J0IHsgVHlwc3RSZW5kZXJlciwgVHlwc3RSZW5kZXJlckRyaXZlciB9IGZyb20gJy4vcmVuZGVyZXIubWpzJztcclxuaW1wb3J0IHtcclxuICBHQ29uc3RydWN0b3IsXHJcbiAgVHlwc3REb2N1bWVudENvbnRleHQsXHJcbiAgY29tcG9zZURvYyxcclxuICBwcm92aWRlRG9jLFxyXG59IGZyb20gJy4vY29udHJpYi9kb20vdHlwc3QtZG9jLm1qcyc7XHJcbmltcG9ydCB7IFR5cHN0Q2FuY2VsbGF0aW9uVG9rZW4gfSBmcm9tICcuL2NvbnRyaWIvZG9tL3R5cHN0LWNhbmNlbC5tanMnO1xyXG5cclxuY29uc3QgYW5pbWF0aW9uRnJhbWUgPSAoKSA9PiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZShyZXNvbHZlKSk7XHJcblxyXG5jbGFzcyBEb21QYWdlIHtcclxuICBkaXNwb3NlKCkge31cclxufVxyXG5cclxuY29uc3QgZW51bSBUcmFja01vZGUge1xyXG4gIERvYyxcclxuICBQYWdlcyxcclxufVxyXG5cclxuY29uc3QgZW51bSBSZXBhaW50U3RhZ2Uge1xyXG4gIExheW91dCA9IDAsXHJcbiAgU3ZnID0gMSxcclxuICBTZW1hbnRpY3MgPSAyLFxyXG4gIFByZXBhcmVDYW52YXMgPSAzLFxyXG4gIENhbnZhcyA9IDQsXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSVR5cHN0RG9tRG9jdW1lbnQge1xyXG4gIG1vdW50RG9tKHBpeGVsUGVyUHQ6IG51bWJlciB8IHVuZGVmaW5lZCk6IFByb21pc2U8dm9pZD47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSW5pdERvbURvY0FyZ3Mge1xyXG4gIHJlbmRlcmVyOiBUeXBzdFJlbmRlcmVyO1xyXG4gIGRvbVNjYWxlPzogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgUmVuZGVyVGFzayB7XHJcbiAgY2FuY2VsKCk6IFByb21pc2U8dm9pZD47XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlRG9tRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yPFR5cHN0RG9jdW1lbnRDb250ZXh0PEluaXREb21Eb2NBcmdzPj4+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4pOiBUQmFzZSAmIEdDb25zdHJ1Y3RvcjxJVHlwc3REb21Eb2N1bWVudD4ge1xyXG4gIHJldHVybiBjbGFzcyBEb21Eb2N1bWVudCBleHRlbmRzIEJhc2Uge1xyXG4gICAgLy8vIFRoZSB0ZW1wbGF0ZSBlbGVtZW50IGZvciBjcmVhdGluZyBET00gYnkgc3RyaW5nLlxyXG4gICAgdG1wbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJyk7XHJcbiAgICAvLy8gVGhlIHN0dWIgZWxlbWVudCBmb3IgcmVwbGFjaW5nIGFuIGludmlzaWJsZSBlbGVtZW50LlxyXG4gICAgc3R1YiA9IHRoaXMuY3JlYXRlRWxlbWVudCgnPHN0dWI+PC9zdHViPicpO1xyXG4gICAgLy8vIFR5cGVzY3JpcHQgc2lkZSBvZiBsaWIuXHJcbiAgICBwbHVnaW46IFR5cHN0UmVuZGVyZXJEcml2ZXI7XHJcbiAgICAvLy8gUnVzdCBzaWRlIG9mIGtlcm5lbC5cclxuICAgIGRvY0tlcm5lbDogSW5jckRvbURvY0NsaWVudDtcclxuICAgIC8vLyBUaGUgZWxlbWVudCB0byB0cmFjay5cclxuICAgIHJlc291cmNlSGVhZGVyOiBTVkdFbGVtZW50ID0gdW5kZWZpbmVkITtcclxuICAgIC8vLyBFeHBlY3RlZCBleGFjdCBzdGF0ZSBvZiB0aGUgY3VycmVudCBET00uXHJcbiAgICAvLy8gSW5pdGlhbGx5IGl0IGlzIGVtcHR5IG1lYW5pbmcgbm8gYW55IHBhZ2UgaXMgcmVuZGVyZWQuXHJcbiAgICBwYWdlczogRG9tUGFnZVtdID0gW107XHJcbiAgICAvLy8gVGhlIHZpcnR1YWwgc2NhbGUgb2YgdGhlIGRvY3VtZW50LlxyXG4gICAgZG9tU2NhbGUgPSAxO1xyXG4gICAgLy8vIFRyYWNrIG1vZGUuXHJcbiAgICB0cmFja19tb2RlOiBUcmFja01vZGUgPSBUcmFja01vZGUuRG9jO1xyXG4gICAgLy8vIEN1cnJlbnQgZXhlY3V0aW5nIHRhc2suXHJcbiAgICBjdXJyZW50X3Rhc2s/OiBSZW5kZXJUYXNrID0gdW5kZWZpbmVkO1xyXG4gICAgLy8vIFRoZSBjdXJyZW50bHkgbWFpbnRhaW5lZCB2aWV3cG9ydC5cclxuICAgIHZpZXdwb3J0OiBSZWN0O1xyXG4gICAgY29uc3RydWN0b3IoLi4uYXJnczogYW55W10pIHtcclxuICAgICAgc3VwZXIoLi4uYXJncyk7XHJcbiAgICAgIHRoaXMucmVnaXN0ZXJNb2RlKCdkb20nKTtcclxuICAgICAgdGhpcy5kaXNwb3NlTGlzdC5wdXNoKCgpID0+IHtcclxuICAgICAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMucGx1Z2luID0gdGhpcy5vcHRzLnJlbmRlcmVyIGFzIGFueSBhcyBUeXBzdFJlbmRlcmVyRHJpdmVyO1xyXG4gICAgICBpZiAodGhpcy5vcHRzLmRvbVNjYWxlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRzLmRvbVNjYWxlIDw9IDApIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZG9tU2NhbGUgbXVzdCBiZSBwb3NpdGl2ZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmRvbVNjYWxlID0gdGhpcy5vcHRzLmRvbVNjYWxlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGlzcG9zZSgpIHtcclxuICAgICAgZm9yIChjb25zdCBwYWdlIG9mIHRoaXMucGFnZXMpIHtcclxuICAgICAgICBwYWdlLmRpc3Bvc2UoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHRoaXMuZG9jS2VybmVsKSB7XHJcbiAgICAgICAgdGhpcy5kb2NLZXJuZWwuZnJlZSgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlRWxlbWVudCh0bXBsOiBzdHJpbmcpIHtcclxuICAgICAgdGhpcy50bXBsLmlubmVySFRNTCA9IHRtcGw7XHJcbiAgICAgIHJldHVybiB0aGlzLnRtcGwuY29udGVudC5maXJzdEVsZW1lbnRDaGlsZDtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBtb3VudERvbShwaXhlbFBlclB0OiBudW1iZXIgfCB1bmRlZmluZWQpIHtcclxuICAgICAgY29uc29sZS5sb2coJ21vdW50RG9tJywgcGl4ZWxQZXJQdCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5kb2NLZXJuZWwpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FscmVhZHkgbW91bnRlZCcpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBjcmVhdGUgdHlwc3Qtc3ZnLXJlc291cmNlcyBieSBzdHJpbmdcclxuICAgICAgdGhpcy5ob29rZWRFbGVtLmlubmVySFRNTCA9IGA8c3ZnIGNsYXNzPVwidHlwc3Qtc3ZnLXJlc291cmNlc1wiIHZpZXdCb3g9XCIwIDAgMCAwXCIgd2lkdGg9XCIwXCIgaGVpZ2h0PVwiMFwiIHN0eWxlPVwib3BhY2l0eTogMDsgcG9zaXRpb246IGFic29sdXRlO1wiPjwvc3ZnPmA7XHJcbiAgICAgIHRoaXMucmVzb3VyY2VIZWFkZXIgPSB0aGlzLmhvb2tlZEVsZW0ucXVlcnlTZWxlY3RvcignLnR5cHN0LXN2Zy1yZXNvdXJjZXMnKSE7XHJcblxyXG4gICAgICB0aGlzLmRvY0tlcm5lbCA9IGF3YWl0IHRoaXMucGx1Z2luLnJlbmRlcmVyLm1vdW50X2RvbSh0aGlzLmtNb2R1bGVba09iamVjdF0sIHRoaXMuaG9va2VkRWxlbSk7XHJcblxyXG4gICAgICB0aGlzLmRvY0tlcm5lbC5iaW5kX2Z1bmN0aW9ucyh7XHJcbiAgICAgICAgcG9wdWxhdGVHbHlwaHM6IChkYXRhOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIGxldCBzdmcgPSB0aGlzLmNyZWF0ZUVsZW1lbnQoZGF0YSkhO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ3BvcHVsYXRlR2x5cGhzJywgc3ZnKTtcclxuICAgICAgICAgIGxldCBjb250ZW50ID0gc3ZnLmZpcnN0RWxlbWVudENoaWxkITtcclxuICAgICAgICAgIHRoaXMucmVzb3VyY2VIZWFkZXIuYXBwZW5kKGNvbnRlbnQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGNhbmNlbEFueXdheSRkb20oKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdjYW5jZWxBbnl3YXkkZG9tJyk7XHJcbiAgICAgIGlmICh0aGlzLmN1cnJlbnRfdGFzaykge1xyXG4gICAgICAgIGNvbnN0IHRhc2sgPSB0aGlzLmN1cnJlbnRfdGFzaztcclxuICAgICAgICB0aGlzLmN1cnJlbnRfdGFzayA9IHVuZGVmaW5lZDtcclxuICAgICAgICBhd2FpdCB0YXNrLmNhbmNlbCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0cmlldmVET01QYWdlcygpIHtcclxuICAgICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5ob29rZWRFbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJy50eXBzdC1kb20tcGFnZScpKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBkb2Vzbid0IG5lZWQgdG8gcG9zdFJlbmRlclxyXG4gICAgcG9zdFJlbmRlciRkb20oKSB7fVxyXG5cclxuICAgIC8vIGRvZXNuJ3QgbmVlZCB0byByZXNjYWxlXHJcbiAgICByZXNjYWxlJGRvbSgpIHt9XHJcblxyXG4gICAgZ2V0RG9tVmlld3BvcnQoXHJcbiAgICAgIGNhY2hlZFdpbmRvdzogUGljazxXaW5kb3csICdpbm5lckhlaWdodCcgfCAnaW5uZXJXaWR0aCc+LFxyXG4gICAgICBjYWNoZWRCb3VuZGluZ1JlY3Q6IFBpY2s8RE9NUmVjdCwgJ2xlZnQnIHwgJ3RvcCcgfCAncmlnaHQnPixcclxuICAgICkge1xyXG4gICAgICBjb25zdCBsZWZ0ID0gY2FjaGVkQm91bmRpbmdSZWN0LmxlZnQ7XHJcbiAgICAgIGNvbnN0IHRvcCA9IC1jYWNoZWRCb3VuZGluZ1JlY3QudG9wO1xyXG4gICAgICBjb25zdCByaWdodCA9IGNhY2hlZEJvdW5kaW5nUmVjdC5yaWdodDtcclxuICAgICAgY29uc3QgYm90dG9tID0gY2FjaGVkV2luZG93LmlubmVySGVpZ2h0IC0gY2FjaGVkQm91bmRpbmdSZWN0LnRvcDtcclxuICAgICAgY29uc3QgcmVjdCA9IHtcclxuICAgICAgICB4OiAwLFxyXG4gICAgICAgIHk6IHRvcCAvIHRoaXMuZG9tU2NhbGUsXHJcbiAgICAgICAgd2lkdGg6IE1hdGgubWF4KHJpZ2h0IC0gbGVmdCwgMCkgLyB0aGlzLmRvbVNjYWxlLFxyXG4gICAgICAgIGhlaWdodDogTWF0aC5tYXgoYm90dG9tIC0gdG9wLCAwKSAvIHRoaXMuZG9tU2NhbGUsXHJcbiAgICAgIH07XHJcbiAgICAgIGlmIChyZWN0LndpZHRoIDw9IDAgfHwgcmVjdC5oZWlnaHQgPD0gMCkge1xyXG4gICAgICAgIHJlY3QueCA9IHJlY3QueSA9IHJlY3Qud2lkdGggPSByZWN0LmhlaWdodCA9IDA7XHJcbiAgICAgIH1cclxuICAgICAgLy8gY29uc29sZS5sb2coJ2NjYycsIGJhc2VQb3MsIGFwcFBvcywgcmVjdCk7XHJcbiAgICAgIHJldHVybiByZWN0O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGZhc3QgbW9kZVxyXG4gICAgYXN5bmMgcmVyZW5kZXIkZG9tKCkge1xyXG4gICAgICBjb25zdCBkb21TdGF0ZSA9IHRoaXMucmV0cmlldmVET01TdGF0ZSgpO1xyXG5cclxuICAgICAgLy8gY29uc3QgbCA9IGRvbVN0YXRlLmJvdW5kaW5nUmVjdC5sZWZ0O1xyXG4gICAgICBjb25zdCB7IHgsIHksIHdpZHRoLCBoZWlnaHQgfSA9IHRoaXMuZ2V0RG9tVmlld3BvcnQoZG9tU3RhdGUud2luZG93LCBkb21TdGF0ZS5ib3VuZGluZ1JlY3QpO1xyXG5cclxuICAgICAgbGV0IGRpcnR5ID0gYXdhaXQgdGhpcy5kb2NLZXJuZWwucmVsYXlvdXQoeCwgeSwgd2lkdGgsIGhlaWdodCk7XHJcbiAgICAgIGlmICghZGlydHkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGNhbmNlbCA9IG5ldyBUeXBzdENhbmNlbGxhdGlvblRva2VuKCk7XHJcbiAgICAgIHRoaXMuZG9SZW5kZXIkZG9tKGNhbmNlbCk7XHJcbiAgICAgIHRoaXMuY3VycmVudF90YXNrID0gY2FuY2VsO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGRvUmVuZGVyJGRvbShjdHg6IFR5cHN0Q2FuY2VsbGF0aW9uVG9rZW4pIHtcclxuICAgICAgY29uc3QgY29uZE9yRXhpdCA9IDxULD4obmVlZEZyYW1lOiBib29sZWFuLCBjYjogKCkgPT4gUHJvbWlzZTxUPikgPT4ge1xyXG4gICAgICAgIGlmIChuZWVkRnJhbWUgJiYgIWN0eC5pc0NhbmNlbFJlcXVlc3RlZCgpICYmIGNiKSB7XHJcbiAgICAgICAgICByZXR1cm4gY2IoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IHBhZ2VzID0gdGhpcy5yZXRyaWV2ZURPTVBhZ2VzKCkubWFwKHBhZ2UgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgaW5uZXJXaWR0aCwgaW5uZXJIZWlnaHQgfSA9IHdpbmRvdztcclxuICAgICAgICBjb25zdCBicm93c2VyQkJveCA9IHBhZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgLy8gYW55IHBhcnQgb2YgdGhlIHBhZ2UgaXMgaW4gdGhlIHdpbmRvd1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBpbldpbmRvdzogIShcclxuICAgICAgICAgICAgYnJvd3NlckJCb3gubGVmdCA+IGlubmVyV2lkdGggfHxcclxuICAgICAgICAgICAgYnJvd3NlckJCb3gucmlnaHQgPCAwIHx8XHJcbiAgICAgICAgICAgIGJyb3dzZXJCQm94LnRvcCA+IGlubmVySGVpZ2h0IHx8XHJcbiAgICAgICAgICAgIGJyb3dzZXJCQm94LmJvdHRvbSA8IDBcclxuICAgICAgICAgICksXHJcbiAgICAgICAgICBwYWdlLFxyXG4gICAgICAgIH07XHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zdCByZW5kZXJQYWdlID0gYXN5bmMgKGk6IG51bWJlcikgPT4ge1xyXG4gICAgICAgIGF3YWl0IGFuaW1hdGlvbkZyYW1lKCk7XHJcbiAgICAgICAgaWYgKGN0eC5pc0NhbmNlbFJlcXVlc3RlZCgpKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnY2FuY2VsIHN0YWdlJywgUmVwYWludFN0YWdlLkxheW91dCwgaSk7XHJcbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYWdlID0gcGFnZXNbaV0ucGFnZTtcclxuICAgICAgICBjb25zdCBicm93c2VyQkJveCA9IHBhZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3QgdiA9IHRoaXMuZ2V0RG9tVmlld3BvcnQod2luZG93LCBicm93c2VyQkJveCk7XHJcblxyXG4gICAgICAgIGNvbnN0IG5lZWRDYWxjID0gKHN0YWdlOiBSZXBhaW50U3RhZ2UpID0+XHJcbiAgICAgICAgICB0aGlzLmRvY0tlcm5lbC5uZWVkX3JlcGFpbnQoaSwgdi54LCB2LnksIHYud2lkdGgsIHYuaGVpZ2h0LCBzdGFnZSk7XHJcbiAgICAgICAgY29uc3QgcmVwYWludCA9IChzdGFnZTogUmVwYWludFN0YWdlKSA9PlxyXG4gICAgICAgICAgdGhpcy5kb2NLZXJuZWwucmVwYWludChpLCB2LngsIHYueSwgdi53aWR0aCwgdi5oZWlnaHQsIHN0YWdlKTtcclxuICAgICAgICBjb25zdCBjYWxjID0gKHN0YWdlOiBSZXBhaW50U3RhZ2UpID0+IHtcclxuICAgICAgICAgIGlmIChjdHguaXNDYW5jZWxSZXF1ZXN0ZWQoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGNvbmRPckV4aXQobmVlZENhbGMoc3RhZ2UpLCAoKSA9PiByZXBhaW50KHN0YWdlKSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgYXdhaXQgY2FsYyhSZXBhaW50U3RhZ2UuTGF5b3V0KTtcclxuXHJcbiAgICAgICAgY29uc3Qgd1NjYWxlID1cclxuICAgICAgICAgIChicm93c2VyQkJveC53aWR0aFxyXG4gICAgICAgICAgICA/IE51bWJlci5wYXJzZUZsb2F0KHBhZ2UuZ2V0QXR0cmlidXRlKCdkYXRhLXdpZHRoJykhKSAvIGJyb3dzZXJCQm94LndpZHRoXHJcbiAgICAgICAgICAgIDogMSkgKiB0aGlzLmRvbVNjYWxlO1xyXG4gICAgICAgIGNvbnN0IGhTY2FsZSA9XHJcbiAgICAgICAgICAoYnJvd3NlckJCb3guaGVpZ2h0XHJcbiAgICAgICAgICAgID8gTnVtYmVyLnBhcnNlRmxvYXQocGFnZS5nZXRBdHRyaWJ1dGUoJ2RhdGEtaGVpZ2h0JykhKSAvIGJyb3dzZXJCQm94LmhlaWdodFxyXG4gICAgICAgICAgICA6IDEpICogdGhpcy5kb21TY2FsZTtcclxuICAgICAgICB2LnggKj0gd1NjYWxlO1xyXG4gICAgICAgIHYueSAqPSBoU2NhbGU7XHJcbiAgICAgICAgdi55IC09IDEwMDtcclxuICAgICAgICB2LndpZHRoICo9IHdTY2FsZTtcclxuICAgICAgICB2LmhlaWdodCAqPSBoU2NhbGU7XHJcbiAgICAgICAgdi5oZWlnaHQgKz0gMjAwO1xyXG5cclxuICAgICAgICBhd2FpdCBjYWxjKFJlcGFpbnRTdGFnZS5TdmcpO1xyXG4gICAgICAgIGF3YWl0IGNhbGMoUmVwYWludFN0YWdlLlNlbWFudGljcyk7XHJcbiAgICAgICAgaWYgKGN0eC5pc0NhbmNlbFJlcXVlc3RlZCgpKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnY2FuY2VsIHN0YWdlJywgUmVwYWludFN0YWdlLlNlbWFudGljcywgaSk7XHJcbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobmVlZENhbGMoUmVwYWludFN0YWdlLlByZXBhcmVDYW52YXMpKSB7XHJcbiAgICAgICAgICBjb25zdCBjYWxjQ2FudmFzQWZ0ZXJQcmVwYXJpbmcgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGF3YWl0IHJlcGFpbnQoUmVwYWludFN0YWdlLlByZXBhcmVDYW52YXMpO1xyXG4gICAgICAgICAgICBpZiAoY3R4LmlzQ2FuY2VsUmVxdWVzdGVkKCkpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjYWxjKFJlcGFpbnRTdGFnZS5DYW52YXMpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGNhbGNDYW52YXNBZnRlclByZXBhcmluZygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBhd2FpdCBjYWxjKFJlcGFpbnRTdGFnZS5DYW52YXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgY29uc3QgcmVuZGVyUGFnZXMgPSBhc3luYyAoaW5XaW5kb3c6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBmb3IgKGxldCBpZHggPSAwOyBpZHggPCBwYWdlcy5sZW5ndGg7ICsraWR4KSB7XHJcbiAgICAgICAgICBpZiAoY3R4LmlzQ2FuY2VsUmVxdWVzdGVkKCkpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ2NhbmNlbCBwYWdlJywgUmVwYWludFN0YWdlLkxheW91dCwgaWR4KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKHBhZ2VzW2lkeF0uaW5XaW5kb3cgPT09IGluV2luZG93KSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHJlbmRlclBhZ2UoaWR4KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcblxyXG4gICAgICB0aGlzLmNhbmNlbEFueXdheSRkb20oKTtcclxuXHJcbiAgICAgIGF3YWl0IHJlbmRlclBhZ2VzKHRydWUpO1xyXG4gICAgICBhd2FpdCByZW5kZXJQYWdlcyhmYWxzZSk7XHJcbiAgICAgIGlmIChjdHguaXNDYW5jZWxSZXF1ZXN0ZWQoKSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zb2xlLmxvZygnZmluaXNoZWQnLCBSZXBhaW50U3RhZ2UuTGF5b3V0KTtcclxuICAgIH1cclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgVHlwc3REb21Eb2N1bWVudCBleHRlbmRzIHByb3ZpZGVEb2MoXHJcbiAgY29tcG9zZURvYyhcclxuICAgIFR5cHN0RG9jdW1lbnRDb250ZXh0IGFzIEdDb25zdHJ1Y3RvcjxUeXBzdERvY3VtZW50Q29udGV4dDxJbml0RG9tRG9jQXJncz4+LFxyXG4gICAgcHJvdmlkZURvbURvYyxcclxuICApLFxyXG4pIHt9XHJcbiJdfQ==