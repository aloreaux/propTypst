"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FetchAccessModel = void 0;
class FetchAccessModel {
    root;
    fullyCached;
    mTimes = new Map();
    mRealPaths = new Map();
    mData = new Map();
    constructor(root, options) {
        this.root = root;
        if (root.endsWith('/')) {
            this.root = this.root.slice(0, this.root.length - 1);
        }
        if (options?.polyfillHeadRequest) {
            void 0;
        }
        this.fullyCached = !!options?.fullyCached;
    }
    reset() {
        this.mTimes.clear();
        this.mRealPaths.clear();
        this.mData.clear();
    }
    resolvePath(path) {
        return this.root + path;
    }
    insertFile(path, data, mtime) {
        this.mTimes.set(path, mtime);
        this.mData.set(path, data);
    }
    removeFile(path) {
        this.mTimes.delete(path);
        this.mData.delete(path);
    }
    async getPreloadScript() {
        const snapshot = [];
        snapshot.push('((async () => {');
        snapshot.push(`const snapshot = {  root: '', mTimes: new Map(),  mRealPaths: new Map(),  mData: [],};`);
        // runFetch
        snapshot.push(`const runFetch = async (path) => {`);
        snapshot.push(`  const res = await fetch(snapshot.root + path);`);
        snapshot.push(`  const buffer = await res.arrayBuffer();`);
        snapshot.push(`  return [path, new Uint8Array(buffer)];`);
        snapshot.push(`};`);
        snapshot.push(`snapshot.root = ${JSON.stringify(this.root)};`);
        snapshot.push(`snapshot.mTimes = new Map([${[...this.mTimes.entries()]
            .map(([k, v]) => `[${JSON.stringify(k)}, ${v?.getTime() || 'undefined'}]`)
            .join(', ')}]);`);
        snapshot.push(`snapshot.mRealPaths = new Map([${[...this.mRealPaths.entries()]
            .map(([k, v]) => `[${JSON.stringify(k)}, ${JSON.stringify(v)}]`)
            .join(', ')}]);`);
        const dataEntries = await Promise.all([...this.mData.entries()].map(async ([k, v]) => {
            k = JSON.stringify(k);
            return v ? `runFetch(${k})` : `Promise.resolve([${k}, undefined])`;
        }));
        snapshot.push(`snapshot.mData = await Promise.all([${dataEntries.join(', ')}]);`);
        snapshot.push(`return snapshot;`);
        snapshot.push('})())');
        return snapshot.join('\n');
    }
    getLastModified(path) {
        const request = new XMLHttpRequest();
        request.open('HEAD', path, false);
        request.send(null);
        if (request.status === 200) {
            return request.getResponseHeader('Last-Modified');
        }
        return null;
    }
    getMTimeInternal(path) {
        const lastModified = this.getLastModified(this.resolvePath(path));
        if (lastModified) {
            return new Date(lastModified);
        }
        return undefined;
    }
    getMTime(path) {
        // todo: no hack
        if (path.startsWith('/@memory/')) {
            if (this.mTimes.has(path)) {
                return this.mTimes.get(path);
            }
            return undefined;
        }
        if (!this.fullyCached) {
            return this.getMTimeInternal(path);
        }
        if (this.mTimes.has(path)) {
            return this.mTimes.get(path);
        }
        const mTime = this.getMTimeInternal(path);
        this.mTimes.set(path, mTime);
        return mTime;
    }
    // todo: isFile
    isFile() {
        // path: string
        // const request = this.getLastModified(this.resolvePath(path));
        // if (request.status === 200) {
        //   console.log(request, request.getAllResponseHeaders());
        // }
        return true;
    }
    // todo: getRealPath
    getRealPath(path) {
        return path;
    }
    readAllInternal(path) {
        const request = new XMLHttpRequest();
        request.overrideMimeType('text/plain; charset=x-user-defined');
        request.open('GET', this.resolvePath(path), false);
        request.send(null);
        if (request.status === 200 &&
            (request.response instanceof String || typeof request.response === 'string')) {
            return Uint8Array.from(request.response, (c) => c.charCodeAt(0));
        }
        return undefined;
    }
    readAll(path) {
        if (path.startsWith('/@memory/')) {
            if (this.mData.has(path)) {
                return this.mData.get(path);
            }
            return undefined;
        }
        if (!this.fullyCached) {
            return this.readAllInternal(path);
        }
        if (this.mData.has(path)) {
            return this.mData.get(path);
        }
        const data = this.readAllInternal(path);
        this.mData.set(path, data);
        return data;
    }
}
exports.FetchAccessModel = FetchAccessModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmV0Y2gubWpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ZzL2ZldGNoLm10cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFRQSxNQUFhLGdCQUFnQjtJQU1qQjtJQUxWLFdBQVcsQ0FBVTtJQUNyQixNQUFNLEdBQWtDLElBQUksR0FBRyxFQUFFLENBQUM7SUFDbEQsVUFBVSxHQUFvQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3hELEtBQUssR0FBd0MsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUN2RCxZQUNVLElBQVksRUFDcEIsT0FBNEI7UUFEcEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUdwQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDdEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDdEQ7UUFDRCxJQUFJLE9BQU8sRUFBRSxtQkFBbUIsRUFBRTtZQUNoQyxLQUFLLENBQUMsQ0FBQztTQUNSO1FBQ0QsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQztJQUM1QyxDQUFDO0lBRUQsS0FBSztRQUNILElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxXQUFXLENBQUMsSUFBWTtRQUN0QixPQUFPLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQzFCLENBQUM7SUFFRCxVQUFVLENBQUMsSUFBWSxFQUFFLElBQWdCLEVBQUUsS0FBVztRQUNwRCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJ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T0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUM3QjtZQUVELE9BQU8sU0FBUyxDQUFDO1NBQ2xCO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDckIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ25DO1FBRUQsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN4QixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzdCO1FBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDM0IsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUF4S0QsNENBd0tDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRnNBY2Nlc3NNb2RlbCB9IGZyb20gJy4uL2ludGVybmFsLnR5cGVzLm1qcyc7XHJcbmltcG9ydCB7IFdyaXRhYmxlQWNjZXNzTW9kZWwgfSBmcm9tICcuL2luZGV4Lm1qcyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZldGNoQWNjZXNzT3B0aW9ucyB7XHJcbiAgcG9seWZpbGxIZWFkUmVxdWVzdD86IGJvb2xlYW47XHJcbiAgZnVsbHlDYWNoZWQ/OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRmV0Y2hBY2Nlc3NNb2RlbCBpbXBsZW1lbnRzIEZzQWNjZXNzTW9kZWwsIFdyaXRhYmxlQWNjZXNzTW9kZWwge1xyXG4gIGZ1bGx5Q2FjaGVkOiBib29sZWFuO1xyXG4gIG1UaW1lczogTWFwPHN0cmluZywgRGF0ZSB8IHVuZGVmaW5lZD4gPSBuZXcgTWFwKCk7XHJcbiAgbVJlYWxQYXRoczogTWFwPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPiA9IG5ldyBNYXAoKTtcclxuICBtRGF0YTogTWFwPHN0cmluZywgVWludDhBcnJheSB8IHVuZGVmaW5lZD4gPSBuZXcgTWFwKCk7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJvb3Q6IHN0cmluZyxcclxuICAgIG9wdGlvbnM/OiBGZXRjaEFjY2Vzc09wdGlvbnMsXHJcbiAgKSB7XHJcbiAgICBpZiAocm9vdC5lbmRzV2l0aCgnLycpKSB7XHJcbiAgICAgIHRoaXMucm9vdCA9IHRoaXMucm9vdC5zbGljZSgwLCB0aGlzLnJvb3QubGVuZ3RoIC0gMSk7XHJcbiAgICB9XHJcbiAgICBpZiAob3B0aW9ucz8ucG9seWZpbGxIZWFkUmVxdWVzdCkge1xyXG4gICAgICB2b2lkIDA7XHJcbiAgICB9XHJcbiAgICB0aGlzLmZ1bGx5Q2FjaGVkID0gISFvcHRpb25zPy5mdWxseUNhY2hlZDtcclxuICB9XHJcblxyXG4gIHJlc2V0KCkge1xyXG4gICAgdGhpcy5tVGltZXMuY2xlYXIoKTtcclxuICAgIHRoaXMubVJlYWxQYXRocy5jbGVhcigpO1xyXG4gICAgdGhpcy5tRGF0YS5jbGVhcigpO1xyXG4gIH1cclxuXHJcbiAgcmVzb2x2ZVBhdGgocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLnJvb3QgKyBwYXRoO1xyXG4gIH1cclxuXHJcbiAgaW5zZXJ0RmlsZShwYXRoOiBzdHJpbmcsIGRhdGE6IFVpbnQ4QXJyYXksIG10aW1lOiBEYXRlKSB7XHJcbiAgICB0aGlzLm1UaW1lcy5zZXQocGF0aCwgbXRpbWUpO1xyXG4gICAgdGhpcy5tRGF0YS5zZXQocGF0aCwgZGF0YSk7XHJcbiAgfVxyXG5cclxuICByZW1vdmVGaWxlKHBhdGg6IHN0cmluZykge1xyXG4gICAgdGhpcy5tVGltZXMuZGVsZXRlKHBhdGgpO1xyXG4gICAgdGhpcy5tRGF0YS5kZWxldGUocGF0aCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRQcmVsb2FkU2NyaXB0KCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBzbmFwc2hvdDogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICBzbmFwc2hvdC5wdXNoKCcoKGFzeW5jICgpID0+IHsnKTtcclxuICAgIHNuYXBzaG90LnB1c2goXHJcbiAgICAgIGBjb25zdCBzbmFwc2hvdCA9IHsgIHJvb3Q6ICcnLCBtVGltZXM6IG5ldyBNYXAoKSwgIG1SZWFsUGF0aHM6IG5ldyBNYXAoKSwgIG1EYXRhOiBbXSx9O2AsXHJcbiAgICApO1xyXG4gICAgLy8gcnVuRmV0Y2hcclxuICAgIHNuYXBzaG90LnB1c2goYGNvbnN0IHJ1bkZldGNoID0gYXN5bmMgKHBhdGgpID0+IHtgKTtcclxuICAgIHNuYXBzaG90LnB1c2goYCAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2goc25hcHNob3Qucm9vdCArIHBhdGgpO2ApO1xyXG4gICAgc25hcHNob3QucHVzaChgICBjb25zdCBidWZmZXIgPSBhd2FpdCByZXMuYXJyYXlCdWZmZXIoKTtgKTtcclxuICAgIHNuYXBzaG90LnB1c2goYCAgcmV0dXJuIFtwYXRoLCBuZXcgVWludDhBcnJheShidWZmZXIpXTtgKTtcclxuICAgIHNuYXBzaG90LnB1c2goYH07YCk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKGBzbmFwc2hvdC5yb290ID0gJHtKU09OLnN0cmluZ2lmeSh0aGlzLnJvb3QpfTtgKTtcclxuICAgIHNuYXBzaG90LnB1c2goXHJcbiAgICAgIGBzbmFwc2hvdC5tVGltZXMgPSBuZXcgTWFwKFske1suLi50aGlzLm1UaW1lcy5lbnRyaWVzKCldXHJcbiAgICAgICAgLm1hcCgoW2ssIHZdKSA9PiBgWyR7SlNPTi5zdHJpbmdpZnkoayl9LCAke3Y/LmdldFRpbWUoKSB8fCAndW5kZWZpbmVkJ31dYClcclxuICAgICAgICAuam9pbignLCAnKX1dKTtgLFxyXG4gICAgKTtcclxuICAgIHNuYXBzaG90LnB1c2goXHJcbiAgICAgIGBzbmFwc2hvdC5tUmVhbFBhdGhzID0gbmV3IE1hcChbJHtbLi4udGhpcy5tUmVhbFBhdGhzLmVudHJpZXMoKV1cclxuICAgICAgICAubWFwKChbaywgdl0pID0+IGBbJHtKU09OLnN0cmluZ2lmeShrKX0sICR7SlNPTi5zdHJpbmdpZnkodil9XWApXHJcbiAgICAgICAgLmpvaW4oJywgJyl9XSk7YCxcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZGF0YUVudHJpZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgWy4uLnRoaXMubURhdGEuZW50cmllcygpXS5tYXAoYXN5bmMgKFtrLCB2XSkgPT4ge1xyXG4gICAgICAgIGsgPSBKU09OLnN0cmluZ2lmeShrKTtcclxuICAgICAgICByZXR1cm4gdiA/IGBydW5GZXRjaCgke2t9KWAgOiBgUHJvbWlzZS5yZXNvbHZlKFske2t9LCB1bmRlZmluZWRdKWA7XHJcbiAgICAgIH0pLFxyXG4gICAgKTtcclxuICAgIHNuYXBzaG90LnB1c2goYHNuYXBzaG90Lm1EYXRhID0gYXdhaXQgUHJvbWlzZS5hbGwoWyR7ZGF0YUVudHJpZXMuam9pbignLCAnKX1dKTtgKTtcclxuXHJcbiAgICBzbmFwc2hvdC5wdXNoKGByZXR1cm4gc25hcHNob3Q7YCk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKCd9KSgpKScpO1xyXG4gICAgcmV0dXJuIHNuYXBzaG90LmpvaW4oJ1xcbicpO1xyXG4gIH1cclxuXHJcbiAgZ2V0TGFzdE1vZGlmaWVkKHBhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gICAgcmVxdWVzdC5vcGVuKCdIRUFEJywgcGF0aCwgZmFsc2UpO1xyXG4gICAgcmVxdWVzdC5zZW5kKG51bGwpO1xyXG4gICAgaWYgKHJlcXVlc3Quc3RhdHVzID09PSAyMDApIHtcclxuICAgICAgcmV0dXJuIHJlcXVlc3QuZ2V0UmVzcG9uc2VIZWFkZXIoJ0xhc3QtTW9kaWZpZWQnKTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgZ2V0TVRpbWVJbnRlcm5hbChwYXRoOiBzdHJpbmcpOiBEYXRlIHwgdW5kZWZpbmVkIHtcclxuICAgIGNvbnN0IGxhc3RNb2RpZmllZCA9IHRoaXMuZ2V0TGFzdE1vZGlmaWVkKHRoaXMucmVzb2x2ZVBhdGgocGF0aCkpO1xyXG4gICAgaWYgKGxhc3RNb2RpZmllZCkge1xyXG4gICAgICByZXR1cm4gbmV3IERhdGUobGFzdE1vZGlmaWVkKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgZ2V0TVRpbWUocGF0aDogc3RyaW5nKTogRGF0ZSB8IHVuZGVmaW5lZCB7XHJcbiAgICAvLyB0b2RvOiBubyBoYWNrXHJcbiAgICBpZiAocGF0aC5zdGFydHNXaXRoKCcvQG1lbW9yeS8nKSkge1xyXG4gICAgICBpZiAodGhpcy5tVGltZXMuaGFzKHBhdGgpKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubVRpbWVzLmdldChwYXRoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXRoaXMuZnVsbHlDYWNoZWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0TVRpbWVJbnRlcm5hbChwYXRoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5tVGltZXMuaGFzKHBhdGgpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLm1UaW1lcy5nZXQocGF0aCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBtVGltZSA9IHRoaXMuZ2V0TVRpbWVJbnRlcm5hbChwYXRoKTtcclxuICAgIHRoaXMubVRpbWVzLnNldChwYXRoLCBtVGltZSk7XHJcbiAgICByZXR1cm4gbVRpbWU7XHJcbiAgfVxyXG5cclxuICAvLyB0b2RvOiBpc0ZpbGVcclxuICBpc0ZpbGUoKTogYm9vbGVhbiB8IHVuZGVmaW5lZCB7XHJcbiAgICAvLyBwYXRoOiBzdHJpbmdcclxuICAgIC8vIGNvbnN0IHJlcXVlc3QgPSB0aGlzLmdldExhc3RNb2RpZmllZCh0aGlzLnJlc29sdmVQYXRoKHBhdGgpKTtcclxuICAgIC8vIGlmIChyZXF1ZXN0LnN0YXR1cyA9PT0gMjAwKSB7XHJcbiAgICAvLyAgIGNvbnNvbGUubG9nKHJlcXVlc3QsIHJlcXVlc3QuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpO1xyXG4gICAgLy8gfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICAvLyB0b2RvOiBnZXRSZWFsUGF0aFxyXG4gIGdldFJlYWxQYXRoKHBhdGg6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XHJcbiAgICByZXR1cm4gcGF0aDtcclxuICB9XHJcblxyXG4gIHJlYWRBbGxJbnRlcm5hbChwYXRoOiBzdHJpbmcpOiBVaW50OEFycmF5IHwgdW5kZWZpbmVkIHtcclxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICAgIHJlcXVlc3Qub3ZlcnJpZGVNaW1lVHlwZSgndGV4dC9wbGFpbjsgY2hhcnNldD14LXVzZXItZGVmaW5lZCcpO1xyXG4gICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB0aGlzLnJlc29sdmVQYXRoKHBhdGgpLCBmYWxzZSk7XHJcbiAgICByZXF1ZXN0LnNlbmQobnVsbCk7XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICByZXF1ZXN0LnN0YXR1cyA9PT0gMjAwICYmXHJcbiAgICAgIChyZXF1ZXN0LnJlc3BvbnNlIGluc3RhbmNlb2YgU3RyaW5nIHx8IHR5cGVvZiByZXF1ZXN0LnJlc3BvbnNlID09PSAnc3RyaW5nJylcclxuICAgICkge1xyXG4gICAgICByZXR1cm4gVWludDhBcnJheS5mcm9tKHJlcXVlc3QucmVzcG9uc2UsIChjOiBzdHJpbmcpID0+IGMuY2hhckNvZGVBdCgwKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgcmVhZEFsbChwYXRoOiBzdHJpbmcpOiBVaW50OEFycmF5IHwgdW5kZWZpbmVkIHtcclxuICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJy9AbWVtb3J5LycpKSB7XHJcbiAgICAgIGlmICh0aGlzLm1EYXRhLmhhcyhwYXRoKSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1EYXRhLmdldChwYXRoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXRoaXMuZnVsbHlDYWNoZWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMucmVhZEFsbEludGVybmFsKHBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLm1EYXRhLmhhcyhwYXRoKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5tRGF0YS5nZXQocGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZGF0YSA9IHRoaXMucmVhZEFsbEludGVybmFsKHBhdGgpO1xyXG4gICAgdGhpcy5tRGF0YS5zZXQocGF0aCwgZGF0YSk7XHJcbiAgICByZXR1cm4gZGF0YTtcclxuICB9XHJcbn1cclxuIl19