"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.composeDoc = exports.provideDoc = exports.TypstDocumentContext = exports.PreviewMode = void 0;
var PreviewMode;
(function (PreviewMode) {
    PreviewMode[PreviewMode["Doc"] = 0] = "Doc";
    PreviewMode[PreviewMode["Slide"] = 1] = "Slide";
})(PreviewMode = exports.PreviewMode || (exports.PreviewMode = {}));
class TypstDocumentContext {
    hookedElem;
    kModule;
    opts;
    modes = [];
    /// Configuration fields
    /// enable partial rendering
    partialRendering = true;
    /// underlying renderer
    renderMode = 'svg';
    r = undefined;
    /// preview mode
    previewMode = PreviewMode.Doc;
    /// whether this is a content preview
    isContentPreview = false;
    /// whether this content preview will mix outline titles
    isMixinOutline = false;
    /// background color
    backgroundColor = 'black';
    /// default page color (empty string means transparent)
    pageColor = 'white';
    /// pixel per pt
    pixelPerPt = 3;
    /// customized way to retrieving dom state
    retrieveDOMState;
    /// State fields
    /// whether svg is updating (in triggerSvgUpdate)
    isRendering = false;
    /// whether kModule is initialized
    moduleInitialized = false;
    /// patch queue for updating data.
    patchQueue = [];
    /// resources to dispose
    disposeList = [];
    /// canvas render ctoken
    canvasRenderCToken;
    /// There are two scales in this class: The real scale is to adjust the size
    /// of `hookedElem` to fit the svg. The virtual scale (scale ratio) is to let
    /// user zoom in/out the svg. For example:
    /// + the default value of virtual scale is 1, which means the svg is totally
    ///   fit in `hookedElem`.
    /// + if user set virtual scale to 0.5, then the svg will be zoomed out to fit
    ///   in half width of `hookedElem`. "real" current scale of `hookedElem`
    currentRealScale = 1;
    /// "virtual" current scale of `hookedElem`
    currentScaleRatio = 1;
    /// timeout for delayed viewport change
    vpTimeout = undefined;
    /// sampled by last render time.
    sampledRenderTime = 0;
    /// page to partial render
    partialRenderPage = 0;
    /// outline data
    outline = undefined;
    /// cursor position in form of [page, x, y]
    cursorPosition = undefined;
    // id: number = rnd++;
    /// Cache fields
    /// cached state of container, default to retrieve state from `this.hookedElem`
    cachedDOMState = {
        width: 0,
        height: 0,
        window: {
            innerWidth: 0,
            innerHeight: 0,
        },
        boundingRect: {
            left: 0,
            top: 0,
            right: 0,
        },
    };
    constructor(opts) {
        this.hookedElem = opts.hookedElem;
        this.kModule = opts.kModule;
        this.opts = opts || {};
        /// Apply configuration
        {
            const { renderMode, previewMode, isContentPreview, retrieveDOMState } = opts || {};
            this.partialRendering = false;
            this.renderMode = renderMode ?? this.renderMode;
            this.previewMode = previewMode ?? this.previewMode;
            this.isContentPreview = isContentPreview || false;
            this.retrieveDOMState =
                retrieveDOMState ??
                    (() => {
                        return {
                            width: this.hookedElem.offsetWidth,
                            height: this.hookedElem.offsetHeight,
                            window: {
                                innerWidth: window.innerWidth,
                                innerHeight: window.innerHeight,
                            },
                            boundingRect: this.hookedElem.getBoundingClientRect(),
                        };
                    });
            this.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--typst-preview-background-color');
        }
        // if init scale == 1
        // hide scrollbar if scale == 1
        this.hookedElem.classList.add('hide-scrollbar-x');
        this.hookedElem.parentElement?.classList.add('hide-scrollbar-x');
        if (this.previewMode === PreviewMode.Slide) {
            this.hookedElem.classList.add('hide-scrollbar-y');
            this.hookedElem.parentElement?.classList.add('hide-scrollbar-y');
        }
        this.installCtrlWheelHandler();
    }
    reset() {
        this.kModule.reset();
        this.moduleInitialized = false;
    }
    dispose() {
        const disposeList = this.disposeList;
        this.disposeList = [];
        disposeList.forEach(x => x());
    }
    static derive(ctx, mode) {
        return ['rescale', 'rerender', 'postRender'].reduce((acc, x) => {
            acc[x] = ctx[`${x}$${mode}`].bind(ctx);
            console.assert(acc[x] !== undefined, `${x}$${mode} is undefined`);
            return acc;
        }, {});
    }
    registerMode(mode) {
        const facade = TypstDocumentContext.derive(this, mode);
        this.modes.push([mode, facade]);
        if (mode === this.renderMode) {
            this.r = facade;
        }
    }
    installCtrlWheelHandler() {
        // Ctrl+scroll rescaling
        // will disable auto resizing
        // fixed factors, same as pdf.js
        const factors = [
            0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.3, 1.5, 1.7, 1.9, 2.1, 2.4, 2.7, 3,
            3.3, 3.7, 4.1, 4.6, 5.1, 5.7, 6.3, 7, 7.7, 8.5, 9.4, 10,
        ];
        const wheelEventHandler = (event) => {
            if (event.ctrlKey) {
                event.preventDefault();
                // retrieve dom state before any operation
                this.cachedDOMState = this.retrieveDOMState();
                if (window.onresize !== null) {
                    // is auto resizing
                    window.onresize = null;
                }
                const prevScaleRatio = this.currentScaleRatio;
                // Get wheel scroll direction and calculate new scale
                if (event.deltaY < 0) {
                    // enlarge
                    if (this.currentScaleRatio >= factors.at(-1)) {
                        // already large than max factor
                        return;
                    }
                    else {
                        this.currentScaleRatio = factors.filter(x => x > this.currentScaleRatio).at(0);
                    }
                }
                else if (event.deltaY > 0) {
                    // reduce
                    if (this.currentScaleRatio <= factors.at(0)) {
                        return;
                    }
                    else {
                        this.currentScaleRatio = factors.filter(x => x < this.currentScaleRatio).at(-1);
                    }
                }
                else {
                    // no y-axis scroll
                    return;
                }
                const scrollFactor = this.currentScaleRatio / prevScaleRatio;
                const scrollX = event.pageX * (scrollFactor - 1);
                const scrollY = event.pageY * (scrollFactor - 1);
                // hide scrollbar if scale == 1
                if (Math.abs(this.currentScaleRatio - 1) < 1e-5) {
                    this.hookedElem.classList.add('hide-scrollbar-x');
                    this.hookedElem.parentElement?.classList.add('hide-scrollbar-x');
                    if (this.previewMode === PreviewMode.Slide) {
                        this.hookedElem.classList.add('hide-scrollbar-y');
                        this.hookedElem.parentElement?.classList.add('hide-scrollbar-y');
                    }
                }
                else {
                    this.hookedElem.classList.remove('hide-scrollbar-x');
                    this.hookedElem.parentElement?.classList.remove('hide-scrollbar-x');
                    if (this.previewMode === PreviewMode.Slide) {
                        this.hookedElem.classList.remove('hide-scrollbar-y');
                        this.hookedElem.parentElement?.classList.remove('hide-scrollbar-y');
                    }
                }
                // reserve space to scroll down
                const svg = this.hookedElem.firstElementChild;
                if (svg) {
                    const scaleRatio = this.getSvgScaleRatio();
                    const dataHeight = Number.parseFloat(svg.getAttribute('data-height'));
                    const scaledHeight = Math.ceil(dataHeight * scaleRatio);
                    // we increase the height by 2 times.
                    // The `2` is only a magic number that is large enough.
                    this.hookedElem.style.height = `${scaledHeight * 2}px`;
                }
                // make sure the cursor is still on the same position
                window.scrollBy(scrollX, scrollY);
                // toggle scale change event
                this.addViewportChange();
                return false;
            }
        };
        if (this.renderMode !== 'dom') {
            const vscodeAPI = typeof acquireVsCodeApi !== 'undefined';
            if (vscodeAPI) {
                window.addEventListener('wheel', wheelEventHandler, {
                    passive: false,
                });
                this.disposeList.push(() => {
                    window.removeEventListener('wheel', wheelEventHandler);
                });
            }
            else {
                document.body.addEventListener('wheel', wheelEventHandler, {
                    passive: false,
                });
                this.disposeList.push(() => {
                    document.body.removeEventListener('wheel', wheelEventHandler);
                });
            }
        }
    }
    /// Get current scale from html to svg
    // Note: one should retrieve dom state before rescale
    getSvgScaleRatio() {
        const svg = this.hookedElem.firstElementChild;
        if (!svg) {
            return 0;
        }
        const container = this.cachedDOMState;
        const svgWidth = Number.parseFloat(svg.getAttribute('data-width') || svg.getAttribute('width') || '1');
        const svgHeight = Number.parseFloat(svg.getAttribute('data-height') || svg.getAttribute('height') || '1');
        this.currentRealScale =
            this.previewMode === PreviewMode.Slide
                ? Math.min(container.width / svgWidth, container.height / svgHeight)
                : container.width / svgWidth;
        return this.currentRealScale * this.currentScaleRatio;
    }
    processQueue(svgUpdateEvent) {
        const eventName = svgUpdateEvent[0];
        switch (eventName) {
            case 'new':
            case 'diff-v1': {
                if (eventName === 'new') {
                    this.reset();
                }
                this.kModule.manipulateData({
                    action: 'merge',
                    data: svgUpdateEvent[1],
                });
                this.moduleInitialized = true;
                return true;
            }
            case 'viewport-change': {
                if (!this.moduleInitialized) {
                    console.log('viewport-change before initialization');
                    return false;
                }
                return true;
            }
            default:
                console.log('svgUpdateEvent', svgUpdateEvent);
                return false;
        }
    }
    triggerUpdate() {
        if (this.isRendering) {
            return;
        }
        this.isRendering = true;
        const doUpdate = async () => {
            this.cachedDOMState = this.retrieveDOMState();
            if (this.patchQueue.length === 0) {
                this.isRendering = false;
                this.postprocessChanges();
                return;
            }
            try {
                let t0 = performance.now();
                const ctoken = this.canvasRenderCToken;
                if (ctoken) {
                    await ctoken.cancel();
                    await ctoken.wait();
                    this.canvasRenderCToken = undefined;
                    console.log('cancel canvas rendering');
                }
                let needRerender = false;
                // console.log('patchQueue', JSON.stringify(this.patchQueue.map(x => x[0])));
                while (this.patchQueue.length > 0) {
                    needRerender = this.processQueue(this.patchQueue.shift()) || needRerender;
                }
                // todo: trigger viewport change once
                let t1 = performance.now();
                if (needRerender) {
                    this.r.rescale();
                    await this.r.rerender();
                    this.r.rescale();
                }
                let t2 = performance.now();
                /// perf event
                const d = (e, x, y) => `${e} ${(y - x).toFixed(2)} ms`;
                this.sampledRenderTime = t2 - t0;
                console.log([d('parse', t0, t1), d('rerender', t1, t2), d('total', t0, t2)].join(', '));
                requestAnimationFrame(doUpdate);
            }
            catch (e) {
                console.error(e);
                this.isRendering = false;
                this.postprocessChanges();
            }
        };
        requestAnimationFrame(doUpdate);
    }
    postprocessChanges() {
        this.r.postRender();
        // todo: abstract this
        if (this.previewMode === PreviewMode.Slide) {
            document.querySelectorAll('.typst-page-number-indicator').forEach(x => {
                x.textContent = `${this.kModule.retrievePagesInfo().length}`;
            });
        }
    }
    addChangement(change) {
        if (change[0] === 'new') {
            this.patchQueue.splice(0, this.patchQueue.length);
        }
        const pushChange = () => {
            this.vpTimeout = undefined;
            this.patchQueue.push(change);
            this.triggerUpdate();
        };
        if (this.vpTimeout !== undefined) {
            clearTimeout(this.vpTimeout);
        }
        if (change[0] === 'viewport-change' && this.isRendering) {
            // delay viewport change a bit
            this.vpTimeout = setTimeout(pushChange, this.sampledRenderTime || 100);
        }
        else {
            pushChange();
        }
    }
    addViewportChange() {
        this.addChangement(['viewport-change', '']);
    }
}
exports.TypstDocumentContext = TypstDocumentContext;
function provideDoc(Base) {
    return class TypstDocument {
        impl;
        kModule;
        constructor(options) {
            if (options.isContentPreview) {
                options.renderMode = 'canvas';
            }
            this.kModule = options.kModule;
            this.impl = new Base(options);
            if (!this.impl.r) {
                throw new Error(`mode is not supported, ${options?.renderMode}`);
            }
            if (options.isContentPreview) {
                // content preview has very bad performance without partial rendering
                this.impl.partialRendering = true;
                this.impl.pixelPerPt = 1;
                this.impl.isMixinOutline = true;
            }
        }
        dispose() {
            this.impl.dispose();
        }
        reset() {
            this.impl.reset();
        }
        addChangement(change) {
            this.impl.addChangement(change);
        }
        addViewportChange() {
            this.impl.addViewportChange();
        }
        setPageColor(color) {
            this.impl.pageColor = color;
            this.addViewportChange();
        }
        setPartialRendering(partialRendering) {
            this.impl.partialRendering = partialRendering;
        }
        setCursor(page, x, y) {
            this.impl.cursorPosition = [page, x, y];
        }
        setPartialPageNumber(page) {
            if (page <= 0 || page > this.kModule.retrievePagesInfo().length) {
                return false;
            }
            this.impl.partialRenderPage = page - 1;
            this.addViewportChange();
            return true;
        }
        getPartialPageNumber() {
            return this.impl.partialRenderPage + 1;
        }
        setOutineData(outline) {
            this.impl.outline = outline;
            this.addViewportChange();
        }
    };
}
exports.provideDoc = provideDoc;
function composeDoc(Base, ...mixins) {
    return mixins.reduce((acc, mixin) => mixin(acc), Base);
}
exports.composeDoc = composeDoc;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwc3QtZG9jLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb250cmliL2RvbS90eXBzdC1kb2MubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQXVCQSxJQUFZLFdBR1g7QUFIRCxXQUFZLFdBQVc7SUFDckIsMkNBQUcsQ0FBQTtJQUNILCtDQUFLLENBQUE7QUFDUCxDQUFDLEVBSFcsV0FBVyxHQUFYLG1CQUFXLEtBQVgsbUJBQVcsUUFHdEI7QUFvQkQsTUFBYSxvQkFBb0I7SUFDeEIsVUFBVSxDQUFjO0lBQ3hCLE9BQU8sQ0FBZ0I7SUFDdkIsSUFBSSxDQUFJO0lBQ2YsS0FBSyxHQUFvQyxFQUFFLENBQUM7SUFFNUMsd0JBQXdCO0lBRXhCLDRCQUE0QjtJQUM1QixnQkFBZ0IsR0FBWSxJQUFJLENBQUM7SUFDakMsdUJBQXVCO0lBQ3ZCLFVBQVUsR0FBZSxLQUFLLENBQUM7SUFDL0IsQ0FBQyxHQUF3QixTQUFVLENBQUM7SUFDcEMsZ0JBQWdCO0lBQ2hCLFdBQVcsR0FBZ0IsV0FBVyxDQUFDLEdBQUcsQ0FBQztJQUMzQyxxQ0FBcUM7SUFDckMsZ0JBQWdCLEdBQVksS0FBSyxDQUFDO0lBQ2xDLHdEQUF3RDtJQUN4RCxjQUFjLEdBQVksS0FBSyxDQUFDO0lBQ2hDLG9CQUFvQjtJQUNwQixlQUFlLEdBQVcsT0FBTyxDQUFDO0lBQ2xDLHVEQUF1RDtJQUN2RCxTQUFTLEdBQVcsT0FBTyxDQUFDO0lBQzVCLGdCQUFnQjtJQUNoQixVQUFVLEdBQVcsQ0FBQyxDQUFDO0lBQ3ZCLDBDQUEwQztJQUMxQyxnQkFBZ0IsQ0FBMEI7SUFFMUMsZ0JBQWdCO0lBRWhCLGlEQUFpRDtJQUNqRCxXQUFXLEdBQVksS0FBSyxDQUFDO0lBQzdCLGtDQUFrQztJQUNsQyxpQkFBaUIsR0FBWSxLQUFLLENBQUM7SUFDbkMsa0NBQWtDO0lBQ2xDLFVBQVUsR0FBdUIsRUFBRSxDQUFDO0lBQ3BDLHdCQUF3QjtJQUN4QixXQUFXLEdBQW1C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O2FBQ2Q7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksR0FBRyxDQUFDLENBQUM7WUFDdkMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDekIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsb0JBQW9CO1lBQ2xCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLENBQUM7UUFDekMsQ0FBQztRQUVELGFBQWEsQ0FBQyxPQUFZO1lBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztZQUM1QixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUMzQixDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUF6RUQsZ0NBeUVDO0FBMEVELFNBQWdCLFVBQVUsQ0FBNkIsSUFBVyxFQUFFLEdBQUcsTUFBYTtJQUNsRixPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDekQsQ0FBQztBQUZELGdDQUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBSZW5kZXJTZXNzaW9uIH0gZnJvbSAnLi4vLi4vcmVuZGVyZXIubWpzJztcclxuaW1wb3J0IHsgVHlwc3RDYW5jZWxsYXRpb25Ub2tlbiB9IGZyb20gJy4vdHlwc3QtY2FuY2VsLm1qcyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIENvbnRhaW5lckRPTVN0YXRlIHtcclxuICAvLy8gY2FjaGVkIGBob29rZWRFbGVtLm9mZnNldFdpZHRoYCBvciBgaG9va2VkRWxlbS5pbm5lcldpZHRoYFxyXG4gIHdpZHRoOiBudW1iZXI7XHJcbiAgLy8vIGNhY2hlZCBgaG9va2VkRWxlbS5vZmZzZXRIZWlnaHRgIG9yIGBob29rZWRFbGVtLmlubmVySGVpZ2h0YFxyXG4gIGhlaWdodDogbnVtYmVyO1xyXG4gIHdpbmRvdzoge1xyXG4gICAgaW5uZXJXaWR0aDogbnVtYmVyO1xyXG4gICAgaW5uZXJIZWlnaHQ6IG51bWJlcjtcclxuICB9O1xyXG4gIC8vLyBjYWNoZWQgYGhvb2tlZEVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClgXHJcbiAgLy8vIFdlIG9ubHkgdXNlIGBsZWZ0YCBhbmQgYHRvcGAgaGVyZS5cclxuICBib3VuZGluZ1JlY3Q6IHtcclxuICAgIGxlZnQ6IG51bWJlcjtcclxuICAgIHRvcDogbnVtYmVyO1xyXG4gICAgcmlnaHQ6IG51bWJlcjtcclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBSZW5kZXJNb2RlID0gJ3N2ZycgfCAnY2FudmFzJyB8ICdkb20nO1xyXG5cclxuZXhwb3J0IGVudW0gUHJldmlld01vZGUge1xyXG4gIERvYyxcclxuICBTbGlkZSxcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcclxuICBob29rZWRFbGVtOiBIVE1MRWxlbWVudDtcclxuICBrTW9kdWxlOiBSZW5kZXJTZXNzaW9uO1xyXG4gIHJlbmRlck1vZGU/OiBSZW5kZXJNb2RlO1xyXG4gIHByZXZpZXdNb2RlPzogUHJldmlld01vZGU7XHJcbiAgaXNDb250ZW50UHJldmlldz86IGJvb2xlYW47XHJcbiAgc291cmNlTWFwcGluZz86IGJvb2xlYW47XHJcbiAgcmV0cmlldmVET01TdGF0ZT86ICgpID0+IENvbnRhaW5lckRPTVN0YXRlO1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBHQ29uc3RydWN0b3I8VCA9IHt9PiA9IG5ldyAoLi4uYXJnczogYW55W10pID0+IFQ7XHJcblxyXG5pbnRlcmZhY2UgVHlwc3REb2N1bWVudEZhY2FkZSB7XHJcbiAgcmVzY2FsZSgpOiB2b2lkO1xyXG4gIHJlcmVuZGVyKCk6IFByb21pc2U8dm9pZD47XHJcbiAgcG9zdFJlbmRlcigpOiB2b2lkO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgVHlwc3REb2N1bWVudENvbnRleHQ8TyA9IGFueT4ge1xyXG4gIHB1YmxpYyBob29rZWRFbGVtOiBIVE1MRWxlbWVudDtcclxuICBwdWJsaWMga01vZHVsZTogUmVuZGVyU2Vzc2lvbjtcclxuICBwdWJsaWMgb3B0czogTztcclxuICBtb2RlczogW3N0cmluZywgVHlwc3REb2N1bWVudEZhY2FkZV1bXSA9IFtdO1xyXG5cclxuICAvLy8gQ29uZmlndXJhdGlvbiBmaWVsZHNcclxuXHJcbiAgLy8vIGVuYWJsZSBwYXJ0aWFsIHJlbmRlcmluZ1xyXG4gIHBhcnRpYWxSZW5kZXJpbmc6IGJvb2xlYW4gPSB0cnVlO1xyXG4gIC8vLyB1bmRlcmx5aW5nIHJlbmRlcmVyXHJcbiAgcmVuZGVyTW9kZTogUmVuZGVyTW9kZSA9ICdzdmcnO1xyXG4gIHI6IFR5cHN0RG9jdW1lbnRGYWNhZGUgPSB1bmRlZmluZWQhO1xyXG4gIC8vLyBwcmV2aWV3IG1vZGVcclxuICBwcmV2aWV3TW9kZTogUHJldmlld01vZGUgPSBQcmV2aWV3TW9kZS5Eb2M7XHJcbiAgLy8vIHdoZXRoZXIgdGhpcyBpcyBhIGNvbnRlbnQgcHJldmlld1xyXG4gIGlzQ29udGVudFByZXZpZXc6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAvLy8gd2hldGhlciB0aGlzIGNvbnRlbnQgcHJldmlldyB3aWxsIG1peCBvdXRsaW5lIHRpdGxlc1xyXG4gIGlzTWl4aW5PdXRsaW5lOiBib29sZWFuID0gZmFsc2U7XHJcbiAgLy8vIGJhY2tncm91bmQgY29sb3JcclxuICBiYWNrZ3JvdW5kQ29sb3I6IHN0cmluZyA9ICdibGFjayc7XHJcbiAgLy8vIGRlZmF1bHQgcGFnZSBjb2xvciAoZW1wdHkgc3RyaW5nIG1lYW5zIHRyYW5zcGFyZW50KVxyXG4gIHBhZ2VDb2xvcjogc3RyaW5nID0gJ3doaXRlJztcclxuICAvLy8gcGl4ZWwgcGVyIHB0XHJcbiAgcGl4ZWxQZXJQdDogbnVtYmVyID0gMztcclxuICAvLy8gY3VzdG9taXplZCB3YXkgdG8gcmV0cmlldmluZyBkb20gc3RhdGVcclxuICByZXRyaWV2ZURPTVN0YXRlOiAoKSA9PiBDb250YWluZXJET01TdGF0ZTtcclxuXHJcbiAgLy8vIFN0YXRlIGZpZWxkc1xyXG5cclxuICAvLy8gd2hldGhlciBzdmcgaXMgdXBkYXRpbmcgKGluIHRyaWdnZXJTdmdVcGRhdGUpXHJcbiAgaXNSZW5kZXJpbmc6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAvLy8gd2hldGhlciBrTW9kdWxlIGlzIGluaXRpYWxpemVkXHJcbiAgbW9kdWxlSW5pdGlhbGl6ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAvLy8gcGF0Y2ggcXVldWUgZm9yIHVwZGF0aW5nIGRhdGEuXHJcbiAgcGF0Y2hRdWV1ZTogW3N0cmluZywgc3RyaW5nXVtdID0gW107XHJcbiAgLy8vIHJlc291cmNlcyB0byBkaXNwb3NlXHJcbiAgZGlzcG9zZUxpc3Q6ICgoKSA9PiB2b2lkKVtdID0gW107XHJcbiAgLy8vIGNhbnZhcyByZW5kZXIgY3Rva2VuXHJcbiAgY2FudmFzUmVuZGVyQ1Rva2VuPzogVHlwc3RDYW5jZWxsYXRpb25Ub2tlbjtcclxuXHJcbiAgLy8vIFRoZXJlIGFyZSB0d28gc2NhbGVzIGluIHRoaXMgY2xhc3M6IFRoZSByZWFsIHNjYWxlIGlzIHRvIGFkanVzdCB0aGUgc2l6ZVxyXG4gIC8vLyBvZiBgaG9va2VkRWxlbWAgdG8gZml0IHRoZSBzdmcuIFRoZSB2aXJ0dWFsIHNjYWxlIChzY2FsZSByYXRpbykgaXMgdG8gbGV0XHJcbiAgLy8vIHVzZXIgem9vbSBpbi9vdXQgdGhlIHN2Zy4gRm9yIGV4YW1wbGU6XHJcbiAgLy8vICsgdGhlIGRlZmF1bHQgdmFsdWUgb2YgdmlydHVhbCBzY2FsZSBpcyAxLCB3aGljaCBtZWFucyB0aGUgc3ZnIGlzIHRvdGFsbHlcclxuICAvLy8gICBmaXQgaW4gYGhvb2tlZEVsZW1gLlxyXG4gIC8vLyArIGlmIHVzZXIgc2V0IHZpcnR1YWwgc2NhbGUgdG8gMC41LCB0aGVuIHRoZSBzdmcgd2lsbCBiZSB6b29tZWQgb3V0IHRvIGZpdFxyXG4gIC8vLyAgIGluIGhhbGYgd2lkdGggb2YgYGhvb2tlZEVsZW1gLiBcInJlYWxcIiBjdXJyZW50IHNjYWxlIG9mIGBob29rZWRFbGVtYFxyXG4gIGN1cnJlbnRSZWFsU2NhbGU6IG51bWJlciA9IDE7XHJcbiAgLy8vIFwidmlydHVhbFwiIGN1cnJlbnQgc2NhbGUgb2YgYGhvb2tlZEVsZW1gXHJcbiAgY3VycmVudFNjYWxlUmF0aW86IG51bWJlciA9IDE7XHJcbiAgLy8vIHRpbWVvdXQgZm9yIGRlbGF5ZWQgdmlld3BvcnQgY2hhbmdlXHJcbiAgdnBUaW1lb3V0OiBhbnkgPSB1bmRlZmluZWQ7XHJcbiAgLy8vIHNhbXBsZWQgYnkgbGFzdCByZW5kZXIgdGltZS5cclxuICBzYW1wbGVkUmVuZGVyVGltZTogbnVtYmVyID0gMDtcclxuICAvLy8gcGFnZSB0byBwYXJ0aWFsIHJlbmRlclxyXG4gIHBhcnRpYWxSZW5kZXJQYWdlOiBudW1iZXIgPSAwO1xyXG4gIC8vLyBvdXRsaW5lIGRhdGFcclxuICBvdXRsaW5lOiBhbnkgPSB1bmRlZmluZWQ7XHJcbiAgLy8vIGN1cnNvciBwb3NpdGlvbiBpbiBmb3JtIG9mIFtwYWdlLCB4LCB5XVxyXG4gIGN1cnNvclBvc2l0aW9uPzogW251bWJlciwgbnVtYmVyLCBudW1iZXJdID0gdW5kZWZpbmVkO1xyXG4gIC8vIGlkOiBudW1iZXIgPSBybmQrKztcclxuXHJcbiAgLy8vIENhY2hlIGZpZWxkc1xyXG5cclxuICAvLy8gY2FjaGVkIHN0YXRlIG9mIGNvbnRhaW5lciwgZGVmYXVsdCB0byByZXRyaWV2ZSBzdGF0ZSBmcm9tIGB0aGlzLmhvb2tlZEVsZW1gXHJcbiAgY2FjaGVkRE9NU3RhdGU6IENvbnRhaW5lckRPTVN0YXRlID0ge1xyXG4gICAgd2lkdGg6IDAsXHJcbiAgICBoZWlnaHQ6IDAsXHJcbiAgICB3aW5kb3c6IHtcclxuICAgICAgaW5uZXJXaWR0aDogMCxcclxuICAgICAgaW5uZXJIZWlnaHQ6IDAsXHJcbiAgICB9LFxyXG4gICAgYm91bmRpbmdSZWN0OiB7XHJcbiAgICAgIGxlZnQ6IDAsXHJcbiAgICAgIHRvcDogMCxcclxuICAgICAgcmlnaHQ6IDAsXHJcbiAgICB9LFxyXG4gIH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKG9wdHM6IE9wdGlvbnMgJiBPKSB7XHJcbiAgICB0aGlzLmhvb2tlZEVsZW0gPSBvcHRzLmhvb2tlZEVsZW07XHJcbiAgICB0aGlzLmtNb2R1bGUgPSBvcHRzLmtNb2R1bGU7XHJcbiAgICB0aGlzLm9wdHMgPSBvcHRzIHx8IHt9O1xyXG5cclxuICAgIC8vLyBBcHBseSBjb25maWd1cmF0aW9uXHJcbiAgICB7XHJcbiAgICAgIGNvbnN0IHsgcmVuZGVyTW9kZSwgcHJldmlld01vZGUsIGlzQ29udGVudFByZXZpZXcsIHJldHJpZXZlRE9NU3RhdGUgfSA9IG9wdHMgfHwge307XHJcbiAgICAgIHRoaXMucGFydGlhbFJlbmRlcmluZyA9IGZhbHNlO1xyXG4gICAgICB0aGlzLnJlbmRlck1vZGUgPSByZW5kZXJNb2RlID8/IHRoaXMucmVuZGVyTW9kZTtcclxuICAgICAgdGhpcy5wcmV2aWV3TW9kZSA9IHByZXZpZXdNb2RlID8/IHRoaXMucHJldmlld01vZGU7XHJcbiAgICAgIHRoaXMuaXNDb250ZW50UHJldmlldyA9IGlzQ29udGVudFByZXZpZXcgfHwgZmFsc2U7XHJcbiAgICAgIHRoaXMucmV0cmlldmVET01TdGF0ZSA9XHJcbiAgICAgICAgcmV0cmlldmVET01TdGF0ZSA/P1xyXG4gICAgICAgICgoKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB3aWR0aDogdGhpcy5ob29rZWRFbGVtLm9mZnNldFdpZHRoLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IHRoaXMuaG9va2VkRWxlbS5vZmZzZXRIZWlnaHQsXHJcbiAgICAgICAgICAgIHdpbmRvdzoge1xyXG4gICAgICAgICAgICAgIGlubmVyV2lkdGg6IHdpbmRvdy5pbm5lcldpZHRoLFxyXG4gICAgICAgICAgICAgIGlubmVySGVpZ2h0OiB3aW5kb3cuaW5uZXJIZWlnaHQsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGJvdW5kaW5nUmVjdDogdGhpcy5ob29rZWRFbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuICAgICAgdGhpcy5iYWNrZ3JvdW5kQ29sb3IgPSBnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkuZ2V0UHJvcGVydHlWYWx1ZShcclxuICAgICAgICAnLS10eXBzdC1wcmV2aWV3LWJhY2tncm91bmQtY29sb3InLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGlmIGluaXQgc2NhbGUgPT0gMVxyXG4gICAgLy8gaGlkZSBzY3JvbGxiYXIgaWYgc2NhbGUgPT0gMVxyXG5cclxuICAgIHRoaXMuaG9va2VkRWxlbS5jbGFzc0xpc3QuYWRkKCdoaWRlLXNjcm9sbGJhci14Jyk7XHJcbiAgICB0aGlzLmhvb2tlZEVsZW0ucGFyZW50RWxlbWVudD8uY2xhc3NMaXN0LmFkZCgnaGlkZS1zY3JvbGxiYXIteCcpO1xyXG4gICAgaWYgKHRoaXMucHJldmlld01vZGUgPT09IFByZXZpZXdNb2RlLlNsaWRlKSB7XHJcbiAgICAgIHRoaXMuaG9va2VkRWxlbS5jbGFzc0xpc3QuYWRkKCdoaWRlLXNjcm9sbGJhci15Jyk7XHJcbiAgICAgIHRoaXMuaG9va2VkRWxlbS5wYXJlbnRFbGVtZW50Py5jbGFzc0xpc3QuYWRkKCdoaWRlLXNjcm9sbGJhci15Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5pbnN0YWxsQ3RybFdoZWVsSGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbiAgcmVzZXQoKSB7XHJcbiAgICB0aGlzLmtNb2R1bGUucmVzZXQoKTtcclxuICAgIHRoaXMubW9kdWxlSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICBjb25zdCBkaXNwb3NlTGlzdCA9IHRoaXMuZGlzcG9zZUxpc3Q7XHJcbiAgICB0aGlzLmRpc3Bvc2VMaXN0ID0gW107XHJcbiAgICBkaXNwb3NlTGlzdC5mb3JFYWNoKHggPT4geCgpKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBkZXJpdmUoY3R4OiBhbnksIG1vZGU6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIFsncmVzY2FsZScsICdyZXJlbmRlcicsICdwb3N0UmVuZGVyJ10ucmVkdWNlKChhY2M6IGFueSwgeDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGFjY1t4XSA9IGN0eFtgJHt4fSQke21vZGV9YF0uYmluZChjdHgpO1xyXG4gICAgICBjb25zb2xlLmFzc2VydChhY2NbeF0gIT09IHVuZGVmaW5lZCwgYCR7eH0kJHttb2RlfSBpcyB1bmRlZmluZWRgKTtcclxuICAgICAgcmV0dXJuIGFjYztcclxuICAgIH0sIHt9IGFzIFR5cHN0RG9jdW1lbnRGYWNhZGUpO1xyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJNb2RlKG1vZGU6IGFueSkge1xyXG4gICAgY29uc3QgZmFjYWRlID0gVHlwc3REb2N1bWVudENvbnRleHQuZGVyaXZlKHRoaXMsIG1vZGUpO1xyXG4gICAgdGhpcy5tb2Rlcy5wdXNoKFttb2RlLCBmYWNhZGVdKTtcclxuICAgIGlmIChtb2RlID09PSB0aGlzLnJlbmRlck1vZGUpIHtcclxuICAgICAgdGhpcy5yID0gZmFjYWRlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbnN0YWxsQ3RybFdoZWVsSGFuZGxlcigpIHtcclxuICAgIC8vIEN0cmwrc2Nyb2xsIHJlc2NhbGluZ1xyXG4gICAgLy8gd2lsbCBkaXNhYmxlIGF1dG8gcmVzaXppbmdcclxuICAgIC8vIGZpeGVkIGZhY3RvcnMsIHNhbWUgYXMgcGRmLmpzXHJcbiAgICBjb25zdCBmYWN0b3JzID0gW1xyXG4gICAgICAwLjEsIDAuMiwgMC4zLCAwLjQsIDAuNSwgMC42LCAwLjcsIDAuOCwgMC45LCAxLCAxLjEsIDEuMywgMS41LCAxLjcsIDEuOSwgMi4xLCAyLjQsIDIuNywgMyxcclxuICAgICAgMy4zLCAzLjcsIDQuMSwgNC42LCA1LjEsIDUuNywgNi4zLCA3LCA3LjcsIDguNSwgOS40LCAxMCxcclxuICAgIF07XHJcbiAgICBjb25zdCB3aGVlbEV2ZW50SGFuZGxlciA9IChldmVudDogV2hlZWxFdmVudCkgPT4ge1xyXG4gICAgICBpZiAoZXZlbnQuY3RybEtleSkge1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgLy8gcmV0cmlldmUgZG9tIHN0YXRlIGJlZm9yZSBhbnkgb3BlcmF0aW9uXHJcbiAgICAgICAgdGhpcy5jYWNoZWRET01TdGF0ZSA9IHRoaXMucmV0cmlldmVET01TdGF0ZSgpO1xyXG4gICAgICAgIGlmICh3aW5kb3cub25yZXNpemUgIT09IG51bGwpIHtcclxuICAgICAgICAgIC8vIGlzIGF1dG8gcmVzaXppbmdcclxuICAgICAgICAgIHdpbmRvdy5vbnJlc2l6ZSA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHByZXZTY2FsZVJhdGlvID0gdGhpcy5jdXJyZW50U2NhbGVSYXRpbztcclxuICAgICAgICAvLyBHZXQgd2hlZWwgc2Nyb2xsIGRpcmVjdGlvbiBhbmQgY2FsY3VsYXRlIG5ldyBzY2FsZVxyXG4gICAgICAgIGlmIChldmVudC5kZWx0YVkgPCAwKSB7XHJcbiAgICAgICAgICAvLyBlbmxhcmdlXHJcbiAgICAgICAgICBpZiAodGhpcy5jdXJyZW50U2NhbGVSYXRpbyA+PSBmYWN0b3JzLmF0KC0xKSEpIHtcclxuICAgICAgICAgICAgLy8gYWxyZWFkeSBsYXJnZSB0aGFuIG1heCBmYWN0b3JcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50U2NhbGVSYXRpbyA9IGZhY3RvcnMuZmlsdGVyKHggPT4geCA+IHRoaXMuY3VycmVudFNjYWxlUmF0aW8pLmF0KDApITtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmRlbHRhWSA+IDApIHtcclxuICAgICAgICAgIC8vIHJlZHVjZVxyXG4gICAgICAgICAgaWYgKHRoaXMuY3VycmVudFNjYWxlUmF0aW8gPD0gZmFjdG9ycy5hdCgwKSEpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50U2NhbGVSYXRpbyA9IGZhY3RvcnMuZmlsdGVyKHggPT4geCA8IHRoaXMuY3VycmVudFNjYWxlUmF0aW8pLmF0KC0xKSE7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIG5vIHktYXhpcyBzY3JvbGxcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsRmFjdG9yID0gdGhpcy5jdXJyZW50U2NhbGVSYXRpbyAvIHByZXZTY2FsZVJhdGlvO1xyXG4gICAgICAgIGNvbnN0IHNjcm9sbFggPSBldmVudC5wYWdlWCAqIChzY3JvbGxGYWN0b3IgLSAxKTtcclxuICAgICAgICBjb25zdCBzY3JvbGxZID0gZXZlbnQucGFnZVkgKiAoc2Nyb2xsRmFjdG9yIC0gMSk7XHJcbiAgICAgICAgLy8gaGlkZSBzY3JvbGxiYXIgaWYgc2NhbGUgPT0gMVxyXG4gICAgICAgIGlmIChNYXRoLmFicyh0aGlzLmN1cnJlbnRTY2FsZVJhdGlvIC0gMSkgPCAxZS01KSB7XHJcbiAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0uY2xhc3NMaXN0LmFkZCgnaGlkZS1zY3JvbGxiYXIteCcpO1xyXG4gICAgICAgICAgdGhpcy5ob29rZWRFbGVtLnBhcmVudEVsZW1lbnQ/LmNsYXNzTGlzdC5hZGQoJ2hpZGUtc2Nyb2xsYmFyLXgnKTtcclxuICAgICAgICAgIGlmICh0aGlzLnByZXZpZXdNb2RlID09PSBQcmV2aWV3TW9kZS5TbGlkZSkge1xyXG4gICAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0uY2xhc3NMaXN0LmFkZCgnaGlkZS1zY3JvbGxiYXIteScpO1xyXG4gICAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0ucGFyZW50RWxlbWVudD8uY2xhc3NMaXN0LmFkZCgnaGlkZS1zY3JvbGxiYXIteScpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0uY2xhc3NMaXN0LnJlbW92ZSgnaGlkZS1zY3JvbGxiYXIteCcpO1xyXG4gICAgICAgICAgdGhpcy5ob29rZWRFbGVtLnBhcmVudEVsZW1lbnQ/LmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGUtc2Nyb2xsYmFyLXgnKTtcclxuICAgICAgICAgIGlmICh0aGlzLnByZXZpZXdNb2RlID09PSBQcmV2aWV3TW9kZS5TbGlkZSkge1xyXG4gICAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0uY2xhc3NMaXN0LnJlbW92ZSgnaGlkZS1zY3JvbGxiYXIteScpO1xyXG4gICAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0ucGFyZW50RWxlbWVudD8uY2xhc3NMaXN0LnJlbW92ZSgnaGlkZS1zY3JvbGxiYXIteScpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyByZXNlcnZlIHNwYWNlIHRvIHNjcm9sbCBkb3duXHJcbiAgICAgICAgY29uc3Qgc3ZnID0gdGhpcy5ob29rZWRFbGVtLmZpcnN0RWxlbWVudENoaWxkISBhcyBTVkdFbGVtZW50O1xyXG4gICAgICAgIGlmIChzdmcpIHtcclxuICAgICAgICAgIGNvbnN0IHNjYWxlUmF0aW8gPSB0aGlzLmdldFN2Z1NjYWxlUmF0aW8oKTtcclxuICAgICAgICAgIGNvbnN0IGRhdGFIZWlnaHQgPSBOdW1iZXIucGFyc2VGbG9hdChzdmcuZ2V0QXR0cmlidXRlKCdkYXRhLWhlaWdodCcpISk7XHJcbiAgICAgICAgICBjb25zdCBzY2FsZWRIZWlnaHQgPSBNYXRoLmNlaWwoZGF0YUhlaWdodCAqIHNjYWxlUmF0aW8pO1xyXG4gICAgICAgICAgLy8gd2UgaW5jcmVhc2UgdGhlIGhlaWdodCBieSAyIHRpbWVzLlxyXG4gICAgICAgICAgLy8gVGhlIGAyYCBpcyBvbmx5IGEgbWFnaWMgbnVtYmVyIHRoYXQgaXMgbGFyZ2UgZW5vdWdoLlxyXG4gICAgICAgICAgdGhpcy5ob29rZWRFbGVtLnN0eWxlLmhlaWdodCA9IGAke3NjYWxlZEhlaWdodCAqIDJ9cHhgO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIGN1cnNvciBpcyBzdGlsbCBvbiB0aGUgc2FtZSBwb3NpdGlvblxyXG4gICAgICAgIHdpbmRvdy5zY3JvbGxCeShzY3JvbGxYLCBzY3JvbGxZKTtcclxuICAgICAgICAvLyB0b2dnbGUgc2NhbGUgY2hhbmdlIGV2ZW50XHJcbiAgICAgICAgdGhpcy5hZGRWaWV3cG9ydENoYW5nZSgpO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBpZiAodGhpcy5yZW5kZXJNb2RlICE9PSAnZG9tJykge1xyXG4gICAgICBjb25zdCB2c2NvZGVBUEkgPSB0eXBlb2YgYWNxdWlyZVZzQ29kZUFwaSAhPT0gJ3VuZGVmaW5lZCc7XHJcbiAgICAgIGlmICh2c2NvZGVBUEkpIHtcclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignd2hlZWwnLCB3aGVlbEV2ZW50SGFuZGxlciwge1xyXG4gICAgICAgICAgcGFzc2l2ZTogZmFsc2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlTGlzdC5wdXNoKCgpID0+IHtcclxuICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd3aGVlbCcsIHdoZWVsRXZlbnRIYW5kbGVyKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ3doZWVsJywgd2hlZWxFdmVudEhhbmRsZXIsIHtcclxuICAgICAgICAgIHBhc3NpdmU6IGZhbHNlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zZUxpc3QucHVzaCgoKSA9PiB7XHJcbiAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3doZWVsJywgd2hlZWxFdmVudEhhbmRsZXIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLy8gR2V0IGN1cnJlbnQgc2NhbGUgZnJvbSBodG1sIHRvIHN2Z1xyXG4gIC8vIE5vdGU6IG9uZSBzaG91bGQgcmV0cmlldmUgZG9tIHN0YXRlIGJlZm9yZSByZXNjYWxlXHJcbiAgZ2V0U3ZnU2NhbGVSYXRpbygpIHtcclxuICAgIGNvbnN0IHN2ZyA9IHRoaXMuaG9va2VkRWxlbS5maXJzdEVsZW1lbnRDaGlsZCBhcyBTVkdFbGVtZW50O1xyXG4gICAgaWYgKCFzdmcpIHtcclxuICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jYWNoZWRET01TdGF0ZTtcclxuXHJcbiAgICBjb25zdCBzdmdXaWR0aCA9IE51bWJlci5wYXJzZUZsb2F0KFxyXG4gICAgICBzdmcuZ2V0QXR0cmlidXRlKCdkYXRhLXdpZHRoJykgfHwgc3ZnLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSB8fCAnMScsXHJcbiAgICApO1xyXG4gICAgY29uc3Qgc3ZnSGVpZ2h0ID0gTnVtYmVyLnBhcnNlRmxvYXQoXHJcbiAgICAgIHN2Zy5nZXRBdHRyaWJ1dGUoJ2RhdGEtaGVpZ2h0JykgfHwgc3ZnLmdldEF0dHJpYnV0ZSgnaGVpZ2h0JykgfHwgJzEnLFxyXG4gICAgKTtcclxuICAgIHRoaXMuY3VycmVudFJlYWxTY2FsZSA9XHJcbiAgICAgIHRoaXMucHJldmlld01vZGUgPT09IFByZXZpZXdNb2RlLlNsaWRlXHJcbiAgICAgICAgPyBNYXRoLm1pbihjb250YWluZXIud2lkdGggLyBzdmdXaWR0aCwgY29udGFpbmVyLmhlaWdodCAvIHN2Z0hlaWdodClcclxuICAgICAgICA6IGNvbnRhaW5lci53aWR0aCAvIHN2Z1dpZHRoO1xyXG5cclxuICAgIHJldHVybiB0aGlzLmN1cnJlbnRSZWFsU2NhbGUgKiB0aGlzLmN1cnJlbnRTY2FsZVJhdGlvO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwcm9jZXNzUXVldWUoc3ZnVXBkYXRlRXZlbnQ6IFtzdHJpbmcsIHN0cmluZ10pOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGV2ZW50TmFtZSA9IHN2Z1VwZGF0ZUV2ZW50WzBdO1xyXG4gICAgc3dpdGNoIChldmVudE5hbWUpIHtcclxuICAgICAgY2FzZSAnbmV3JzpcclxuICAgICAgY2FzZSAnZGlmZi12MSc6IHtcclxuICAgICAgICBpZiAoZXZlbnROYW1lID09PSAnbmV3Jykge1xyXG4gICAgICAgICAgdGhpcy5yZXNldCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmtNb2R1bGUubWFuaXB1bGF0ZURhdGEoe1xyXG4gICAgICAgICAgYWN0aW9uOiAnbWVyZ2UnLFxyXG4gICAgICAgICAgZGF0YTogc3ZnVXBkYXRlRXZlbnRbMV0gYXMgdW5rbm93biBhcyBVaW50OEFycmF5LFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLm1vZHVsZUluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBjYXNlICd2aWV3cG9ydC1jaGFuZ2UnOiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLm1vZHVsZUluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygndmlld3BvcnQtY2hhbmdlIGJlZm9yZSBpbml0aWFsaXphdGlvbicpO1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIGNvbnNvbGUubG9nKCdzdmdVcGRhdGVFdmVudCcsIHN2Z1VwZGF0ZUV2ZW50KTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRyaWdnZXJVcGRhdGUoKSB7XHJcbiAgICBpZiAodGhpcy5pc1JlbmRlcmluZykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5pc1JlbmRlcmluZyA9IHRydWU7XHJcbiAgICBjb25zdCBkb1VwZGF0ZSA9IGFzeW5jICgpID0+IHtcclxuICAgICAgdGhpcy5jYWNoZWRET01TdGF0ZSA9IHRoaXMucmV0cmlldmVET01TdGF0ZSgpO1xyXG5cclxuICAgICAgaWYgKHRoaXMucGF0Y2hRdWV1ZS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICB0aGlzLmlzUmVuZGVyaW5nID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5wb3N0cHJvY2Vzc0NoYW5nZXMoKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgbGV0IHQwID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGN0b2tlbiA9IHRoaXMuY2FudmFzUmVuZGVyQ1Rva2VuO1xyXG4gICAgICAgIGlmIChjdG9rZW4pIHtcclxuICAgICAgICAgIGF3YWl0IGN0b2tlbi5jYW5jZWwoKTtcclxuICAgICAgICAgIGF3YWl0IGN0b2tlbi53YWl0KCk7XHJcbiAgICAgICAgICB0aGlzLmNhbnZhc1JlbmRlckNUb2tlbiA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdjYW5jZWwgY2FudmFzIHJlbmRlcmluZycpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IG5lZWRSZXJlbmRlciA9IGZhbHNlO1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdwYXRjaFF1ZXVlJywgSlNPTi5zdHJpbmdpZnkodGhpcy5wYXRjaFF1ZXVlLm1hcCh4ID0+IHhbMF0pKSk7XHJcbiAgICAgICAgd2hpbGUgKHRoaXMucGF0Y2hRdWV1ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBuZWVkUmVyZW5kZXIgPSB0aGlzLnByb2Nlc3NRdWV1ZSh0aGlzLnBhdGNoUXVldWUuc2hpZnQoKSEpIHx8IG5lZWRSZXJlbmRlcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHRvZG86IHRyaWdnZXIgdmlld3BvcnQgY2hhbmdlIG9uY2VcclxuICAgICAgICBsZXQgdDEgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuICAgICAgICBpZiAobmVlZFJlcmVuZGVyKSB7XHJcbiAgICAgICAgICB0aGlzLnIucmVzY2FsZSgpO1xyXG4gICAgICAgICAgYXdhaXQgdGhpcy5yLnJlcmVuZGVyKCk7XHJcbiAgICAgICAgICB0aGlzLnIucmVzY2FsZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgdDIgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuXHJcbiAgICAgICAgLy8vIHBlcmYgZXZlbnRcclxuICAgICAgICBjb25zdCBkID0gKGU6IHN0cmluZywgeDogbnVtYmVyLCB5OiBudW1iZXIpID0+IGAke2V9ICR7KHkgLSB4KS50b0ZpeGVkKDIpfSBtc2A7XHJcbiAgICAgICAgdGhpcy5zYW1wbGVkUmVuZGVyVGltZSA9IHQyIC0gdDA7XHJcbiAgICAgICAgY29uc29sZS5sb2coW2QoJ3BhcnNlJywgdDAsIHQxKSwgZCgncmVyZW5kZXInLCB0MSwgdDIpLCBkKCd0b3RhbCcsIHQwLCB0MildLmpvaW4oJywgJykpO1xyXG5cclxuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZG9VcGRhdGUpO1xyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICB0aGlzLmlzUmVuZGVyaW5nID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5wb3N0cHJvY2Vzc0NoYW5nZXMoKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShkb1VwZGF0ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBvc3Rwcm9jZXNzQ2hhbmdlcygpIHtcclxuICAgIHRoaXMuci5wb3N0UmVuZGVyKCk7XHJcblxyXG4gICAgLy8gdG9kbzogYWJzdHJhY3QgdGhpc1xyXG4gICAgaWYgKHRoaXMucHJldmlld01vZGUgPT09IFByZXZpZXdNb2RlLlNsaWRlKSB7XHJcbiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy50eXBzdC1wYWdlLW51bWJlci1pbmRpY2F0b3InKS5mb3JFYWNoKHggPT4ge1xyXG4gICAgICAgIHgudGV4dENvbnRlbnQgPSBgJHt0aGlzLmtNb2R1bGUucmV0cmlldmVQYWdlc0luZm8oKS5sZW5ndGh9YDtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhZGRDaGFuZ2VtZW50KGNoYW5nZTogW3N0cmluZywgc3RyaW5nXSkge1xyXG4gICAgaWYgKGNoYW5nZVswXSA9PT0gJ25ldycpIHtcclxuICAgICAgdGhpcy5wYXRjaFF1ZXVlLnNwbGljZSgwLCB0aGlzLnBhdGNoUXVldWUubGVuZ3RoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwdXNoQ2hhbmdlID0gKCkgPT4ge1xyXG4gICAgICB0aGlzLnZwVGltZW91dCA9IHVuZGVmaW5lZDtcclxuICAgICAgdGhpcy5wYXRjaFF1ZXVlLnB1c2goY2hhbmdlKTtcclxuICAgICAgdGhpcy50cmlnZ2VyVXBkYXRlKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGlmICh0aGlzLnZwVGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnZwVGltZW91dCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNoYW5nZVswXSA9PT0gJ3ZpZXdwb3J0LWNoYW5nZScgJiYgdGhpcy5pc1JlbmRlcmluZykge1xyXG4gICAgICAvLyBkZWxheSB2aWV3cG9ydCBjaGFuZ2UgYSBiaXRcclxuICAgICAgdGhpcy52cFRpbWVvdXQgPSBzZXRUaW1lb3V0KHB1c2hDaGFuZ2UsIHRoaXMuc2FtcGxlZFJlbmRlclRpbWUgfHwgMTAwKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHB1c2hDaGFuZ2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFkZFZpZXdwb3J0Q2hhbmdlKCkge1xyXG4gICAgdGhpcy5hZGRDaGFuZ2VtZW50KFsndmlld3BvcnQtY2hhbmdlJywgJyddKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVHlwc3REb2N1bWVudDxUPiB7XHJcbiAgaW1wbDogVDtcclxuICBrTW9kdWxlOiBSZW5kZXJTZXNzaW9uO1xyXG4gIGRpc3Bvc2UoKTogdm9pZDtcclxuICByZXNldCgpOiB2b2lkO1xyXG4gIGFkZENoYW5nZW1lbnQoY2hhbmdlOiBbc3RyaW5nLCBzdHJpbmddKTogdm9pZDtcclxuICBhZGRWaWV3cG9ydENoYW5nZSgpOiB2b2lkO1xyXG4gIHNldFBhZ2VDb2xvcihjb2xvcjogc3RyaW5nKTogdm9pZDtcclxuICBzZXRQYXJ0aWFsUmVuZGVyaW5nKHBhcnRpYWxSZW5kZXJpbmc6IGJvb2xlYW4pOiB2b2lkO1xyXG4gIHNldEN1cnNvcihwYWdlOiBudW1iZXIsIHg6IG51bWJlciwgeTogbnVtYmVyKTogdm9pZDtcclxuICBzZXRQYXJ0aWFsUGFnZU51bWJlcihwYWdlOiBudW1iZXIpOiBib29sZWFuO1xyXG4gIGdldFBhcnRpYWxQYWdlTnVtYmVyKCk6IG51bWJlcjtcclxuICBzZXRPdXRpbmVEYXRhKG91dGxpbmU6IGFueSk6IHZvaWQ7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlRG9jPFQgZXh0ZW5kcyBUeXBzdERvY3VtZW50Q29udGV4dD4oXHJcbiAgQmFzZTogR0NvbnN0cnVjdG9yPFQ+LFxyXG4pOiBuZXcgKG9wdGlvbnM6IE9wdGlvbnMgJiBUWydvcHRzJ10pID0+IFR5cHN0RG9jdW1lbnQ8VD4ge1xyXG4gIHJldHVybiBjbGFzcyBUeXBzdERvY3VtZW50IHtcclxuICAgIHB1YmxpYyBpbXBsOiBUO1xyXG4gICAgcHVibGljIGtNb2R1bGU6IFJlbmRlclNlc3Npb247XHJcblxyXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogT3B0aW9ucykge1xyXG4gICAgICBpZiAob3B0aW9ucy5pc0NvbnRlbnRQcmV2aWV3KSB7XHJcbiAgICAgICAgb3B0aW9ucy5yZW5kZXJNb2RlID0gJ2NhbnZhcyc7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMua01vZHVsZSA9IG9wdGlvbnMua01vZHVsZTtcclxuICAgICAgdGhpcy5pbXBsID0gbmV3IEJhc2Uob3B0aW9ucyk7XHJcbiAgICAgIGlmICghdGhpcy5pbXBsLnIpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG1vZGUgaXMgbm90IHN1cHBvcnRlZCwgJHtvcHRpb25zPy5yZW5kZXJNb2RlfWApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAob3B0aW9ucy5pc0NvbnRlbnRQcmV2aWV3KSB7XHJcbiAgICAgICAgLy8gY29udGVudCBwcmV2aWV3IGhhcyB2ZXJ5IGJhZCBwZXJmb3JtYW5jZSB3aXRob3V0IHBhcnRpYWwgcmVuZGVyaW5nXHJcbiAgICAgICAgdGhpcy5pbXBsLnBhcnRpYWxSZW5kZXJpbmcgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMuaW1wbC5waXhlbFBlclB0ID0gMTtcclxuICAgICAgICB0aGlzLmltcGwuaXNNaXhpbk91dGxpbmUgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGlzcG9zZSgpIHtcclxuICAgICAgdGhpcy5pbXBsLmRpc3Bvc2UoKTtcclxuICAgIH1cclxuXHJcbiAgICByZXNldCgpIHtcclxuICAgICAgdGhpcy5pbXBsLnJlc2V0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkQ2hhbmdlbWVudChjaGFuZ2U6IFtzdHJpbmcsIHN0cmluZ10pIHtcclxuICAgICAgdGhpcy5pbXBsLmFkZENoYW5nZW1lbnQoY2hhbmdlKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRWaWV3cG9ydENoYW5nZSgpIHtcclxuICAgICAgdGhpcy5pbXBsLmFkZFZpZXdwb3J0Q2hhbmdlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0UGFnZUNvbG9yKGNvbG9yOiBzdHJpbmcpIHtcclxuICAgICAgdGhpcy5pbXBsLnBhZ2VDb2xvciA9IGNvbG9yO1xyXG4gICAgICB0aGlzLmFkZFZpZXdwb3J0Q2hhbmdlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0UGFydGlhbFJlbmRlcmluZyhwYXJ0aWFsUmVuZGVyaW5nOiBib29sZWFuKSB7XHJcbiAgICAgIHRoaXMuaW1wbC5wYXJ0aWFsUmVuZGVyaW5nID0gcGFydGlhbFJlbmRlcmluZztcclxuICAgIH1cclxuXHJcbiAgICBzZXRDdXJzb3IocGFnZTogbnVtYmVyLCB4OiBudW1iZXIsIHk6IG51bWJlcikge1xyXG4gICAgICB0aGlzLmltcGwuY3Vyc29yUG9zaXRpb24gPSBbcGFnZSwgeCwgeV07XHJcbiAgICB9XHJcblxyXG4gICAgc2V0UGFydGlhbFBhZ2VOdW1iZXIocGFnZTogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICAgIGlmIChwYWdlIDw9IDAgfHwgcGFnZSA+IHRoaXMua01vZHVsZS5yZXRyaWV2ZVBhZ2VzSW5mbygpLmxlbmd0aCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmltcGwucGFydGlhbFJlbmRlclBhZ2UgPSBwYWdlIC0gMTtcclxuICAgICAgdGhpcy5hZGRWaWV3cG9ydENoYW5nZSgpO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQYXJ0aWFsUGFnZU51bWJlcigpOiBudW1iZXIge1xyXG4gICAgICByZXR1cm4gdGhpcy5pbXBsLnBhcnRpYWxSZW5kZXJQYWdlICsgMTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRPdXRpbmVEYXRhKG91dGxpbmU6IGFueSkge1xyXG4gICAgICB0aGlzLmltcGwub3V0bGluZSA9IG91dGxpbmU7XHJcbiAgICAgIHRoaXMuYWRkVmlld3BvcnRDaGFuZ2UoKTtcclxuICAgIH1cclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjE+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4pOiBUQmFzZSAmIEYxO1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjEsIEYyPihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuICBmMjogKGJhc2U6IEYxKSA9PiBGMixcclxuKTogVEJhc2UgJiBGMSAmIEYyO1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjEsIEYyLCBGMz4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbiAgZjI6IChiYXNlOiBGMSkgPT4gRjIsXHJcbiAgZjM6IChiYXNlOiBGMikgPT4gRjMsXHJcbik6IFRCYXNlICYgRjEgJiBGMiAmIEYzO1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjEsIEYyLCBGMywgRjQ+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4gIGYyOiAoYmFzZTogRjEpID0+IEYyLFxyXG4gIGYzOiAoYmFzZTogRjIpID0+IEYzLFxyXG4gIGY0OiAoYmFzZTogRjMpID0+IEY0LFxyXG4pOiBUQmFzZSAmIEYxICYgRjIgJiBGMyAmIEY0O1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjEsIEYyLCBGMywgRjQsIEY1PihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuICBmMjogKGJhc2U6IEYxKSA9PiBGMixcclxuICBmMzogKGJhc2U6IEYyKSA9PiBGMyxcclxuICBmNDogKGJhc2U6IEYzKSA9PiBGNCxcclxuICBmNTogKGJhc2U6IEY0KSA9PiBGNSxcclxuKTogVEJhc2UgJiBGMSAmIEYyICYgRjMgJiBGNCAmIEY1O1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjEsIEYyLCBGMywgRjQsIEY1LCBGNj4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbiAgZjI6IChiYXNlOiBGMSkgPT4gRjIsXHJcbiAgZjM6IChiYXNlOiBGMikgPT4gRjMsXHJcbiAgZjQ6IChiYXNlOiBGMykgPT4gRjQsXHJcbiAgZjU6IChiYXNlOiBGNCkgPT4gRjUsXHJcbiAgZjY6IChiYXNlOiBGNSkgPT4gRjYsXHJcbik6IFRCYXNlICYgRjEgJiBGMiAmIEYzICYgRjQgJiBGNSAmIEY2O1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjEsIEYyLCBGMywgRjQsIEY1LCBGNiwgRjc+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4gIGYyOiAoYmFzZTogRjEpID0+IEYyLFxyXG4gIGYzOiAoYmFzZTogRjIpID0+IEYzLFxyXG4gIGY0OiAoYmFzZTogRjMpID0+IEY0LFxyXG4gIGY1OiAoYmFzZTogRjQpID0+IEY1LFxyXG4gIGY2OiAoYmFzZTogRjUpID0+IEY2LFxyXG4gIGY3OiAoYmFzZTogRjYpID0+IEY3LFxyXG4pOiBUQmFzZSAmIEYxICYgRjIgJiBGMyAmIEY0ICYgRjUgJiBGNiAmIEY3O1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjEsIEYyLCBGMywgRjQsIEY1LCBGNiwgRjcsIEY4PihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuICBmMjogKGJhc2U6IEYxKSA9PiBGMixcclxuICBmMzogKGJhc2U6IEYyKSA9PiBGMyxcclxuICBmNDogKGJhc2U6IEYzKSA9PiBGNCxcclxuICBmNTogKGJhc2U6IEY0KSA9PiBGNSxcclxuICBmNjogKGJhc2U6IEY1KSA9PiBGNixcclxuICBmNzogKGJhc2U6IEY2KSA9PiBGNyxcclxuICBmODogKGJhc2U6IEY3KSA9PiBGOCxcclxuKTogVEJhc2UgJiBGMSAmIEYyICYgRjMgJiBGNCAmIEY1ICYgRjYgJiBGNyAmIEY4O1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3RvciwgRjEsIEYyLCBGMywgRjQsIEY1LCBGNiwgRjcsIEY4LCBGOT4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbiAgZjI6IChiYXNlOiBGMSkgPT4gRjIsXHJcbiAgZjM6IChiYXNlOiBGMikgPT4gRjMsXHJcbiAgZjQ6IChiYXNlOiBGMykgPT4gRjQsXHJcbiAgZjU6IChiYXNlOiBGNCkgPT4gRjUsXHJcbiAgZjY6IChiYXNlOiBGNSkgPT4gRjYsXHJcbiAgZjc6IChiYXNlOiBGNikgPT4gRjcsXHJcbiAgZjg6IChiYXNlOiBGNykgPT4gRjgsXHJcbiAgZjk6IChiYXNlOiBGOCkgPT4gRjksXHJcbik6IFRCYXNlICYgRjEgJiBGMiAmIEYzICYgRjQgJiBGNSAmIEY2ICYgRjcgJiBGOCAmIEY5O1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcG9zZURvYzxUQmFzZSBleHRlbmRzIEdDb25zdHJ1Y3Rvcj4oQmFzZTogVEJhc2UsIC4uLm1peGluczogYW55W10pOiBUQmFzZSB7XHJcbiAgcmV0dXJuIG1peGlucy5yZWR1Y2UoKGFjYywgbWl4aW4pID0+IG1peGluKGFjYyksIEJhc2UpO1xyXG59XHJcbiJdfQ==