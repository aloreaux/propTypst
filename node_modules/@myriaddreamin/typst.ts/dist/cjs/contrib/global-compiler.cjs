"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.withGlobalCompiler = exports.createGlobalCompiler = exports.getGlobalCompiler = void 0;
let globalCompiler = undefined;
let globalCompilerInitReady;
let isReady = false;
function getGlobalCompiler() {
    return isReady ? globalCompiler : undefined;
}
exports.getGlobalCompiler = getGlobalCompiler;
function createGlobalCompiler(creator, initOptions) {
    // todo: determine compiler thread-safety
    // todo: check inconsistent initOptions
    const compiler = globalCompiler || creator();
    if (globalCompilerInitReady !== undefined) {
        return globalCompilerInitReady;
    }
    return (globalCompilerInitReady = (async () => {
        isReady = true;
        await compiler.init(initOptions);
        return (globalCompiler = compiler);
    })());
}
exports.createGlobalCompiler = createGlobalCompiler;
function withGlobalCompiler(creator, initOptions, resolve, reject) {
    const compiler = getGlobalCompiler();
    if (compiler) {
        resolve(compiler);
        return;
    }
    createGlobalCompiler(creator, initOptions).then(resolve).catch(reject);
}
exports.withGlobalCompiler = withGlobalCompiler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2xvYmFsLWNvbXBpbGVyLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb250cmliL2dsb2JhbC1jb21waWxlci5tdHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBR0EsSUFBSSxjQUFjLEdBQThCLFNBQVMsQ0FBQztBQUMxRCxJQUFJLHVCQUErQyxDQUFDO0FBQ3BELElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztBQUVwQixTQUFnQixpQkFBaUI7SUFDL0IsT0FBTyxPQUFPLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0FBQzlDLENBQUM7QUFGRCw4Q0FFQztBQUVELFNBQWdCLG9CQUFvQixDQUNsQyxPQUE0QixFQUM1QixXQUFrQztJQUVsQyx5Q0FBeUM7SUFDekMsdUNBQXVDO0lBQ3ZDLE1BQU0sUUFBUSxHQUFHLGNBQWMsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUU3QyxJQUFJLHVCQUF1QixLQUFLLFNBQVMsRUFBRTtRQUN6QyxPQUFPLHVCQUF1QixDQUFDO0tBQ2hDO0lBRUQsT0FBTyxDQUFDLHVCQUF1QixHQUFHLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDNUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUNmLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqQyxPQUFPLENBQUMsY0FBYyxHQUFHLFFBQVEsQ0FBQyxDQUFDO0lBQ3JDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNSLENBQUM7QUFqQkQsb0RBaUJDO0FBRUQsU0FBZ0Isa0JBQWtCLENBQ2hDLE9BQTRCLEVBQzVCLFdBQTZDLEVBQzdDLE9BQTBDLEVBQzFDLE1BQTJCO0lBRTNCLE1BQU0sUUFBUSxHQUFHLGlCQUFpQixFQUFFLENBQUM7SUFDckMsSUFBSSxRQUFRLEVBQUU7UUFDWixPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbEIsT0FBTztLQUNSO0lBRUQsb0JBQW9CLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDekUsQ0FBQztBQWJELGdEQWFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBJbml0T3B0aW9ucyB9IGZyb20gJy4uL29wdGlvbnMuaW5pdC5tanMnO1xyXG5pbXBvcnQgdHlwZSB7IFR5cHN0Q29tcGlsZXIgfSBmcm9tICcuLi9jb21waWxlci5tanMnO1xyXG5cclxubGV0IGdsb2JhbENvbXBpbGVyOiBUeXBzdENvbXBpbGVyIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xyXG5sZXQgZ2xvYmFsQ29tcGlsZXJJbml0UmVhZHk6IFByb21pc2U8VHlwc3RDb21waWxlcj47XHJcbmxldCBpc1JlYWR5ID0gZmFsc2U7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0R2xvYmFsQ29tcGlsZXIoKTogVHlwc3RDb21waWxlciB8IHVuZGVmaW5lZCB7XHJcbiAgcmV0dXJuIGlzUmVhZHkgPyBnbG9iYWxDb21waWxlciA6IHVuZGVmaW5lZDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUdsb2JhbENvbXBpbGVyKFxyXG4gIGNyZWF0b3I6ICgpID0+IFR5cHN0Q29tcGlsZXIsXHJcbiAgaW5pdE9wdGlvbnM/OiBQYXJ0aWFsPEluaXRPcHRpb25zPixcclxuKTogUHJvbWlzZTxUeXBzdENvbXBpbGVyPiB7XHJcbiAgLy8gdG9kbzogZGV0ZXJtaW5lIGNvbXBpbGVyIHRocmVhZC1zYWZldHlcclxuICAvLyB0b2RvOiBjaGVjayBpbmNvbnNpc3RlbnQgaW5pdE9wdGlvbnNcclxuICBjb25zdCBjb21waWxlciA9IGdsb2JhbENvbXBpbGVyIHx8IGNyZWF0b3IoKTtcclxuXHJcbiAgaWYgKGdsb2JhbENvbXBpbGVySW5pdFJlYWR5ICE9PSB1bmRlZmluZWQpIHtcclxuICAgIHJldHVybiBnbG9iYWxDb21waWxlckluaXRSZWFkeTtcclxuICB9XHJcblxyXG4gIHJldHVybiAoZ2xvYmFsQ29tcGlsZXJJbml0UmVhZHkgPSAoYXN5bmMgKCkgPT4ge1xyXG4gICAgaXNSZWFkeSA9IHRydWU7XHJcbiAgICBhd2FpdCBjb21waWxlci5pbml0KGluaXRPcHRpb25zKTtcclxuICAgIHJldHVybiAoZ2xvYmFsQ29tcGlsZXIgPSBjb21waWxlcik7XHJcbiAgfSkoKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB3aXRoR2xvYmFsQ29tcGlsZXIoXHJcbiAgY3JlYXRvcjogKCkgPT4gVHlwc3RDb21waWxlcixcclxuICBpbml0T3B0aW9uczogUGFydGlhbDxJbml0T3B0aW9ucz4gfCB1bmRlZmluZWQsXHJcbiAgcmVzb2x2ZTogKGNvbXBpbGVyOiBUeXBzdENvbXBpbGVyKSA9PiB2b2lkLFxyXG4gIHJlamVjdD86IChlcnI6IGFueSkgPT4gdm9pZCxcclxuKSB7XHJcbiAgY29uc3QgY29tcGlsZXIgPSBnZXRHbG9iYWxDb21waWxlcigpO1xyXG4gIGlmIChjb21waWxlcikge1xyXG4gICAgcmVzb2x2ZShjb21waWxlcik7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBjcmVhdGVHbG9iYWxDb21waWxlcihjcmVhdG9yLCBpbml0T3B0aW9ucykudGhlbihyZXNvbHZlKS5jYXRjaChyZWplY3QpO1xyXG59XHJcbiJdfQ==