"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TypstDocument = void 0;
const patch_mjs_1 = require("./render/svg/patch.cjs");
class TypstDocument {
    props;
    session;
    sessionReady;
    disposeSession;
    constructor(props) {
        this.props = props;
        this.init();
    }
    static layoutPagesFullMode(doc) {
        return Promise.resolve(doc.session.retrievePagesInfo().map(() => {
            return {};
        }));
    }
    // copy from typst-preview
    static layoutSvgPagesPartialMode(doc, before) {
        const docRect = doc.shadowRoot.getBoundingClientRect(); // this.cachedBoundingRect;
        // https://measurethat.net/Benchmarks/Show/5392/0/clientwidth-vs-offsetwidth-vs-windowgetcomputedstyle
        // todo: this is only a PoC
        const cachedOffsetWidth = 'offsetWidth' in doc.shadowRoot
            ? doc.shadowRoot.offsetWidth
            : Number.parseInt(window.getComputedStyle(doc.shadowRoot).width.replace('px', ''));
        const currentScaleRatio = 1; // this.currentScaleRatio;
        // scale derived from svg width and container with.
        const computedRevScale = cachedOffsetWidth ? doc.session.docWidth / cachedOffsetWidth : 1;
        // respect current scale ratio
        const revScale = computedRevScale / currentScaleRatio;
        const left = (window.screenLeft - docRect.left) * revScale;
        const top = (window.screenTop - docRect.top) * revScale;
        const width = window.innerWidth * revScale;
        const height = window.innerHeight * revScale;
        void before;
        const patchStr = doc.session.renderSvgDiff({
            window: {
                lo: {
                    x: left,
                    y: top,
                },
                hi: {
                    x: left + width,
                    y: top + height,
                },
            },
        });
        // todo: ideally, we should patch per page separately
        // todo: then, we can call the api doc.renderPieces(pages + windows).
        if (doc.shadowRoot.firstElementChild) {
            const elem = document.createElement('div');
            elem.innerHTML = patchStr;
            const svgElement = elem.firstElementChild;
            (0, patch_mjs_1.patchRoot)(doc.shadowRoot.firstElementChild, svgElement);
        }
        else {
            doc.shadowRoot.innerHTML = patchStr;
        }
        return Promise.resolve([]);
    }
    // copy from typst-preview
    // todo: generalize patchRoot here
    static layoutSvgPages(options) {
        return (doc, before) => {
            // todo
            return TypstDocument.layoutSvgPagesPartialMode(doc, before);
        };
    }
    addChangements(change) {
        throw new Error('Method not implemented.');
    }
    renderPieces(pieces) {
        throw new Error('Method not implemented.');
    }
    onSessionReady() {
        return this.sessionReady;
    }
    dispose() {
        if (this.disposeSession !== undefined) {
            this.disposeSession();
        }
    }
    init() {
        if (this.sessionReady !== undefined) {
            throw new Error('Already initialized');
        }
        if (this.props.session !== undefined) {
            this.session = this.props.session;
            return (this.sessionReady = Promise.resolve(this.session));
        }
        return (this.sessionReady = new Promise(resolve => {
            this.props.plugin.runWithSession(session => {
                return new Promise(dispose => {
                    this.session = session;
                    this.disposeSession = dispose;
                    resolve(session);
                });
            });
        }));
    }
}
exports.TypstDocument = TypstDocument;
//   private collectDocProperties(): DocProperties {
//     return {
//       [kRects]: undefined,
//     };
//   }
//   async mutate(
//     cb: (ctx: PageMutationContext) => Promise<void>,
//     // options?: {
//     //   prefetchedDocProperties?: DocProperties;
//     // },
//   ): Promise<void> {
//     await this.sessionReady;
//     // const docProperties = options?.prefetchedDocProperties ?? this.collectDocProperties();
//     const ctx = new PageMutationContextImpl(this.props, docProperties);
//     await cb(ctx);
//     return ctx[kDispose]();
//   }
// import { ManipulateDataOptions } from '../../options.render';
// export interface PageMutationInst<K> {
//   /**
//    * The kind of mutation.
//    * @property {string} kind - The kind of mutation.
//    */
//   kind: K;
//   /**
//    * After/At which element the mutation happens.
//    */
//   sentinel?: Element;
// }
// export type PageMutation = PageMutationInst<'create' | 'delete' | 'change'>;
// const kRects = Symbol('rects');
// class PageMutationContextImpl implements PageMutationContext {
//   mutations: PageMutation[] = [];
//   constructor(
//     private props: TypstDocumentProps,
//     private docProperties: DocProperties,
//   ) {}
//   manipulateData(opts: ManipulateDataOptions) {
//     throw new Error('Method not implemented.');
//   }
//   //   mutateSeq(mutation: PageMutation[]): Promise<Element[]> {
//   //     return Promise.all(mutation.map(this.mutateOne));
//   //   }
//   //   mutateOne(mutation: PageMutation): Promise<Element> {
//   //     throw new Error('Method not implemented. ' + JSON.stringify(mutation));
//   //   }
//   [kDispose](): void {}
// }
// export interface DocProperties {
//   [kRects]: unknown;
// }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kb2MubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLHNEQUFtRDtBQStFbkQsTUFBYSxhQUFhO0lBS0o7SUFKcEIsT0FBTyxDQUFnQjtJQUNmLFlBQVksQ0FBeUI7SUFDckMsY0FBYyxDQUEwQjtJQUVoRCxZQUFvQixLQUF3QztRQUF4QyxVQUFLLEdBQUwsS0FBSyxDQUFtQztRQUMxRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxDQUFDLG1CQUFtQixDQUFDLEdBQWtCO1FBQzNDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FDcEIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7WUFDdkMsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVELDBCQUEwQjtJQUMxQixNQUFNLENBQUMseUJBQXlCLENBQUMsR0FBa0IsRUFBRSxNQUFnQjtRQUNuRSxNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLHFCQUFxQixFQUFFLENBQUMsQ0FBQywyQkFBMkI7UUFDbkYsc0dBQXNHO1FBQ3RHLDJCQUEyQjtRQUMzQixNQUFNLGlCQUFpQixHQUNyQixhQUFhLElBQUssR0FBRyxDQUFDLFVBQTBCO1lBQzlDLENBQUMsQ0FBRSxHQUFHLENBQUMsVUFBMEIsQ0FBQyxXQUFXO1lBQzdDLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN2RixNQUFNLGlCQUFpQixHQUFHLENBQUMsQ0FBQyxDQUFDLDBCQUEwQjtRQUN2RCxtREFBbUQ7UUFDbkQsTUFBTSxn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QU07QUFFTixtRUFBbUU7QUFDbkUsNkRBQTZEO0FBQzdELFdBQVc7QUFFWCwrREFBK0Q7QUFDL0QsbUZBQW1GO0FBQ25GLFdBQVc7QUFFWCwwQkFBMEI7QUFDMUIsSUFBSTtBQUVKLG1DQUFtQztBQUNuQyx1QkFBdUI7QUFDdkIsSUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhZ2VJbmZvLCBSZWN0LCBUcmFuc2Zvcm1NYXRyaXggfSBmcm9tICcuL2ludGVybmFsLnR5cGVzLm1qcyc7XHJcbmltcG9ydCB7IFJlbmRlck9wdGlvbnMgfSBmcm9tICcuL29wdGlvbnMucmVuZGVyLm1qcyc7XHJcbmltcG9ydCB7IHBhdGNoUm9vdCB9IGZyb20gJy4vcmVuZGVyL3N2Zy9wYXRjaC5tanMnO1xyXG5pbXBvcnQgeyBSZW5kZXJTZXNzaW9uLCBUeXBzdFJlbmRlcmVyIH0gZnJvbSAnLi9yZW5kZXJlci5tanMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBMYXlvdXRDb250ZXh0IHt9XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBhZ2VWaWV3IHtcclxuICBwYWdlczogUGFnZUluZm9bXTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSZW5kZXJQaWVjZSB7XHJcbiAgcGFnZU9mZnNldD86IG51bWJlcjtcclxuICBpbnZpc2libGU/OiBib29sZWFuO1xyXG4gIGF0PzogRWxlbWVudDtcclxuICB3aW5kb3c/OiBSZWN0O1xyXG4gIHRzPzogVHJhbnNmb3JtTWF0cml4O1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFR5cHN0RG9jdW1lbnRQcm9wcyB7XHJcbiAgcGx1Z2luOiBUeXBzdFJlbmRlcmVyO1xyXG4gIHNoYWRvd1Jvb3Q6IEVsZW1lbnQ7XHJcbiAgLy8gZGVmYXVsdDogc3ZnXHJcbiAgcmVuZGVyTW9kZT86ICdzdmcnIHwgJ3N2Zy1ncm91cCcgfCAnY2FudmFzJztcclxuXHJcbiAgc2Vzc2lvbj86IFJlbmRlclNlc3Npb247XHJcblxyXG4gIGxheW91dFBhZ2VzPyhkb2M6IFR5cHN0RG9jdW1lbnQsIGJlZm9yZTogUGFnZVZpZXcpOiBQcm9taXNlPFJlbmRlclBpZWNlW10+O1xyXG59XHJcblxyXG4vKipcclxuICogVGhlIG9wdGlvbnMgZm9yIG1hbmlwdWxhdGluZyB0aGUgVHlwc3QgZG9jdW1lbnQgaW4gdGhlIHNlc3Npb24uXHJcbiAqL1xyXG5pbnRlcmZhY2UgRG9jdW1lbnREYXRhQ2hhbmdlbWVudCB7XHJcbiAgLyoqXHJcbiAgICogVGhlIGFjdGlvbiB0byBtYW5pcHVsYXRlIHRoZSBkYXRhLlxyXG4gICAqIEBkZXNjcmlwdGlvbiBgcmVzZXQtZG9jYDogcmVzZXQgdGhlIGRhdGEgdG8gdGhlIGluaXRpYWwgc3RhdGUuXHJcbiAgICogQGRlc2NyaXB0aW9uIGBtZXJnZS1kb2NgOiBtZXJnZSB0aGUgZGF0YSB0byB0aGUgY3VycmVudCBzdGF0ZS5cclxuICAgKi9cclxuICBhY3Rpb246ICdyZXNldC1kb2MnIHwgJ21lcmdlLWRvYyc7XHJcbiAgLyoqXHJcbiAgICogT3BhcXVlIGRhdGEgdG8gbWFuaXB1bGF0ZSB0aGUgVHlwc3QgZG9jdW1lbnQgZnJvbSBzZXJ2ZXIuXHJcbiAgICovXHJcbiAgZGF0YTogVWludDhBcnJheTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFRoZSBvcHRpb25zIGZvciBtYW5pcHVsYXRpbmcgdGhlIFR5cHN0IGRvY3VtZW50IGluIHRoZSBzZXNzaW9uLlxyXG4gKi9cclxuaW50ZXJmYWNlIERvY3VtZW50Vmlld3BvcnRDaGFuZ2VtZW50IHtcclxuICAvKipcclxuICAgKiBDaGFuZ2UgdGhlIHZpZXdwb3J0IG9mIHRoZSBUeXBzdCBkb2N1bWVudC5cclxuICAgKi9cclxuICBhY3Rpb246ICd2aWV3cG9ydC1jaGFuZ2UnO1xyXG59XHJcblxyXG4vKipcclxuICogVGhlIG9wdGlvbnMgZm9yIG1hbmlwdWxhdGluZyB0aGUgVHlwc3QgZG9jdW1lbnQgaW4gdGhlIHNlc3Npb24uXHJcbiAqL1xyXG5leHBvcnQgdHlwZSBEb2N1bWVudENoYW5nZW1lbnQgPSBEb2N1bWVudERhdGFDaGFuZ2VtZW50IHwgRG9jdW1lbnRWaWV3cG9ydENoYW5nZW1lbnQ7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIExheW91dFN2Z1BhZ2VPcHRpb25zIHtcclxuICAvLy8gd3JhcCBpbiBzdmctZ3JvdXAgbW9kZVxyXG4gIHdyYXBHPyhnOiBbUmVjdCwgU1ZHR0VsZW1lbnRdKTogW1JlY3QsIFNWR0dFbGVtZW50XTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBUeXBzdERvY3VtZW50IHtcclxuICBzaGFkb3dSb290OiBFbGVtZW50O1xyXG4gIHNlc3Npb246IFJlbmRlclNlc3Npb247XHJcbiAgb25TZXNzaW9uUmVhZHkoKTogUHJvbWlzZTxSZW5kZXJTZXNzaW9uPjtcclxuXHJcbiAgY2hhbmdlTGF5b3V0KGxheW91dFNlbGVjdG9yOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogdm9pZDtcclxuXHJcbiAgYWRkQ2hhbmdlbWVudHMoY2hhbmdlOiBEb2N1bWVudENoYW5nZW1lbnRbXSk6IHZvaWQ7XHJcbiAgYWRkVmlld3BvcnRDaGFuZ2UoKTogdm9pZDtcclxuXHJcbiAgcmVuZGVyUGllY2VzKHBpZWNlczogUmVuZGVyUGllY2VbXSk6IFByb21pc2U8dm9pZD47XHJcblxyXG4gIGRpc3Bvc2UoKTogdm9pZDtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFR5cHN0RG9jdW1lbnQgaW1wbGVtZW50cyBUeXBzdERvY3VtZW50IHtcclxuICBzZXNzaW9uOiBSZW5kZXJTZXNzaW9uO1xyXG4gIHByaXZhdGUgc2Vzc2lvblJlYWR5OiBQcm9taXNlPFJlbmRlclNlc3Npb24+O1xyXG4gIHByaXZhdGUgZGlzcG9zZVNlc3Npb246ICguLi5hcmdzOiBhbnlbXSkgPT4gYW55O1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHByb3BzOiBSZW5kZXJPcHRpb25zPFR5cHN0RG9jdW1lbnRQcm9wcz4pIHtcclxuICAgIHRoaXMuaW5pdCgpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGxheW91dFBhZ2VzRnVsbE1vZGUoZG9jOiBUeXBzdERvY3VtZW50KTogUHJvbWlzZTxSZW5kZXJQaWVjZVtdPiB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFxyXG4gICAgICBkb2Muc2Vzc2lvbi5yZXRyaWV2ZVBhZ2VzSW5mbygpLm1hcCgoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHt9O1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyBjb3B5IGZyb20gdHlwc3QtcHJldmlld1xyXG4gIHN0YXRpYyBsYXlvdXRTdmdQYWdlc1BhcnRpYWxNb2RlKGRvYzogVHlwc3REb2N1bWVudCwgYmVmb3JlOiBQYWdlVmlldyk6IFByb21pc2U8UmVuZGVyUGllY2VbXT4ge1xyXG4gICAgY29uc3QgZG9jUmVjdCA9IGRvYy5zaGFkb3dSb290LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOyAvLyB0aGlzLmNhY2hlZEJvdW5kaW5nUmVjdDtcclxuICAgIC8vIGh0dHBzOi8vbWVhc3VyZXRoYXQubmV0L0JlbmNobWFya3MvU2hvdy81MzkyLzAvY2xpZW50d2lkdGgtdnMtb2Zmc2V0d2lkdGgtdnMtd2luZG93Z2V0Y29tcHV0ZWRzdHlsZVxyXG4gICAgLy8gdG9kbzogdGhpcyBpcyBvbmx5IGEgUG9DXHJcbiAgICBjb25zdCBjYWNoZWRPZmZzZXRXaWR0aDogbnVtYmVyID1cclxuICAgICAgJ29mZnNldFdpZHRoJyBpbiAoZG9jLnNoYWRvd1Jvb3QgYXMgSFRNTEVsZW1lbnQpXHJcbiAgICAgICAgPyAoZG9jLnNoYWRvd1Jvb3QgYXMgSFRNTEVsZW1lbnQpLm9mZnNldFdpZHRoXHJcbiAgICAgICAgOiBOdW1iZXIucGFyc2VJbnQod2luZG93LmdldENvbXB1dGVkU3R5bGUoZG9jLnNoYWRvd1Jvb3QpLndpZHRoLnJlcGxhY2UoJ3B4JywgJycpKTtcclxuICAgIGNvbnN0IGN1cnJlbnRTY2FsZVJhdGlvID0gMTsgLy8gdGhpcy5jdXJyZW50U2NhbGVSYXRpbztcclxuICAgIC8vIHNjYWxlIGRlcml2ZWQgZnJvbSBzdmcgd2lkdGggYW5kIGNvbnRhaW5lciB3aXRoLlxyXG4gICAgY29uc3QgY29tcHV0ZWRSZXZTY2FsZSA9IGNhY2hlZE9mZnNldFdpZHRoID8gZG9jLnNlc3Npb24uZG9jV2lkdGggLyBjYWNoZWRPZmZzZXRXaWR0aCA6IDE7XHJcbiAgICAvLyByZXNwZWN0IGN1cnJlbnQgc2NhbGUgcmF0aW9cclxuICAgIGNvbnN0IHJldlNjYWxlID0gY29tcHV0ZWRSZXZTY2FsZSAvIGN1cnJlbnRTY2FsZVJhdGlvO1xyXG4gICAgY29uc3QgbGVmdCA9ICh3aW5kb3cuc2NyZWVuTGVmdCAtIGRvY1JlY3QubGVmdCkgKiByZXZTY2FsZTtcclxuICAgIGNvbnN0IHRvcCA9ICh3aW5kb3cuc2NyZWVuVG9wIC0gZG9jUmVjdC50b3ApICogcmV2U2NhbGU7XHJcbiAgICBjb25zdCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoICogcmV2U2NhbGU7XHJcbiAgICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgKiByZXZTY2FsZTtcclxuXHJcbiAgICB2b2lkIGJlZm9yZTtcclxuICAgIGNvbnN0IHBhdGNoU3RyID0gZG9jLnNlc3Npb24ucmVuZGVyU3ZnRGlmZih7XHJcbiAgICAgIHdpbmRvdzoge1xyXG4gICAgICAgIGxvOiB7XHJcbiAgICAgICAgICB4OiBsZWZ0LFxyXG4gICAgICAgICAgeTogdG9wLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaGk6IHtcclxuICAgICAgICAgIHg6IGxlZnQgKyB3aWR0aCxcclxuICAgICAgICAgIHk6IHRvcCArIGhlaWdodCxcclxuICAgICAgICB9LFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcbiAgICAvLyB0b2RvOiBpZGVhbGx5LCB3ZSBzaG91bGQgcGF0Y2ggcGVyIHBhZ2Ugc2VwYXJhdGVseVxyXG4gICAgLy8gdG9kbzogdGhlbiwgd2UgY2FuIGNhbGwgdGhlIGFwaSBkb2MucmVuZGVyUGllY2VzKHBhZ2VzICsgd2luZG93cykuXHJcblxyXG4gICAgaWYgKGRvYy5zaGFkb3dSb290LmZpcnN0RWxlbWVudENoaWxkKSB7XHJcbiAgICAgIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgZWxlbS5pbm5lckhUTUwgPSBwYXRjaFN0cjtcclxuICAgICAgY29uc3Qgc3ZnRWxlbWVudCA9IGVsZW0uZmlyc3RFbGVtZW50Q2hpbGQgYXMgU1ZHRWxlbWVudDtcclxuICAgICAgcGF0Y2hSb290KGRvYy5zaGFkb3dSb290LmZpcnN0RWxlbWVudENoaWxkIGFzIFNWR0VsZW1lbnQsIHN2Z0VsZW1lbnQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZG9jLnNoYWRvd1Jvb3QuaW5uZXJIVE1MID0gcGF0Y2hTdHI7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XHJcbiAgfVxyXG5cclxuICAvLyBjb3B5IGZyb20gdHlwc3QtcHJldmlld1xyXG4gIC8vIHRvZG86IGdlbmVyYWxpemUgcGF0Y2hSb290IGhlcmVcclxuICBzdGF0aWMgbGF5b3V0U3ZnUGFnZXMoXHJcbiAgICBvcHRpb25zOiBMYXlvdXRTdmdQYWdlT3B0aW9ucyxcclxuICApOiAoZG9jOiBUeXBzdERvY3VtZW50LCBiZWZvcmU6IFBhZ2VWaWV3KSA9PiBQcm9taXNlPFJlbmRlclBpZWNlW10+IHtcclxuICAgIHJldHVybiAoZG9jOiBUeXBzdERvY3VtZW50LCBiZWZvcmU6IFBhZ2VWaWV3KSA9PiB7XHJcbiAgICAgIC8vIHRvZG9cclxuICAgICAgcmV0dXJuIFR5cHN0RG9jdW1lbnQubGF5b3V0U3ZnUGFnZXNQYXJ0aWFsTW9kZShkb2MsIGJlZm9yZSk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgYWRkQ2hhbmdlbWVudHMoY2hhbmdlOiBEb2N1bWVudENoYW5nZW1lbnRbXSk6IHZvaWQge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xyXG4gIH1cclxuXHJcbiAgcmVuZGVyUGllY2VzKHBpZWNlczogUmVuZGVyUGllY2VbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xyXG4gIH1cclxuXHJcbiAgb25TZXNzaW9uUmVhZHkoKTogUHJvbWlzZTxSZW5kZXJTZXNzaW9uPiB7XHJcbiAgICByZXR1cm4gdGhpcy5zZXNzaW9uUmVhZHk7XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKCkge1xyXG4gICAgaWYgKHRoaXMuZGlzcG9zZVNlc3Npb24gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB0aGlzLmRpc3Bvc2VTZXNzaW9uKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXQoKTogUHJvbWlzZTxSZW5kZXJTZXNzaW9uPiB7XHJcbiAgICBpZiAodGhpcy5zZXNzaW9uUmVhZHkgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FscmVhZHkgaW5pdGlhbGl6ZWQnKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5wcm9wcy5zZXNzaW9uICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgdGhpcy5zZXNzaW9uID0gdGhpcy5wcm9wcy5zZXNzaW9uO1xyXG4gICAgICByZXR1cm4gKHRoaXMuc2Vzc2lvblJlYWR5ID0gUHJvbWlzZS5yZXNvbHZlKHRoaXMuc2Vzc2lvbikpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiAodGhpcy5zZXNzaW9uUmVhZHkgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcclxuICAgICAgdGhpcy5wcm9wcy5wbHVnaW4ucnVuV2l0aFNlc3Npb24oc2Vzc2lvbiA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGRpc3Bvc2UgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbjtcclxuICAgICAgICAgIHRoaXMuZGlzcG9zZVNlc3Npb24gPSBkaXNwb3NlO1xyXG4gICAgICAgICAgcmVzb2x2ZShzZXNzaW9uKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9KSk7XHJcbiAgfVxyXG59XHJcblxyXG4vLyAgIHByaXZhdGUgY29sbGVjdERvY1Byb3BlcnRpZXMoKTogRG9jUHJvcGVydGllcyB7XHJcbi8vICAgICByZXR1cm4ge1xyXG4vLyAgICAgICBba1JlY3RzXTogdW5kZWZpbmVkLFxyXG4vLyAgICAgfTtcclxuLy8gICB9XHJcblxyXG4vLyAgIGFzeW5jIG11dGF0ZShcclxuLy8gICAgIGNiOiAoY3R4OiBQYWdlTXV0YXRpb25Db250ZXh0KSA9PiBQcm9taXNlPHZvaWQ+LFxyXG4vLyAgICAgLy8gb3B0aW9ucz86IHtcclxuLy8gICAgIC8vICAgcHJlZmV0Y2hlZERvY1Byb3BlcnRpZXM/OiBEb2NQcm9wZXJ0aWVzO1xyXG4vLyAgICAgLy8gfSxcclxuLy8gICApOiBQcm9taXNlPHZvaWQ+IHtcclxuLy8gICAgIGF3YWl0IHRoaXMuc2Vzc2lvblJlYWR5O1xyXG5cclxuLy8gICAgIC8vIGNvbnN0IGRvY1Byb3BlcnRpZXMgPSBvcHRpb25zPy5wcmVmZXRjaGVkRG9jUHJvcGVydGllcyA/PyB0aGlzLmNvbGxlY3REb2NQcm9wZXJ0aWVzKCk7XHJcbi8vICAgICBjb25zdCBjdHggPSBuZXcgUGFnZU11dGF0aW9uQ29udGV4dEltcGwodGhpcy5wcm9wcywgZG9jUHJvcGVydGllcyk7XHJcbi8vICAgICBhd2FpdCBjYihjdHgpO1xyXG4vLyAgICAgcmV0dXJuIGN0eFtrRGlzcG9zZV0oKTtcclxuLy8gICB9XHJcblxyXG4vLyBpbXBvcnQgeyBNYW5pcHVsYXRlRGF0YU9wdGlvbnMgfSBmcm9tICcuLi8uLi9vcHRpb25zLnJlbmRlcic7XHJcbi8vIGV4cG9ydCBpbnRlcmZhY2UgUGFnZU11dGF0aW9uSW5zdDxLPiB7XHJcbi8vICAgLyoqXHJcbi8vICAgICogVGhlIGtpbmQgb2YgbXV0YXRpb24uXHJcbi8vICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGtpbmQgLSBUaGUga2luZCBvZiBtdXRhdGlvbi5cclxuLy8gICAgKi9cclxuLy8gICBraW5kOiBLO1xyXG5cclxuLy8gICAvKipcclxuLy8gICAgKiBBZnRlci9BdCB3aGljaCBlbGVtZW50IHRoZSBtdXRhdGlvbiBoYXBwZW5zLlxyXG4vLyAgICAqL1xyXG4vLyAgIHNlbnRpbmVsPzogRWxlbWVudDtcclxuLy8gfVxyXG5cclxuLy8gZXhwb3J0IHR5cGUgUGFnZU11dGF0aW9uID0gUGFnZU11dGF0aW9uSW5zdDwnY3JlYXRlJyB8ICdkZWxldGUnIHwgJ2NoYW5nZSc+O1xyXG4vLyBjb25zdCBrUmVjdHMgPSBTeW1ib2woJ3JlY3RzJyk7XHJcblxyXG4vLyBjbGFzcyBQYWdlTXV0YXRpb25Db250ZXh0SW1wbCBpbXBsZW1lbnRzIFBhZ2VNdXRhdGlvbkNvbnRleHQge1xyXG4vLyAgIG11dGF0aW9uczogUGFnZU11dGF0aW9uW10gPSBbXTtcclxuLy8gICBjb25zdHJ1Y3RvcihcclxuLy8gICAgIHByaXZhdGUgcHJvcHM6IFR5cHN0RG9jdW1lbnRQcm9wcyxcclxuLy8gICAgIHByaXZhdGUgZG9jUHJvcGVydGllczogRG9jUHJvcGVydGllcyxcclxuLy8gICApIHt9XHJcblxyXG4vLyAgIG1hbmlwdWxhdGVEYXRhKG9wdHM6IE1hbmlwdWxhdGVEYXRhT3B0aW9ucykge1xyXG4vLyAgICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xyXG4vLyAgIH1cclxuXHJcbi8vICAgLy8gICBtdXRhdGVTZXEobXV0YXRpb246IFBhZ2VNdXRhdGlvbltdKTogUHJvbWlzZTxFbGVtZW50W10+IHtcclxuLy8gICAvLyAgICAgcmV0dXJuIFByb21pc2UuYWxsKG11dGF0aW9uLm1hcCh0aGlzLm11dGF0ZU9uZSkpO1xyXG4vLyAgIC8vICAgfVxyXG5cclxuLy8gICAvLyAgIG11dGF0ZU9uZShtdXRhdGlvbjogUGFnZU11dGF0aW9uKTogUHJvbWlzZTxFbGVtZW50PiB7XHJcbi8vICAgLy8gICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4gJyArIEpTT04uc3RyaW5naWZ5KG11dGF0aW9uKSk7XHJcbi8vICAgLy8gICB9XHJcblxyXG4vLyAgIFtrRGlzcG9zZV0oKTogdm9pZCB7fVxyXG4vLyB9XHJcblxyXG4vLyBleHBvcnQgaW50ZXJmYWNlIERvY1Byb3BlcnRpZXMge1xyXG4vLyAgIFtrUmVjdHNdOiB1bmtub3duO1xyXG4vLyB9XHJcbiJdfQ==