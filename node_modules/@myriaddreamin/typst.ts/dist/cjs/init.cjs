"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildComponent = exports.globalFontPromises = void 0;
const idb = require("idb");
/** @internal */
exports.globalFontPromises = [];
async function addPartialFonts({ builder, hooks }) {
    const t = performance.now();
    if ('queryLocalFonts' in window) {
        const fonts = await window.queryLocalFonts();
        console.log('local fonts count:', fonts.length);
        const db = await idb.openDB('typst-ts-store', 1, {
            upgrade(db) {
                db.createObjectStore('font-information', {
                    keyPath: 'postscriptName',
                });
            },
        });
        const informations = await Promise.all(fonts.map(async (font) => {
            const postscriptName = font.postscriptName;
            return (await db.get('font-information', postscriptName))?.info;
        }));
        const get_font_info = builder.handler_for_font_info();
        await builder.add_web_fonts(fonts.map((font, font_idx) => {
            let gettingBuffer = false;
            let readyBuffer = undefined;
            const fullName = font.fullName;
            const postscriptName = font.postscriptName;
            const prev = informations[font_idx];
            if (prev) {
                console.log('prev', postscriptName, prev);
            }
            return {
                family: font.family,
                style: font.style,
                fullName: fullName,
                postscriptName: postscriptName,
                ref: font,
                info: informations[font_idx],
                blob: (idx) => {
                    console.log(this, font, idx);
                    if (readyBuffer) {
                        return readyBuffer;
                    }
                    if (gettingBuffer) {
                        return;
                    }
                    gettingBuffer = true;
                    exports.globalFontPromises.push((async () => {
                        const blob = await font.blob();
                        const buffer = await blob.arrayBuffer();
                        readyBuffer = buffer;
                        const realFontInfo = get_font_info(new Uint8Array(buffer));
                        console.log(realFontInfo);
                        db.put('font-information', {
                            fullName,
                            postscriptName,
                            info: realFontInfo,
                        });
                        return { buffer, idx };
                    })());
                },
            };
        }));
    }
    const t2 = performance.now();
    console.log('addPartialFonts time used:', t2 - t);
}
class ComponentBuilder {
    loadedFonts = new Set();
    fetcher = fetch;
    setFetcher(fetcher) {
        this.fetcher = fetcher;
    }
    async loadFonts(builder, fonts) {
        const escapeImport = new Function('m', 'return import(m)');
        const fetcher = (this.fetcher ||= await (async function () {
            const { fetchBuilder, FileSystemCache } = await escapeImport('node-fetch-cache');
            const cache = new FileSystemCache({
                /// By default, we don't have a complicated cache policy.
                cacheDirectory: '.cache/typst/fonts',
            });
            const cachedFetcher = fetchBuilder.withCache(cache);
            return function (input, init) {
                const timeout = setTimeout(() => {
                    console.warn('font fetching is stucking:', input);
                }, 15000);
                return cachedFetcher(input, init).finally(() => {
                    clearTimeout(timeout);
                });
            };
        })());
        const fontsToLoad = fonts.filter(font => {
            if (font instanceof Uint8Array) {
                return true;
            }
            if (this.loadedFonts.has(font)) {
                return false;
            }
            this.loadedFonts.add(font);
            return true;
        });
        const fontLists = await Promise.all(fontsToLoad.map(async (font) => {
            if (font instanceof Uint8Array) {
                await builder.add_raw_font(font);
                return;
            }
            return new Uint8Array(await (await fetcher(font)).arrayBuffer());
        }));
        for (const font of fontLists) {
            if (!font) {
                continue;
            }
            await builder.add_raw_font(font);
        }
    }
    async build(options, builder, hooks) {
        /// build typst component
        const buildCtx = { ref: this, builder, hooks };
        for (const fn of options?.beforeBuild ?? []) {
            await fn(undefined, buildCtx);
        }
        // await addPartialFonts(buildCtx);
        if (hooks.latelyBuild) {
            hooks.latelyBuild(buildCtx);
        }
        const component = await builder.build();
        return component;
    }
}
/** @internal */
async function buildComponent(options, gModule, Builder, hooks) {
    /// init typst wasm module
    await gModule.init(options?.getModule?.());
    return await new ComponentBuilder().build(options, new Builder(), hooks);
}
exports.buildComponent = buildComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5tanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5pdC5tdHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsMkJBQTJCO0FBMEIzQixnQkFBZ0I7QUFDSCxRQUFBLGtCQUFrQixHQUFvRCxFQUFFLENBQUM7QUFFdEYsS0FBSyxVQUFVLGVBQWUsQ0FBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQWtCO0lBQ2xFLE1BQU0sQ0FBQyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUU1QixJQUFJLGlCQUFpQixJQUFJLE1BQU0sRUFBRTtRQUMvQixNQUFNLEtBQUssR0FBVSxNQUFPLE1BQWMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUM3RCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVoRCxNQUFNLEVBQUUsR0FBRyxNQUFNLEdBQUcsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFO1lBQy9DLE9BQU8sQ0FBQyxFQUFFO2dCQUNSLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxrQkFBa0IsRUFBRTtvQkFDdkMsT0FBTyxFQUFFLGdCQUFnQjtpQkFDMUIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sWUFBWSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDcEMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEVBQUU7WUFDckIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUUzQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLGNBQWMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDO1FBQ2xFLENBQUMsQ0FBQyxDQUNILENBQUM7UUFFRixNQUFNLGFBQWEsR0FBSSxPQUFlLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUUvRCxNQUFNLE9BQU8sQ0FBQyxhQUFhLENBQ3pCLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUU7WUFDM0IsSUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDO1lBQzFCLElBQUksV0FBVyxHQUE0QixTQUFTLENBQUM7WUFDckQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUMvQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDO1lBRTNDLE1BQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNwQyxJQUFJLElBQUksRUFBRTtnQkFDUixPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDM0M7WUFDRCxPQUFPO2dCQUNMLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTtnQkFDbkIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO2dCQUNqQixRQUFRLEVBQUUsUUFBUTtnQkFDbEIsY0FBYyxFQUFFLGNBQWM7Z0JBQzlCLEdBQUcsRUFBRSxJQUFJO2dCQUNULElBQUksRUFBRSxZQUFZLENBQUMsUUFBUSxDQUFDO2dCQUM1QixJQUFJLEVBQUUsQ0FBQyxHQUFXLEVBQUUsRUFBRTtvQkFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO29CQUM3QixJQUFJLFdBQVcsRUFBRTt3QkFDZixPQUFPLFdBQVcsQ0FBQztxQkFDcEI7b0JBQ0QsSUFBSSxhQUFhLEVBQUU7d0JBQ2pCLE9BQU87cUJBQ1I7b0JBQ0QsYUFBYSxHQUFHLElBQUksQ0FBQztvQkFDckIsMEJBQWtCLENBQUMsSUFBSSxDQUNyQixDQUFDLEtBQUssSUFBSSxFQUFFO3dCQUNWLE1BQU0sSUFBSSxHQUFTLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO3dCQUNyQyxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQzt3QkFDeEMsV0FBVyxHQUFHLE1BQU0sQ0FBQzt3QkFDckIsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7d0JBQzNELE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7d0JBRTFCLEVBQUUsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUU7NEJBQ3pCLFFBQVE7NEJBQ1IsY0FBYzs0QkFDZCxJQUFJLEVBQUUsWUFBWTt5QkFDbkIsQ0FBQyxDQUFDO3dCQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUM7b0JBQ3pCLENBQUMsQ0FBQyxFQUFFLENBQ0wsQ0FBQztnQkFDSixDQUFDO2FBQ0YsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7S0FDSDtJQUVELE1BQU0sRUFBRSxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNwRCxDQUFDO0FBRUQsTUFBTSxnQkFBZ0I7SUFDcEIsV0FBVyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7SUFDaEMsT0FBTyxHQUFrQixLQUFLLENBQUM7SUFFL0IsVUFBVSxDQUFDLE9BQXFCO1FBQzlCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQThCLEVBQUUsS0FBOEI7UUFDNUUsTUFBTSxZQUFZLEdBQUcsSUFBSSxRQUFRLENBQUMsR0FBRyxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDM0QsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLE1BQU0sQ0FBQyxLQUFLO1lBQzVDLE1BQU0sRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFFLEdBQUcsTUFBTSxZQUFZLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUNqRixNQUFNLEtBQUssR0FBRyxJQUFJLGVBQWUsQ0FBQztnQkFDaEMseURBQXlEO2dCQUN6RCxjQUFjLEVBQUUsb0JBQW9CO2FBQ3JDLENBQUMsQ0FBQztZQUVILE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFcEQsT0FBTyxVQUFVLEtBQXdCLEVBQUUsSUFBa0I7Z0JBQzNELE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7b0JBQzlCLE9BQU8sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ3BELENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDVixPQUFPLGFBQWEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRTtvQkFDN0MsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUN4QixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVOLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdEMsSUFBSSxJQUFJLFlBQVksVUFBVSxFQUFFO2dCQUM5QixPQUFPLElBQUksQ0FBQzthQUNiO1lBRUQsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDOUIsT0FBTyxLQUFLLENBQUM7YUFDZDtZQUVELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzNCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLFNBQVMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQ2pDLFdBQVcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxFQUFFO1lBQzNCLElBQUksSUFBSSxZQUFZLFVBQVUsRUFBRTtnQkFDOUIsTUFBTSxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNqQyxPQUFPO2FBQ1I7WUFFRCxPQUFPLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUVGLEtBQUssTUFBTSxJQUFJLElBQUksU0FBUyxFQUFFO1lBQzVCLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQ1QsU0FBUzthQUNWO1lBQ0QsTUFBTSxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2xDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLLENBQ1QsT0FBeUMsRUFDekMsT0FBOEIsRUFDOUIsS0FBMEI7UUFFMUIseUJBQXlCO1FBQ3pCLE1BQU0sUUFBUSxHQUFtQixFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDO1FBRS9ELEtBQUssTUFBTSxFQUFFLElBQUksT0FBTyxFQUFFLFdBQVcsSUFBSSxFQUFFLEVBQUU7WUFDM0MsTUFBTSxFQUFFLENBQUMsU0FBdUMsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUM3RDtRQUNELG1DQUFtQztRQUVuQyxJQUFJLEtBQUssQ0FBQyxXQUFXLEVBQUU7WUFDckIsS0FBSyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM3QjtRQUVELE1BQU0sU0FBUyxHQUFHLE1BQU0sT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXhDLE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQUVELGdCQUFnQjtBQUNULEtBQUssVUFBVSxjQUFjLENBQ2xDLE9BQXlDLEVBQ3pDLE9BQXVCLEVBQ3ZCLE9BQTBDLEVBQzFDLEtBQTBCO0lBRTFCLDBCQUEwQjtJQUMxQixNQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUUzQyxPQUFPLE1BQU0sSUFBSSxnQkFBZ0IsRUFBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxPQUFPLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM5RSxDQUFDO0FBVkQsd0NBVUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZWZvcmVCdWlsZE1hcmssIEluaXRPcHRpb25zIH0gZnJvbSAnLi9vcHRpb25zLmluaXQubWpzJztcclxuaW1wb3J0IHsgTGF6eVdhc21Nb2R1bGUgfSBmcm9tICcuL3dhc20ubWpzJztcclxuaW1wb3J0ICogYXMgaWRiIGZyb20gJ2lkYic7XHJcblxyXG4vKiogQGludGVybmFsICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgVHlwc3RDb21tb25CdWlsZGVyPFQ+IHtcclxuICBmcmVlKCk6IHZvaWQ7XHJcblxyXG4gIGFkZF9yYXdfZm9udChmb250X2J1ZmZlcjogVWludDhBcnJheSk6IFByb21pc2U8dm9pZD47XHJcblxyXG4gIGFkZF93ZWJfZm9udHMoZm9udDogYW55W10pOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICBidWlsZCgpOiBQcm9taXNlPFQ+O1xyXG59XHJcblxyXG4vKiogQGludGVybmFsICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ29tcG9uZW50QnVpbGRIb29rcyB7XHJcbiAgbGF0ZWx5QnVpbGQ/OiAoY3R4OiB1bmtub3duKSA9PiB2b2lkO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSW5pdENvbnRleHQ8VD4ge1xyXG4gIHJlZjoge1xyXG4gICAgbG9hZEZvbnRzKGJ1aWxkZXI6IFR5cHN0Q29tbW9uQnVpbGRlcjxUPiwgZm9udHM6IChzdHJpbmcgfCBVaW50OEFycmF5KVtdKTogUHJvbWlzZTx2b2lkPjtcclxuICB9O1xyXG4gIGJ1aWxkZXI6IFR5cHN0Q29tbW9uQnVpbGRlcjxUPjtcclxuICBob29rczogQ29tcG9uZW50QnVpbGRIb29rcztcclxufVxyXG5cclxuLyoqIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgY29uc3QgZ2xvYmFsRm9udFByb21pc2VzOiBQcm9taXNlPHsgYnVmZmVyOiBBcnJheUJ1ZmZlcjsgaWR4OiBudW1iZXIgfT5bXSA9IFtdO1xyXG5cclxuYXN5bmMgZnVuY3Rpb24gYWRkUGFydGlhbEZvbnRzPFQ+KHsgYnVpbGRlciwgaG9va3MgfTogSW5pdENvbnRleHQ8VD4pOiBQcm9taXNlPHZvaWQ+IHtcclxuICBjb25zdCB0ID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblxyXG4gIGlmICgncXVlcnlMb2NhbEZvbnRzJyBpbiB3aW5kb3cpIHtcclxuICAgIGNvbnN0IGZvbnRzOiBhbnlbXSA9IGF3YWl0ICh3aW5kb3cgYXMgYW55KS5xdWVyeUxvY2FsRm9udHMoKTtcclxuICAgIGNvbnNvbGUubG9nKCdsb2NhbCBmb250cyBjb3VudDonLCBmb250cy5sZW5ndGgpO1xyXG5cclxuICAgIGNvbnN0IGRiID0gYXdhaXQgaWRiLm9wZW5EQigndHlwc3QtdHMtc3RvcmUnLCAxLCB7XHJcbiAgICAgIHVwZ3JhZGUoZGIpIHtcclxuICAgICAgICBkYi5jcmVhdGVPYmplY3RTdG9yZSgnZm9udC1pbmZvcm1hdGlvbicsIHtcclxuICAgICAgICAgIGtleVBhdGg6ICdwb3N0c2NyaXB0TmFtZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBpbmZvcm1hdGlvbnMgPSBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgZm9udHMubWFwKGFzeW5jIGZvbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBvc3RzY3JpcHROYW1lID0gZm9udC5wb3N0c2NyaXB0TmFtZTtcclxuXHJcbiAgICAgICAgcmV0dXJuIChhd2FpdCBkYi5nZXQoJ2ZvbnQtaW5mb3JtYXRpb24nLCBwb3N0c2NyaXB0TmFtZSkpPy5pbmZvO1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZ2V0X2ZvbnRfaW5mbyA9IChidWlsZGVyIGFzIGFueSkuaGFuZGxlcl9mb3JfZm9udF9pbmZvKCk7XHJcblxyXG4gICAgYXdhaXQgYnVpbGRlci5hZGRfd2ViX2ZvbnRzKFxyXG4gICAgICBmb250cy5tYXAoKGZvbnQsIGZvbnRfaWR4KSA9PiB7XHJcbiAgICAgICAgbGV0IGdldHRpbmdCdWZmZXIgPSBmYWxzZTtcclxuICAgICAgICBsZXQgcmVhZHlCdWZmZXI6IEFycmF5QnVmZmVyIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIGNvbnN0IGZ1bGxOYW1lID0gZm9udC5mdWxsTmFtZTtcclxuICAgICAgICBjb25zdCBwb3N0c2NyaXB0TmFtZSA9IGZvbnQucG9zdHNjcmlwdE5hbWU7XHJcblxyXG4gICAgICAgIGNvbnN0IHByZXYgPSBpbmZvcm1hdGlvbnNbZm9udF9pZHhdO1xyXG4gICAgICAgIGlmIChwcmV2KSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygncHJldicsIHBvc3RzY3JpcHROYW1lLCBwcmV2KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGZhbWlseTogZm9udC5mYW1pbHksXHJcbiAgICAgICAgICBzdHlsZTogZm9udC5zdHlsZSxcclxuICAgICAgICAgIGZ1bGxOYW1lOiBmdWxsTmFtZSxcclxuICAgICAgICAgIHBvc3RzY3JpcHROYW1lOiBwb3N0c2NyaXB0TmFtZSxcclxuICAgICAgICAgIHJlZjogZm9udCxcclxuICAgICAgICAgIGluZm86IGluZm9ybWF0aW9uc1tmb250X2lkeF0sXHJcbiAgICAgICAgICBibG9iOiAoaWR4OiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcywgZm9udCwgaWR4KTtcclxuICAgICAgICAgICAgaWYgKHJlYWR5QnVmZmVyKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHJlYWR5QnVmZmVyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChnZXR0aW5nQnVmZmVyKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGdldHRpbmdCdWZmZXIgPSB0cnVlO1xyXG4gICAgICAgICAgICBnbG9iYWxGb250UHJvbWlzZXMucHVzaChcclxuICAgICAgICAgICAgICAoYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYmxvYjogQmxvYiA9IGF3YWl0IGZvbnQuYmxvYigpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgYmxvYi5hcnJheUJ1ZmZlcigpO1xyXG4gICAgICAgICAgICAgICAgcmVhZHlCdWZmZXIgPSBidWZmZXI7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZWFsRm9udEluZm8gPSBnZXRfZm9udF9pbmZvKG5ldyBVaW50OEFycmF5KGJ1ZmZlcikpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVhbEZvbnRJbmZvKTtcclxuXHJcbiAgICAgICAgICAgICAgICBkYi5wdXQoJ2ZvbnQtaW5mb3JtYXRpb24nLCB7XHJcbiAgICAgICAgICAgICAgICAgIGZ1bGxOYW1lLFxyXG4gICAgICAgICAgICAgICAgICBwb3N0c2NyaXB0TmFtZSxcclxuICAgICAgICAgICAgICAgICAgaW5mbzogcmVhbEZvbnRJbmZvLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgYnVmZmVyLCBpZHggfTtcclxuICAgICAgICAgICAgICB9KSgpLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBjb25zdCB0MiA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG4gIGNvbnNvbGUubG9nKCdhZGRQYXJ0aWFsRm9udHMgdGltZSB1c2VkOicsIHQyIC0gdCk7XHJcbn1cclxuXHJcbmNsYXNzIENvbXBvbmVudEJ1aWxkZXI8VD4ge1xyXG4gIGxvYWRlZEZvbnRzID0gbmV3IFNldDxzdHJpbmc+KCk7XHJcbiAgZmV0Y2hlcj86IHR5cGVvZiBmZXRjaCA9IGZldGNoO1xyXG5cclxuICBzZXRGZXRjaGVyKGZldGNoZXI6IHR5cGVvZiBmZXRjaCk6IHZvaWQge1xyXG4gICAgdGhpcy5mZXRjaGVyID0gZmV0Y2hlcjtcclxuICB9XHJcblxyXG4gIGFzeW5jIGxvYWRGb250cyhidWlsZGVyOiBUeXBzdENvbW1vbkJ1aWxkZXI8VD4sIGZvbnRzOiAoc3RyaW5nIHwgVWludDhBcnJheSlbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgY29uc3QgZXNjYXBlSW1wb3J0ID0gbmV3IEZ1bmN0aW9uKCdtJywgJ3JldHVybiBpbXBvcnQobSknKTtcclxuICAgIGNvbnN0IGZldGNoZXIgPSAodGhpcy5mZXRjaGVyIHx8PSBhd2FpdCAoYXN5bmMgZnVuY3Rpb24gKCkge1xyXG4gICAgICBjb25zdCB7IGZldGNoQnVpbGRlciwgRmlsZVN5c3RlbUNhY2hlIH0gPSBhd2FpdCBlc2NhcGVJbXBvcnQoJ25vZGUtZmV0Y2gtY2FjaGUnKTtcclxuICAgICAgY29uc3QgY2FjaGUgPSBuZXcgRmlsZVN5c3RlbUNhY2hlKHtcclxuICAgICAgICAvLy8gQnkgZGVmYXVsdCwgd2UgZG9uJ3QgaGF2ZSBhIGNvbXBsaWNhdGVkIGNhY2hlIHBvbGljeS5cclxuICAgICAgICBjYWNoZURpcmVjdG9yeTogJy5jYWNoZS90eXBzdC9mb250cycsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgY2FjaGVkRmV0Y2hlciA9IGZldGNoQnVpbGRlci53aXRoQ2FjaGUoY2FjaGUpO1xyXG5cclxuICAgICAgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dDogUmVxdWVzdEluZm8gfCBVUkwsIGluaXQ/OiBSZXF1ZXN0SW5pdCkge1xyXG4gICAgICAgIGNvbnN0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIGNvbnNvbGUud2FybignZm9udCBmZXRjaGluZyBpcyBzdHVja2luZzonLCBpbnB1dCk7XHJcbiAgICAgICAgfSwgMTUwMDApO1xyXG4gICAgICAgIHJldHVybiBjYWNoZWRGZXRjaGVyKGlucHV0LCBpbml0KS5maW5hbGx5KCgpID0+IHtcclxuICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcclxuICAgICAgICB9KTtcclxuICAgICAgfTtcclxuICAgIH0pKCkpO1xyXG5cclxuICAgIGNvbnN0IGZvbnRzVG9Mb2FkID0gZm9udHMuZmlsdGVyKGZvbnQgPT4ge1xyXG4gICAgICBpZiAoZm9udCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHRoaXMubG9hZGVkRm9udHMuaGFzKGZvbnQpKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmxvYWRlZEZvbnRzLmFkZChmb250KTtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBmb250TGlzdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgZm9udHNUb0xvYWQubWFwKGFzeW5jIGZvbnQgPT4ge1xyXG4gICAgICAgIGlmIChmb250IGluc3RhbmNlb2YgVWludDhBcnJheSkge1xyXG4gICAgICAgICAgYXdhaXQgYnVpbGRlci5hZGRfcmF3X2ZvbnQoZm9udCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYXdhaXQgKGF3YWl0IGZldGNoZXIoZm9udCkpLmFycmF5QnVmZmVyKCkpO1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcblxyXG4gICAgZm9yIChjb25zdCBmb250IG9mIGZvbnRMaXN0cykge1xyXG4gICAgICBpZiAoIWZvbnQpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICBhd2FpdCBidWlsZGVyLmFkZF9yYXdfZm9udChmb250KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGJ1aWxkKFxyXG4gICAgb3B0aW9uczogUGFydGlhbDxJbml0T3B0aW9ucz4gfCB1bmRlZmluZWQsXHJcbiAgICBidWlsZGVyOiBUeXBzdENvbW1vbkJ1aWxkZXI8VD4sXHJcbiAgICBob29rczogQ29tcG9uZW50QnVpbGRIb29rcyxcclxuICApOiBQcm9taXNlPFQ+IHtcclxuICAgIC8vLyBidWlsZCB0eXBzdCBjb21wb25lbnRcclxuICAgIGNvbnN0IGJ1aWxkQ3R4OiBJbml0Q29udGV4dDxUPiA9IHsgcmVmOiB0aGlzLCBidWlsZGVyLCBob29rcyB9O1xyXG5cclxuICAgIGZvciAoY29uc3QgZm4gb2Ygb3B0aW9ucz8uYmVmb3JlQnVpbGQgPz8gW10pIHtcclxuICAgICAgYXdhaXQgZm4odW5kZWZpbmVkIGFzIHVua25vd24gYXMgQmVmb3JlQnVpbGRNYXJrLCBidWlsZEN0eCk7XHJcbiAgICB9XHJcbiAgICAvLyBhd2FpdCBhZGRQYXJ0aWFsRm9udHMoYnVpbGRDdHgpO1xyXG5cclxuICAgIGlmIChob29rcy5sYXRlbHlCdWlsZCkge1xyXG4gICAgICBob29rcy5sYXRlbHlCdWlsZChidWlsZEN0eCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY29tcG9uZW50ID0gYXdhaXQgYnVpbGRlci5idWlsZCgpO1xyXG5cclxuICAgIHJldHVybiBjb21wb25lbnQ7XHJcbiAgfVxyXG59XHJcblxyXG4vKiogQGludGVybmFsICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZENvbXBvbmVudDxUPihcclxuICBvcHRpb25zOiBQYXJ0aWFsPEluaXRPcHRpb25zPiB8IHVuZGVmaW5lZCxcclxuICBnTW9kdWxlOiBMYXp5V2FzbU1vZHVsZSxcclxuICBCdWlsZGVyOiB7IG5ldyAoKTogVHlwc3RDb21tb25CdWlsZGVyPFQ+IH0sXHJcbiAgaG9va3M6IENvbXBvbmVudEJ1aWxkSG9va3MsXHJcbik6IFByb21pc2U8VD4ge1xyXG4gIC8vLyBpbml0IHR5cHN0IHdhc20gbW9kdWxlXHJcbiAgYXdhaXQgZ01vZHVsZS5pbml0KG9wdGlvbnM/LmdldE1vZHVsZT8uKCkpO1xyXG5cclxuICByZXR1cm4gYXdhaXQgbmV3IENvbXBvbmVudEJ1aWxkZXI8VD4oKS5idWlsZChvcHRpb25zLCBuZXcgQnVpbGRlcigpLCBob29rcyk7XHJcbn1cclxuIl19