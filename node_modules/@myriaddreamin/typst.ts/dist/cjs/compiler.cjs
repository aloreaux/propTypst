"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createTypstCompiler = exports.IncrementalServer = void 0;
const init_mjs_1 = require("./init.cjs");
const internal_types_mjs_1 = require("./internal.types.cjs");
const options_init_mjs_1 = require("./options.init.cjs");
const wasm_mjs_1 = require("./wasm.cjs");
class IncrementalServer {
    /**
     * @internal
     */
    [internal_types_mjs_1.kObject];
    /**
     * @internal
     */
    constructor(s) {
        this[internal_types_mjs_1.kObject] = s;
    }
    /**
     * Reset the incremental server to the initial state.
     */
    reset() {
        this[internal_types_mjs_1.kObject].reset();
    }
    /**
     * Return current result.
     */
    current() {
        return this[internal_types_mjs_1.kObject].current();
    }
    /**
     * Also attach the debug info to the result.
     */
    setAttachDebugInfo(enable) {
        this[internal_types_mjs_1.kObject].set_attach_debug_info(enable);
    }
}
exports.IncrementalServer = IncrementalServer;
const gCompilerModule = new wasm_mjs_1.LazyWasmModule(async (bin) => {
    const module = await import('@myriaddreamin/typst-ts-web-compiler/pkg/wasm-pack-shim.mjs');
    return await module.default(bin);
});
/**
 * create a Typst compiler.
 * @returns {TypstCompiler} - The Typst compiler.
 * @example
 * ```typescript
 * import { createTypstCompiler } from 'typst';
 * const compiler = createTypstCompiler();
 * await compiler.init();
 * compiler.addSource('/main.typ', 'Hello, typst!');
 * await compiler.compile({ mainFilePath: '/main.typ' });
 * ```
 */
function createTypstCompiler() {
    return new TypstCompilerDriver();
}
exports.createTypstCompiler = createTypstCompiler;
class TypstCompilerDriver {
    compiler;
    compilerJs;
    constructor() { }
    async init(options) {
        this.compilerJs = await import('@myriaddreamin/typst-ts-web-compiler/pkg/wasm-pack-shim.mjs');
        const TypstCompilerBuilder = this.compilerJs.TypstCompilerBuilder;
        const compilerOptions = { ...(options || {}) };
        const hasPreloadRemoteFonts = compilerOptions.beforeBuild?.some((fn) => fn._preloadRemoteFontOptions !== undefined);
        const hasSpecifiedAssets = compilerOptions.beforeBuild?.some((fn) => fn._preloadRemoteFontOptions?.assets !== undefined);
        const hasDisableAssets = compilerOptions.beforeBuild?.some((fn) => fn._preloadRemoteFontOptions?.assets === false);
        if (!hasPreloadRemoteFonts || (!hasSpecifiedAssets && !hasDisableAssets)) {
            compilerOptions.beforeBuild?.push((0, options_init_mjs_1.preloadRemoteFonts)([], {
                assets: ['text'],
            }));
        }
        this.compiler = await (0, init_mjs_1.buildComponent)(options, gCompilerModule, TypstCompilerBuilder, {});
    }
    compile(options) {
        return new Promise(resolve => {
            if ('incrementalServer' in options) {
                resolve(this.compiler.incr_compile(options.mainFilePath, convertInputs(options.inputs), options.incrementalServer[internal_types_mjs_1.kObject], getDiagnosticsArg(options.diagnostics)));
                return;
            }
            resolve(this.compiler.compile(options.mainFilePath, convertInputs(options.inputs), options.format || 'vector', getDiagnosticsArg(options.diagnostics)));
        });
    }
    query(options) {
        return new Promise(resolve => {
            resolve(JSON.parse(this.compiler.query(options.mainFilePath, convertInputs(options.inputs), options.selector, options.field)));
        });
    }
    getSemanticTokenLegend() {
        return new Promise(resolve => {
            resolve(this.compiler.get_semantic_token_legend());
        });
    }
    getSemanticTokens(opts) {
        return new Promise(resolve => {
            this.compiler.reset();
            resolve(this.compiler.get_semantic_tokens(opts.offsetEncoding || 'utf-16', opts.mainFilePath, opts.resultId));
        });
    }
    async withIncrementalServer(f) {
        const srv = new IncrementalServer(this.compiler.create_incr_server());
        try {
            return await f(srv);
        }
        finally {
            srv[internal_types_mjs_1.kObject].free();
        }
    }
    async getAst(mainFilePath) {
        return this.compiler.get_ast(mainFilePath);
    }
    async reset() {
        await new Promise(resolve => {
            this.compiler.reset();
            resolve(undefined);
        });
    }
    addSource(path, source) {
        if (arguments.length > 2) {
            throw new Error('use of addSource(path, source, isMain) is deprecated, please use addSource(path, source) instead');
        }
        this.compiler.add_source(path, source);
    }
    mapShadow(path, content) {
        this.compiler.map_shadow(path, content);
    }
    unmapShadow(path) {
        this.compiler.unmap_shadow(path);
    }
    resetShadow() {
        this.compiler.reset_shadow();
    }
    renderPageToCanvas() {
        throw new Error('Please use the api TypstRenderer.renderToCanvas in v0.4.0');
    }
}
// todo: caching inputs
function convertInputs(inputs) {
    return inputs ? Object.entries(inputs) : undefined;
}
function getDiagnosticsArg(diagnostics) {
    switch (diagnostics) {
        case 'none':
            return 1;
        case 'unix':
            return 2;
        case 'full':
            return 3;
        default:
            return 0;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZXIubWpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbXBpbGVyLm10cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSx5Q0FBZ0U7QUFDaEUsNkRBQW9HO0FBRXBHLHlEQUEwRTtBQUMxRSx5Q0FBNEM7QUErSDVDLE1BQWEsaUJBQWlCO0lBQzVCOztPQUVHO0lBQ0gsQ0FBQyw0QkFBTyxDQUFDLENBQW1CO0lBRTVCOztPQUVHO0lBQ0gsWUFBWSxDQUFtQjtRQUM3QixJQUFJLENBQUMsNEJBQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLDRCQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPO1FBQ0wsT0FBTyxJQUFJLENBQUMsNEJBQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFFRDs7T0FFRztJQUNILGtCQUFrQixDQUFDLE1BQWU7UUFDaEMsSUFBSSxDQUFDLDRCQUFPLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QyxDQUFDO0NBQ0Y7QUFqQ0QsOENBaUNDO0FBMkhELE1BQU0sZUFBZSxHQUFHLElBQUkseUJBQWMsQ0FBQyxLQUFLLEVBQUUsR0FBUyxFQUFFLEVBQUU7SUFDN0QsTUFBTSxNQUFNLEdBQUcsTUFBTSxNQUFNLENBQUMsNkRBQTZELENBQUMsQ0FBQztJQUMzRixPQUFPLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNuQyxDQUFDLENBQUMsQ0FBQztBQUVIOzs7Ozs7Ozs7OztHQVdHO0FBQ0gsU0FBZ0IsbUJBQW1CO0lBQ2pDLE9BQU8sSUFBSSxtQkFBbUIsRUFBRSxDQUFDO0FBQ25DLENBQUM7QUFGRCxrREFFQztBQUVELE1BQU0sbUJBQW1CO0lBQ3ZCLFFBQVEsQ0FBc0I7SUFDOUIsVUFBVSxDQUFlO0lBRXpCLGdCQUFlLENBQUM7SUFFaEIsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUE4QjtRQUN2QyxJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sTUFBTSxDQUFDLDZEQUE2RCxDQUFDLENBQUM7UUFDOUYsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDO1FBRWxFLE1BQU0sZUFBZSxHQUFHLEVBQUUsR0FBRyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQy9DLE1BQU0scUJBQXFCLEdBQUcsZUFBZSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQzdELENBQUMsRUFBTyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMseUJBQXlCLEtBQUssU0FBUyxDQUN4RCxDQUFDO1FBQ0YsTUFBTSxrQkFBa0IsR0FBRyxlQUFlLENBQUMsV0FBVyxFQUFFLElBQUksQ0FDMUQsQ0FBQyxFQUFPLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyx5QkFBeUIsRUFBRSxNQUFNLEtBQUssU0FBUyxDQUNoRSxDQUFDO1FBQ0YsTUFBTSxnQkFBZ0IsR0FBRyxlQUFlLENBQUMsV0FBVyxFQUFFLElBQUksQ0FDeEQsQ0FBQyxFQUFPLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyx5QkFBeUIsRUFBRSxNQUFNLEtBQUssS0FBSyxDQUM1RCxDQUFDO1FBRUYsSUFBSSxDQUFDLHFCQUFxQixJQUFJLENBQUMsQ0FBQyxrQkFBa0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7WUFDeEUsZUFBZSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQy9CLElBQUEscUNBQWtCLEVBQUMsRUFBRSxFQUFFO2dCQUNyQixNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUM7YUFDakIsQ0FBQyxDQUNILENBQUM7U0FDSDtRQUVELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxJQUFBLHlCQUFjLEVBQUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxvQkFBb0IsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMzRixDQUFDO0lBRUQsT0FBTyxDQUFDLE9BQXVCO1FBQzdCLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDM0IsSUFBSSxtQkFBbUIsSUFBSSxPQUFPLEVBQUU7Z0JBQ2xDLE9BQU8sQ0FDTCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FDeEIsT0FBTyxDQUFDLFlBQVksRUFDcEIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDN0IsT0FBTyxDQUFDLGlCQUFpQixDQUFDLDRCQUFPLENBQUMsRUFDbEMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUN2QyxDQUNGLENBQUM7Z0JBQ0YsT0FBTzthQUNSO1lBQ0QsT0FBTyxDQUNMLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUNuQixPQUFPLENBQUMsWUFBWSxFQUNwQixhQUFhLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUM3QixPQUFPLENBQUMsTUFBTSxJQUFJLFFBQVEsRUFDMUIsaUJBQWlCLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUN2QyxDQUNGLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBcUI7UUFDekIsT0FBTyxJQUFJLE9BQU8sQ0FBTSxPQUFPLENBQUMsRUFBRTtZQUNoQyxPQUFPLENBQ0wsSUFBSSxDQUFDLEtBQUssQ0FDUixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FDakIsT0FBTyxDQUFDLFlBQVksRUFDcEIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDN0IsT0FBTyxDQUFDLFFBQVEsRUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FDZCxDQUNGLENBQ0YsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELHNCQUFzQjtRQUNwQixPQUFPLElBQUksT0FBTyxDQUF1QixPQUFPLENBQUMsRUFBRTtZQUNqRCxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyx5QkFBeUIsRUFBRSxDQUFDLENBQUM7UUFDckQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsaUJBQWlCLENBQUMsSUFJakI7UUFDQyxPQUFPLElBQUksT0FBTyxDQUFpQixPQUFPLENBQUMsRUFBRTtZQUMzQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3RCLE9BQU8sQ0FDTCxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUMvQixJQUFJLENBQUMsY0FBYyxJQUFJLFFBQVEsRUFDL0IsSUFBSSxDQUFDLFlBQVksRUFDakIsSUFBSSxDQUFDLFFBQVEsQ0FDUCxDQUNULENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMscUJBQXFCLENBQUksQ0FBdUM7UUFDcEUsTUFBTSxHQUFHLEdBQUcsSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGtCQUFrQixFQUFFLENBQUMsQ0FBQztRQUN0RSxJQUFJO1lBQ0YsT0FBTyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNyQjtnQkFBUztZQUNSLEdBQUcsQ0FBQyw0QkFBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDckI7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxZQUFvQjtRQUMvQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNULE1BQU0sSUFBSSxPQUFPLENBQU8sT0FBTyxDQUFDLEVBQUU7WUFDaEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUN0QixPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsU0FBUyxDQUFDLElBQVksRUFBRSxNQUFjO1FBQ3BDLElBQUksU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDeEIsTUFBTSxJQUFJLEtBQUssQ0FDYixrR0FBa0csQ0FDbkcsQ0FBQztTQUNIO1FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRCxTQUFTLENBQUMsSUFBWSxFQUFFLE9BQW1CO1FBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsV0FBVyxDQUFDLElBQVk7UUFDdEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQywyREFBMkQsQ0FBQyxDQUFDO0lBQy9FLENBQUM7Q0FDRjtBQUVELHVCQUF1QjtBQUN2QixTQUFTLGFBQWEsQ0FBQyxNQUErQjtJQUNwRCxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0FBQ3JELENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLFdBQStCO0lBQ3hELFFBQVEsV0FBVyxFQUFFO1FBQ25CLEtBQUssTUFBTTtZQUNULE9BQU8sQ0FBQyxDQUFDO1FBQ1gsS0FBSyxNQUFNO1lBQ1QsT0FBTyxDQUFDLENBQUM7UUFDWCxLQUFLLE1BQU07WUFDVCxPQUFPLENBQUMsQ0FBQztRQUNYO1lBQ0UsT0FBTyxDQUFDLENBQUM7S0FDWjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtaWdub3JlXHJcbmltcG9ydCB0eXBlICogYXMgdHlwc3QgZnJvbSAnQG15cmlhZGRyZWFtaW4vdHlwc3QtdHMtd2ViLWNvbXBpbGVyL3BrZy93YXNtLXBhY2stc2hpbS5tanMnO1xyXG5pbXBvcnQgeyBidWlsZENvbXBvbmVudCwgZ2xvYmFsRm9udFByb21pc2VzIH0gZnJvbSAnLi9pbml0Lm1qcyc7XHJcbmltcG9ydCB7IEZzQWNjZXNzTW9kZWwsIFNlbWFudGljVG9rZW5zLCBTZW1hbnRpY1Rva2Vuc0xlZ2VuZCwga09iamVjdCB9IGZyb20gJy4vaW50ZXJuYWwudHlwZXMubWpzJztcclxuXHJcbmltcG9ydCB7IHByZWxvYWRSZW1vdGVGb250cywgdHlwZSBJbml0T3B0aW9ucyB9IGZyb20gJy4vb3B0aW9ucy5pbml0Lm1qcyc7XHJcbmltcG9ydCB7IExhenlXYXNtTW9kdWxlIH0gZnJvbSAnLi93YXNtLm1qcyc7XHJcblxyXG4vKipcclxuICogQXZhaWxhYmxlIGZvcm1hdHMgZm9yIGNvbXBpbGluZyB0aGUgZG9jdW1lbnQuXHJcbiAqL1xyXG5leHBvcnQgdHlwZSBDb21waWxlRm9ybWF0ID0gJ3ZlY3RvcicgfCAncGRmJztcclxuXHJcbi8qKlxyXG4gKiBUaGUgZGlhZ25vc3RpYyBtZXNzYWdlIHBhcnRpYWxseSBmb2xsb3dpbmcgdGhlIExTUCBzcGVjaWZpY2F0aW9uLlxyXG4gKi9cclxuaW50ZXJmYWNlIERpYWdub3N0aWNNZXNzYWdlIHtcclxuICAvLyBUaGUgcGFja2FnZSBvd25pbmcgdGhlIHBhdGguXHJcbiAgLy8gSWYgdGhlIHBhY2thZ2UgaXMgZW1wdHksIHRoZSBwYXRoIGlzIGEgcmVsYXRpdmUgcGF0aCB0byB0aGUgKndvcmtzcGFjZSByb290Ki5cclxuICBwYWNrYWdlOiBzdHJpbmc7XHJcbiAgLy8gVGhlIHBhdGggb2YgdGhlIGZpbGUuXHJcbiAgcGF0aDogc3RyaW5nO1xyXG4gIC8vIFNldmVyaXR5IG9mIHRoZSBkaWFnbm9zdGljIG1lc3NhZ2UuXHJcbiAgc2V2ZXJpdHk6IHN0cmluZztcclxuICAvLyBaZXJvLWJhc2VkIGxpbmUgbnVtYmVyIGFuZCBvbmUtYmFzZWQgY2hhcmFjdGVyIG9mZnNldC5cclxuICAvLyBUaGUgcmFuZ2Ugb2YgdGhlIGRpYWdub3N0aWMgbWVzc2FnZS5cclxuICAvLyBJZiB0aGUgZGlhZ25vc3RpYyBtZXNzYWdlIGlzIGEgcmFuZ2UsIHRoZSByYW5nZSBpcyBpbiB0aGUgZm9ybWF0IG9mIGBzdGFydExpbmU6c3RhcnRDaGFyYWN0ZXItZW5kTGluZTplbmRDaGFyYWN0ZXJgLlxyXG4gIC8vIElmIHRoZSBkaWFnbm9zdGljIG1lc3NhZ2UgaXMgYSBwb2ludCwgdGhlIHJhbmdlIGlzIGluIHRoZSBmb3JtYXQgb2YgYGxpbmU6Y2hhcmFjdGVyYC5cclxuICAvLyBPdGhlcndpc2UsIHRoZSByYW5nZSBpcyBlbXB0eS5cclxuICByYW5nZTogc3RyaW5nO1xyXG4gIC8vIFRoZSBtZXNzYWdlIG9mIHRoZSBkaWFnbm9zdGljIG1lc3NhZ2UuXHJcbiAgbWVzc2FnZTogc3RyaW5nO1xyXG59XHJcblxyXG4vKipcclxuICogQXZhaWxhYmxlIGZvcm1hdHMgZm9yIGNvbXBpbGluZyB0aGUgZG9jdW1lbnQuXHJcbiAqXHJcbiAqIElmIHNldCB0byB1bml4LCBhIGRpYWdub3N0aWNzIGlzIGluIGZvcm1hdCBvZlxyXG4gKlxyXG4gKiBgYGBsb2dcclxuICogLy8gd2l0aCBwYWNrYWdlXHJcbiAqIGNldHo6MC4yLjBAbGliLnR5cDoyOjktMzoxNTogZXJyb3I6IHVuZXhwZWN0ZWQgdHlwZSBpbiBgK2AgYXBwbGljYXRpb25cclxuICogLy8gd2l0aG91dCBwYWNrYWdlXHJcbiAqIG1haW4udHlwOjI6OS0zOjE1OiBlcnJvcjogdW5leHBlY3RlZCB0eXBlIGluIGArYCBhcHBsaWNhdGlvblxyXG4gKiBgYGBcclxuICpcclxuICogSWYgc2V0IHRvIGxvbmcsIGEgZGlhZ25vc3RpY3MgaXMgaW4gZm9ybWF0IG9mIHtAbGluayBEaWFnbm9zdGljTWVzc2FnZX0uXHJcbiAqXHJcbiAqIElmIHNldCB0byBmdWxsLCBhIGRpYWdub3N0aWNzIGlzIGluIGZvcm1hdCBvZiB7QGxpbmsgRGlhZ25vc3RpY01lc3NhZ2V9LCBidXQgYWxzbyB3aXRoIHRyYWNlIG1lc3NhZ2VzLlxyXG4gKi9cclxuZXhwb3J0IHR5cGUgRGlhZ25vc3RpY3NGb3JtYXQgPSAnbm9uZScgfCAndW5peCcgfCAnZnVsbCc7XHJcblxyXG5leHBvcnQgdHlwZSBEaWFnbm9zdGljc0RhdGEgPSB7XHJcbiAgbm9uZTogbmV2ZXI7XHJcbiAgdW5peDogc3RyaW5nO1xyXG4gIGZ1bGw6IERpYWdub3N0aWNNZXNzYWdlO1xyXG59O1xyXG5cclxuaW50ZXJmYWNlIENvbXBpbGVPcHRpb25zQ29tbW9uIHtcclxuICAvKipcclxuICAgKiBUaGUgcGF0aCBvZiB0aGUgbWFpbiBmaWxlLlxyXG4gICAqL1xyXG4gIG1haW5GaWxlUGF0aDogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIEFkZHMgYSBzdHJpbmcga2V5LXZhbHVlIHBhaXIgdmlzaWJsZSB0aHJvdWdoIGBzeXMuaW5wdXRzYFxyXG4gICAqXHJcbiAgICogTm90ZTogcGFzcyBge31gIHRvIGNsZWFyIGBzeXMuaW5wdXRzYFxyXG4gICAqXHJcbiAgICogTm90ZTogV2hlbiBwYXNzaW5nIGB1bmRlZmluZWRgLCBjb21waWxlciB3aWxsIHVzZSBsYXN0IHNldCBgc3lzLmlucHV0c2AuXHJcbiAgICpcclxuICAgKiBOb3RlOiBUaGlzIG1lYW5zIHlvdSBzaG91bGQgYWx3YXlzIHNwZWNpZnkgaW5wdXRzIHdoZW4gdXNpbmcgY29tcGlsZXIgZm9yIGNvbmN1cnJlbnQgdGFza3MuXHJcbiAgICovXHJcbiAgaW5wdXRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcclxufVxyXG5cclxuaW50ZXJmYWNlIFRyYW5zaWVudENvbXBpbGVPcHRpb25zPFxyXG4gIEYgZXh0ZW5kcyBDb21waWxlRm9ybWF0ID0gYW55LFxyXG4gIERpYWdub3N0aWNzIGV4dGVuZHMgRGlhZ25vc3RpY3NGb3JtYXQgPSBEaWFnbm9zdGljc0Zvcm1hdCxcclxuPiBleHRlbmRzIENvbXBpbGVPcHRpb25zQ29tbW9uIHtcclxuICAvKipcclxuICAgKiBUaGUgZm9ybWF0IG9mIHRoZSBhcnRpZmFjdC5cclxuICAgKiAtICd2ZWN0b3InOiBjYW4gdGhlbiBsb2FkIHRvIHRoZSByZW5kZXJlciB0byByZW5kZXIgdGhlIGRvY3VtZW50LlxyXG4gICAqIC0gJ3BkZic6IGZvciBmaW5hbGx5IGV4cG9ydGluZyBwZGYgdG8gdGhlIHVzZXIuXHJcbiAgICogQGRlZmF1bHQgJ3ZlY3RvcidcclxuICAgKi9cclxuICBmb3JtYXQ/OiBGO1xyXG4gIC8qKlxyXG4gICAqIFdoZXRoZXIgdG8gaW5jbHVkZSBkaWFnbm9zdGljIGluZm9ybWF0aW9uIGluIHRoZSByZXN1bHQuXHJcbiAgICogTm90ZTogaXQgd2lsbCBiZSBzZXQgdG8gdHJ1ZSBieSBkZWZhdWx0IGluIHYwLjYuMFxyXG4gICAqIEBkZWZhdWx0IHVuZGVmaW5lZFxyXG4gICAqL1xyXG4gIGRpYWdub3N0aWNzOiBEaWFnbm9zdGljcztcclxufVxyXG5cclxuaW50ZXJmYWNlIEluY3JlbWVudGFsQ29tcGlsZU9wdGlvbnM8RGlhZ25vc3RpY3MgZXh0ZW5kcyBEaWFnbm9zdGljc0Zvcm1hdCA9IERpYWdub3N0aWNzRm9ybWF0PlxyXG4gIGV4dGVuZHMgQ29tcGlsZU9wdGlvbnNDb21tb24ge1xyXG4gIC8qKlxyXG4gICAqIFRoZSBmb3JtYXQgb2YgdGhlIGluY3JlbWVudGFsbHkgZXhwb3J0ZWQgYXJ0aWZhY3QuXHJcbiAgICogQGRlZmF1bHQgJ3ZlY3RvcidcclxuICAgKi9cclxuICBmb3JtYXQ/OiAndmVjdG9yJztcclxuICAvKipcclxuICAgKiBUaGUgaW5jcmVtZW50YWwgc2VydmVyIGZvciB0aGUgZG9jdW1lbnQuXHJcbiAgICovXHJcbiAgaW5jcmVtZW50YWxTZXJ2ZXI6IEluY3JlbWVudGFsU2VydmVyO1xyXG4gIC8qKlxyXG4gICAqIFdoZXRoZXIgdG8gaW5jbHVkZSBkaWFnbm9zdGljIGluZm9ybWF0aW9uIGluIHRoZSByZXN1bHQuXHJcbiAgICogTm90ZTogQmVmb3JlIHYwLjYuMCwgd2hlbiBkaWFnbm9zdGljcyBpcyBub3Qgc2V0LCB0aGUgcmVzdWx0IHdpbGwgYmUgYSBVaW50OEFycmF5LlxyXG4gICAqIEFmdGVyIHYwLjYuMCwgd2hlbiBkaWFnbm9zdGljcyBpcyBub3Qgc2V0LCB0aGUgcmVzdWx0IHdpbGwgYmUgYSBDb21waWxlUmVzdWx0PFVpbnQ4QXJyYXk+IHdpdGhvdXQgZGlhZ25vc3RpY3MuXHJcbiAgICogQGRlZmF1bHQgZmFsc2VcclxuICAgKi9cclxuICBkaWFnbm9zdGljczogRGlhZ25vc3RpY3M7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlPcHRpb25zIGV4dGVuZHMgQ29tcGlsZU9wdGlvbnNDb21tb24ge1xyXG4gIC8qKlxyXG4gICAqIHNlbGVjdCBwYXJ0IG9mIGRvY3VtZW50IGZvciBxdWVyeS5cclxuICAgKi9cclxuICBzZWxlY3Rvcjogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIGNhc3QgcmVzdWx0IGJ5IGFjY2Vzc2luZyBzaW5nbGUgZmllbGQuXHJcbiAgICovXHJcbiAgZmllbGQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUaGUgb3B0aW9ucyBmb3IgY29tcGlsaW5nIHRoZSBkb2N1bWVudC5cclxuICovXHJcbmV4cG9ydCB0eXBlIENvbXBpbGVPcHRpb25zPFxyXG4gIEZvcm1hdCBleHRlbmRzIENvbXBpbGVGb3JtYXQgPSBhbnksXHJcbiAgRGlhZ25vc3RpY3MgZXh0ZW5kcyBEaWFnbm9zdGljc0Zvcm1hdCA9IERpYWdub3N0aWNzRm9ybWF0LFxyXG4+ID0gVHJhbnNpZW50Q29tcGlsZU9wdGlvbnM8Rm9ybWF0LCBEaWFnbm9zdGljcz4gfCBJbmNyZW1lbnRhbENvbXBpbGVPcHRpb25zO1xyXG5cclxuZXhwb3J0IGNsYXNzIEluY3JlbWVudGFsU2VydmVyIHtcclxuICAvKipcclxuICAgKiBAaW50ZXJuYWxcclxuICAgKi9cclxuICBba09iamVjdF06IHR5cHN0LkluY3JTZXJ2ZXI7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBpbnRlcm5hbFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHM6IHR5cHN0LkluY3JTZXJ2ZXIpIHtcclxuICAgIHRoaXNba09iamVjdF0gPSBzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXQgdGhlIGluY3JlbWVudGFsIHNlcnZlciB0byB0aGUgaW5pdGlhbCBzdGF0ZS5cclxuICAgKi9cclxuICByZXNldCgpOiB2b2lkIHtcclxuICAgIHRoaXNba09iamVjdF0ucmVzZXQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybiBjdXJyZW50IHJlc3VsdC5cclxuICAgKi9cclxuICBjdXJyZW50KCk6IFVpbnQ4QXJyYXkgfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuIHRoaXNba09iamVjdF0uY3VycmVudCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWxzbyBhdHRhY2ggdGhlIGRlYnVnIGluZm8gdG8gdGhlIHJlc3VsdC5cclxuICAgKi9cclxuICBzZXRBdHRhY2hEZWJ1Z0luZm8oZW5hYmxlOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICB0aGlzW2tPYmplY3RdLnNldF9hdHRhY2hfZGVidWdfaW5mbyhlbmFibGUpO1xyXG4gIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIENvbXBpbGVSZXN1bHQ8VCwgRCBleHRlbmRzIERpYWdub3N0aWNzRm9ybWF0PiB7XHJcbiAgcmVzdWx0PzogVDtcclxuICBkaWFnbm9zdGljcz86IERpYWdub3N0aWNzRGF0YVtEXVtdO1xyXG59XHJcblxyXG4vKipcclxuICogVGhlIGludGVyZmFjZSBvZiBUeXBzdCBjb21waWxlci5cclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgVHlwc3RDb21waWxlciB7XHJcbiAgLyoqXHJcbiAgICogSW5pdGlhbGl6ZSB0aGUgdHlwc3QgY29tcGlsZXIuXHJcbiAgICogQHBhcmFtIHtQYXJ0aWFsPEluaXRPcHRpb25zPn0gb3B0aW9ucyAtIFRoZSBvcHRpb25zIGZvciBpbml0aWFsaXppbmcgdGhlXHJcbiAgICogdHlwc3QgY29tcGlsZXIuXHJcbiAgICovXHJcbiAgaW5pdChvcHRpb25zPzogUGFydGlhbDxJbml0T3B0aW9ucz4pOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICAvKipcclxuICAgKiBSZXNldCB0aGUgdHlwc3QgY29tcGlsZXIgdG8gdGhlIGluaXRpYWwgc3RhdGUuXHJcbiAgICogTm90ZTogd2l0aG91dCBjYWxsaW5nIHRoaXMgZnVuY3Rpb24sIHRoZSBjb21waWxlciB3aWxsIGFsd2F5cyBrZWVwIGNhY2hlc1xyXG4gICAqIHN1Y2ggYXM6XHJcbiAgICogLSBsb2FkZWQgZm9udHNcclxuICAgKiAtIHNvdXJjZSBmaWxlcyBjb3JyZXNwb25kaW5nIHRvIHR5cHN0IG1vZHVsZXNcclxuICAgKlxyXG4gICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgaW5kZXBlbmRlbnQgdG8gdGhlIHtAbGluayByZXNldFNoYWRvd30gZnVuY3Rpb24uXHJcbiAgICogVGhpcyBpcyBpbnRlbmRlZCB0byBvcHRpbWl6ZSB0aGUgcGVyZm9ybWFuY2Ugb2YgdGhlIGNvbXBpbGVyLlxyXG4gICAqL1xyXG4gIHJlc2V0KCk6IFByb21pc2U8dm9pZD47XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbXBpbGUgYW4gZG9jdW1lbnQgd2l0aCB0aGUgbWFpbnRhaW5lZCBzdGF0ZS5cclxuICAgKiBAcGFyYW0ge0NvbXBpbGVPcHRpb25zfSBvcHRpb25zIC0gVGhlIG9wdGlvbnMgZm9yIGNvbXBpbGluZyB0aGUgZG9jdW1lbnQuXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8VWludDhBcnJheT59IC0gYXJ0aWZhY3QgaW4gdmVjdG9yIGZvcm1hdC5cclxuICAgKiBZb3UgY2FuIHRoZW4gbG9hZCB0aGUgYXJ0aWZhY3QgdG8gdGhlIHJlbmRlcmVyIHRvIHJlbmRlciB0aGUgZG9jdW1lbnQuXHJcbiAgICovXHJcbiAgY29tcGlsZTxEIGV4dGVuZHMgRGlhZ25vc3RpY3NGb3JtYXQ+KFxyXG4gICAgb3B0aW9uczogQ29tcGlsZU9wdGlvbnM8J3ZlY3RvcicsIEQ+LFxyXG4gICk6IFByb21pc2U8Q29tcGlsZVJlc3VsdDxVaW50OEFycmF5LCBEPj47XHJcbiAgY29tcGlsZTxEIGV4dGVuZHMgRGlhZ25vc3RpY3NGb3JtYXQ+KFxyXG4gICAgb3B0aW9uczogQ29tcGlsZU9wdGlvbnM8J3BkZicsIEQ+LFxyXG4gICk6IFByb21pc2U8Q29tcGlsZVJlc3VsdDxVaW50OEFycmF5LCBEPj47XHJcbiAgY29tcGlsZTxEIGV4dGVuZHMgRGlhZ25vc3RpY3NGb3JtYXQ+KFxyXG4gICAgb3B0aW9uczogQ29tcGlsZU9wdGlvbnM8YW55LCBEPixcclxuICApOiBQcm9taXNlPENvbXBpbGVSZXN1bHQ8VWludDhBcnJheSwgRD4+O1xyXG5cclxuICAvKipcclxuICAgKiBleHBlcmltZW50YWxcclxuICAgKiBRdWVyeSB0aGUgcmVzdWx0IHdpdGggZG9jdW1lbnRcclxuICAgKi9cclxuICBxdWVyeTxUPihvcHRpb25zOiBRdWVyeU9wdGlvbnMpOiBQcm9taXNlPFQ+O1xyXG5cclxuICAvKipcclxuICAgKiBQcmludCB0aGUgQVNUIG9mIHRoZSBtYWluIGZpbGUuXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG1haW5GaWxlUGF0aCAtIFRoZSBwYXRoIG9mIHRoZSBtYWluIGZpbGUuXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gLSBhbiBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIEFTVC5cclxuICAgKi9cclxuICBnZXRBc3QobWFpbkZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz47XHJcblxyXG4gIC8qKlxyXG4gICAqIEFkZCBhIHNvdXJjZSBmaWxlIHRvIHRoZSBjb21waWxlci5cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIFRoZSBwYXRoIG9mIHRoZSBzb3VyY2UgZmlsZS5cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gc291cmNlIC0gVGhlIHNvdXJjZSBjb2RlIG9mIHRoZSBzb3VyY2UgZmlsZS5cclxuICAgKlxyXG4gICAqL1xyXG4gIGFkZFNvdXJjZShwYXRoOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nKTogdm9pZDtcclxuXHJcbiAgLyoqXHJcbiAgICogQWRkIGEgc2hhZG93IGZpbGUgdG8gdGhlIGNvbXBpbGVyLlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIC0gVGhlIHBhdGggdG8gdGhlIHNoYWRvdyBmaWxlLlxyXG4gICAqIEBwYXJhbSB7VWludDhBcnJheX0gY29udGVudCAtIFRoZSBjb250ZW50IG9mIHRoZSBzaGFkb3cgZmlsZS5cclxuICAgKlxyXG4gICAqL1xyXG4gIG1hcFNoYWRvdyhwYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IFVpbnQ4QXJyYXkpOiB2b2lkO1xyXG5cclxuICAvKipcclxuICAgKiBSZW1vdmUgYSBzaGFkb3cgZmlsZSBmcm9tIHRoZSBjb21waWxlci5cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIFRoZSBwYXRoIHRvIHRoZSBzaGFkb3cgZmlsZS5cclxuICAgKi9cclxuICB1bm1hcFNoYWRvdyhwYXRoOiBzdHJpbmcpOiB2b2lkO1xyXG5cclxuICAvKipcclxuICAgKiBSZXNldCB0aGUgc2hhZG93IGZpbGVzLlxyXG4gICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgaW5kZXBlbmRlbnQgdG8gdGhlIHtAbGluayByZXNldH0gZnVuY3Rpb24uXHJcbiAgICovXHJcbiAgcmVzZXRTaGFkb3coKTogdm9pZDtcclxuXHJcbiAgLyoqXHJcbiAgICogZXhwZXJpbWVudGFsXHJcbiAgICogU2VlIFNlbWFudGljIHRva2VuczogaHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC92c2NvZGUvaXNzdWVzLzg2NDE1XHJcbiAgICovXHJcbiAgZ2V0U2VtYW50aWNUb2tlbkxlZ2VuZCgpOiBQcm9taXNlPFNlbWFudGljVG9rZW5zTGVnZW5kPjtcclxuXHJcbiAgLyoqXHJcbiAgICogZXhwZXJpbWVudGFsXHJcbiAgICogU2VlIFNlbWFudGljIHRva2VuczogaHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC92c2NvZGUvaXNzdWVzLzg2NDE1XHJcbiAgICpcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5tYWluRmlsZVBhdGggLSBUaGUgcGF0aCBvZiB0aGUgbWFpbiBmaWxlLlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRzLnJlc3VsdElkIC0gVGhlIGlkIG9mIHRoZSByZXN1bHQuXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdHMub2Zmc2V0RW5jb2RpbmcgLSBUaGUgZW5jb2Rpbmcgb2YgdGhlIG9mZnNldC5cclxuICAgKiAgIC0gJ3V0Zi0xNic6IHRoZSBvZmZzZXQgaXMgZW5jb2RlZCBpbiB1dGYtMTYuXHJcbiAgICogICAtICd1dGYtOCc6IHRoZSBvZmZzZXQgaXMgZW5jb2RlZCBpbiB1dGYtOC5cclxuICAgKiAgIEBkZWZhdWx0ICd1dGYtMTYnXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8U2VtYW50aWNUb2tlbnM+fSAtIFRoZSBzZW1hbnRpYyB0b2tlbnMuXHJcbiAgICovXHJcbiAgZ2V0U2VtYW50aWNUb2tlbnMob3B0czoge1xyXG4gICAgbWFpbkZpbGVQYXRoOiBzdHJpbmc7XHJcbiAgICByZXN1bHRJZD86IHN0cmluZztcclxuICAgIG9mZnNldEVuY29kaW5nPzogc3RyaW5nO1xyXG4gIH0pOiBQcm9taXNlPFNlbWFudGljVG9rZW5zPjtcclxuXHJcbiAgLyoqXHJcbiAgICogZXhwZXJpbWVudGFsXHJcbiAgICogUnVuIHdpdGggYW4gaW5jcmVtZW50YWwgc2VydmVyIHdoaWNoIGhvbGRzIHRoZSBzdGF0ZSBvZiB0aGUgZG9jdW1lbnQgaW4gd2FzbS5cclxuICAgKlxyXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb24oSW5jcmVtZW50YWxTZXJ2ZXIpOiBQcm9taXNlPFQ+fSBmIC0gVGhlIGZ1bmN0aW9uIHRvIHJ1biB3aXRoIHRoZSBpbmNyZW1lbnRhbCBzZXJ2ZXIuXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8VD59IC0gVGhlIHJlc3VsdCBvZiB0aGUgZnVuY3Rpb24uXHJcbiAgICpcclxuICAgKiBOb3RlOiB0aGUgaW5jcmVtZW50YWwgc2VydmVyIHdpbGwgYmUgZnJlZWQgYWZ0ZXIgdGhlIGZ1bmN0aW9uIGlzIGZpbmlzaGVkLlxyXG4gICAqL1xyXG4gIHdpdGhJbmNyZW1lbnRhbFNlcnZlcjxUPihmOiAoczogSW5jcmVtZW50YWxTZXJ2ZXIpID0+IFByb21pc2U8VD4pOiBQcm9taXNlPFQ+O1xyXG59XHJcblxyXG5jb25zdCBnQ29tcGlsZXJNb2R1bGUgPSBuZXcgTGF6eVdhc21Nb2R1bGUoYXN5bmMgKGJpbj86IGFueSkgPT4ge1xyXG4gIGNvbnN0IG1vZHVsZSA9IGF3YWl0IGltcG9ydCgnQG15cmlhZGRyZWFtaW4vdHlwc3QtdHMtd2ViLWNvbXBpbGVyL3BrZy93YXNtLXBhY2stc2hpbS5tanMnKTtcclxuICByZXR1cm4gYXdhaXQgbW9kdWxlLmRlZmF1bHQoYmluKTtcclxufSk7XHJcblxyXG4vKipcclxuICogY3JlYXRlIGEgVHlwc3QgY29tcGlsZXIuXHJcbiAqIEByZXR1cm5zIHtUeXBzdENvbXBpbGVyfSAtIFRoZSBUeXBzdCBjb21waWxlci5cclxuICogQGV4YW1wbGVcclxuICogYGBgdHlwZXNjcmlwdFxyXG4gKiBpbXBvcnQgeyBjcmVhdGVUeXBzdENvbXBpbGVyIH0gZnJvbSAndHlwc3QnO1xyXG4gKiBjb25zdCBjb21waWxlciA9IGNyZWF0ZVR5cHN0Q29tcGlsZXIoKTtcclxuICogYXdhaXQgY29tcGlsZXIuaW5pdCgpO1xyXG4gKiBjb21waWxlci5hZGRTb3VyY2UoJy9tYWluLnR5cCcsICdIZWxsbywgdHlwc3QhJyk7XHJcbiAqIGF3YWl0IGNvbXBpbGVyLmNvbXBpbGUoeyBtYWluRmlsZVBhdGg6ICcvbWFpbi50eXAnIH0pO1xyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVUeXBzdENvbXBpbGVyKCk6IFR5cHN0Q29tcGlsZXIge1xyXG4gIHJldHVybiBuZXcgVHlwc3RDb21waWxlckRyaXZlcigpO1xyXG59XHJcblxyXG5jbGFzcyBUeXBzdENvbXBpbGVyRHJpdmVyIHtcclxuICBjb21waWxlcjogdHlwc3QuVHlwc3RDb21waWxlcjtcclxuICBjb21waWxlckpzOiB0eXBlb2YgdHlwc3Q7XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge31cclxuXHJcbiAgYXN5bmMgaW5pdChvcHRpb25zPzogUGFydGlhbDxJbml0T3B0aW9ucz4pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRoaXMuY29tcGlsZXJKcyA9IGF3YWl0IGltcG9ydCgnQG15cmlhZGRyZWFtaW4vdHlwc3QtdHMtd2ViLWNvbXBpbGVyL3BrZy93YXNtLXBhY2stc2hpbS5tanMnKTtcclxuICAgIGNvbnN0IFR5cHN0Q29tcGlsZXJCdWlsZGVyID0gdGhpcy5jb21waWxlckpzLlR5cHN0Q29tcGlsZXJCdWlsZGVyO1xyXG5cclxuICAgIGNvbnN0IGNvbXBpbGVyT3B0aW9ucyA9IHsgLi4uKG9wdGlvbnMgfHwge30pIH07XHJcbiAgICBjb25zdCBoYXNQcmVsb2FkUmVtb3RlRm9udHMgPSBjb21waWxlck9wdGlvbnMuYmVmb3JlQnVpbGQ/LnNvbWUoXHJcbiAgICAgIChmbjogYW55KSA9PiBmbi5fcHJlbG9hZFJlbW90ZUZvbnRPcHRpb25zICE9PSB1bmRlZmluZWQsXHJcbiAgICApO1xyXG4gICAgY29uc3QgaGFzU3BlY2lmaWVkQXNzZXRzID0gY29tcGlsZXJPcHRpb25zLmJlZm9yZUJ1aWxkPy5zb21lKFxyXG4gICAgICAoZm46IGFueSkgPT4gZm4uX3ByZWxvYWRSZW1vdGVGb250T3B0aW9ucz8uYXNzZXRzICE9PSB1bmRlZmluZWQsXHJcbiAgICApO1xyXG4gICAgY29uc3QgaGFzRGlzYWJsZUFzc2V0cyA9IGNvbXBpbGVyT3B0aW9ucy5iZWZvcmVCdWlsZD8uc29tZShcclxuICAgICAgKGZuOiBhbnkpID0+IGZuLl9wcmVsb2FkUmVtb3RlRm9udE9wdGlvbnM/LmFzc2V0cyA9PT0gZmFsc2UsXHJcbiAgICApO1xyXG5cclxuICAgIGlmICghaGFzUHJlbG9hZFJlbW90ZUZvbnRzIHx8ICghaGFzU3BlY2lmaWVkQXNzZXRzICYmICFoYXNEaXNhYmxlQXNzZXRzKSkge1xyXG4gICAgICBjb21waWxlck9wdGlvbnMuYmVmb3JlQnVpbGQ/LnB1c2goXHJcbiAgICAgICAgcHJlbG9hZFJlbW90ZUZvbnRzKFtdLCB7XHJcbiAgICAgICAgICBhc3NldHM6IFsndGV4dCddLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY29tcGlsZXIgPSBhd2FpdCBidWlsZENvbXBvbmVudChvcHRpb25zLCBnQ29tcGlsZXJNb2R1bGUsIFR5cHN0Q29tcGlsZXJCdWlsZGVyLCB7fSk7XHJcbiAgfVxyXG5cclxuICBjb21waWxlKG9wdGlvbnM6IENvbXBpbGVPcHRpb25zKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcclxuICAgICAgaWYgKCdpbmNyZW1lbnRhbFNlcnZlcicgaW4gb3B0aW9ucykge1xyXG4gICAgICAgIHJlc29sdmUoXHJcbiAgICAgICAgICB0aGlzLmNvbXBpbGVyLmluY3JfY29tcGlsZShcclxuICAgICAgICAgICAgb3B0aW9ucy5tYWluRmlsZVBhdGgsXHJcbiAgICAgICAgICAgIGNvbnZlcnRJbnB1dHMob3B0aW9ucy5pbnB1dHMpLFxyXG4gICAgICAgICAgICBvcHRpb25zLmluY3JlbWVudGFsU2VydmVyW2tPYmplY3RdLFxyXG4gICAgICAgICAgICBnZXREaWFnbm9zdGljc0FyZyhvcHRpb25zLmRpYWdub3N0aWNzKSxcclxuICAgICAgICAgICksXHJcbiAgICAgICAgKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgcmVzb2x2ZShcclxuICAgICAgICB0aGlzLmNvbXBpbGVyLmNvbXBpbGUoXHJcbiAgICAgICAgICBvcHRpb25zLm1haW5GaWxlUGF0aCxcclxuICAgICAgICAgIGNvbnZlcnRJbnB1dHMob3B0aW9ucy5pbnB1dHMpLFxyXG4gICAgICAgICAgb3B0aW9ucy5mb3JtYXQgfHwgJ3ZlY3RvcicsXHJcbiAgICAgICAgICBnZXREaWFnbm9zdGljc0FyZyhvcHRpb25zLmRpYWdub3N0aWNzKSxcclxuICAgICAgICApLFxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBxdWVyeShvcHRpb25zOiBRdWVyeU9wdGlvbnMpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4ocmVzb2x2ZSA9PiB7XHJcbiAgICAgIHJlc29sdmUoXHJcbiAgICAgICAgSlNPTi5wYXJzZShcclxuICAgICAgICAgIHRoaXMuY29tcGlsZXIucXVlcnkoXHJcbiAgICAgICAgICAgIG9wdGlvbnMubWFpbkZpbGVQYXRoLFxyXG4gICAgICAgICAgICBjb252ZXJ0SW5wdXRzKG9wdGlvbnMuaW5wdXRzKSxcclxuICAgICAgICAgICAgb3B0aW9ucy5zZWxlY3RvcixcclxuICAgICAgICAgICAgb3B0aW9ucy5maWVsZCxcclxuICAgICAgICAgICksXHJcbiAgICAgICAgKSxcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0U2VtYW50aWNUb2tlbkxlZ2VuZCgpOiBQcm9taXNlPFNlbWFudGljVG9rZW5zTGVnZW5kPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8U2VtYW50aWNUb2tlbnNMZWdlbmQ+KHJlc29sdmUgPT4ge1xyXG4gICAgICByZXNvbHZlKHRoaXMuY29tcGlsZXIuZ2V0X3NlbWFudGljX3Rva2VuX2xlZ2VuZCgpKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0U2VtYW50aWNUb2tlbnMob3B0czoge1xyXG4gICAgbWFpbkZpbGVQYXRoOiBzdHJpbmc7XHJcbiAgICByZXN1bHRJZD86IHN0cmluZztcclxuICAgIG9mZnNldEVuY29kaW5nPzogc3RyaW5nO1xyXG4gIH0pOiBQcm9taXNlPFNlbWFudGljVG9rZW5zPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8U2VtYW50aWNUb2tlbnM+KHJlc29sdmUgPT4ge1xyXG4gICAgICB0aGlzLmNvbXBpbGVyLnJlc2V0KCk7XHJcbiAgICAgIHJlc29sdmUoXHJcbiAgICAgICAgdGhpcy5jb21waWxlci5nZXRfc2VtYW50aWNfdG9rZW5zKFxyXG4gICAgICAgICAgb3B0cy5vZmZzZXRFbmNvZGluZyB8fCAndXRmLTE2JyxcclxuICAgICAgICAgIG9wdHMubWFpbkZpbGVQYXRoLFxyXG4gICAgICAgICAgb3B0cy5yZXN1bHRJZCxcclxuICAgICAgICApIGFzIGFueSxcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgd2l0aEluY3JlbWVudGFsU2VydmVyPFQ+KGY6IChzOiBJbmNyZW1lbnRhbFNlcnZlcikgPT4gUHJvbWlzZTxUPik6IFByb21pc2U8VD4ge1xyXG4gICAgY29uc3Qgc3J2ID0gbmV3IEluY3JlbWVudGFsU2VydmVyKHRoaXMuY29tcGlsZXIuY3JlYXRlX2luY3Jfc2VydmVyKCkpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIGF3YWl0IGYoc3J2KTtcclxuICAgIH0gZmluYWxseSB7XHJcbiAgICAgIHNydltrT2JqZWN0XS5mcmVlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRBc3QobWFpbkZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZXIuZ2V0X2FzdChtYWluRmlsZVBhdGgpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgcmVzZXQoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPihyZXNvbHZlID0+IHtcclxuICAgICAgdGhpcy5jb21waWxlci5yZXNldCgpO1xyXG4gICAgICByZXNvbHZlKHVuZGVmaW5lZCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGFkZFNvdXJjZShwYXRoOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICd1c2Ugb2YgYWRkU291cmNlKHBhdGgsIHNvdXJjZSwgaXNNYWluKSBpcyBkZXByZWNhdGVkLCBwbGVhc2UgdXNlIGFkZFNvdXJjZShwYXRoLCBzb3VyY2UpIGluc3RlYWQnLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY29tcGlsZXIuYWRkX3NvdXJjZShwYXRoLCBzb3VyY2UpO1xyXG4gIH1cclxuXHJcbiAgbWFwU2hhZG93KHBhdGg6IHN0cmluZywgY29udGVudDogVWludDhBcnJheSk6IHZvaWQge1xyXG4gICAgdGhpcy5jb21waWxlci5tYXBfc2hhZG93KHBhdGgsIGNvbnRlbnQpO1xyXG4gIH1cclxuXHJcbiAgdW5tYXBTaGFkb3cocGF0aDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLmNvbXBpbGVyLnVubWFwX3NoYWRvdyhwYXRoKTtcclxuICB9XHJcblxyXG4gIHJlc2V0U2hhZG93KCk6IHZvaWQge1xyXG4gICAgdGhpcy5jb21waWxlci5yZXNldF9zaGFkb3coKTtcclxuICB9XHJcblxyXG4gIHJlbmRlclBhZ2VUb0NhbnZhcygpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdQbGVhc2UgdXNlIHRoZSBhcGkgVHlwc3RSZW5kZXJlci5yZW5kZXJUb0NhbnZhcyBpbiB2MC40LjAnKTtcclxuICB9XHJcbn1cclxuXHJcbi8vIHRvZG86IGNhY2hpbmcgaW5wdXRzXHJcbmZ1bmN0aW9uIGNvbnZlcnRJbnB1dHMoaW5wdXRzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPik6IFtzdHJpbmcsIHN0cmluZ11bXSB8IHVuZGVmaW5lZCB7XHJcbiAgcmV0dXJuIGlucHV0cyA/IE9iamVjdC5lbnRyaWVzKGlucHV0cykgOiB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldERpYWdub3N0aWNzQXJnKGRpYWdub3N0aWNzOiBzdHJpbmcgfCB1bmRlZmluZWQpOiBudW1iZXIge1xyXG4gIHN3aXRjaCAoZGlhZ25vc3RpY3MpIHtcclxuICAgIGNhc2UgJ25vbmUnOlxyXG4gICAgICByZXR1cm4gMTtcclxuICAgIGNhc2UgJ3VuaXgnOlxyXG4gICAgICByZXR1cm4gMjtcclxuICAgIGNhc2UgJ2Z1bGwnOlxyXG4gICAgICByZXR1cm4gMztcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgIHJldHVybiAwO1xyXG4gIH1cclxufVxyXG4iXX0=