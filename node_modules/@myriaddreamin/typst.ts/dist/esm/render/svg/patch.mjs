/// Semantic attributes attached to SVG elements.
var TypstSvgAttrs;
(function (TypstSvgAttrs) {
    /// The data-tid attribute is used to identify the element.
    /// It is used to compare two elements.
    ///
    /// At most time, the data-tid is exactly their content hash.
    /// A disambiguation suffix is added when the content hash is not unique.
    TypstSvgAttrs["Tid"] = "data-tid";
    /// The data-reuse attribute is used to this element is reused from specified element.
    /// The attribute content is the data-tid of the element.
    TypstSvgAttrs["ReuseFrom"] = "data-reuse-from";
})(TypstSvgAttrs || (TypstSvgAttrs = {}));
/// Predicate that a xml element is a `<g>` element.
function isGElem(node) {
    return node.tagName === 'g';
}
/// Compare two elements by their data-tid attribute.
function equalElem(prev, next) {
    const prevDataTid = prev.getAttribute(TypstSvgAttrs.Tid);
    const nextDataTid = next.getAttribute(TypstSvgAttrs.Tid);
    return prevDataTid && prevDataTid === nextDataTid;
}
/// Interpret the transform between origin sequence and target sequence.
export function interpretTargetView(originChildren, targetChildren, tIsU = (_x) => true) {
    const availableOwnedResource = new Map();
    const targetView = [];
    for (let i = 0; i < originChildren.length; i++) {
        const prevChild = originChildren[i];
        if (!tIsU(prevChild)) {
            continue;
        }
        const data_tid = prevChild.getAttribute(TypstSvgAttrs.Tid);
        if (!data_tid) {
            targetView.push(['remove', i]);
            continue;
        }
        if (!availableOwnedResource.has(data_tid)) {
            availableOwnedResource.set(data_tid, [prevChild, []]);
        }
        availableOwnedResource.get(data_tid)[1].push(i);
    }
    const toPatch = [];
    for (let i = 0; i < targetChildren.length; i++) {
        const nextChild = targetChildren[i];
        if (!tIsU(nextChild)) {
            continue;
        }
        const nextDataTid = nextChild.getAttribute(TypstSvgAttrs.Tid);
        if (!nextDataTid) {
            throw new Error('not data tid for reusing g element for ' + nextDataTid);
        }
        const reuseTargetTid = nextChild.getAttribute(TypstSvgAttrs.ReuseFrom);
        if (!reuseTargetTid) {
            targetView.push(['append', nextChild]);
            continue;
        }
        if (!availableOwnedResource.has(reuseTargetTid)) {
            throw new Error('no available resource for reuse ' + reuseTargetTid);
        }
        const rsrc = availableOwnedResource.get(reuseTargetTid);
        const prevIdx = rsrc[1].shift();
        /// no available resource
        if (prevIdx === undefined) {
            /// clean one is reused directly
            if (nextDataTid === reuseTargetTid) {
                const clonedNode = rsrc[0].cloneNode(true);
                toPatch.push([clonedNode, nextChild]);
                targetView.push(['append', clonedNode]);
            }
            else {
                targetView.push(['append', nextChild]);
            }
            continue;
        }
        /// dirty one should be patched and reused
        toPatch.push([originChildren[prevIdx], nextChild]);
        targetView.push(['reuse', prevIdx]);
    }
    for (let [_, unusedIndices] of availableOwnedResource.values()) {
        for (let unused of unusedIndices) {
            targetView.push(['remove', unused]);
        }
    }
    return [targetView, toPatch];
}
/// Change a sequence of target view instructions to the origin ones.
/// Currently, it applies a greedy strategy.
/// + First, it applies all remove instructions.
/// + Then, it applies the swap ones.
/// + Finally, it inserts the extra elements.
///
/// Some better strategy would help and be implemented in future.
export function changeViewPerspective(originChildren, targetView, tIsU = (_x) => true) {
    const originView = [];
    /// see remove instructions
    let removeIndices = [];
    for (let inst of targetView) {
        if (inst[0] === 'remove') {
            removeIndices.push(inst[1]);
        }
    }
    removeIndices = removeIndices.sort((a, b) => a - b);
    const removeShift = [];
    /// apply remove instructions and get effect
    {
        let r = 0;
        for (let i = 0; i < removeIndices.length; i++) {
            while (r < removeIndices[i]) {
                removeShift.push(r - i);
                r++;
            }
            removeShift.push(undefined);
            originView.push(['remove', removeIndices[i] - i]);
            r++;
        }
        while (r <= originChildren.length) {
            removeShift.push(r - removeIndices.length);
            r++;
        }
    }
    // console.log(removeIndices, removeShift);
    /// get shift considering remove effects
    const getShift = (off) => {
        if (off >= removeShift.length || removeShift[off] === undefined) {
            throw new Error(`invalid offset ${off} for getShift ${removeShift}`);
        }
        return removeShift[off];
    };
    /// variables used by `interpretOriginView`
    /// scanning the target view
    let targetViewCursor = 0;
    /// the append effect
    let appendOffset = 0;
    /// converted append instructions.
    const swapIns = [];
    /// converted append instructions.
    const inserts = [];
    /// apply append and reuse instructions till the offset of origin sequence.
    const interpretOriginView = (off) => {
        // console.log(off, getShift(off));
        off = getShift(off);
        while (targetViewCursor < targetView.length) {
            let done = false;
            const inst = targetView[targetViewCursor];
            switch (inst[0]) {
                case 'append':
                    inserts.push(['insert', appendOffset, inst[1]]);
                    appendOffset++;
                    break;
                case 'reuse':
                    const target_off = getShift(inst[1]);
                    swapIns.push(target_off);
                    appendOffset++;
                    break;
                // case "remove":
                default:
                    break;
            }
            targetViewCursor++;
            if (done) {
                break;
            }
        }
    };
    /// scanning the origin view
    for (let off = 0; off < originChildren.length; off++) {
        const prevChild = originChildren[off];
        if (removeShift[off] === undefined) {
            continue;
        }
        // keep position of unpredictable elements
        if (!tIsU(prevChild)) {
            const target_off = getShift(off);
            swapIns.push(target_off);
            continue;
        }
        interpretOriginView(off);
    }
    interpretOriginView(originChildren.length);
    const simulated = [];
    for (let i = 0; i < swapIns.length; i++) {
        simulated.push(i);
    }
    for (let i = 0; i < swapIns.length; i++) {
        const off = swapIns[i];
        for (let j = 0; j < simulated.length; j++) {
            if (simulated[j] === off) {
                // console.log("swap_in", j, i, simulated);
                simulated.splice(j, 1);
                if (i <= j) {
                    simulated.splice(i, 0, off);
                }
                else {
                    simulated.splice(i + 1, 0, off);
                }
                if (j !== i) {
                    originView.push(['swap_in', i, j]);
                    // console.log("swap_in then", j, i, simulated);
                }
                break;
            }
        }
    }
    return [...originView, ...inserts];
}
function runOriginViewInstructions(prev, originView) {
    // console.log("interpreted origin view", originView);
    for (const [op, off, fr] of originView) {
        switch (op) {
            case 'insert':
                prev.insertBefore(fr, prev.children[off]);
                break;
            case 'swap_in':
                prev.insertBefore(prev.children[fr], prev.children[off]);
                break;
            case 'remove':
                prev.children[off].remove();
                break;
            default:
                throw new Error('unknown op ' + op);
        }
    }
}
/// End of View Interpretation
/// Begin of Recursive Svg Patch
/// Patch the `prev <svg>` in the DOM according to `next <svg>` from the backend.
export function patchRoot(prev, next) {
    /// Patch attributes
    patchAttributes(prev, next);
    /// Patch global svg resources
    patchSvgHeader(prev, next);
    /// Patch `<g>` children, call `reuseOrPatchElem` to patch.
    patchChildren(prev, next);
    return;
    function patchSvgHeader(prev, next) {
        for (let i = 0; i < 3; i++) {
            const prevChild = prev.children[i];
            const nextChild = next.children[i];
            // console.log("prev", prevChild);
            // console.log("next", nextChild);
            if (prevChild.tagName === 'defs') {
                if (prevChild.getAttribute('class') === 'glyph') {
                    // console.log("append glyphs:", nextChild.children, "to", prevChild);
                    prevChild.append(...nextChild.children);
                }
                else if (prevChild.getAttribute('class') === 'clip-path') {
                    // console.log("clip path: replace");
                    // todo: gc
                    prevChild.append(...nextChild.children);
                }
            }
            else if (prevChild.tagName === 'style' && nextChild.getAttribute('data-reuse') !== '1') {
                // console.log("replace extra style", prevChild, nextChild);
                // todo: gc
                if (nextChild.textContent) {
                    // todo: looks slow
                    // https://stackoverflow.com/questions/3326494/parsing-css-in-javascript-jquery
                    var doc = document.implementation.createHTMLDocument(''), styleElement = document.createElement('style');
                    styleElement.textContent = nextChild.textContent;
                    // the style will only be parsed once it is added to a document
                    doc.body.appendChild(styleElement);
                    const currentSvgSheet = prevChild.sheet;
                    const rulesToInsert = styleElement.sheet?.cssRules || [];
                    // console.log("rules to insert", currentSvgSheet, rulesToInsert);
                    for (const rule of rulesToInsert) {
                        currentSvgSheet.insertRule(rule.cssText);
                    }
                }
            }
        }
    }
}
/// apply attribute patches to the `prev <svg or g>` element
function patchAttributes(prev, next) {
    const prevAttrs = prev.attributes;
    const nextAttrs = next.attributes;
    if (prevAttrs.length === nextAttrs.length) {
        let same = true;
        for (let i = 0; i < prevAttrs.length; i++) {
            const prevAttr = prevAttrs[i];
            const nextAttr = nextAttrs.getNamedItem(prevAttr.name);
            if (nextAttr === null || prevAttr.value !== nextAttr.value) {
                same = false;
                break;
            }
        }
        if (same) {
            // console.log("same attributes, skip");
            return;
        }
    }
    // console.log("different attributes, replace");
    const removedAttrs = [];
    for (let i = 0; i < prevAttrs.length; i++) {
        removedAttrs.push(prevAttrs[i].name);
    }
    for (const attr of removedAttrs) {
        prev.removeAttribute(attr);
    }
    for (let i = 0; i < nextAttrs.length; i++) {
        prev.setAttribute(nextAttrs[i].name, nextAttrs[i].value);
    }
}
/// apply patches to the children sequence of `prev <svg or g>` in the DOM
function patchChildren(prev, next) {
    const [targetView, toPatch] = interpretTargetView(prev.children, next.children, isGElem);
    for (let [prevChild, nextChild] of toPatch) {
        reuseOrPatchElem(prevChild, nextChild);
    }
    // console.log("interpreted target view", targetView);
    const originView = changeViewPerspective(prev.children, targetView, isGElem);
    runOriginViewInstructions(prev, originView);
}
/// Replace the `prev` element with `next` element.
/// Return true if the `prev` element is reused.
/// Return false if the `prev` element is replaced.
function reuseOrPatchElem(prev, next) {
    const canReuse = equalElem(prev, next);
    /// Even if the element is reused, we still need to replace its attributes.
    next.removeAttribute(TypstSvgAttrs.ReuseFrom);
    patchAttributes(prev, next);
    if (canReuse) {
        return true /* reused */;
    }
    /// Hard replace elements that is not a `<g>` element.
    replaceNonSVGElements(prev, next);
    /// Patch `<g>` children, will call `reuseOrPatchElem` again.
    patchChildren(prev, next);
    return false /* reused */;
    function replaceNonSVGElements(prev, next) {
        const removedIndecies = [];
        for (let i = 0; i < prev.children.length; i++) {
            const prevChild = prev.children[i];
            if (!isGElem(prevChild)) {
                removedIndecies.push(i);
            }
        }
        for (const index of removedIndecies.reverse()) {
            prev.children[index].remove();
        }
        for (let i = 0; i < next.children.length; i++) {
            const nextChild = next.children[i];
            if (!isGElem(nextChild)) {
                prev.appendChild(nextChild.cloneNode(true));
            }
        }
    }
}
/// End of Recursive Svg Patch
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0Y2gubWpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3JlbmRlci9zdmcvcGF0Y2gubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLGlEQUFpRDtBQUNqRCxJQUFXLGFBV1Y7QUFYRCxXQUFXLGFBQWE7SUFDdEIsMkRBQTJEO0lBQzNELHVDQUF1QztJQUN2QyxHQUFHO0lBQ0gsNkRBQTZEO0lBQzdELHlFQUF5RTtJQUN6RSxpQ0FBZ0IsQ0FBQTtJQUVoQixzRkFBc0Y7SUFDdEYseURBQXlEO0lBQ3pELDhDQUE2QixDQUFBO0FBQy9CLENBQUMsRUFYVSxhQUFhLEtBQWIsYUFBYSxRQVd2QjtBQUVELG9EQUFvRDtBQUNwRCxTQUFTLE9BQU8sQ0FBQyxJQUFhO0lBQzVCLE9BQU8sSUFBSSxDQUFDLE9BQU8sS0FBSyxHQUFHLENBQUM7QUFDOUIsQ0FBQztBQUVELHFEQUFxRDtBQUNyRCxTQUFTLFNBQVMsQ0FBQyxJQUFpQixFQUFFLElBQWlCO0lBQ3JELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pELE9BQU8sV0FBVyxJQUFJLFdBQVcsS0FBSyxXQUFXLENBQUM7QUFDcEQsQ0FBQztBQXFDRCx3RUFBd0U7QUFDeEUsTUFBTSxVQUFVLG1CQUFtQixDQUNqQyxjQUFtQixFQUNuQixjQUFtQixFQUNuQixPQUFPLENBQUMsRUFBSyxFQUFXLEVBQUUsQ0FBQyxJQUFJO0lBRS9CLE1BQU0sc0JBQXNCLEdBQUcsSUFBSSxHQUFHLEVBQXlCLENBQUM7SUFDaEUsTUFBTSxVQUFVLEdBQStCLEVBQUUsQ0FBQztJQUVsRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsY0FBYyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVB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QUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUM3QyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25DLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQzdDO1NBQ0Y7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUVELDhCQUE4QiIsInNvdXJjZXNDb250ZW50IjpbIi8vLyBUaGUgRWxlbWVudENoaWxkcmVuIHJlcHJlc2VudHMgYW4gb2JqZWN0IG9mIGEgbGlzdCBvZiBub2Rlcy5cclxuZXhwb3J0IGludGVyZmFjZSBFbGVtZW50Q2hpbGRyZW4ge1xyXG4gIHRhZ05hbWU6IHN0cmluZztcclxuICBnZXRBdHRyaWJ1dGUobmFtZTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbDtcclxuICBjbG9uZU5vZGUoZGVlcDogYm9vbGVhbik6IHVua25vd247XHJcbn1cclxuXHJcbi8vLyBTZW1hbnRpYyBhdHRyaWJ1dGVzIGF0dGFjaGVkIHRvIFNWRyBlbGVtZW50cy5cclxuY29uc3QgZW51bSBUeXBzdFN2Z0F0dHJzIHtcclxuICAvLy8gVGhlIGRhdGEtdGlkIGF0dHJpYnV0ZSBpcyB1c2VkIHRvIGlkZW50aWZ5IHRoZSBlbGVtZW50LlxyXG4gIC8vLyBJdCBpcyB1c2VkIHRvIGNvbXBhcmUgdHdvIGVsZW1lbnRzLlxyXG4gIC8vL1xyXG4gIC8vLyBBdCBtb3N0IHRpbWUsIHRoZSBkYXRhLXRpZCBpcyBleGFjdGx5IHRoZWlyIGNvbnRlbnQgaGFzaC5cclxuICAvLy8gQSBkaXNhbWJpZ3VhdGlvbiBzdWZmaXggaXMgYWRkZWQgd2hlbiB0aGUgY29udGVudCBoYXNoIGlzIG5vdCB1bmlxdWUuXHJcbiAgVGlkID0gJ2RhdGEtdGlkJyxcclxuXHJcbiAgLy8vIFRoZSBkYXRhLXJldXNlIGF0dHJpYnV0ZSBpcyB1c2VkIHRvIHRoaXMgZWxlbWVudCBpcyByZXVzZWQgZnJvbSBzcGVjaWZpZWQgZWxlbWVudC5cclxuICAvLy8gVGhlIGF0dHJpYnV0ZSBjb250ZW50IGlzIHRoZSBkYXRhLXRpZCBvZiB0aGUgZWxlbWVudC5cclxuICBSZXVzZUZyb20gPSAnZGF0YS1yZXVzZS1mcm9tJyxcclxufVxyXG5cclxuLy8vIFByZWRpY2F0ZSB0aGF0IGEgeG1sIGVsZW1lbnQgaXMgYSBgPGc+YCBlbGVtZW50LlxyXG5mdW5jdGlvbiBpc0dFbGVtKG5vZGU6IEVsZW1lbnQpOiBub2RlIGlzIFNWR0dFbGVtZW50IHtcclxuICByZXR1cm4gbm9kZS50YWdOYW1lID09PSAnZyc7XHJcbn1cclxuXHJcbi8vLyBDb21wYXJlIHR3byBlbGVtZW50cyBieSB0aGVpciBkYXRhLXRpZCBhdHRyaWJ1dGUuXHJcbmZ1bmN0aW9uIGVxdWFsRWxlbShwcmV2OiBTVkdHRWxlbWVudCwgbmV4dDogU1ZHR0VsZW1lbnQpIHtcclxuICBjb25zdCBwcmV2RGF0YVRpZCA9IHByZXYuZ2V0QXR0cmlidXRlKFR5cHN0U3ZnQXR0cnMuVGlkKTtcclxuICBjb25zdCBuZXh0RGF0YVRpZCA9IG5leHQuZ2V0QXR0cmlidXRlKFR5cHN0U3ZnQXR0cnMuVGlkKTtcclxuICByZXR1cm4gcHJldkRhdGFUaWQgJiYgcHJldkRhdGFUaWQgPT09IG5leHREYXRhVGlkO1xyXG59XHJcblxyXG4vLy8gQmVnaW4gb2YgVmlldyBJbnRlcnByZXRhdGlvblxyXG4vLy9cclxuLy8vICMjIyBWaWV3XHJcbi8vL1xyXG4vLy8gVGhlIHZpZXcgaXMgZGVmaW5lZCBhcyBhIHN0cnVjdHVyZSB0byBkZXNjcmliZSB0aGUgc3RhdGUgb2YgYSBzZXF1ZW5jZSxcclxuLy8vIFdoaWxlIHRoZSB2aWV3IGluc3RydWN0aW9ucyBkZXNjcmliZSB0aGUgY2hhbmdlIG9mIHZpZXcuXHJcbi8vLyAgIFRoYXQgaXMsIEdpdmVuIFYsIFYnLCBWIGJlY29tZXMgVicgYWZ0ZXIgYXBwbHlpbmcgdmlldyBpbnN0cnVjdGlvbnMgaW4gb3JkZXIuXHJcbi8vLyBXZSBjYWxsIFYnIHRoZSB0YXJnZXQgdmlldywgYW5kIFYnIHRoZSBvcmlnaW4gdmlldy5cclxuLy8vXHJcbi8vLyAjIyMgVmlldyBJbnN0cnVjdGlvblxyXG4vLy9cclxuLy8vIEludHJvZHVjZWQgdGhlIHRhcmdldC9vcmlnaW4gdmlldywgdGhlcmUgYXJlIHR3byB0eXBlIG9mIGluc3RydWN0aW9ucyB0byBub3RlOlxyXG5cclxuLy8vIFRoZSB0YXJnZXQgdmlldyBpbnN0cnVjdGlvbnMgYXJlIGdlbmVyYXRlZCBieVxyXG4vLy8gICBjb21wYXJpbmcgd2l0aCB0aGUgdGFyZ2V0IHZpZXcgYW5kIG9yaWdpbiB2aWV3LlxyXG4vLy8gVGhlIGluc3RydWN0aW9uIHNlcXVlbmNlIHNwZWNpZnkgaG93IHdlIGNhbiBnZW5lcmF0ZSBhIHZpZXcgd2l0aCBjb25kaXRpb25zOlxyXG4vLy8gKyBJdCBpcyBnZW5lcmF0ZWQgZnJvbSBhIGVtcHR5IHNlcXVlbmNlLlxyXG4vLy8gKyBJdCBjYW4gdXRpbGl6ZSBhIHNldCBvZiBlbGVtZW50cyBhcyByZXNvdXJjZXMuXHJcbi8vL1xyXG4vLy8gRXhhbXBsZTE6IHJlc291cmNlOltdIC0+IDxhcHBlbmQgdDE+IC0+IFt0MV1cclxuLy8vIEV4YW1wbGUyOiByZXNvdXJjZTpbbzFdIC0+IDxyZXVzZSBvMT4gLT4gW28xXVxyXG4vLy8gRXhhbXBsZTM6IHJlc291cmNlOltvMV0gLT4gPHJldXNlIG8xPiA8cmV1c2UgbzE+IC0+IFtvMSwgbzFdXHJcbi8vLyBFeGFtcGxlNDogcmVzb3VyY2U6W28xLCBvMl0gLT4gPHJldXNlIG8xPiA8YXBwZW5kIHQxPiAtPiBbbzEsIHQxXVxyXG4vLy9cclxuLy8vIFRvIHJlbW92ZSB1bnVzZWQgcmVzb3VyY2VzLCBBbiBleHRyYSByZW1vdmUgaW5zdCBjYW4gcmVtb3ZlIGEgc3BlY2lmeSBlbGVtZW50XHJcbi8vL1xyXG4vLy8gRXhhbXBsZTU6IHJlc291cmNlOltvMSwgbzJdIC0+IDxyZXVzZSBvMT4gPGFwcGVuZCB0MT4gPHJlbW92ZSBvMj4gLT4gW28xLCB0MV0gYW5kIHJlbW92ZSBvMlxyXG5leHBvcnQgdHlwZSBUYXJnZXRWaWV3SW5zdHJ1Y3Rpb248VD4gPSBbJ2FwcGVuZCcsIFRdIHwgWydyZXVzZScsIG51bWJlcl0gfCBbJ3JlbW92ZScsIG51bWJlcl07XHJcblxyXG4vLy8gVGhlIHJlY3Vyc2l2ZSBwYXRjaCBvcGVyYXRpb24gbXVzdCBiZSBhcHBsaWVkIHRvIHRoaXMgdHdvIGVsZW1lbnQuXHJcbmV4cG9ydCB0eXBlIFBhdGNoUGFpcjxUPiA9IFtUIC8qIG9yaWdpbiAqLywgVCAvKiB0YXJnZXQgKi9dO1xyXG5cclxuLy8vIEludGVycHJldGVkIHJlc3VsdCBmb3IgdHJhbnNmb3JtaW5nIG9yaWdpbiBzZXF1ZW5jZSB0byB0YXJnZXQgc2VxdWVuY2UuXHJcbmV4cG9ydCB0eXBlIFZpZXdUcmFuc2Zvcm08VT4gPSBbVGFyZ2V0Vmlld0luc3RydWN0aW9uPFU+W10sIFBhdGNoUGFpcjxVPltdXTtcclxuXHJcbi8vLyBJbnRlcnByZXQgdGhlIHRyYW5zZm9ybSBiZXR3ZWVuIG9yaWdpbiBzZXF1ZW5jZSBhbmQgdGFyZ2V0IHNlcXVlbmNlLlxyXG5leHBvcnQgZnVuY3Rpb24gaW50ZXJwcmV0VGFyZ2V0VmlldzxUIGV4dGVuZHMgRWxlbWVudENoaWxkcmVuLCBVIGV4dGVuZHMgVCA9IFQ+KFxyXG4gIG9yaWdpbkNoaWxkcmVuOiBUW10sXHJcbiAgdGFyZ2V0Q2hpbGRyZW46IFRbXSxcclxuICB0SXNVID0gKF94OiBUKTogX3ggaXMgVSA9PiB0cnVlLFxyXG4pOiBWaWV3VHJhbnNmb3JtPFU+IHtcclxuICBjb25zdCBhdmFpbGFibGVPd25lZFJlc291cmNlID0gbmV3IE1hcDxzdHJpbmcsIFtULCBudW1iZXJbXV0+KCk7XHJcbiAgY29uc3QgdGFyZ2V0VmlldzogVGFyZ2V0Vmlld0luc3RydWN0aW9uPFU+W10gPSBbXTtcclxuXHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcmlnaW5DaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG4gICAgY29uc3QgcHJldkNoaWxkID0gb3JpZ2luQ2hpbGRyZW5baV07XHJcbiAgICBpZiAoIXRJc1UocHJldkNoaWxkKSkge1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBkYXRhX3RpZCA9IHByZXZDaGlsZC5nZXRBdHRyaWJ1dGUoVHlwc3RTdmdBdHRycy5UaWQpO1xyXG4gICAgaWYgKCFkYXRhX3RpZCkge1xyXG4gICAgICB0YXJnZXRWaWV3LnB1c2goWydyZW1vdmUnLCBpXSk7XHJcbiAgICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghYXZhaWxhYmxlT3duZWRSZXNvdXJjZS5oYXMoZGF0YV90aWQpKSB7XHJcbiAgICAgIGF2YWlsYWJsZU93bmVkUmVzb3VyY2Uuc2V0KGRhdGFfdGlkLCBbcHJldkNoaWxkLCBbXV0pO1xyXG4gICAgfVxyXG4gICAgYXZhaWxhYmxlT3duZWRSZXNvdXJjZS5nZXQoZGF0YV90aWQpIVsxXS5wdXNoKGkpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgdG9QYXRjaDogW1UsIFVdW10gPSBbXTtcclxuXHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YXJnZXRDaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG4gICAgY29uc3QgbmV4dENoaWxkID0gdGFyZ2V0Q2hpbGRyZW5baV07XHJcbiAgICBpZiAoIXRJc1UobmV4dENoaWxkKSkge1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBuZXh0RGF0YVRpZCA9IG5leHRDaGlsZC5nZXRBdHRyaWJ1dGUoVHlwc3RTdmdBdHRycy5UaWQpO1xyXG4gICAgaWYgKCFuZXh0RGF0YVRpZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBkYXRhIHRpZCBmb3IgcmV1c2luZyBnIGVsZW1lbnQgZm9yICcgKyBuZXh0RGF0YVRpZCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmV1c2VUYXJnZXRUaWQgPSBuZXh0Q2hpbGQuZ2V0QXR0cmlidXRlKFR5cHN0U3ZnQXR0cnMuUmV1c2VGcm9tKTtcclxuICAgIGlmICghcmV1c2VUYXJnZXRUaWQpIHtcclxuICAgICAgdGFyZ2V0Vmlldy5wdXNoKFsnYXBwZW5kJywgbmV4dENoaWxkXSk7XHJcbiAgICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG4gICAgaWYgKCFhdmFpbGFibGVPd25lZFJlc291cmNlLmhhcyhyZXVzZVRhcmdldFRpZCkpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdubyBhdmFpbGFibGUgcmVzb3VyY2UgZm9yIHJldXNlICcgKyByZXVzZVRhcmdldFRpZCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcnNyYyA9IGF2YWlsYWJsZU93bmVkUmVzb3VyY2UuZ2V0KHJldXNlVGFyZ2V0VGlkKSE7XHJcbiAgICBjb25zdCBwcmV2SWR4ID0gcnNyY1sxXS5zaGlmdCgpO1xyXG5cclxuICAgIC8vLyBubyBhdmFpbGFibGUgcmVzb3VyY2VcclxuICAgIGlmIChwcmV2SWR4ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgLy8vIGNsZWFuIG9uZSBpcyByZXVzZWQgZGlyZWN0bHlcclxuICAgICAgaWYgKG5leHREYXRhVGlkID09PSByZXVzZVRhcmdldFRpZCkge1xyXG4gICAgICAgIGNvbnN0IGNsb25lZE5vZGUgPSByc3JjWzBdLmNsb25lTm9kZSh0cnVlKSBhcyBVO1xyXG4gICAgICAgIHRvUGF0Y2gucHVzaChbY2xvbmVkTm9kZSwgbmV4dENoaWxkXSk7XHJcbiAgICAgICAgdGFyZ2V0Vmlldy5wdXNoKFsnYXBwZW5kJywgY2xvbmVkTm9kZV0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRhcmdldFZpZXcucHVzaChbJ2FwcGVuZCcsIG5leHRDaGlsZF0pO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vLyBkaXJ0eSBvbmUgc2hvdWxkIGJlIHBhdGNoZWQgYW5kIHJldXNlZFxyXG4gICAgdG9QYXRjaC5wdXNoKFtvcmlnaW5DaGlsZHJlbltwcmV2SWR4XSBhcyBVLCBuZXh0Q2hpbGRdKTtcclxuICAgIHRhcmdldFZpZXcucHVzaChbJ3JldXNlJywgcHJldklkeF0pO1xyXG4gIH1cclxuXHJcbiAgZm9yIChsZXQgW18sIHVudXNlZEluZGljZXNdIG9mIGF2YWlsYWJsZU93bmVkUmVzb3VyY2UudmFsdWVzKCkpIHtcclxuICAgIGZvciAobGV0IHVudXNlZCBvZiB1bnVzZWRJbmRpY2VzKSB7XHJcbiAgICAgIHRhcmdldFZpZXcucHVzaChbJ3JlbW92ZScsIHVudXNlZF0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIFt0YXJnZXRWaWV3LCB0b1BhdGNoXTtcclxufVxyXG5cclxuLy8vIFRoZSBvcmlnaW4gdmlldyBpbnN0cnVjdGlvbnMgYXJlIHNlbWFudGljLXByZXNlcnZlZCB0byB0aGUgdGFyZ2V0IG9uZXMuXHJcbi8vLyBUaGUgbWFqb3IgZGlmZmVyZW5jZXMgYmV0d2VlbiB0aGUgb3JpZ2luIG9uZXMgYW5kIHRhcmdldCBvbmVzIGFyZSB0aGF0OlxyXG4vLy8gKyBJdCBjYW4gYmUgZWFzaWx5IGFwcGxpZWQgdG8gYSBET00gc2VxdWVuY2VcclxuLy8vICsgSXQgaGFzIGJldHRlciBwZXJmb3JtYW5jZS5cclxuLy8vXHJcbi8vLyBFeGFtcGxlMTogZG9tOltvMCwgbzFdIC0+IDxpbnNlcnQgYXQgMSwgdDE+IC0+IFtvMCwgdDEsIG8xXVxyXG4vLy8gRXhhbXBsZTI6IGRvbTpbbzAsIG8xLCBvMiwgbzNdIC0+IDxzd2FwX2luIGF0IDIsIDA+IC0+IFtvMSwgbzAsIG8yLCBvM11cclxuLy8vIEV4YW1wbGUzOiBkb206W28wLCBvMSwgbzIsIG8zLCBvNF0gLT4gPHN3YXBfaW4gYXQgMywgMD4gLT4gW28xLCBvMiwgbzAsIG8zXVxyXG4vLy8gRXhhbXBsZTQ6IGRvbTpbbzAsIG8xLCBvMl0gLT4gPHJlbW92ZSBhdCAxPiAtPiBbbzAsIG8yXVxyXG5leHBvcnQgdHlwZSBPcmlnaW5WaWV3SW5zdHJ1Y3Rpb248VD4gPVxyXG4gIHwgWydpbnNlcnQnLCBudW1iZXIsIFRdXHJcbiAgfCBbJ3N3YXBfaW4nLCBudW1iZXIsIG51bWJlcl1cclxuICB8IFsncmVtb3ZlJywgbnVtYmVyXTtcclxuXHJcbi8vLyBDaGFuZ2UgYSBzZXF1ZW5jZSBvZiB0YXJnZXQgdmlldyBpbnN0cnVjdGlvbnMgdG8gdGhlIG9yaWdpbiBvbmVzLlxyXG4vLy8gQ3VycmVudGx5LCBpdCBhcHBsaWVzIGEgZ3JlZWR5IHN0cmF0ZWd5LlxyXG4vLy8gKyBGaXJzdCwgaXQgYXBwbGllcyBhbGwgcmVtb3ZlIGluc3RydWN0aW9ucy5cclxuLy8vICsgVGhlbiwgaXQgYXBwbGllcyB0aGUgc3dhcCBvbmVzLlxyXG4vLy8gKyBGaW5hbGx5LCBpdCBpbnNlcnRzIHRoZSBleHRyYSBlbGVtZW50cy5cclxuLy8vXHJcbi8vLyBTb21lIGJldHRlciBzdHJhdGVneSB3b3VsZCBoZWxwIGFuZCBiZSBpbXBsZW1lbnRlZCBpbiBmdXR1cmUuXHJcbmV4cG9ydCBmdW5jdGlvbiBjaGFuZ2VWaWV3UGVyc3BlY3RpdmU8VCBleHRlbmRzIEVsZW1lbnRDaGlsZHJlbiwgVSBleHRlbmRzIFQgPSBUPihcclxuICBvcmlnaW5DaGlsZHJlbjogVFtdLFxyXG4gIHRhcmdldFZpZXc6IFRhcmdldFZpZXdJbnN0cnVjdGlvbjxVPltdLFxyXG4gIHRJc1UgPSAoX3g6IFQpOiBfeCBpcyBVID0+IHRydWUsXHJcbik6IE9yaWdpblZpZXdJbnN0cnVjdGlvbjxVPltdIHtcclxuICBjb25zdCBvcmlnaW5WaWV3OiBPcmlnaW5WaWV3SW5zdHJ1Y3Rpb248VT5bXSA9IFtdO1xyXG5cclxuICAvLy8gc2VlIHJlbW92ZSBpbnN0cnVjdGlvbnNcclxuICBsZXQgcmVtb3ZlSW5kaWNlczogbnVtYmVyW10gPSBbXTtcclxuICBmb3IgKGxldCBpbnN0IG9mIHRhcmdldFZpZXcpIHtcclxuICAgIGlmIChpbnN0WzBdID09PSAncmVtb3ZlJykge1xyXG4gICAgICByZW1vdmVJbmRpY2VzLnB1c2goaW5zdFsxXSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJlbW92ZUluZGljZXMgPSByZW1vdmVJbmRpY2VzLnNvcnQoKGEsIGIpID0+IGEgLSBiKTtcclxuICBjb25zdCByZW1vdmVTaGlmdDogKG51bWJlciB8IHVuZGVmaW5lZClbXSA9IFtdO1xyXG5cclxuICAvLy8gYXBwbHkgcmVtb3ZlIGluc3RydWN0aW9ucyBhbmQgZ2V0IGVmZmVjdFxyXG4gIHtcclxuICAgIGxldCByID0gMDtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVtb3ZlSW5kaWNlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICB3aGlsZSAociA8IHJlbW92ZUluZGljZXNbaV0pIHtcclxuICAgICAgICByZW1vdmVTaGlmdC5wdXNoKHIgLSBpKTtcclxuICAgICAgICByKys7XHJcbiAgICAgIH1cclxuICAgICAgcmVtb3ZlU2hpZnQucHVzaCh1bmRlZmluZWQpO1xyXG4gICAgICBvcmlnaW5WaWV3LnB1c2goWydyZW1vdmUnLCByZW1vdmVJbmRpY2VzW2ldIC0gaV0pO1xyXG4gICAgICByKys7XHJcbiAgICB9XHJcbiAgICB3aGlsZSAociA8PSBvcmlnaW5DaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgcmVtb3ZlU2hpZnQucHVzaChyIC0gcmVtb3ZlSW5kaWNlcy5sZW5ndGgpO1xyXG4gICAgICByKys7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vIGNvbnNvbGUubG9nKHJlbW92ZUluZGljZXMsIHJlbW92ZVNoaWZ0KTtcclxuICAvLy8gZ2V0IHNoaWZ0IGNvbnNpZGVyaW5nIHJlbW92ZSBlZmZlY3RzXHJcbiAgY29uc3QgZ2V0U2hpZnQgPSAob2ZmOiBudW1iZXIpID0+IHtcclxuICAgIGlmIChvZmYgPj0gcmVtb3ZlU2hpZnQubGVuZ3RoIHx8IHJlbW92ZVNoaWZ0W29mZl0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgb2Zmc2V0ICR7b2ZmfSBmb3IgZ2V0U2hpZnQgJHtyZW1vdmVTaGlmdH1gKTtcclxuICAgIH1cclxuICAgIHJldHVybiByZW1vdmVTaGlmdFtvZmZdITtcclxuICB9O1xyXG5cclxuICAvLy8gdmFyaWFibGVzIHVzZWQgYnkgYGludGVycHJldE9yaWdpblZpZXdgXHJcbiAgLy8vIHNjYW5uaW5nIHRoZSB0YXJnZXQgdmlld1xyXG4gIGxldCB0YXJnZXRWaWV3Q3Vyc29yID0gMDtcclxuICAvLy8gdGhlIGFwcGVuZCBlZmZlY3RcclxuICBsZXQgYXBwZW5kT2Zmc2V0ID0gMDtcclxuICAvLy8gY29udmVydGVkIGFwcGVuZCBpbnN0cnVjdGlvbnMuXHJcbiAgY29uc3Qgc3dhcEluczogbnVtYmVyW10gPSBbXTtcclxuICAvLy8gY29udmVydGVkIGFwcGVuZCBpbnN0cnVjdGlvbnMuXHJcbiAgY29uc3QgaW5zZXJ0czogWydpbnNlcnQnLCBudW1iZXIsIFVdW10gPSBbXTtcclxuXHJcbiAgLy8vIGFwcGx5IGFwcGVuZCBhbmQgcmV1c2UgaW5zdHJ1Y3Rpb25zIHRpbGwgdGhlIG9mZnNldCBvZiBvcmlnaW4gc2VxdWVuY2UuXHJcbiAgY29uc3QgaW50ZXJwcmV0T3JpZ2luVmlldyA9IChvZmY6IG51bWJlcikgPT4ge1xyXG4gICAgLy8gY29uc29sZS5sb2cob2ZmLCBnZXRTaGlmdChvZmYpKTtcclxuICAgIG9mZiA9IGdldFNoaWZ0KG9mZik7XHJcbiAgICB3aGlsZSAodGFyZ2V0Vmlld0N1cnNvciA8IHRhcmdldFZpZXcubGVuZ3RoKSB7XHJcbiAgICAgIGxldCBkb25lID0gZmFsc2U7XHJcbiAgICAgIGNvbnN0IGluc3QgPSB0YXJnZXRWaWV3W3RhcmdldFZpZXdDdXJzb3JdO1xyXG4gICAgICBzd2l0Y2ggKGluc3RbMF0pIHtcclxuICAgICAgICBjYXNlICdhcHBlbmQnOlxyXG4gICAgICAgICAgaW5zZXJ0cy5wdXNoKFsnaW5zZXJ0JywgYXBwZW5kT2Zmc2V0LCBpbnN0WzFdXSk7XHJcbiAgICAgICAgICBhcHBlbmRPZmZzZXQrKztcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3JldXNlJzpcclxuICAgICAgICAgIGNvbnN0IHRhcmdldF9vZmYgPSBnZXRTaGlmdChpbnN0WzFdKTtcclxuICAgICAgICAgIHN3YXBJbnMucHVzaCh0YXJnZXRfb2ZmKTtcclxuICAgICAgICAgIGFwcGVuZE9mZnNldCsrO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgLy8gY2FzZSBcInJlbW92ZVwiOlxyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG5cclxuICAgICAgdGFyZ2V0Vmlld0N1cnNvcisrO1xyXG4gICAgICBpZiAoZG9uZSkge1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgLy8vIHNjYW5uaW5nIHRoZSBvcmlnaW4gdmlld1xyXG4gIGZvciAobGV0IG9mZiA9IDA7IG9mZiA8IG9yaWdpbkNoaWxkcmVuLmxlbmd0aDsgb2ZmKyspIHtcclxuICAgIGNvbnN0IHByZXZDaGlsZCA9IG9yaWdpbkNoaWxkcmVuW29mZl07XHJcblxyXG4gICAgaWYgKHJlbW92ZVNoaWZ0W29mZl0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBrZWVwIHBvc2l0aW9uIG9mIHVucHJlZGljdGFibGUgZWxlbWVudHNcclxuICAgIGlmICghdElzVShwcmV2Q2hpbGQpKSB7XHJcbiAgICAgIGNvbnN0IHRhcmdldF9vZmYgPSBnZXRTaGlmdChvZmYpO1xyXG4gICAgICBzd2FwSW5zLnB1c2godGFyZ2V0X29mZik7XHJcbiAgICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGludGVycHJldE9yaWdpblZpZXcob2ZmKTtcclxuICB9XHJcbiAgaW50ZXJwcmV0T3JpZ2luVmlldyhvcmlnaW5DaGlsZHJlbi5sZW5ndGgpO1xyXG5cclxuICBjb25zdCBzaW11bGF0ZWQ6IG51bWJlcltdID0gW107XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzd2FwSW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBzaW11bGF0ZWQucHVzaChpKTtcclxuICB9XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzd2FwSW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBjb25zdCBvZmYgPSBzd2FwSW5zW2ldO1xyXG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCBzaW11bGF0ZWQubGVuZ3RoOyBqKyspIHtcclxuICAgICAgaWYgKHNpbXVsYXRlZFtqXSA9PT0gb2ZmKSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJzd2FwX2luXCIsIGosIGksIHNpbXVsYXRlZCk7XHJcbiAgICAgICAgc2ltdWxhdGVkLnNwbGljZShqLCAxKTtcclxuICAgICAgICBpZiAoaSA8PSBqKSB7XHJcbiAgICAgICAgICBzaW11bGF0ZWQuc3BsaWNlKGksIDAsIG9mZik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHNpbXVsYXRlZC5zcGxpY2UoaSArIDEsIDAsIG9mZik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChqICE9PSBpKSB7XHJcbiAgICAgICAgICBvcmlnaW5WaWV3LnB1c2goWydzd2FwX2luJywgaSwgal0pO1xyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coXCJzd2FwX2luIHRoZW5cIiwgaiwgaSwgc2ltdWxhdGVkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBbLi4ub3JpZ2luVmlldywgLi4uaW5zZXJ0c107XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJ1bk9yaWdpblZpZXdJbnN0cnVjdGlvbnMocHJldjogRWxlbWVudCwgb3JpZ2luVmlldzogT3JpZ2luVmlld0luc3RydWN0aW9uPE5vZGU+W10pIHtcclxuICAvLyBjb25zb2xlLmxvZyhcImludGVycHJldGVkIG9yaWdpbiB2aWV3XCIsIG9yaWdpblZpZXcpO1xyXG4gIGZvciAoY29uc3QgW29wLCBvZmYsIGZyXSBvZiBvcmlnaW5WaWV3KSB7XHJcbiAgICBzd2l0Y2ggKG9wKSB7XHJcbiAgICAgIGNhc2UgJ2luc2VydCc6XHJcbiAgICAgICAgcHJldi5pbnNlcnRCZWZvcmUoZnIsIHByZXYuY2hpbGRyZW5bb2ZmXSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgJ3N3YXBfaW4nOlxyXG4gICAgICAgIHByZXYuaW5zZXJ0QmVmb3JlKHByZXYuY2hpbGRyZW5bZnJdLCBwcmV2LmNoaWxkcmVuW29mZl0pO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlICdyZW1vdmUnOlxyXG4gICAgICAgIHByZXYuY2hpbGRyZW5bb2ZmXS5yZW1vdmUoKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Vua25vd24gb3AgJyArIG9wKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbi8vLyBFbmQgb2YgVmlldyBJbnRlcnByZXRhdGlvblxyXG4vLy8gQmVnaW4gb2YgUmVjdXJzaXZlIFN2ZyBQYXRjaFxyXG5cclxuLy8vIFBhdGNoIHRoZSBgcHJldiA8c3ZnPmAgaW4gdGhlIERPTSBhY2NvcmRpbmcgdG8gYG5leHQgPHN2Zz5gIGZyb20gdGhlIGJhY2tlbmQuXHJcbmV4cG9ydCBmdW5jdGlvbiBwYXRjaFJvb3QocHJldjogU1ZHRWxlbWVudCwgbmV4dDogU1ZHRWxlbWVudCkge1xyXG4gIC8vLyBQYXRjaCBhdHRyaWJ1dGVzXHJcbiAgcGF0Y2hBdHRyaWJ1dGVzKHByZXYsIG5leHQpO1xyXG4gIC8vLyBQYXRjaCBnbG9iYWwgc3ZnIHJlc291cmNlc1xyXG4gIHBhdGNoU3ZnSGVhZGVyKHByZXYsIG5leHQpO1xyXG5cclxuICAvLy8gUGF0Y2ggYDxnPmAgY2hpbGRyZW4sIGNhbGwgYHJldXNlT3JQYXRjaEVsZW1gIHRvIHBhdGNoLlxyXG4gIHBhdGNoQ2hpbGRyZW4ocHJldiwgbmV4dCk7XHJcbiAgcmV0dXJuO1xyXG5cclxuICBmdW5jdGlvbiBwYXRjaFN2Z0hlYWRlcihwcmV2OiBTVkdFbGVtZW50LCBuZXh0OiBTVkdFbGVtZW50KSB7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7IGkrKykge1xyXG4gICAgICBjb25zdCBwcmV2Q2hpbGQgPSBwcmV2LmNoaWxkcmVuW2ldO1xyXG4gICAgICBjb25zdCBuZXh0Q2hpbGQgPSBuZXh0LmNoaWxkcmVuW2ldO1xyXG4gICAgICAvLyBjb25zb2xlLmxvZyhcInByZXZcIiwgcHJldkNoaWxkKTtcclxuICAgICAgLy8gY29uc29sZS5sb2coXCJuZXh0XCIsIG5leHRDaGlsZCk7XHJcbiAgICAgIGlmIChwcmV2Q2hpbGQudGFnTmFtZSA9PT0gJ2RlZnMnKSB7XHJcbiAgICAgICAgaWYgKHByZXZDaGlsZC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgPT09ICdnbHlwaCcpIHtcclxuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiYXBwZW5kIGdseXBoczpcIiwgbmV4dENoaWxkLmNoaWxkcmVuLCBcInRvXCIsIHByZXZDaGlsZCk7XHJcbiAgICAgICAgICBwcmV2Q2hpbGQuYXBwZW5kKC4uLm5leHRDaGlsZC5jaGlsZHJlbik7XHJcbiAgICAgICAgfSBlbHNlIGlmIChwcmV2Q2hpbGQuZ2V0QXR0cmlidXRlKCdjbGFzcycpID09PSAnY2xpcC1wYXRoJykge1xyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coXCJjbGlwIHBhdGg6IHJlcGxhY2VcIik7XHJcbiAgICAgICAgICAvLyB0b2RvOiBnY1xyXG4gICAgICAgICAgcHJldkNoaWxkLmFwcGVuZCguLi5uZXh0Q2hpbGQuY2hpbGRyZW4pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIGlmIChwcmV2Q2hpbGQudGFnTmFtZSA9PT0gJ3N0eWxlJyAmJiBuZXh0Q2hpbGQuZ2V0QXR0cmlidXRlKCdkYXRhLXJldXNlJykgIT09ICcxJykge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwicmVwbGFjZSBleHRyYSBzdHlsZVwiLCBwcmV2Q2hpbGQsIG5leHRDaGlsZCk7XHJcblxyXG4gICAgICAgIC8vIHRvZG86IGdjXHJcbiAgICAgICAgaWYgKG5leHRDaGlsZC50ZXh0Q29udGVudCkge1xyXG4gICAgICAgICAgLy8gdG9kbzogbG9va3Mgc2xvd1xyXG4gICAgICAgICAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzMyNjQ5NC9wYXJzaW5nLWNzcy1pbi1qYXZhc2NyaXB0LWpxdWVyeVxyXG4gICAgICAgICAgdmFyIGRvYyA9IGRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudCgnJyksXHJcbiAgICAgICAgICAgIHN0eWxlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XHJcblxyXG4gICAgICAgICAgc3R5bGVFbGVtZW50LnRleHRDb250ZW50ID0gbmV4dENoaWxkLnRleHRDb250ZW50O1xyXG4gICAgICAgICAgLy8gdGhlIHN0eWxlIHdpbGwgb25seSBiZSBwYXJzZWQgb25jZSBpdCBpcyBhZGRlZCB0byBhIGRvY3VtZW50XHJcbiAgICAgICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChzdHlsZUVsZW1lbnQpO1xyXG5cclxuICAgICAgICAgIGNvbnN0IGN1cnJlbnRTdmdTaGVldCA9IChwcmV2Q2hpbGQgYXMgSFRNTFN0eWxlRWxlbWVudCkuc2hlZXQhO1xyXG4gICAgICAgICAgY29uc3QgcnVsZXNUb0luc2VydCA9IHN0eWxlRWxlbWVudC5zaGVldD8uY3NzUnVsZXMgfHwgW107XHJcblxyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coXCJydWxlcyB0byBpbnNlcnRcIiwgY3VycmVudFN2Z1NoZWV0LCBydWxlc1RvSW5zZXJ0KTtcclxuICAgICAgICAgIGZvciAoY29uc3QgcnVsZSBvZiBydWxlc1RvSW5zZXJ0KSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRTdmdTaGVldC5pbnNlcnRSdWxlKHJ1bGUuY3NzVGV4dCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vLy8gYXBwbHkgYXR0cmlidXRlIHBhdGNoZXMgdG8gdGhlIGBwcmV2IDxzdmcgb3IgZz5gIGVsZW1lbnRcclxuZnVuY3Rpb24gcGF0Y2hBdHRyaWJ1dGVzKHByZXY6IEVsZW1lbnQsIG5leHQ6IEVsZW1lbnQpIHtcclxuICBjb25zdCBwcmV2QXR0cnMgPSBwcmV2LmF0dHJpYnV0ZXM7XHJcbiAgY29uc3QgbmV4dEF0dHJzID0gbmV4dC5hdHRyaWJ1dGVzO1xyXG4gIGlmIChwcmV2QXR0cnMubGVuZ3RoID09PSBuZXh0QXR0cnMubGVuZ3RoKSB7XHJcbiAgICBsZXQgc2FtZSA9IHRydWU7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByZXZBdHRycy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBjb25zdCBwcmV2QXR0ciA9IHByZXZBdHRyc1tpXTtcclxuICAgICAgY29uc3QgbmV4dEF0dHIgPSBuZXh0QXR0cnMuZ2V0TmFtZWRJdGVtKHByZXZBdHRyLm5hbWUpO1xyXG4gICAgICBpZiAobmV4dEF0dHIgPT09IG51bGwgfHwgcHJldkF0dHIudmFsdWUgIT09IG5leHRBdHRyLnZhbHVlKSB7XHJcbiAgICAgICAgc2FtZSA9IGZhbHNlO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNhbWUpIHtcclxuICAgICAgLy8gY29uc29sZS5sb2coXCJzYW1lIGF0dHJpYnV0ZXMsIHNraXBcIik7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9XHJcbiAgLy8gY29uc29sZS5sb2coXCJkaWZmZXJlbnQgYXR0cmlidXRlcywgcmVwbGFjZVwiKTtcclxuXHJcbiAgY29uc3QgcmVtb3ZlZEF0dHJzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICBmb3IgKGxldCBpID0gMDsgaSA8IHByZXZBdHRycy5sZW5ndGg7IGkrKykge1xyXG4gICAgcmVtb3ZlZEF0dHJzLnB1c2gocHJldkF0dHJzW2ldLm5hbWUpO1xyXG4gIH1cclxuXHJcbiAgZm9yIChjb25zdCBhdHRyIG9mIHJlbW92ZWRBdHRycykge1xyXG4gICAgcHJldi5yZW1vdmVBdHRyaWJ1dGUoYXR0cik7XHJcbiAgfVxyXG5cclxuICBmb3IgKGxldCBpID0gMDsgaSA8IG5leHRBdHRycy5sZW5ndGg7IGkrKykge1xyXG4gICAgcHJldi5zZXRBdHRyaWJ1dGUobmV4dEF0dHJzW2ldLm5hbWUsIG5leHRBdHRyc1tpXS52YWx1ZSk7XHJcbiAgfVxyXG59XHJcblxyXG4vLy8gYXBwbHkgcGF0Y2hlcyB0byB0aGUgY2hpbGRyZW4gc2VxdWVuY2Ugb2YgYHByZXYgPHN2ZyBvciBnPmAgaW4gdGhlIERPTVxyXG5mdW5jdGlvbiBwYXRjaENoaWxkcmVuKHByZXY6IEVsZW1lbnQsIG5leHQ6IEVsZW1lbnQpIHtcclxuICBjb25zdCBbdGFyZ2V0VmlldywgdG9QYXRjaF0gPSBpbnRlcnByZXRUYXJnZXRWaWV3PFNWR0dFbGVtZW50PihcclxuICAgIHByZXYuY2hpbGRyZW4gYXMgdW5rbm93biBhcyBTVkdHRWxlbWVudFtdLFxyXG4gICAgbmV4dC5jaGlsZHJlbiBhcyB1bmtub3duIGFzIFNWR0dFbGVtZW50W10sXHJcbiAgICBpc0dFbGVtLFxyXG4gICk7XHJcblxyXG4gIGZvciAobGV0IFtwcmV2Q2hpbGQsIG5leHRDaGlsZF0gb2YgdG9QYXRjaCkge1xyXG4gICAgcmV1c2VPclBhdGNoRWxlbShwcmV2Q2hpbGQsIG5leHRDaGlsZCk7XHJcbiAgfVxyXG5cclxuICAvLyBjb25zb2xlLmxvZyhcImludGVycHJldGVkIHRhcmdldCB2aWV3XCIsIHRhcmdldFZpZXcpO1xyXG5cclxuICBjb25zdCBvcmlnaW5WaWV3ID0gY2hhbmdlVmlld1BlcnNwZWN0aXZlKFxyXG4gICAgcHJldi5jaGlsZHJlbiBhcyB1bmtub3duIGFzIFNWR0dFbGVtZW50W10sXHJcbiAgICB0YXJnZXRWaWV3LFxyXG4gICAgaXNHRWxlbSxcclxuICApO1xyXG5cclxuICBydW5PcmlnaW5WaWV3SW5zdHJ1Y3Rpb25zKHByZXYsIG9yaWdpblZpZXcpO1xyXG59XHJcblxyXG4vLy8gUmVwbGFjZSB0aGUgYHByZXZgIGVsZW1lbnQgd2l0aCBgbmV4dGAgZWxlbWVudC5cclxuLy8vIFJldHVybiB0cnVlIGlmIHRoZSBgcHJldmAgZWxlbWVudCBpcyByZXVzZWQuXHJcbi8vLyBSZXR1cm4gZmFsc2UgaWYgdGhlIGBwcmV2YCBlbGVtZW50IGlzIHJlcGxhY2VkLlxyXG5mdW5jdGlvbiByZXVzZU9yUGF0Y2hFbGVtKHByZXY6IFNWR0dFbGVtZW50LCBuZXh0OiBTVkdHRWxlbWVudCkge1xyXG4gIGNvbnN0IGNhblJldXNlID0gZXF1YWxFbGVtKHByZXYsIG5leHQpO1xyXG5cclxuICAvLy8gRXZlbiBpZiB0aGUgZWxlbWVudCBpcyByZXVzZWQsIHdlIHN0aWxsIG5lZWQgdG8gcmVwbGFjZSBpdHMgYXR0cmlidXRlcy5cclxuICBuZXh0LnJlbW92ZUF0dHJpYnV0ZShUeXBzdFN2Z0F0dHJzLlJldXNlRnJvbSk7XHJcbiAgcGF0Y2hBdHRyaWJ1dGVzKHByZXYsIG5leHQpO1xyXG5cclxuICBpZiAoY2FuUmV1c2UpIHtcclxuICAgIHJldHVybiB0cnVlIC8qIHJldXNlZCAqLztcclxuICB9XHJcblxyXG4gIC8vLyBIYXJkIHJlcGxhY2UgZWxlbWVudHMgdGhhdCBpcyBub3QgYSBgPGc+YCBlbGVtZW50LlxyXG4gIHJlcGxhY2VOb25TVkdFbGVtZW50cyhwcmV2LCBuZXh0KTtcclxuICAvLy8gUGF0Y2ggYDxnPmAgY2hpbGRyZW4sIHdpbGwgY2FsbCBgcmV1c2VPclBhdGNoRWxlbWAgYWdhaW4uXHJcbiAgcGF0Y2hDaGlsZHJlbihwcmV2LCBuZXh0KTtcclxuICByZXR1cm4gZmFsc2UgLyogcmV1c2VkICovO1xyXG5cclxuICBmdW5jdGlvbiByZXBsYWNlTm9uU1ZHRWxlbWVudHMocHJldjogRWxlbWVudCwgbmV4dDogRWxlbWVudCkge1xyXG4gICAgY29uc3QgcmVtb3ZlZEluZGVjaWVzOiBudW1iZXJbXSA9IFtdO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmV2LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IHByZXZDaGlsZCA9IHByZXYuY2hpbGRyZW5baV07XHJcbiAgICAgIGlmICghaXNHRWxlbShwcmV2Q2hpbGQpKSB7XHJcbiAgICAgICAgcmVtb3ZlZEluZGVjaWVzLnB1c2goaSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IGluZGV4IG9mIHJlbW92ZWRJbmRlY2llcy5yZXZlcnNlKCkpIHtcclxuICAgICAgcHJldi5jaGlsZHJlbltpbmRleF0ucmVtb3ZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXh0LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IG5leHRDaGlsZCA9IG5leHQuY2hpbGRyZW5baV07XHJcbiAgICAgIGlmICghaXNHRWxlbShuZXh0Q2hpbGQpKSB7XHJcbiAgICAgICAgcHJldi5hcHBlbmRDaGlsZChuZXh0Q2hpbGQuY2xvbmVOb2RlKHRydWUpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLy8vIEVuZCBvZiBSZWN1cnNpdmUgU3ZnIFBhdGNoXHJcbiJdfQ==