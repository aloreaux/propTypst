export var PreviewMode;
(function (PreviewMode) {
    PreviewMode[PreviewMode["Doc"] = 0] = "Doc";
    PreviewMode[PreviewMode["Slide"] = 1] = "Slide";
})(PreviewMode = PreviewMode || (PreviewMode = {}));
export class TypstDocumentContext {
    hookedElem;
    kModule;
    opts;
    modes = [];
    /// Configuration fields
    /// enable partial rendering
    partialRendering = true;
    /// underlying renderer
    renderMode = 'svg';
    r = undefined;
    /// preview mode
    previewMode = PreviewMode.Doc;
    /// whether this is a content preview
    isContentPreview = false;
    /// whether this content preview will mix outline titles
    isMixinOutline = false;
    /// background color
    backgroundColor = 'black';
    /// default page color (empty string means transparent)
    pageColor = 'white';
    /// pixel per pt
    pixelPerPt = 3;
    /// customized way to retrieving dom state
    retrieveDOMState;
    /// State fields
    /// whether svg is updating (in triggerSvgUpdate)
    isRendering = false;
    /// whether kModule is initialized
    moduleInitialized = false;
    /// patch queue for updating data.
    patchQueue = [];
    /// resources to dispose
    disposeList = [];
    /// canvas render ctoken
    canvasRenderCToken;
    /// There are two scales in this class: The real scale is to adjust the size
    /// of `hookedElem` to fit the svg. The virtual scale (scale ratio) is to let
    /// user zoom in/out the svg. For example:
    /// + the default value of virtual scale is 1, which means the svg is totally
    ///   fit in `hookedElem`.
    /// + if user set virtual scale to 0.5, then the svg will be zoomed out to fit
    ///   in half width of `hookedElem`. "real" current scale of `hookedElem`
    currentRealScale = 1;
    /// "virtual" current scale of `hookedElem`
    currentScaleRatio = 1;
    /// timeout for delayed viewport change
    vpTimeout = undefined;
    /// sampled by last render time.
    sampledRenderTime = 0;
    /// page to partial render
    partialRenderPage = 0;
    /// outline data
    outline = undefined;
    /// cursor position in form of [page, x, y]
    cursorPosition = undefined;
    // id: number = rnd++;
    /// Cache fields
    /// cached state of container, default to retrieve state from `this.hookedElem`
    cachedDOMState = {
        width: 0,
        height: 0,
        window: {
            innerWidth: 0,
            innerHeight: 0,
        },
        boundingRect: {
            left: 0,
            top: 0,
            right: 0,
        },
    };
    constructor(opts) {
        this.hookedElem = opts.hookedElem;
        this.kModule = opts.kModule;
        this.opts = opts || {};
        /// Apply configuration
        {
            const { renderMode, previewMode, isContentPreview, retrieveDOMState } = opts || {};
            this.partialRendering = false;
            this.renderMode = renderMode ?? this.renderMode;
            this.previewMode = previewMode ?? this.previewMode;
            this.isContentPreview = isContentPreview || false;
            this.retrieveDOMState =
                retrieveDOMState ??
                    (() => {
                        return {
                            width: this.hookedElem.offsetWidth,
                            height: this.hookedElem.offsetHeight,
                            window: {
                                innerWidth: window.innerWidth,
                                innerHeight: window.innerHeight,
                            },
                            boundingRect: this.hookedElem.getBoundingClientRect(),
                        };
                    });
            this.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--typst-preview-background-color');
        }
        // if init scale == 1
        // hide scrollbar if scale == 1
        this.hookedElem.classList.add('hide-scrollbar-x');
        this.hookedElem.parentElement?.classList.add('hide-scrollbar-x');
        if (this.previewMode === PreviewMode.Slide) {
            this.hookedElem.classList.add('hide-scrollbar-y');
            this.hookedElem.parentElement?.classList.add('hide-scrollbar-y');
        }
        this.installCtrlWheelHandler();
    }
    reset() {
        this.kModule.reset();
        this.moduleInitialized = false;
    }
    dispose() {
        const disposeList = this.disposeList;
        this.disposeList = [];
        disposeList.forEach(x => x());
    }
    static derive(ctx, mode) {
        return ['rescale', 'rerender', 'postRender'].reduce((acc, x) => {
            acc[x] = ctx[`${x}$${mode}`].bind(ctx);
            console.assert(acc[x] !== undefined, `${x}$${mode} is undefined`);
            return acc;
        }, {});
    }
    registerMode(mode) {
        const facade = TypstDocumentContext.derive(this, mode);
        this.modes.push([mode, facade]);
        if (mode === this.renderMode) {
            this.r = facade;
        }
    }
    installCtrlWheelHandler() {
        // Ctrl+scroll rescaling
        // will disable auto resizing
        // fixed factors, same as pdf.js
        const factors = [
            0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.3, 1.5, 1.7, 1.9, 2.1, 2.4, 2.7, 3,
            3.3, 3.7, 4.1, 4.6, 5.1, 5.7, 6.3, 7, 7.7, 8.5, 9.4, 10,
        ];
        const wheelEventHandler = (event) => {
            if (event.ctrlKey) {
                event.preventDefault();
                // retrieve dom state before any operation
                this.cachedDOMState = this.retrieveDOMState();
                if (window.onresize !== null) {
                    // is auto resizing
                    window.onresize = null;
                }
                const prevScaleRatio = this.currentScaleRatio;
                // Get wheel scroll direction and calculate new scale
                if (event.deltaY < 0) {
                    // enlarge
                    if (this.currentScaleRatio >= factors.at(-1)) {
                        // already large than max factor
                        return;
                    }
                    else {
                        this.currentScaleRatio = factors.filter(x => x > this.currentScaleRatio).at(0);
                    }
                }
                else if (event.deltaY > 0) {
                    // reduce
                    if (this.currentScaleRatio <= factors.at(0)) {
                        return;
                    }
                    else {
                        this.currentScaleRatio = factors.filter(x => x < this.currentScaleRatio).at(-1);
                    }
                }
                else {
                    // no y-axis scroll
                    return;
                }
                const scrollFactor = this.currentScaleRatio / prevScaleRatio;
                const scrollX = event.pageX * (scrollFactor - 1);
                const scrollY = event.pageY * (scrollFactor - 1);
                // hide scrollbar if scale == 1
                if (Math.abs(this.currentScaleRatio - 1) < 1e-5) {
                    this.hookedElem.classList.add('hide-scrollbar-x');
                    this.hookedElem.parentElement?.classList.add('hide-scrollbar-x');
                    if (this.previewMode === PreviewMode.Slide) {
                        this.hookedElem.classList.add('hide-scrollbar-y');
                        this.hookedElem.parentElement?.classList.add('hide-scrollbar-y');
                    }
                }
                else {
                    this.hookedElem.classList.remove('hide-scrollbar-x');
                    this.hookedElem.parentElement?.classList.remove('hide-scrollbar-x');
                    if (this.previewMode === PreviewMode.Slide) {
                        this.hookedElem.classList.remove('hide-scrollbar-y');
                        this.hookedElem.parentElement?.classList.remove('hide-scrollbar-y');
                    }
                }
                // reserve space to scroll down
                const svg = this.hookedElem.firstElementChild;
                if (svg) {
                    const scaleRatio = this.getSvgScaleRatio();
                    const dataHeight = Number.parseFloat(svg.getAttribute('data-height'));
                    const scaledHeight = Math.ceil(dataHeight * scaleRatio);
                    // we increase the height by 2 times.
                    // The `2` is only a magic number that is large enough.
                    this.hookedElem.style.height = `${scaledHeight * 2}px`;
                }
                // make sure the cursor is still on the same position
                window.scrollBy(scrollX, scrollY);
                // toggle scale change event
                this.addViewportChange();
                return false;
            }
        };
        if (this.renderMode !== 'dom') {
            const vscodeAPI = typeof acquireVsCodeApi !== 'undefined';
            if (vscodeAPI) {
                window.addEventListener('wheel', wheelEventHandler, {
                    passive: false,
                });
                this.disposeList.push(() => {
                    window.removeEventListener('wheel', wheelEventHandler);
                });
            }
            else {
                document.body.addEventListener('wheel', wheelEventHandler, {
                    passive: false,
                });
                this.disposeList.push(() => {
                    document.body.removeEventListener('wheel', wheelEventHandler);
                });
            }
        }
    }
    /// Get current scale from html to svg
    // Note: one should retrieve dom state before rescale
    getSvgScaleRatio() {
        const svg = this.hookedElem.firstElementChild;
        if (!svg) {
            return 0;
        }
        const container = this.cachedDOMState;
        const svgWidth = Number.parseFloat(svg.getAttribute('data-width') || svg.getAttribute('width') || '1');
        const svgHeight = Number.parseFloat(svg.getAttribute('data-height') || svg.getAttribute('height') || '1');
        this.currentRealScale =
            this.previewMode === PreviewMode.Slide
                ? Math.min(container.width / svgWidth, container.height / svgHeight)
                : container.width / svgWidth;
        return this.currentRealScale * this.currentScaleRatio;
    }
    processQueue(svgUpdateEvent) {
        const eventName = svgUpdateEvent[0];
        switch (eventName) {
            case 'new':
            case 'diff-v1': {
                if (eventName === 'new') {
                    this.reset();
                }
                this.kModule.manipulateData({
                    action: 'merge',
                    data: svgUpdateEvent[1],
                });
                this.moduleInitialized = true;
                return true;
            }
            case 'viewport-change': {
                if (!this.moduleInitialized) {
                    console.log('viewport-change before initialization');
                    return false;
                }
                return true;
            }
            default:
                console.log('svgUpdateEvent', svgUpdateEvent);
                return false;
        }
    }
    triggerUpdate() {
        if (this.isRendering) {
            return;
        }
        this.isRendering = true;
        const doUpdate = async () => {
            this.cachedDOMState = this.retrieveDOMState();
            if (this.patchQueue.length === 0) {
                this.isRendering = false;
                this.postprocessChanges();
                return;
            }
            try {
                let t0 = performance.now();
                const ctoken = this.canvasRenderCToken;
                if (ctoken) {
                    await ctoken.cancel();
                    await ctoken.wait();
                    this.canvasRenderCToken = undefined;
                    console.log('cancel canvas rendering');
                }
                let needRerender = false;
                // console.log('patchQueue', JSON.stringify(this.patchQueue.map(x => x[0])));
                while (this.patchQueue.length > 0) {
                    needRerender = this.processQueue(this.patchQueue.shift()) || needRerender;
                }
                // todo: trigger viewport change once
                let t1 = performance.now();
                if (needRerender) {
                    this.r.rescale();
                    await this.r.rerender();
                    this.r.rescale();
                }
                let t2 = performance.now();
                /// perf event
                const d = (e, x, y) => `${e} ${(y - x).toFixed(2)} ms`;
                this.sampledRenderTime = t2 - t0;
                console.log([d('parse', t0, t1), d('rerender', t1, t2), d('total', t0, t2)].join(', '));
                requestAnimationFrame(doUpdate);
            }
            catch (e) {
                console.error(e);
                this.isRendering = false;
                this.postprocessChanges();
            }
        };
        requestAnimationFrame(doUpdate);
    }
    postprocessChanges() {
        this.r.postRender();
        // todo: abstract this
        if (this.previewMode === PreviewMode.Slide) {
            document.querySelectorAll('.typst-page-number-indicator').forEach(x => {
                x.textContent = `${this.kModule.retrievePagesInfo().length}`;
            });
        }
    }
    addChangement(change) {
        if (change[0] === 'new') {
            this.patchQueue.splice(0, this.patchQueue.length);
        }
        const pushChange = () => {
            this.vpTimeout = undefined;
            this.patchQueue.push(change);
            this.triggerUpdate();
        };
        if (this.vpTimeout !== undefined) {
            clearTimeout(this.vpTimeout);
        }
        if (change[0] === 'viewport-change' && this.isRendering) {
            // delay viewport change a bit
            this.vpTimeout = setTimeout(pushChange, this.sampledRenderTime || 100);
        }
        else {
            pushChange();
        }
    }
    addViewportChange() {
        this.addChangement(['viewport-change', '']);
    }
}
export function provideDoc(Base) {
    return class TypstDocument {
        impl;
        kModule;
        constructor(options) {
            if (options.isContentPreview) {
                options.renderMode = 'canvas';
            }
            this.kModule = options.kModule;
            this.impl = new Base(options);
            if (!this.impl.r) {
                throw new Error(`mode is not supported, ${options?.renderMode}`);
            }
            if (options.isContentPreview) {
                // content preview has very bad performance without partial rendering
                this.impl.partialRendering = true;
                this.impl.pixelPerPt = 1;
                this.impl.isMixinOutline = true;
            }
        }
        dispose() {
            this.impl.dispose();
        }
        reset() {
            this.impl.reset();
        }
        addChangement(change) {
            this.impl.addChangement(change);
        }
        addViewportChange() {
            this.impl.addViewportChange();
        }
        setPageColor(color) {
            this.impl.pageColor = color;
            this.addViewportChange();
        }
        setPartialRendering(partialRendering) {
            this.impl.partialRendering = partialRendering;
        }
        setCursor(page, x, y) {
            this.impl.cursorPosition = [page, x, y];
        }
        setPartialPageNumber(page) {
            if (page <= 0 || page > this.kModule.retrievePagesInfo().length) {
                return false;
            }
            this.impl.partialRenderPage = page - 1;
            this.addViewportChange();
            return true;
        }
        getPartialPageNumber() {
            return this.impl.partialRenderPage + 1;
        }
        setOutineData(outline) {
            this.impl.outline = outline;
            this.addViewportChange();
        }
    };
}
export function composeDoc(Base, ...mixins) {
    return mixins.reduce((acc, mixin) => mixin(acc), Base);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwc3QtZG9jLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb250cmliL2RvbS90eXBzdC1kb2MubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQXVCQSxNQUFNLENBQU4sSUFBWSxXQUdYO0FBSEQsV0FBWSxXQUFXO0lBQ3JCLDJDQUFHLENBQUE7SUFDSCwrQ0FBSyxDQUFBO0FBQ1AsQ0FBQyxFQUhXLFdBQVcsR0FBWCxXQUFXLEtBQVgsV0FBVyxRQUd0QjtBQW9CRCxNQUFNLE9BQU8sb0JBQW9CO0lBQ3hCLFVBQVUsQ0FBYztJQUN4QixPQUFPLENBQWdCO0lBQ3ZCLElBQUksQ0FBSTtJQUNmLEtBQUssR0FBb0MsRUFBRSxDQUFDO0lBRTVDLHdCQUF3QjtJQUV4Qiw0QkFBNEI7SUFDNUIsZ0JBQWdCLEdBQVksSUFBSSxDQUFDO0lBQ2pDLHVCQUF1QjtJQUN2QixVQUFVLEdBQWUsS0FBSyxDQUFDO0lBQy9CLENBQUMsR0FBd0IsU0FBVSxDQUFDO0lBQ3BDLGdCQUFnQjtJQUNoQixXQUFXLEdBQWdCLFdBQVcsQ0FBQyxHQUFHLENBQUM7SUFDM0MscUNBQXFDO0lBQ3JDLGdCQUFnQixHQUFZLEtBQUssQ0FBQztJQUNsQyx3REFBd0Q7SUFDeEQsY0FBYyxHQUFZLEtBQUssQ0FBQztJQUNoQyxvQkFBb0I7SUFDcEIsZUFBZSxHQUFXLE9BQU8sQ0FBQztJQUNsQyx1REFBdUQ7SUFDdkQsU0FBUyxHQUFXLE9BQU8sQ0FBQztJQUM1QixnQkFBZ0I7SUFDaEIsVUFBVSxHQUFXLENBQUMsQ0FBQztJQUN2QiwwQ0FBMEM7SUFDMUMsZ0JBQWdCLENBQTBCO0lBRTFDLGdCQUFnQjtJQUVoQixpREFBaUQ7SUFDakQsV0FBVyxHQUFZLEtBQUssQ0FBQztJQUM3QixrQ0FBa0M7SUFDbEMsaUJBQWlCLEdBQVksS0FBSyxDQUFDO0lBQ25DLGtDQUFrQztJQUNsQyxVQUFVLEdBQXVCLEVBQUUsQ0FBQztJQUNwQyx3QkFBd0I7SUFDeEIs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QzthQUNkO1lBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQ3pCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELG9CQUFvQjtZQUNsQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLENBQUM7UUFFRCxhQUFhLENBQUMsT0FBWTtZQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7WUFDNUIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDM0IsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDO0FBMEVELE1BQU0sVUFBVSxVQUFVLENBQTZCLElBQVcsRUFBRSxHQUFHLE1BQWE7SUFDbEYsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3pELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFJlbmRlclNlc3Npb24gfSBmcm9tICcuLi8uLi9yZW5kZXJlci5tanMnO1xyXG5pbXBvcnQgeyBUeXBzdENhbmNlbGxhdGlvblRva2VuIH0gZnJvbSAnLi90eXBzdC1jYW5jZWwubWpzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ29udGFpbmVyRE9NU3RhdGUge1xyXG4gIC8vLyBjYWNoZWQgYGhvb2tlZEVsZW0ub2Zmc2V0V2lkdGhgIG9yIGBob29rZWRFbGVtLmlubmVyV2lkdGhgXHJcbiAgd2lkdGg6IG51bWJlcjtcclxuICAvLy8gY2FjaGVkIGBob29rZWRFbGVtLm9mZnNldEhlaWdodGAgb3IgYGhvb2tlZEVsZW0uaW5uZXJIZWlnaHRgXHJcbiAgaGVpZ2h0OiBudW1iZXI7XHJcbiAgd2luZG93OiB7XHJcbiAgICBpbm5lcldpZHRoOiBudW1iZXI7XHJcbiAgICBpbm5lckhlaWdodDogbnVtYmVyO1xyXG4gIH07XHJcbiAgLy8vIGNhY2hlZCBgaG9va2VkRWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKWBcclxuICAvLy8gV2Ugb25seSB1c2UgYGxlZnRgIGFuZCBgdG9wYCBoZXJlLlxyXG4gIGJvdW5kaW5nUmVjdDoge1xyXG4gICAgbGVmdDogbnVtYmVyO1xyXG4gICAgdG9wOiBudW1iZXI7XHJcbiAgICByaWdodDogbnVtYmVyO1xyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIFJlbmRlck1vZGUgPSAnc3ZnJyB8ICdjYW52YXMnIHwgJ2RvbSc7XHJcblxyXG5leHBvcnQgZW51bSBQcmV2aWV3TW9kZSB7XHJcbiAgRG9jLFxyXG4gIFNsaWRlLFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE9wdGlvbnMge1xyXG4gIGhvb2tlZEVsZW06IEhUTUxFbGVtZW50O1xyXG4gIGtNb2R1bGU6IFJlbmRlclNlc3Npb247XHJcbiAgcmVuZGVyTW9kZT86IFJlbmRlck1vZGU7XHJcbiAgcHJldmlld01vZGU/OiBQcmV2aWV3TW9kZTtcclxuICBpc0NvbnRlbnRQcmV2aWV3PzogYm9vbGVhbjtcclxuICBzb3VyY2VNYXBwaW5nPzogYm9vbGVhbjtcclxuICByZXRyaWV2ZURPTVN0YXRlPzogKCkgPT4gQ29udGFpbmVyRE9NU3RhdGU7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIEdDb25zdHJ1Y3RvcjxUID0ge30+ID0gbmV3ICguLi5hcmdzOiBhbnlbXSkgPT4gVDtcclxuXHJcbmludGVyZmFjZSBUeXBzdERvY3VtZW50RmFjYWRlIHtcclxuICByZXNjYWxlKCk6IHZvaWQ7XHJcbiAgcmVyZW5kZXIoKTogUHJvbWlzZTx2b2lkPjtcclxuICBwb3N0UmVuZGVyKCk6IHZvaWQ7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBUeXBzdERvY3VtZW50Q29udGV4dDxPID0gYW55PiB7XHJcbiAgcHVibGljIGhvb2tlZEVsZW06IEhUTUxFbGVtZW50O1xyXG4gIHB1YmxpYyBrTW9kdWxlOiBSZW5kZXJTZXNzaW9uO1xyXG4gIHB1YmxpYyBvcHRzOiBPO1xyXG4gIG1vZGVzOiBbc3RyaW5nLCBUeXBzdERvY3VtZW50RmFjYWRlXVtdID0gW107XHJcblxyXG4gIC8vLyBDb25maWd1cmF0aW9uIGZpZWxkc1xyXG5cclxuICAvLy8gZW5hYmxlIHBhcnRpYWwgcmVuZGVyaW5nXHJcbiAgcGFydGlhbFJlbmRlcmluZzogYm9vbGVhbiA9IHRydWU7XHJcbiAgLy8vIHVuZGVybHlpbmcgcmVuZGVyZXJcclxuICByZW5kZXJNb2RlOiBSZW5kZXJNb2RlID0gJ3N2Zyc7XHJcbiAgcjogVHlwc3REb2N1bWVudEZhY2FkZSA9IHVuZGVmaW5lZCE7XHJcbiAgLy8vIHByZXZpZXcgbW9kZVxyXG4gIHByZXZpZXdNb2RlOiBQcmV2aWV3TW9kZSA9IFByZXZpZXdNb2RlLkRvYztcclxuICAvLy8gd2hldGhlciB0aGlzIGlzIGEgY29udGVudCBwcmV2aWV3XHJcbiAgaXNDb250ZW50UHJldmlldzogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIC8vLyB3aGV0aGVyIHRoaXMgY29udGVudCBwcmV2aWV3IHdpbGwgbWl4IG91dGxpbmUgdGl0bGVzXHJcbiAgaXNNaXhpbk91dGxpbmU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAvLy8gYmFja2dyb3VuZCBjb2xvclxyXG4gIGJhY2tncm91bmRDb2xvcjogc3RyaW5nID0gJ2JsYWNrJztcclxuICAvLy8gZGVmYXVsdCBwYWdlIGNvbG9yIChlbXB0eSBzdHJpbmcgbWVhbnMgdHJhbnNwYXJlbnQpXHJcbiAgcGFnZUNvbG9yOiBzdHJpbmcgPSAnd2hpdGUnO1xyXG4gIC8vLyBwaXhlbCBwZXIgcHRcclxuICBwaXhlbFBlclB0OiBudW1iZXIgPSAzO1xyXG4gIC8vLyBjdXN0b21pemVkIHdheSB0byByZXRyaWV2aW5nIGRvbSBzdGF0ZVxyXG4gIHJldHJpZXZlRE9NU3RhdGU6ICgpID0+IENvbnRhaW5lckRPTVN0YXRlO1xyXG5cclxuICAvLy8gU3RhdGUgZmllbGRzXHJcblxyXG4gIC8vLyB3aGV0aGVyIHN2ZyBpcyB1cGRhdGluZyAoaW4gdHJpZ2dlclN2Z1VwZGF0ZSlcclxuICBpc1JlbmRlcmluZzogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIC8vLyB3aGV0aGVyIGtNb2R1bGUgaXMgaW5pdGlhbGl6ZWRcclxuICBtb2R1bGVJbml0aWFsaXplZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIC8vLyBwYXRjaCBxdWV1ZSBmb3IgdXBkYXRpbmcgZGF0YS5cclxuICBwYXRjaFF1ZXVlOiBbc3RyaW5nLCBzdHJpbmddW10gPSBbXTtcclxuICAvLy8gcmVzb3VyY2VzIHRvIGRpc3Bvc2VcclxuICBkaXNwb3NlTGlzdDogKCgpID0+IHZvaWQpW10gPSBbXTtcclxuICAvLy8gY2FudmFzIHJlbmRlciBjdG9rZW5cclxuICBjYW52YXNSZW5kZXJDVG9rZW4/OiBUeXBzdENhbmNlbGxhdGlvblRva2VuO1xyXG5cclxuICAvLy8gVGhlcmUgYXJlIHR3byBzY2FsZXMgaW4gdGhpcyBjbGFzczogVGhlIHJlYWwgc2NhbGUgaXMgdG8gYWRqdXN0IHRoZSBzaXplXHJcbiAgLy8vIG9mIGBob29rZWRFbGVtYCB0byBmaXQgdGhlIHN2Zy4gVGhlIHZpcnR1YWwgc2NhbGUgKHNjYWxlIHJhdGlvKSBpcyB0byBsZXRcclxuICAvLy8gdXNlciB6b29tIGluL291dCB0aGUgc3ZnLiBGb3IgZXhhbXBsZTpcclxuICAvLy8gKyB0aGUgZGVmYXVsdCB2YWx1ZSBvZiB2aXJ0dWFsIHNjYWxlIGlzIDEsIHdoaWNoIG1lYW5zIHRoZSBzdmcgaXMgdG90YWxseVxyXG4gIC8vLyAgIGZpdCBpbiBgaG9va2VkRWxlbWAuXHJcbiAgLy8vICsgaWYgdXNlciBzZXQgdmlydHVhbCBzY2FsZSB0byAwLjUsIHRoZW4gdGhlIHN2ZyB3aWxsIGJlIHpvb21lZCBvdXQgdG8gZml0XHJcbiAgLy8vICAgaW4gaGFsZiB3aWR0aCBvZiBgaG9va2VkRWxlbWAuIFwicmVhbFwiIGN1cnJlbnQgc2NhbGUgb2YgYGhvb2tlZEVsZW1gXHJcbiAgY3VycmVudFJlYWxTY2FsZTogbnVtYmVyID0gMTtcclxuICAvLy8gXCJ2aXJ0dWFsXCIgY3VycmVudCBzY2FsZSBvZiBgaG9va2VkRWxlbWBcclxuICBjdXJyZW50U2NhbGVSYXRpbzogbnVtYmVyID0gMTtcclxuICAvLy8gdGltZW91dCBmb3IgZGVsYXllZCB2aWV3cG9ydCBjaGFuZ2VcclxuICB2cFRpbWVvdXQ6IGFueSA9IHVuZGVmaW5lZDtcclxuICAvLy8gc2FtcGxlZCBieSBsYXN0IHJlbmRlciB0aW1lLlxyXG4gIHNhbXBsZWRSZW5kZXJUaW1lOiBudW1iZXIgPSAwO1xyXG4gIC8vLyBwYWdlIHRvIHBhcnRpYWwgcmVuZGVyXHJcbiAgcGFydGlhbFJlbmRlclBhZ2U6IG51bWJlciA9IDA7XHJcbiAgLy8vIG91dGxpbmUgZGF0YVxyXG4gIG91dGxpbmU6IGFueSA9IHVuZGVmaW5lZDtcclxuICAvLy8gY3Vyc29yIHBvc2l0aW9uIGluIGZvcm0gb2YgW3BhZ2UsIHgsIHldXHJcbiAgY3Vyc29yUG9zaXRpb24/OiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0gPSB1bmRlZmluZWQ7XHJcbiAgLy8gaWQ6IG51bWJlciA9IHJuZCsrO1xyXG5cclxuICAvLy8gQ2FjaGUgZmllbGRzXHJcblxyXG4gIC8vLyBjYWNoZWQgc3RhdGUgb2YgY29udGFpbmVyLCBkZWZhdWx0IHRvIHJldHJpZXZlIHN0YXRlIGZyb20gYHRoaXMuaG9va2VkRWxlbWBcclxuICBjYWNoZWRET01TdGF0ZTogQ29udGFpbmVyRE9NU3RhdGUgPSB7XHJcbiAgICB3aWR0aDogMCxcclxuICAgIGhlaWdodDogMCxcclxuICAgIHdpbmRvdzoge1xyXG4gICAgICBpbm5lcldpZHRoOiAwLFxyXG4gICAgICBpbm5lckhlaWdodDogMCxcclxuICAgIH0sXHJcbiAgICBib3VuZGluZ1JlY3Q6IHtcclxuICAgICAgbGVmdDogMCxcclxuICAgICAgdG9wOiAwLFxyXG4gICAgICByaWdodDogMCxcclxuICAgIH0sXHJcbiAgfTtcclxuXHJcbiAgY29uc3RydWN0b3Iob3B0czogT3B0aW9ucyAmIE8pIHtcclxuICAgIHRoaXMuaG9va2VkRWxlbSA9IG9wdHMuaG9va2VkRWxlbTtcclxuICAgIHRoaXMua01vZHVsZSA9IG9wdHMua01vZHVsZTtcclxuICAgIHRoaXMub3B0cyA9IG9wdHMgfHwge307XHJcblxyXG4gICAgLy8vIEFwcGx5IGNvbmZpZ3VyYXRpb25cclxuICAgIHtcclxuICAgICAgY29uc3QgeyByZW5kZXJNb2RlLCBwcmV2aWV3TW9kZSwgaXNDb250ZW50UHJldmlldywgcmV0cmlldmVET01TdGF0ZSB9ID0gb3B0cyB8fCB7fTtcclxuICAgICAgdGhpcy5wYXJ0aWFsUmVuZGVyaW5nID0gZmFsc2U7XHJcbiAgICAgIHRoaXMucmVuZGVyTW9kZSA9IHJlbmRlck1vZGUgPz8gdGhpcy5yZW5kZXJNb2RlO1xyXG4gICAgICB0aGlzLnByZXZpZXdNb2RlID0gcHJldmlld01vZGUgPz8gdGhpcy5wcmV2aWV3TW9kZTtcclxuICAgICAgdGhpcy5pc0NvbnRlbnRQcmV2aWV3ID0gaXNDb250ZW50UHJldmlldyB8fCBmYWxzZTtcclxuICAgICAgdGhpcy5yZXRyaWV2ZURPTVN0YXRlID1cclxuICAgICAgICByZXRyaWV2ZURPTVN0YXRlID8/XHJcbiAgICAgICAgKCgpID0+IHtcclxuICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHdpZHRoOiB0aGlzLmhvb2tlZEVsZW0ub2Zmc2V0V2lkdGgsXHJcbiAgICAgICAgICAgIGhlaWdodDogdGhpcy5ob29rZWRFbGVtLm9mZnNldEhlaWdodCxcclxuICAgICAgICAgICAgd2luZG93OiB7XHJcbiAgICAgICAgICAgICAgaW5uZXJXaWR0aDogd2luZG93LmlubmVyV2lkdGgsXHJcbiAgICAgICAgICAgICAgaW5uZXJIZWlnaHQ6IHdpbmRvdy5pbm5lckhlaWdodCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgYm91bmRpbmdSZWN0OiB0aGlzLmhvb2tlZEVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB0aGlzLmJhY2tncm91bmRDb2xvciA9IGdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KS5nZXRQcm9wZXJ0eVZhbHVlKFxyXG4gICAgICAgICctLXR5cHN0LXByZXZpZXctYmFja2dyb3VuZC1jb2xvcicsXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gaWYgaW5pdCBzY2FsZSA9PSAxXHJcbiAgICAvLyBoaWRlIHNjcm9sbGJhciBpZiBzY2FsZSA9PSAxXHJcblxyXG4gICAgdGhpcy5ob29rZWRFbGVtLmNsYXNzTGlzdC5hZGQoJ2hpZGUtc2Nyb2xsYmFyLXgnKTtcclxuICAgIHRoaXMuaG9va2VkRWxlbS5wYXJlbnRFbGVtZW50Py5jbGFzc0xpc3QuYWRkKCdoaWRlLXNjcm9sbGJhci14Jyk7XHJcbiAgICBpZiAodGhpcy5wcmV2aWV3TW9kZSA9PT0gUHJldmlld01vZGUuU2xpZGUpIHtcclxuICAgICAgdGhpcy5ob29rZWRFbGVtLmNsYXNzTGlzdC5hZGQoJ2hpZGUtc2Nyb2xsYmFyLXknKTtcclxuICAgICAgdGhpcy5ob29rZWRFbGVtLnBhcmVudEVsZW1lbnQ/LmNsYXNzTGlzdC5hZGQoJ2hpZGUtc2Nyb2xsYmFyLXknKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmluc3RhbGxDdHJsV2hlZWxIYW5kbGVyKCk7XHJcbiAgfVxyXG5cclxuICByZXNldCgpIHtcclxuICAgIHRoaXMua01vZHVsZS5yZXNldCgpO1xyXG4gICAgdGhpcy5tb2R1bGVJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIGNvbnN0IGRpc3Bvc2VMaXN0ID0gdGhpcy5kaXNwb3NlTGlzdDtcclxuICAgIHRoaXMuZGlzcG9zZUxpc3QgPSBbXTtcclxuICAgIGRpc3Bvc2VMaXN0LmZvckVhY2goeCA9PiB4KCkpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGRlcml2ZShjdHg6IGFueSwgbW9kZTogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gWydyZXNjYWxlJywgJ3JlcmVuZGVyJywgJ3Bvc3RSZW5kZXInXS5yZWR1Y2UoKGFjYzogYW55LCB4OiBzdHJpbmcpID0+IHtcclxuICAgICAgYWNjW3hdID0gY3R4W2Ake3h9JCR7bW9kZX1gXS5iaW5kKGN0eCk7XHJcbiAgICAgIGNvbnNvbGUuYXNzZXJ0KGFjY1t4XSAhPT0gdW5kZWZpbmVkLCBgJHt4fSQke21vZGV9IGlzIHVuZGVmaW5lZGApO1xyXG4gICAgICByZXR1cm4gYWNjO1xyXG4gICAgfSwge30gYXMgVHlwc3REb2N1bWVudEZhY2FkZSk7XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck1vZGUobW9kZTogYW55KSB7XHJcbiAgICBjb25zdCBmYWNhZGUgPSBUeXBzdERvY3VtZW50Q29udGV4dC5kZXJpdmUodGhpcywgbW9kZSk7XHJcbiAgICB0aGlzLm1vZGVzLnB1c2goW21vZGUsIGZhY2FkZV0pO1xyXG4gICAgaWYgKG1vZGUgPT09IHRoaXMucmVuZGVyTW9kZSkge1xyXG4gICAgICB0aGlzLnIgPSBmYWNhZGU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluc3RhbGxDdHJsV2hlZWxIYW5kbGVyKCkge1xyXG4gICAgLy8gQ3RybCtzY3JvbGwgcmVzY2FsaW5nXHJcbiAgICAvLyB3aWxsIGRpc2FibGUgYXV0byByZXNpemluZ1xyXG4gICAgLy8gZml4ZWQgZmFjdG9ycywgc2FtZSBhcyBwZGYuanNcclxuICAgIGNvbnN0IGZhY3RvcnMgPSBbXHJcbiAgICAgIDAuMSwgMC4yLCAwLjMsIDAuNCwgMC41LCAwLjYsIDAuNywgMC44LCAwLjksIDEsIDEuMSwgMS4zLCAxLjUsIDEuNywgMS45LCAyLjEsIDIuNCwgMi43LCAzLFxyXG4gICAgICAzLjMsIDMuNywgNC4xLCA0LjYsIDUuMSwgNS43LCA2LjMsIDcsIDcuNywgOC41LCA5LjQsIDEwLFxyXG4gICAgXTtcclxuICAgIGNvbnN0IHdoZWVsRXZlbnRIYW5kbGVyID0gKGV2ZW50OiBXaGVlbEV2ZW50KSA9PiB7XHJcbiAgICAgIGlmIChldmVudC5jdHJsS2V5KSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAvLyByZXRyaWV2ZSBkb20gc3RhdGUgYmVmb3JlIGFueSBvcGVyYXRpb25cclxuICAgICAgICB0aGlzLmNhY2hlZERPTVN0YXRlID0gdGhpcy5yZXRyaWV2ZURPTVN0YXRlKCk7XHJcbiAgICAgICAgaWYgKHdpbmRvdy5vbnJlc2l6ZSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgLy8gaXMgYXV0byByZXNpemluZ1xyXG4gICAgICAgICAgd2luZG93Lm9ucmVzaXplID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcHJldlNjYWxlUmF0aW8gPSB0aGlzLmN1cnJlbnRTY2FsZVJhdGlvO1xyXG4gICAgICAgIC8vIEdldCB3aGVlbCBzY3JvbGwgZGlyZWN0aW9uIGFuZCBjYWxjdWxhdGUgbmV3IHNjYWxlXHJcbiAgICAgICAgaWYgKGV2ZW50LmRlbHRhWSA8IDApIHtcclxuICAgICAgICAgIC8vIGVubGFyZ2VcclxuICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRTY2FsZVJhdGlvID49IGZhY3RvcnMuYXQoLTEpISkge1xyXG4gICAgICAgICAgICAvLyBhbHJlYWR5IGxhcmdlIHRoYW4gbWF4IGZhY3RvclxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRTY2FsZVJhdGlvID0gZmFjdG9ycy5maWx0ZXIoeCA9PiB4ID4gdGhpcy5jdXJyZW50U2NhbGVSYXRpbykuYXQoMCkhO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnQuZGVsdGFZID4gMCkge1xyXG4gICAgICAgICAgLy8gcmVkdWNlXHJcbiAgICAgICAgICBpZiAodGhpcy5jdXJyZW50U2NhbGVSYXRpbyA8PSBmYWN0b3JzLmF0KDApISkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRTY2FsZVJhdGlvID0gZmFjdG9ycy5maWx0ZXIoeCA9PiB4IDwgdGhpcy5jdXJyZW50U2NhbGVSYXRpbykuYXQoLTEpITtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gbm8geS1heGlzIHNjcm9sbFxyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBzY3JvbGxGYWN0b3IgPSB0aGlzLmN1cnJlbnRTY2FsZVJhdGlvIC8gcHJldlNjYWxlUmF0aW87XHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsWCA9IGV2ZW50LnBhZ2VYICogKHNjcm9sbEZhY3RvciAtIDEpO1xyXG4gICAgICAgIGNvbnN0IHNjcm9sbFkgPSBldmVudC5wYWdlWSAqIChzY3JvbGxGYWN0b3IgLSAxKTtcclxuICAgICAgICAvLyBoaWRlIHNjcm9sbGJhciBpZiBzY2FsZSA9PSAxXHJcbiAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuY3VycmVudFNjYWxlUmF0aW8gLSAxKSA8IDFlLTUpIHtcclxuICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5jbGFzc0xpc3QuYWRkKCdoaWRlLXNjcm9sbGJhci14Jyk7XHJcbiAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0ucGFyZW50RWxlbWVudD8uY2xhc3NMaXN0LmFkZCgnaGlkZS1zY3JvbGxiYXIteCcpO1xyXG4gICAgICAgICAgaWYgKHRoaXMucHJldmlld01vZGUgPT09IFByZXZpZXdNb2RlLlNsaWRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5jbGFzc0xpc3QuYWRkKCdoaWRlLXNjcm9sbGJhci15Jyk7XHJcbiAgICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5wYXJlbnRFbGVtZW50Py5jbGFzc0xpc3QuYWRkKCdoaWRlLXNjcm9sbGJhci15Jyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5jbGFzc0xpc3QucmVtb3ZlKCdoaWRlLXNjcm9sbGJhci14Jyk7XHJcbiAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0ucGFyZW50RWxlbWVudD8uY2xhc3NMaXN0LnJlbW92ZSgnaGlkZS1zY3JvbGxiYXIteCcpO1xyXG4gICAgICAgICAgaWYgKHRoaXMucHJldmlld01vZGUgPT09IFByZXZpZXdNb2RlLlNsaWRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5jbGFzc0xpc3QucmVtb3ZlKCdoaWRlLXNjcm9sbGJhci15Jyk7XHJcbiAgICAgICAgICAgIHRoaXMuaG9va2VkRWxlbS5wYXJlbnRFbGVtZW50Py5jbGFzc0xpc3QucmVtb3ZlKCdoaWRlLXNjcm9sbGJhci15Jyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHJlc2VydmUgc3BhY2UgdG8gc2Nyb2xsIGRvd25cclxuICAgICAgICBjb25zdCBzdmcgPSB0aGlzLmhvb2tlZEVsZW0uZmlyc3RFbGVtZW50Q2hpbGQhIGFzIFNWR0VsZW1lbnQ7XHJcbiAgICAgICAgaWYgKHN2Zykge1xyXG4gICAgICAgICAgY29uc3Qgc2NhbGVSYXRpbyA9IHRoaXMuZ2V0U3ZnU2NhbGVSYXRpbygpO1xyXG4gICAgICAgICAgY29uc3QgZGF0YUhlaWdodCA9IE51bWJlci5wYXJzZUZsb2F0KHN2Zy5nZXRBdHRyaWJ1dGUoJ2RhdGEtaGVpZ2h0JykhKTtcclxuICAgICAgICAgIGNvbnN0IHNjYWxlZEhlaWdodCA9IE1hdGguY2VpbChkYXRhSGVpZ2h0ICogc2NhbGVSYXRpbyk7XHJcbiAgICAgICAgICAvLyB3ZSBpbmNyZWFzZSB0aGUgaGVpZ2h0IGJ5IDIgdGltZXMuXHJcbiAgICAgICAgICAvLyBUaGUgYDJgIGlzIG9ubHkgYSBtYWdpYyBudW1iZXIgdGhhdCBpcyBsYXJnZSBlbm91Z2guXHJcbiAgICAgICAgICB0aGlzLmhvb2tlZEVsZW0uc3R5bGUuaGVpZ2h0ID0gYCR7c2NhbGVkSGVpZ2h0ICogMn1weGA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGUgY3Vyc29yIGlzIHN0aWxsIG9uIHRoZSBzYW1lIHBvc2l0aW9uXHJcbiAgICAgICAgd2luZG93LnNjcm9sbEJ5KHNjcm9sbFgsIHNjcm9sbFkpO1xyXG4gICAgICAgIC8vIHRvZ2dsZSBzY2FsZSBjaGFuZ2UgZXZlbnRcclxuICAgICAgICB0aGlzLmFkZFZpZXdwb3J0Q2hhbmdlKCk7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGlmICh0aGlzLnJlbmRlck1vZGUgIT09ICdkb20nKSB7XHJcbiAgICAgIGNvbnN0IHZzY29kZUFQSSA9IHR5cGVvZiBhY3F1aXJlVnNDb2RlQXBpICE9PSAndW5kZWZpbmVkJztcclxuICAgICAgaWYgKHZzY29kZUFQSSkge1xyXG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd3aGVlbCcsIHdoZWVsRXZlbnRIYW5kbGVyLCB7XHJcbiAgICAgICAgICBwYXNzaXZlOiBmYWxzZSxcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmRpc3Bvc2VMaXN0LnB1c2goKCkgPT4ge1xyXG4gICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3doZWVsJywgd2hlZWxFdmVudEhhbmRsZXIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcignd2hlZWwnLCB3aGVlbEV2ZW50SGFuZGxlciwge1xyXG4gICAgICAgICAgcGFzc2l2ZTogZmFsc2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlTGlzdC5wdXNoKCgpID0+IHtcclxuICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2hlZWwnLCB3aGVlbEV2ZW50SGFuZGxlcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vLyBHZXQgY3VycmVudCBzY2FsZSBmcm9tIGh0bWwgdG8gc3ZnXHJcbiAgLy8gTm90ZTogb25lIHNob3VsZCByZXRyaWV2ZSBkb20gc3RhdGUgYmVmb3JlIHJlc2NhbGVcclxuICBnZXRTdmdTY2FsZVJhdGlvKCkge1xyXG4gICAgY29uc3Qgc3ZnID0gdGhpcy5ob29rZWRFbGVtLmZpcnN0RWxlbWVudENoaWxkIGFzIFNWR0VsZW1lbnQ7XHJcbiAgICBpZiAoIXN2Zykge1xyXG4gICAgICByZXR1cm4gMDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNhY2hlZERPTVN0YXRlO1xyXG5cclxuICAgIGNvbnN0IHN2Z1dpZHRoID0gTnVtYmVyLnBhcnNlRmxvYXQoXHJcbiAgICAgIHN2Zy5nZXRBdHRyaWJ1dGUoJ2RhdGEtd2lkdGgnKSB8fCBzdmcuZ2V0QXR0cmlidXRlKCd3aWR0aCcpIHx8ICcxJyxcclxuICAgICk7XHJcbiAgICBjb25zdCBzdmdIZWlnaHQgPSBOdW1iZXIucGFyc2VGbG9hdChcclxuICAgICAgc3ZnLmdldEF0dHJpYnV0ZSgnZGF0YS1oZWlnaHQnKSB8fCBzdmcuZ2V0QXR0cmlidXRlKCdoZWlnaHQnKSB8fCAnMScsXHJcbiAgICApO1xyXG4gICAgdGhpcy5jdXJyZW50UmVhbFNjYWxlID1cclxuICAgICAgdGhpcy5wcmV2aWV3TW9kZSA9PT0gUHJldmlld01vZGUuU2xpZGVcclxuICAgICAgICA/IE1hdGgubWluKGNvbnRhaW5lci53aWR0aCAvIHN2Z1dpZHRoLCBjb250YWluZXIuaGVpZ2h0IC8gc3ZnSGVpZ2h0KVxyXG4gICAgICAgIDogY29udGFpbmVyLndpZHRoIC8gc3ZnV2lkdGg7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFJlYWxTY2FsZSAqIHRoaXMuY3VycmVudFNjYWxlUmF0aW87XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHByb2Nlc3NRdWV1ZShzdmdVcGRhdGVFdmVudDogW3N0cmluZywgc3RyaW5nXSk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgZXZlbnROYW1lID0gc3ZnVXBkYXRlRXZlbnRbMF07XHJcbiAgICBzd2l0Y2ggKGV2ZW50TmFtZSkge1xyXG4gICAgICBjYXNlICduZXcnOlxyXG4gICAgICBjYXNlICdkaWZmLXYxJzoge1xyXG4gICAgICAgIGlmIChldmVudE5hbWUgPT09ICduZXcnKSB7XHJcbiAgICAgICAgICB0aGlzLnJlc2V0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMua01vZHVsZS5tYW5pcHVsYXRlRGF0YSh7XHJcbiAgICAgICAgICBhY3Rpb246ICdtZXJnZScsXHJcbiAgICAgICAgICBkYXRhOiBzdmdVcGRhdGVFdmVudFsxXSBhcyB1bmtub3duIGFzIFVpbnQ4QXJyYXksXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMubW9kdWxlSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIGNhc2UgJ3ZpZXdwb3J0LWNoYW5nZSc6IHtcclxuICAgICAgICBpZiAoIXRoaXMubW9kdWxlSW5pdGlhbGl6ZWQpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCd2aWV3cG9ydC1jaGFuZ2UgYmVmb3JlIGluaXRpYWxpemF0aW9uJyk7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgY29uc29sZS5sb2coJ3N2Z1VwZGF0ZUV2ZW50Jywgc3ZnVXBkYXRlRXZlbnQpO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgdHJpZ2dlclVwZGF0ZSgpIHtcclxuICAgIGlmICh0aGlzLmlzUmVuZGVyaW5nKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmlzUmVuZGVyaW5nID0gdHJ1ZTtcclxuICAgIGNvbnN0IGRvVXBkYXRlID0gYXN5bmMgKCkgPT4ge1xyXG4gICAgICB0aGlzLmNhY2hlZERPTVN0YXRlID0gdGhpcy5yZXRyaWV2ZURPTVN0YXRlKCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5wYXRjaFF1ZXVlLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHRoaXMuaXNSZW5kZXJpbmcgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnBvc3Rwcm9jZXNzQ2hhbmdlcygpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgdHJ5IHtcclxuICAgICAgICBsZXQgdDAgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuXHJcbiAgICAgICAgY29uc3QgY3Rva2VuID0gdGhpcy5jYW52YXNSZW5kZXJDVG9rZW47XHJcbiAgICAgICAgaWYgKGN0b2tlbikge1xyXG4gICAgICAgICAgYXdhaXQgY3Rva2VuLmNhbmNlbCgpO1xyXG4gICAgICAgICAgYXdhaXQgY3Rva2VuLndhaXQoKTtcclxuICAgICAgICAgIHRoaXMuY2FudmFzUmVuZGVyQ1Rva2VuID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ2NhbmNlbCBjYW52YXMgcmVuZGVyaW5nJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbmVlZFJlcmVuZGVyID0gZmFsc2U7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ3BhdGNoUXVldWUnLCBKU09OLnN0cmluZ2lmeSh0aGlzLnBhdGNoUXVldWUubWFwKHggPT4geFswXSkpKTtcclxuICAgICAgICB3aGlsZSAodGhpcy5wYXRjaFF1ZXVlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIG5lZWRSZXJlbmRlciA9IHRoaXMucHJvY2Vzc1F1ZXVlKHRoaXMucGF0Y2hRdWV1ZS5zaGlmdCgpISkgfHwgbmVlZFJlcmVuZGVyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gdG9kbzogdHJpZ2dlciB2aWV3cG9ydCBjaGFuZ2Ugb25jZVxyXG4gICAgICAgIGxldCB0MSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG4gICAgICAgIGlmIChuZWVkUmVyZW5kZXIpIHtcclxuICAgICAgICAgIHRoaXMuci5yZXNjYWxlKCk7XHJcbiAgICAgICAgICBhd2FpdCB0aGlzLnIucmVyZW5kZXIoKTtcclxuICAgICAgICAgIHRoaXMuci5yZXNjYWxlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCB0MiA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cclxuICAgICAgICAvLy8gcGVyZiBldmVudFxyXG4gICAgICAgIGNvbnN0IGQgPSAoZTogc3RyaW5nLCB4OiBudW1iZXIsIHk6IG51bWJlcikgPT4gYCR7ZX0gJHsoeSAtIHgpLnRvRml4ZWQoMil9IG1zYDtcclxuICAgICAgICB0aGlzLnNhbXBsZWRSZW5kZXJUaW1lID0gdDIgLSB0MDtcclxuICAgICAgICBjb25zb2xlLmxvZyhbZCgncGFyc2UnLCB0MCwgdDEpLCBkKCdyZXJlbmRlcicsIHQxLCB0MiksIGQoJ3RvdGFsJywgdDAsIHQyKV0uam9pbignLCAnKSk7XHJcblxyXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShkb1VwZGF0ZSk7XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgICAgIHRoaXMuaXNSZW5kZXJpbmcgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnBvc3Rwcm9jZXNzQ2hhbmdlcygpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRvVXBkYXRlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcG9zdHByb2Nlc3NDaGFuZ2VzKCkge1xyXG4gICAgdGhpcy5yLnBvc3RSZW5kZXIoKTtcclxuXHJcbiAgICAvLyB0b2RvOiBhYnN0cmFjdCB0aGlzXHJcbiAgICBpZiAodGhpcy5wcmV2aWV3TW9kZSA9PT0gUHJldmlld01vZGUuU2xpZGUpIHtcclxuICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnR5cHN0LXBhZ2UtbnVtYmVyLWluZGljYXRvcicpLmZvckVhY2goeCA9PiB7XHJcbiAgICAgICAgeC50ZXh0Q29udGVudCA9IGAke3RoaXMua01vZHVsZS5yZXRyaWV2ZVBhZ2VzSW5mbygpLmxlbmd0aH1gO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFkZENoYW5nZW1lbnQoY2hhbmdlOiBbc3RyaW5nLCBzdHJpbmddKSB7XHJcbiAgICBpZiAoY2hhbmdlWzBdID09PSAnbmV3Jykge1xyXG4gICAgICB0aGlzLnBhdGNoUXVldWUuc3BsaWNlKDAsIHRoaXMucGF0Y2hRdWV1ZS5sZW5ndGgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHB1c2hDaGFuZ2UgPSAoKSA9PiB7XHJcbiAgICAgIHRoaXMudnBUaW1lb3V0ID0gdW5kZWZpbmVkO1xyXG4gICAgICB0aGlzLnBhdGNoUXVldWUucHVzaChjaGFuZ2UpO1xyXG4gICAgICB0aGlzLnRyaWdnZXJVcGRhdGUoKTtcclxuICAgIH07XHJcblxyXG4gICAgaWYgKHRoaXMudnBUaW1lb3V0ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudnBUaW1lb3V0KTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY2hhbmdlWzBdID09PSAndmlld3BvcnQtY2hhbmdlJyAmJiB0aGlzLmlzUmVuZGVyaW5nKSB7XHJcbiAgICAgIC8vIGRlbGF5IHZpZXdwb3J0IGNoYW5nZSBhIGJpdFxyXG4gICAgICB0aGlzLnZwVGltZW91dCA9IHNldFRpbWVvdXQocHVzaENoYW5nZSwgdGhpcy5zYW1wbGVkUmVuZGVyVGltZSB8fCAxMDApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcHVzaENoYW5nZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYWRkVmlld3BvcnRDaGFuZ2UoKSB7XHJcbiAgICB0aGlzLmFkZENoYW5nZW1lbnQoWyd2aWV3cG9ydC1jaGFuZ2UnLCAnJ10pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBUeXBzdERvY3VtZW50PFQ+IHtcclxuICBpbXBsOiBUO1xyXG4gIGtNb2R1bGU6IFJlbmRlclNlc3Npb247XHJcbiAgZGlzcG9zZSgpOiB2b2lkO1xyXG4gIHJlc2V0KCk6IHZvaWQ7XHJcbiAgYWRkQ2hhbmdlbWVudChjaGFuZ2U6IFtzdHJpbmcsIHN0cmluZ10pOiB2b2lkO1xyXG4gIGFkZFZpZXdwb3J0Q2hhbmdlKCk6IHZvaWQ7XHJcbiAgc2V0UGFnZUNvbG9yKGNvbG9yOiBzdHJpbmcpOiB2b2lkO1xyXG4gIHNldFBhcnRpYWxSZW5kZXJpbmcocGFydGlhbFJlbmRlcmluZzogYm9vbGVhbik6IHZvaWQ7XHJcbiAgc2V0Q3Vyc29yKHBhZ2U6IG51bWJlciwgeDogbnVtYmVyLCB5OiBudW1iZXIpOiB2b2lkO1xyXG4gIHNldFBhcnRpYWxQYWdlTnVtYmVyKHBhZ2U6IG51bWJlcik6IGJvb2xlYW47XHJcbiAgZ2V0UGFydGlhbFBhZ2VOdW1iZXIoKTogbnVtYmVyO1xyXG4gIHNldE91dGluZURhdGEob3V0bGluZTogYW55KTogdm9pZDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVEb2M8VCBleHRlbmRzIFR5cHN0RG9jdW1lbnRDb250ZXh0PihcclxuICBCYXNlOiBHQ29uc3RydWN0b3I8VD4sXHJcbik6IG5ldyAob3B0aW9uczogT3B0aW9ucyAmIFRbJ29wdHMnXSkgPT4gVHlwc3REb2N1bWVudDxUPiB7XHJcbiAgcmV0dXJuIGNsYXNzIFR5cHN0RG9jdW1lbnQge1xyXG4gICAgcHVibGljIGltcGw6IFQ7XHJcbiAgICBwdWJsaWMga01vZHVsZTogUmVuZGVyU2Vzc2lvbjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBPcHRpb25zKSB7XHJcbiAgICAgIGlmIChvcHRpb25zLmlzQ29udGVudFByZXZpZXcpIHtcclxuICAgICAgICBvcHRpb25zLnJlbmRlck1vZGUgPSAnY2FudmFzJztcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5rTW9kdWxlID0gb3B0aW9ucy5rTW9kdWxlO1xyXG4gICAgICB0aGlzLmltcGwgPSBuZXcgQmFzZShvcHRpb25zKTtcclxuICAgICAgaWYgKCF0aGlzLmltcGwucikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgbW9kZSBpcyBub3Qgc3VwcG9ydGVkLCAke29wdGlvbnM/LnJlbmRlck1vZGV9YCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChvcHRpb25zLmlzQ29udGVudFByZXZpZXcpIHtcclxuICAgICAgICAvLyBjb250ZW50IHByZXZpZXcgaGFzIHZlcnkgYmFkIHBlcmZvcm1hbmNlIHdpdGhvdXQgcGFydGlhbCByZW5kZXJpbmdcclxuICAgICAgICB0aGlzLmltcGwucGFydGlhbFJlbmRlcmluZyA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5pbXBsLnBpeGVsUGVyUHQgPSAxO1xyXG4gICAgICAgIHRoaXMuaW1wbC5pc01peGluT3V0bGluZSA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBkaXNwb3NlKCkge1xyXG4gICAgICB0aGlzLmltcGwuZGlzcG9zZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0KCkge1xyXG4gICAgICB0aGlzLmltcGwucmVzZXQoKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRDaGFuZ2VtZW50KGNoYW5nZTogW3N0cmluZywgc3RyaW5nXSkge1xyXG4gICAgICB0aGlzLmltcGwuYWRkQ2hhbmdlbWVudChjaGFuZ2UpO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZFZpZXdwb3J0Q2hhbmdlKCkge1xyXG4gICAgICB0aGlzLmltcGwuYWRkVmlld3BvcnRDaGFuZ2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRQYWdlQ29sb3IoY29sb3I6IHN0cmluZykge1xyXG4gICAgICB0aGlzLmltcGwucGFnZUNvbG9yID0gY29sb3I7XHJcbiAgICAgIHRoaXMuYWRkVmlld3BvcnRDaGFuZ2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRQYXJ0aWFsUmVuZGVyaW5nKHBhcnRpYWxSZW5kZXJpbmc6IGJvb2xlYW4pIHtcclxuICAgICAgdGhpcy5pbXBsLnBhcnRpYWxSZW5kZXJpbmcgPSBwYXJ0aWFsUmVuZGVyaW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHNldEN1cnNvcihwYWdlOiBudW1iZXIsIHg6IG51bWJlciwgeTogbnVtYmVyKSB7XHJcbiAgICAgIHRoaXMuaW1wbC5jdXJzb3JQb3NpdGlvbiA9IFtwYWdlLCB4LCB5XTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRQYXJ0aWFsUGFnZU51bWJlcihwYWdlOiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgICAgaWYgKHBhZ2UgPD0gMCB8fCBwYWdlID4gdGhpcy5rTW9kdWxlLnJldHJpZXZlUGFnZXNJbmZvKCkubGVuZ3RoKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuaW1wbC5wYXJ0aWFsUmVuZGVyUGFnZSA9IHBhZ2UgLSAxO1xyXG4gICAgICB0aGlzLmFkZFZpZXdwb3J0Q2hhbmdlKCk7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFBhcnRpYWxQYWdlTnVtYmVyKCk6IG51bWJlciB7XHJcbiAgICAgIHJldHVybiB0aGlzLmltcGwucGFydGlhbFJlbmRlclBhZ2UgKyAxO1xyXG4gICAgfVxyXG5cclxuICAgIHNldE91dGluZURhdGEob3V0bGluZTogYW55KSB7XHJcbiAgICAgIHRoaXMuaW1wbC5vdXRsaW5lID0gb3V0bGluZTtcclxuICAgICAgdGhpcy5hZGRWaWV3cG9ydENoYW5nZSgpO1xyXG4gICAgfVxyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMT4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbik6IFRCYXNlICYgRjE7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMSwgRjI+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4gIGYyOiAoYmFzZTogRjEpID0+IEYyLFxyXG4pOiBUQmFzZSAmIEYxICYgRjI7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMSwgRjIsIEYzPihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuICBmMjogKGJhc2U6IEYxKSA9PiBGMixcclxuICBmMzogKGJhc2U6IEYyKSA9PiBGMyxcclxuKTogVEJhc2UgJiBGMSAmIEYyICYgRjM7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMSwgRjIsIEYzLCBGND4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbiAgZjI6IChiYXNlOiBGMSkgPT4gRjIsXHJcbiAgZjM6IChiYXNlOiBGMikgPT4gRjMsXHJcbiAgZjQ6IChiYXNlOiBGMykgPT4gRjQsXHJcbik6IFRCYXNlICYgRjEgJiBGMiAmIEYzICYgRjQ7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMSwgRjIsIEYzLCBGNCwgRjU+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4gIGYyOiAoYmFzZTogRjEpID0+IEYyLFxyXG4gIGYzOiAoYmFzZTogRjIpID0+IEYzLFxyXG4gIGY0OiAoYmFzZTogRjMpID0+IEY0LFxyXG4gIGY1OiAoYmFzZTogRjQpID0+IEY1LFxyXG4pOiBUQmFzZSAmIEYxICYgRjIgJiBGMyAmIEY0ICYgRjU7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMSwgRjIsIEYzLCBGNCwgRjUsIEY2PihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuICBmMjogKGJhc2U6IEYxKSA9PiBGMixcclxuICBmMzogKGJhc2U6IEYyKSA9PiBGMyxcclxuICBmNDogKGJhc2U6IEYzKSA9PiBGNCxcclxuICBmNTogKGJhc2U6IEY0KSA9PiBGNSxcclxuICBmNjogKGJhc2U6IEY1KSA9PiBGNixcclxuKTogVEJhc2UgJiBGMSAmIEYyICYgRjMgJiBGNCAmIEY1ICYgRjY7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMSwgRjIsIEYzLCBGNCwgRjUsIEY2LCBGNz4oXHJcbiAgQmFzZTogVEJhc2UsXHJcbiAgZjE6IChiYXNlOiBUQmFzZSkgPT4gRjEsXHJcbiAgZjI6IChiYXNlOiBGMSkgPT4gRjIsXHJcbiAgZjM6IChiYXNlOiBGMikgPT4gRjMsXHJcbiAgZjQ6IChiYXNlOiBGMykgPT4gRjQsXHJcbiAgZjU6IChiYXNlOiBGNCkgPT4gRjUsXHJcbiAgZjY6IChiYXNlOiBGNSkgPT4gRjYsXHJcbiAgZjc6IChiYXNlOiBGNikgPT4gRjcsXHJcbik6IFRCYXNlICYgRjEgJiBGMiAmIEYzICYgRjQgJiBGNSAmIEY2ICYgRjc7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMSwgRjIsIEYzLCBGNCwgRjUsIEY2LCBGNywgRjg+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4gIGYxOiAoYmFzZTogVEJhc2UpID0+IEYxLFxyXG4gIGYyOiAoYmFzZTogRjEpID0+IEYyLFxyXG4gIGYzOiAoYmFzZTogRjIpID0+IEYzLFxyXG4gIGY0OiAoYmFzZTogRjMpID0+IEY0LFxyXG4gIGY1OiAoYmFzZTogRjQpID0+IEY1LFxyXG4gIGY2OiAoYmFzZTogRjUpID0+IEY2LFxyXG4gIGY3OiAoYmFzZTogRjYpID0+IEY3LFxyXG4gIGY4OiAoYmFzZTogRjcpID0+IEY4LFxyXG4pOiBUQmFzZSAmIEYxICYgRjIgJiBGMyAmIEY0ICYgRjUgJiBGNiAmIEY3ICYgRjg7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yLCBGMSwgRjIsIEYzLCBGNCwgRjUsIEY2LCBGNywgRjgsIEY5PihcclxuICBCYXNlOiBUQmFzZSxcclxuICBmMTogKGJhc2U6IFRCYXNlKSA9PiBGMSxcclxuICBmMjogKGJhc2U6IEYxKSA9PiBGMixcclxuICBmMzogKGJhc2U6IEYyKSA9PiBGMyxcclxuICBmNDogKGJhc2U6IEYzKSA9PiBGNCxcclxuICBmNTogKGJhc2U6IEY0KSA9PiBGNSxcclxuICBmNjogKGJhc2U6IEY1KSA9PiBGNixcclxuICBmNzogKGJhc2U6IEY2KSA9PiBGNyxcclxuICBmODogKGJhc2U6IEY3KSA9PiBGOCxcclxuICBmOTogKGJhc2U6IEY4KSA9PiBGOSxcclxuKTogVEJhc2UgJiBGMSAmIEYyICYgRjMgJiBGNCAmIEY1ICYgRjYgJiBGNyAmIEY4ICYgRjk7XHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wb3NlRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yPihCYXNlOiBUQmFzZSwgLi4ubWl4aW5zOiBhbnlbXSk6IFRCYXNlIHtcclxuICByZXR1cm4gbWl4aW5zLnJlZHVjZSgoYWNjLCBtaXhpbikgPT4gbWl4aW4oYWNjKSwgQmFzZSk7XHJcbn1cclxuIl19