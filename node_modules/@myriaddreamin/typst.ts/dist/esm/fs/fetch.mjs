export class FetchAccessModel {
    root;
    fullyCached;
    mTimes = new Map();
    mRealPaths = new Map();
    mData = new Map();
    constructor(root, options) {
        this.root = root;
        if (root.endsWith('/')) {
            this.root = this.root.slice(0, this.root.length - 1);
        }
        if (options?.polyfillHeadRequest) {
            void 0;
        }
        this.fullyCached = !!options?.fullyCached;
    }
    reset() {
        this.mTimes.clear();
        this.mRealPaths.clear();
        this.mData.clear();
    }
    resolvePath(path) {
        return this.root + path;
    }
    insertFile(path, data, mtime) {
        this.mTimes.set(path, mtime);
        this.mData.set(path, data);
    }
    removeFile(path) {
        this.mTimes.delete(path);
        this.mData.delete(path);
    }
    async getPreloadScript() {
        const snapshot = [];
        snapshot.push('((async () => {');
        snapshot.push(`const snapshot = {  root: '', mTimes: new Map(),  mRealPaths: new Map(),  mData: [],};`);
        // runFetch
        snapshot.push(`const runFetch = async (path) => {`);
        snapshot.push(`  const res = await fetch(snapshot.root + path);`);
        snapshot.push(`  const buffer = await res.arrayBuffer();`);
        snapshot.push(`  return [path, new Uint8Array(buffer)];`);
        snapshot.push(`};`);
        snapshot.push(`snapshot.root = ${JSON.stringify(this.root)};`);
        snapshot.push(`snapshot.mTimes = new Map([${[...this.mTimes.entries()]
            .map(([k, v]) => `[${JSON.stringify(k)}, ${v?.getTime() || 'undefined'}]`)
            .join(', ')}]);`);
        snapshot.push(`snapshot.mRealPaths = new Map([${[...this.mRealPaths.entries()]
            .map(([k, v]) => `[${JSON.stringify(k)}, ${JSON.stringify(v)}]`)
            .join(', ')}]);`);
        const dataEntries = await Promise.all([...this.mData.entries()].map(async ([k, v]) => {
            k = JSON.stringify(k);
            return v ? `runFetch(${k})` : `Promise.resolve([${k}, undefined])`;
        }));
        snapshot.push(`snapshot.mData = await Promise.all([${dataEntries.join(', ')}]);`);
        snapshot.push(`return snapshot;`);
        snapshot.push('})())');
        return snapshot.join('\n');
    }
    getLastModified(path) {
        const request = new XMLHttpRequest();
        request.open('HEAD', path, false);
        request.send(null);
        if (request.status === 200) {
            return request.getResponseHeader('Last-Modified');
        }
        return null;
    }
    getMTimeInternal(path) {
        const lastModified = this.getLastModified(this.resolvePath(path));
        if (lastModified) {
            return new Date(lastModified);
        }
        return undefined;
    }
    getMTime(path) {
        // todo: no hack
        if (path.startsWith('/@memory/')) {
            if (this.mTimes.has(path)) {
                return this.mTimes.get(path);
            }
            return undefined;
        }
        if (!this.fullyCached) {
            return this.getMTimeInternal(path);
        }
        if (this.mTimes.has(path)) {
            return this.mTimes.get(path);
        }
        const mTime = this.getMTimeInternal(path);
        this.mTimes.set(path, mTime);
        return mTime;
    }
    // todo: isFile
    isFile() {
        // path: string
        // const request = this.getLastModified(this.resolvePath(path));
        // if (request.status === 200) {
        //   console.log(request, request.getAllResponseHeaders());
        // }
        return true;
    }
    // todo: getRealPath
    getRealPath(path) {
        return path;
    }
    readAllInternal(path) {
        const request = new XMLHttpRequest();
        request.overrideMimeType('text/plain; charset=x-user-defined');
        request.open('GET', this.resolvePath(path), false);
        request.send(null);
        if (request.status === 200 &&
            (request.response instanceof String || typeof request.response === 'string')) {
            return Uint8Array.from(request.response, (c) => c.charCodeAt(0));
        }
        return undefined;
    }
    readAll(path) {
        if (path.startsWith('/@memory/')) {
            if (this.mData.has(path)) {
                return this.mData.get(path);
            }
            return undefined;
        }
        if (!this.fullyCached) {
            return this.readAllInternal(path);
        }
        if (this.mData.has(path)) {
            return this.mData.get(path);
        }
        const data = this.readAllInternal(path);
        this.mData.set(path, data);
        return data;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmV0Y2gubWpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ZzL2ZldGNoLm10cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFRQSxNQUFNLE9BQU8sZ0JBQWdCO0lBTWpCO0lBTFYsV0FBVyxDQUFVO0lBQ3JCLE1BQU0sR0FBa0MsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUNsRCxVQUFVLEdBQW9DLElBQUksR0FBRyxFQUFFLENBQUM7SUFDeEQsS0FBSyxHQUF3QyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3ZELFlBQ1UsSUFBWSxFQUNwQixPQUE0QjtRQURwQixTQUFJLEdBQUosSUFBSSxDQUFRO1FBR3BCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztTQUN0RDtRQUNELElBQUksT0FBTyxFQUFFLG1CQUFtQixFQUFFO1lBQ2hDLEtBQUssQ0FBQyxDQUFDO1NBQ1I7UUFDRCxJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDO0lBQzVDLENBQUM7SUFFRCxLQUFLO1FBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVELFdBQVcsQ0FBQyxJQUFZO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFZLEVBQUUsSUFBZ0IsRUFBRSxLQUFXO1FBQ3BELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElB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QixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzdCO1lBRUQsT0FBTyxTQUFTLENBQUM7U0FDbEI7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNyQixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkM7UUFFRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3hCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDN0I7UUFFRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMzQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZzQWNjZXNzTW9kZWwgfSBmcm9tICcuLi9pbnRlcm5hbC50eXBlcy5tanMnO1xyXG5pbXBvcnQgeyBXcml0YWJsZUFjY2Vzc01vZGVsIH0gZnJvbSAnLi9pbmRleC5tanMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGZXRjaEFjY2Vzc09wdGlvbnMge1xyXG4gIHBvbHlmaWxsSGVhZFJlcXVlc3Q/OiBib29sZWFuO1xyXG4gIGZ1bGx5Q2FjaGVkPzogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEZldGNoQWNjZXNzTW9kZWwgaW1wbGVtZW50cyBGc0FjY2Vzc01vZGVsLCBXcml0YWJsZUFjY2Vzc01vZGVsIHtcclxuICBmdWxseUNhY2hlZDogYm9vbGVhbjtcclxuICBtVGltZXM6IE1hcDxzdHJpbmcsIERhdGUgfCB1bmRlZmluZWQ+ID0gbmV3IE1hcCgpO1xyXG4gIG1SZWFsUGF0aHM6IE1hcDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4gPSBuZXcgTWFwKCk7XHJcbiAgbURhdGE6IE1hcDxzdHJpbmcsIFVpbnQ4QXJyYXkgfCB1bmRlZmluZWQ+ID0gbmV3IE1hcCgpO1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByb290OiBzdHJpbmcsXHJcbiAgICBvcHRpb25zPzogRmV0Y2hBY2Nlc3NPcHRpb25zLFxyXG4gICkge1xyXG4gICAgaWYgKHJvb3QuZW5kc1dpdGgoJy8nKSkge1xyXG4gICAgICB0aGlzLnJvb3QgPSB0aGlzLnJvb3Quc2xpY2UoMCwgdGhpcy5yb290Lmxlbmd0aCAtIDEpO1xyXG4gICAgfVxyXG4gICAgaWYgKG9wdGlvbnM/LnBvbHlmaWxsSGVhZFJlcXVlc3QpIHtcclxuICAgICAgdm9pZCAwO1xyXG4gICAgfVxyXG4gICAgdGhpcy5mdWxseUNhY2hlZCA9ICEhb3B0aW9ucz8uZnVsbHlDYWNoZWQ7XHJcbiAgfVxyXG5cclxuICByZXNldCgpIHtcclxuICAgIHRoaXMubVRpbWVzLmNsZWFyKCk7XHJcbiAgICB0aGlzLm1SZWFsUGF0aHMuY2xlYXIoKTtcclxuICAgIHRoaXMubURhdGEuY2xlYXIoKTtcclxuICB9XHJcblxyXG4gIHJlc29sdmVQYXRoKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5yb290ICsgcGF0aDtcclxuICB9XHJcblxyXG4gIGluc2VydEZpbGUocGF0aDogc3RyaW5nLCBkYXRhOiBVaW50OEFycmF5LCBtdGltZTogRGF0ZSkge1xyXG4gICAgdGhpcy5tVGltZXMuc2V0KHBhdGgsIG10aW1lKTtcclxuICAgIHRoaXMubURhdGEuc2V0KHBhdGgsIGRhdGEpO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlRmlsZShwYXRoOiBzdHJpbmcpIHtcclxuICAgIHRoaXMubVRpbWVzLmRlbGV0ZShwYXRoKTtcclxuICAgIHRoaXMubURhdGEuZGVsZXRlKHBhdGgpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0UHJlbG9hZFNjcmlwdCgpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgY29uc3Qgc25hcHNob3Q6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgc25hcHNob3QucHVzaCgnKChhc3luYyAoKSA9PiB7Jyk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKFxyXG4gICAgICBgY29uc3Qgc25hcHNob3QgPSB7ICByb290OiAnJywgbVRpbWVzOiBuZXcgTWFwKCksICBtUmVhbFBhdGhzOiBuZXcgTWFwKCksICBtRGF0YTogW10sfTtgLFxyXG4gICAgKTtcclxuICAgIC8vIHJ1bkZldGNoXHJcbiAgICBzbmFwc2hvdC5wdXNoKGBjb25zdCBydW5GZXRjaCA9IGFzeW5jIChwYXRoKSA9PiB7YCk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKGAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHNuYXBzaG90LnJvb3QgKyBwYXRoKTtgKTtcclxuICAgIHNuYXBzaG90LnB1c2goYCAgY29uc3QgYnVmZmVyID0gYXdhaXQgcmVzLmFycmF5QnVmZmVyKCk7YCk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKGAgIHJldHVybiBbcGF0aCwgbmV3IFVpbnQ4QXJyYXkoYnVmZmVyKV07YCk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKGB9O2ApO1xyXG4gICAgc25hcHNob3QucHVzaChgc25hcHNob3Qucm9vdCA9ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5yb290KX07YCk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKFxyXG4gICAgICBgc25hcHNob3QubVRpbWVzID0gbmV3IE1hcChbJHtbLi4udGhpcy5tVGltZXMuZW50cmllcygpXVxyXG4gICAgICAgIC5tYXAoKFtrLCB2XSkgPT4gYFske0pTT04uc3RyaW5naWZ5KGspfSwgJHt2Py5nZXRUaW1lKCkgfHwgJ3VuZGVmaW5lZCd9XWApXHJcbiAgICAgICAgLmpvaW4oJywgJyl9XSk7YCxcclxuICAgICk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKFxyXG4gICAgICBgc25hcHNob3QubVJlYWxQYXRocyA9IG5ldyBNYXAoWyR7Wy4uLnRoaXMubVJlYWxQYXRocy5lbnRyaWVzKCldXHJcbiAgICAgICAgLm1hcCgoW2ssIHZdKSA9PiBgWyR7SlNPTi5zdHJpbmdpZnkoayl9LCAke0pTT04uc3RyaW5naWZ5KHYpfV1gKVxyXG4gICAgICAgIC5qb2luKCcsICcpfV0pO2AsXHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IGRhdGFFbnRyaWVzID0gYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgIFsuLi50aGlzLm1EYXRhLmVudHJpZXMoKV0ubWFwKGFzeW5jIChbaywgdl0pID0+IHtcclxuICAgICAgICBrID0gSlNPTi5zdHJpbmdpZnkoayk7XHJcbiAgICAgICAgcmV0dXJuIHYgPyBgcnVuRmV0Y2goJHtrfSlgIDogYFByb21pc2UucmVzb2x2ZShbJHtrfSwgdW5kZWZpbmVkXSlgO1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcbiAgICBzbmFwc2hvdC5wdXNoKGBzbmFwc2hvdC5tRGF0YSA9IGF3YWl0IFByb21pc2UuYWxsKFske2RhdGFFbnRyaWVzLmpvaW4oJywgJyl9XSk7YCk7XHJcblxyXG4gICAgc25hcHNob3QucHVzaChgcmV0dXJuIHNuYXBzaG90O2ApO1xyXG4gICAgc25hcHNob3QucHVzaCgnfSkoKSknKTtcclxuICAgIHJldHVybiBzbmFwc2hvdC5qb2luKCdcXG4nKTtcclxuICB9XHJcblxyXG4gIGdldExhc3RNb2RpZmllZChwYXRoOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICAgIHJlcXVlc3Qub3BlbignSEVBRCcsIHBhdGgsIGZhbHNlKTtcclxuICAgIHJlcXVlc3Quc2VuZChudWxsKTtcclxuICAgIGlmIChyZXF1ZXN0LnN0YXR1cyA9PT0gMjAwKSB7XHJcbiAgICAgIHJldHVybiByZXF1ZXN0LmdldFJlc3BvbnNlSGVhZGVyKCdMYXN0LU1vZGlmaWVkJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIGdldE1UaW1lSW50ZXJuYWwocGF0aDogc3RyaW5nKTogRGF0ZSB8IHVuZGVmaW5lZCB7XHJcbiAgICBjb25zdCBsYXN0TW9kaWZpZWQgPSB0aGlzLmdldExhc3RNb2RpZmllZCh0aGlzLnJlc29sdmVQYXRoKHBhdGgpKTtcclxuICAgIGlmIChsYXN0TW9kaWZpZWQpIHtcclxuICAgICAgcmV0dXJuIG5ldyBEYXRlKGxhc3RNb2RpZmllZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcblxyXG4gIGdldE1UaW1lKHBhdGg6IHN0cmluZyk6IERhdGUgfCB1bmRlZmluZWQge1xyXG4gICAgLy8gdG9kbzogbm8gaGFja1xyXG4gICAgaWYgKHBhdGguc3RhcnRzV2l0aCgnL0BtZW1vcnkvJykpIHtcclxuICAgICAgaWYgKHRoaXMubVRpbWVzLmhhcyhwYXRoKSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1UaW1lcy5nZXQocGF0aCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0aGlzLmZ1bGx5Q2FjaGVkKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmdldE1UaW1lSW50ZXJuYWwocGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMubVRpbWVzLmhhcyhwYXRoKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5tVGltZXMuZ2V0KHBhdGgpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbVRpbWUgPSB0aGlzLmdldE1UaW1lSW50ZXJuYWwocGF0aCk7XHJcbiAgICB0aGlzLm1UaW1lcy5zZXQocGF0aCwgbVRpbWUpO1xyXG4gICAgcmV0dXJuIG1UaW1lO1xyXG4gIH1cclxuXHJcbiAgLy8gdG9kbzogaXNGaWxlXHJcbiAgaXNGaWxlKCk6IGJvb2xlYW4gfCB1bmRlZmluZWQge1xyXG4gICAgLy8gcGF0aDogc3RyaW5nXHJcbiAgICAvLyBjb25zdCByZXF1ZXN0ID0gdGhpcy5nZXRMYXN0TW9kaWZpZWQodGhpcy5yZXNvbHZlUGF0aChwYXRoKSk7XHJcbiAgICAvLyBpZiAocmVxdWVzdC5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgLy8gICBjb25zb2xlLmxvZyhyZXF1ZXN0LCByZXF1ZXN0LmdldEFsbFJlc3BvbnNlSGVhZGVycygpKTtcclxuICAgIC8vIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLy8gdG9kbzogZ2V0UmVhbFBhdGhcclxuICBnZXRSZWFsUGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuIHBhdGg7XHJcbiAgfVxyXG5cclxuICByZWFkQWxsSW50ZXJuYWwocGF0aDogc3RyaW5nKTogVWludDhBcnJheSB8IHVuZGVmaW5lZCB7XHJcbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcbiAgICByZXF1ZXN0Lm92ZXJyaWRlTWltZVR5cGUoJ3RleHQvcGxhaW47IGNoYXJzZXQ9eC11c2VyLWRlZmluZWQnKTtcclxuICAgIHJlcXVlc3Qub3BlbignR0VUJywgdGhpcy5yZXNvbHZlUGF0aChwYXRoKSwgZmFsc2UpO1xyXG4gICAgcmVxdWVzdC5zZW5kKG51bGwpO1xyXG5cclxuICAgIGlmIChcclxuICAgICAgcmVxdWVzdC5zdGF0dXMgPT09IDIwMCAmJlxyXG4gICAgICAocmVxdWVzdC5yZXNwb25zZSBpbnN0YW5jZW9mIFN0cmluZyB8fCB0eXBlb2YgcmVxdWVzdC5yZXNwb25zZSA9PT0gJ3N0cmluZycpXHJcbiAgICApIHtcclxuICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkuZnJvbShyZXF1ZXN0LnJlc3BvbnNlLCAoYzogc3RyaW5nKSA9PiBjLmNoYXJDb2RlQXQoMCkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcblxyXG4gIHJlYWRBbGwocGF0aDogc3RyaW5nKTogVWludDhBcnJheSB8IHVuZGVmaW5lZCB7XHJcbiAgICBpZiAocGF0aC5zdGFydHNXaXRoKCcvQG1lbW9yeS8nKSkge1xyXG4gICAgICBpZiAodGhpcy5tRGF0YS5oYXMocGF0aCkpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tRGF0YS5nZXQocGF0aCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0aGlzLmZ1bGx5Q2FjaGVkKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnJlYWRBbGxJbnRlcm5hbChwYXRoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5tRGF0YS5oYXMocGF0aCkpIHtcclxuICAgICAgcmV0dXJuIHRoaXMubURhdGEuZ2V0KHBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLnJlYWRBbGxJbnRlcm5hbChwYXRoKTtcclxuICAgIHRoaXMubURhdGEuc2V0KHBhdGgsIGRhdGEpO1xyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfVxyXG59XHJcbiJdfQ==