import * as idb from 'idb';
/** @internal */
export const globalFontPromises = [];
async function addPartialFonts({ builder, hooks }) {
    const t = performance.now();
    if ('queryLocalFonts' in window) {
        const fonts = await window.queryLocalFonts();
        console.log('local fonts count:', fonts.length);
        const db = await idb.openDB('typst-ts-store', 1, {
            upgrade(db) {
                db.createObjectStore('font-information', {
                    keyPath: 'postscriptName',
                });
            },
        });
        const informations = await Promise.all(fonts.map(async (font) => {
            const postscriptName = font.postscriptName;
            return (await db.get('font-information', postscriptName))?.info;
        }));
        const get_font_info = builder.handler_for_font_info();
        await builder.add_web_fonts(fonts.map((font, font_idx) => {
            let gettingBuffer = false;
            let readyBuffer = undefined;
            const fullName = font.fullName;
            const postscriptName = font.postscriptName;
            const prev = informations[font_idx];
            if (prev) {
                console.log('prev', postscriptName, prev);
            }
            return {
                family: font.family,
                style: font.style,
                fullName: fullName,
                postscriptName: postscriptName,
                ref: font,
                info: informations[font_idx],
                blob: (idx) => {
                    console.log(this, font, idx);
                    if (readyBuffer) {
                        return readyBuffer;
                    }
                    if (gettingBuffer) {
                        return;
                    }
                    gettingBuffer = true;
                    globalFontPromises.push((async () => {
                        const blob = await font.blob();
                        const buffer = await blob.arrayBuffer();
                        readyBuffer = buffer;
                        const realFontInfo = get_font_info(new Uint8Array(buffer));
                        console.log(realFontInfo);
                        db.put('font-information', {
                            fullName,
                            postscriptName,
                            info: realFontInfo,
                        });
                        return { buffer, idx };
                    })());
                },
            };
        }));
    }
    const t2 = performance.now();
    console.log('addPartialFonts time used:', t2 - t);
}
class ComponentBuilder {
    loadedFonts = new Set();
    fetcher = fetch;
    setFetcher(fetcher) {
        this.fetcher = fetcher;
    }
    async loadFonts(builder, fonts) {
        const escapeImport = new Function('m', 'return import(m)');
        const fetcher = (this.fetcher ||= await (async function () {
            const { fetchBuilder, FileSystemCache } = await escapeImport('node-fetch-cache');
            const cache = new FileSystemCache({
                /// By default, we don't have a complicated cache policy.
                cacheDirectory: '.cache/typst/fonts',
            });
            const cachedFetcher = fetchBuilder.withCache(cache);
            return function (input, init) {
                const timeout = setTimeout(() => {
                    console.warn('font fetching is stucking:', input);
                }, 15000);
                return cachedFetcher(input, init).finally(() => {
                    clearTimeout(timeout);
                });
            };
        })());
        const fontsToLoad = fonts.filter(font => {
            if (font instanceof Uint8Array) {
                return true;
            }
            if (this.loadedFonts.has(font)) {
                return false;
            }
            this.loadedFonts.add(font);
            return true;
        });
        const fontLists = await Promise.all(fontsToLoad.map(async (font) => {
            if (font instanceof Uint8Array) {
                await builder.add_raw_font(font);
                return;
            }
            return new Uint8Array(await (await fetcher(font)).arrayBuffer());
        }));
        for (const font of fontLists) {
            if (!font) {
                continue;
            }
            await builder.add_raw_font(font);
        }
    }
    async build(options, builder, hooks) {
        /// build typst component
        const buildCtx = { ref: this, builder, hooks };
        for (const fn of options?.beforeBuild ?? []) {
            await fn(undefined, buildCtx);
        }
        // await addPartialFonts(buildCtx);
        if (hooks.latelyBuild) {
            hooks.latelyBuild(buildCtx);
        }
        const component = await builder.build();
        return component;
    }
}
/** @internal */
export async function buildComponent(options, gModule, Builder, hooks) {
    /// init typst wasm module
    await gModule.init(options?.getModule?.());
    return await new ComponentBuilder().build(options, new Builder(), hooks);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5tanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5pdC5tdHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxLQUFLLEdBQUcsTUFBTSxLQUFLLENBQUM7QUEwQjNCLGdCQUFnQjtBQUNoQixNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBb0QsRUFBRSxDQUFDO0FBRXRGLEtBQUssVUFBVSxlQUFlLENBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFrQjtJQUNsRSxNQUFNLENBQUMsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFNUIsSUFBSSxpQkFBaUIsSUFBSSxNQUFNLEVBQUU7UUFDL0IsTUFBTSxLQUFLLEdBQVUsTUFBTyxNQUFjLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDN0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFaEQsTUFBTSxFQUFFLEdBQUcsTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUMsRUFBRTtZQUMvQyxPQUFPLENBQUMsRUFBRTtnQkFDUixFQUFFLENBQUMsaUJBQWlCLENBQUMsa0JBQWtCLEVBQUU7b0JBQ3ZDLE9BQU8sRUFBRSxnQkFBZ0I7aUJBQzFCLENBQUMsQ0FBQztZQUNMLENBQUM7U0FDRixDQUFDLENBQUM7UUFFSCxNQUFNLFlBQVksR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQ3BDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxFQUFFO1lBQ3JCLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7WUFFM0MsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxjQUFjLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQztRQUNsRSxDQUFDLENBQUMsQ0FDSCxDQUFDO1FBRUYsTUFBTSxhQUFhLEdBQUksT0FB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QU0sSUFBSSxnQkFBZ0IsRUFBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxPQUFPLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM5RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmVmb3JlQnVpbGRNYXJrLCBJbml0T3B0aW9ucyB9IGZyb20gJy4vb3B0aW9ucy5pbml0Lm1qcyc7XHJcbmltcG9ydCB7IExhenlXYXNtTW9kdWxlIH0gZnJvbSAnLi93YXNtLm1qcyc7XHJcbmltcG9ydCAqIGFzIGlkYiBmcm9tICdpZGInO1xyXG5cclxuLyoqIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFR5cHN0Q29tbW9uQnVpbGRlcjxUPiB7XHJcbiAgZnJlZSgpOiB2b2lkO1xyXG5cclxuICBhZGRfcmF3X2ZvbnQoZm9udF9idWZmZXI6IFVpbnQ4QXJyYXkpOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICBhZGRfd2ViX2ZvbnRzKGZvbnQ6IGFueVtdKTogUHJvbWlzZTx2b2lkPjtcclxuXHJcbiAgYnVpbGQoKTogUHJvbWlzZTxUPjtcclxufVxyXG5cclxuLyoqIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIENvbXBvbmVudEJ1aWxkSG9va3Mge1xyXG4gIGxhdGVseUJ1aWxkPzogKGN0eDogdW5rbm93bikgPT4gdm9pZDtcclxufVxyXG5cclxuaW50ZXJmYWNlIEluaXRDb250ZXh0PFQ+IHtcclxuICByZWY6IHtcclxuICAgIGxvYWRGb250cyhidWlsZGVyOiBUeXBzdENvbW1vbkJ1aWxkZXI8VD4sIGZvbnRzOiAoc3RyaW5nIHwgVWludDhBcnJheSlbXSk6IFByb21pc2U8dm9pZD47XHJcbiAgfTtcclxuICBidWlsZGVyOiBUeXBzdENvbW1vbkJ1aWxkZXI8VD47XHJcbiAgaG9va3M6IENvbXBvbmVudEJ1aWxkSG9va3M7XHJcbn1cclxuXHJcbi8qKiBAaW50ZXJuYWwgKi9cclxuZXhwb3J0IGNvbnN0IGdsb2JhbEZvbnRQcm9taXNlczogUHJvbWlzZTx7IGJ1ZmZlcjogQXJyYXlCdWZmZXI7IGlkeDogbnVtYmVyIH0+W10gPSBbXTtcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGFkZFBhcnRpYWxGb250czxUPih7IGJ1aWxkZXIsIGhvb2tzIH06IEluaXRDb250ZXh0PFQ+KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgY29uc3QgdCA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cclxuICBpZiAoJ3F1ZXJ5TG9jYWxGb250cycgaW4gd2luZG93KSB7XHJcbiAgICBjb25zdCBmb250czogYW55W10gPSBhd2FpdCAod2luZG93IGFzIGFueSkucXVlcnlMb2NhbEZvbnRzKCk7XHJcbiAgICBjb25zb2xlLmxvZygnbG9jYWwgZm9udHMgY291bnQ6JywgZm9udHMubGVuZ3RoKTtcclxuXHJcbiAgICBjb25zdCBkYiA9IGF3YWl0IGlkYi5vcGVuREIoJ3R5cHN0LXRzLXN0b3JlJywgMSwge1xyXG4gICAgICB1cGdyYWRlKGRiKSB7XHJcbiAgICAgICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUoJ2ZvbnQtaW5mb3JtYXRpb24nLCB7XHJcbiAgICAgICAgICBrZXlQYXRoOiAncG9zdHNjcmlwdE5hbWUnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgaW5mb3JtYXRpb25zID0gYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgIGZvbnRzLm1hcChhc3luYyBmb250ID0+IHtcclxuICAgICAgICBjb25zdCBwb3N0c2NyaXB0TmFtZSA9IGZvbnQucG9zdHNjcmlwdE5hbWU7XHJcblxyXG4gICAgICAgIHJldHVybiAoYXdhaXQgZGIuZ2V0KCdmb250LWluZm9ybWF0aW9uJywgcG9zdHNjcmlwdE5hbWUpKT8uaW5mbztcclxuICAgICAgfSksXHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IGdldF9mb250X2luZm8gPSAoYnVpbGRlciBhcyBhbnkpLmhhbmRsZXJfZm9yX2ZvbnRfaW5mbygpO1xyXG5cclxuICAgIGF3YWl0IGJ1aWxkZXIuYWRkX3dlYl9mb250cyhcclxuICAgICAgZm9udHMubWFwKChmb250LCBmb250X2lkeCkgPT4ge1xyXG4gICAgICAgIGxldCBnZXR0aW5nQnVmZmVyID0gZmFsc2U7XHJcbiAgICAgICAgbGV0IHJlYWR5QnVmZmVyOiBBcnJheUJ1ZmZlciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcclxuICAgICAgICBjb25zdCBmdWxsTmFtZSA9IGZvbnQuZnVsbE5hbWU7XHJcbiAgICAgICAgY29uc3QgcG9zdHNjcmlwdE5hbWUgPSBmb250LnBvc3RzY3JpcHROYW1lO1xyXG5cclxuICAgICAgICBjb25zdCBwcmV2ID0gaW5mb3JtYXRpb25zW2ZvbnRfaWR4XTtcclxuICAgICAgICBpZiAocHJldikge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ3ByZXYnLCBwb3N0c2NyaXB0TmFtZSwgcHJldik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBmYW1pbHk6IGZvbnQuZmFtaWx5LFxyXG4gICAgICAgICAgc3R5bGU6IGZvbnQuc3R5bGUsXHJcbiAgICAgICAgICBmdWxsTmFtZTogZnVsbE5hbWUsXHJcbiAgICAgICAgICBwb3N0c2NyaXB0TmFtZTogcG9zdHNjcmlwdE5hbWUsXHJcbiAgICAgICAgICByZWY6IGZvbnQsXHJcbiAgICAgICAgICBpbmZvOiBpbmZvcm1hdGlvbnNbZm9udF9pZHhdLFxyXG4gICAgICAgICAgYmxvYjogKGlkeDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMsIGZvbnQsIGlkeCk7XHJcbiAgICAgICAgICAgIGlmIChyZWFkeUJ1ZmZlcikge1xyXG4gICAgICAgICAgICAgIHJldHVybiByZWFkeUJ1ZmZlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZ2V0dGluZ0J1ZmZlcikge1xyXG4gICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBnZXR0aW5nQnVmZmVyID0gdHJ1ZTtcclxuICAgICAgICAgICAgZ2xvYmFsRm9udFByb21pc2VzLnB1c2goXHJcbiAgICAgICAgICAgICAgKGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJsb2I6IEJsb2IgPSBhd2FpdCBmb250LmJsb2IoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IGJsb2IuYXJyYXlCdWZmZXIoKTtcclxuICAgICAgICAgICAgICAgIHJlYWR5QnVmZmVyID0gYnVmZmVyO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVhbEZvbnRJbmZvID0gZ2V0X2ZvbnRfaW5mbyhuZXcgVWludDhBcnJheShidWZmZXIpKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlYWxGb250SW5mbyk7XHJcblxyXG4gICAgICAgICAgICAgICAgZGIucHV0KCdmb250LWluZm9ybWF0aW9uJywge1xyXG4gICAgICAgICAgICAgICAgICBmdWxsTmFtZSxcclxuICAgICAgICAgICAgICAgICAgcG9zdHNjcmlwdE5hbWUsXHJcbiAgICAgICAgICAgICAgICAgIGluZm86IHJlYWxGb250SW5mbyxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGJ1ZmZlciwgaWR4IH07XHJcbiAgICAgICAgICAgICAgfSkoKSxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfTtcclxuICAgICAgfSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgdDIgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuICBjb25zb2xlLmxvZygnYWRkUGFydGlhbEZvbnRzIHRpbWUgdXNlZDonLCB0MiAtIHQpO1xyXG59XHJcblxyXG5jbGFzcyBDb21wb25lbnRCdWlsZGVyPFQ+IHtcclxuICBsb2FkZWRGb250cyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG4gIGZldGNoZXI/OiB0eXBlb2YgZmV0Y2ggPSBmZXRjaDtcclxuXHJcbiAgc2V0RmV0Y2hlcihmZXRjaGVyOiB0eXBlb2YgZmV0Y2gpOiB2b2lkIHtcclxuICAgIHRoaXMuZmV0Y2hlciA9IGZldGNoZXI7XHJcbiAgfVxyXG5cclxuICBhc3luYyBsb2FkRm9udHMoYnVpbGRlcjogVHlwc3RDb21tb25CdWlsZGVyPFQ+LCBmb250czogKHN0cmluZyB8IFVpbnQ4QXJyYXkpW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IGVzY2FwZUltcG9ydCA9IG5ldyBGdW5jdGlvbignbScsICdyZXR1cm4gaW1wb3J0KG0pJyk7XHJcbiAgICBjb25zdCBmZXRjaGVyID0gKHRoaXMuZmV0Y2hlciB8fD0gYXdhaXQgKGFzeW5jIGZ1bmN0aW9uICgpIHtcclxuICAgICAgY29uc3QgeyBmZXRjaEJ1aWxkZXIsIEZpbGVTeXN0ZW1DYWNoZSB9ID0gYXdhaXQgZXNjYXBlSW1wb3J0KCdub2RlLWZldGNoLWNhY2hlJyk7XHJcbiAgICAgIGNvbnN0IGNhY2hlID0gbmV3IEZpbGVTeXN0ZW1DYWNoZSh7XHJcbiAgICAgICAgLy8vIEJ5IGRlZmF1bHQsIHdlIGRvbid0IGhhdmUgYSBjb21wbGljYXRlZCBjYWNoZSBwb2xpY3kuXHJcbiAgICAgICAgY2FjaGVEaXJlY3Rvcnk6ICcuY2FjaGUvdHlwc3QvZm9udHMnLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IGNhY2hlZEZldGNoZXIgPSBmZXRjaEJ1aWxkZXIud2l0aENhY2hlKGNhY2hlKTtcclxuXHJcbiAgICAgIHJldHVybiBmdW5jdGlvbiAoaW5wdXQ6IFJlcXVlc3RJbmZvIHwgVVJMLCBpbml0PzogUmVxdWVzdEluaXQpIHtcclxuICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ2ZvbnQgZmV0Y2hpbmcgaXMgc3R1Y2tpbmc6JywgaW5wdXQpO1xyXG4gICAgICAgIH0sIDE1MDAwKTtcclxuICAgICAgICByZXR1cm4gY2FjaGVkRmV0Y2hlcihpbnB1dCwgaW5pdCkuZmluYWxseSgoKSA9PiB7XHJcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH07XHJcbiAgICB9KSgpKTtcclxuXHJcbiAgICBjb25zdCBmb250c1RvTG9hZCA9IGZvbnRzLmZpbHRlcihmb250ID0+IHtcclxuICAgICAgaWYgKGZvbnQgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICh0aGlzLmxvYWRlZEZvbnRzLmhhcyhmb250KSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5sb2FkZWRGb250cy5hZGQoZm9udCk7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgZm9udExpc3RzID0gYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgIGZvbnRzVG9Mb2FkLm1hcChhc3luYyBmb250ID0+IHtcclxuICAgICAgICBpZiAoZm9udCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHtcclxuICAgICAgICAgIGF3YWl0IGJ1aWxkZXIuYWRkX3Jhd19mb250KGZvbnQpO1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGF3YWl0IChhd2FpdCBmZXRjaGVyKGZvbnQpKS5hcnJheUJ1ZmZlcigpKTtcclxuICAgICAgfSksXHJcbiAgICApO1xyXG5cclxuICAgIGZvciAoY29uc3QgZm9udCBvZiBmb250TGlzdHMpIHtcclxuICAgICAgaWYgKCFmb250KSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgYXdhaXQgYnVpbGRlci5hZGRfcmF3X2ZvbnQoZm9udCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBidWlsZChcclxuICAgIG9wdGlvbnM6IFBhcnRpYWw8SW5pdE9wdGlvbnM+IHwgdW5kZWZpbmVkLFxyXG4gICAgYnVpbGRlcjogVHlwc3RDb21tb25CdWlsZGVyPFQ+LFxyXG4gICAgaG9va3M6IENvbXBvbmVudEJ1aWxkSG9va3MsXHJcbiAgKTogUHJvbWlzZTxUPiB7XHJcbiAgICAvLy8gYnVpbGQgdHlwc3QgY29tcG9uZW50XHJcbiAgICBjb25zdCBidWlsZEN0eDogSW5pdENvbnRleHQ8VD4gPSB7IHJlZjogdGhpcywgYnVpbGRlciwgaG9va3MgfTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IGZuIG9mIG9wdGlvbnM/LmJlZm9yZUJ1aWxkID8/IFtdKSB7XHJcbiAgICAgIGF3YWl0IGZuKHVuZGVmaW5lZCBhcyB1bmtub3duIGFzIEJlZm9yZUJ1aWxkTWFyaywgYnVpbGRDdHgpO1xyXG4gICAgfVxyXG4gICAgLy8gYXdhaXQgYWRkUGFydGlhbEZvbnRzKGJ1aWxkQ3R4KTtcclxuXHJcbiAgICBpZiAoaG9va3MubGF0ZWx5QnVpbGQpIHtcclxuICAgICAgaG9va3MubGF0ZWx5QnVpbGQoYnVpbGRDdHgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNvbXBvbmVudCA9IGF3YWl0IGJ1aWxkZXIuYnVpbGQoKTtcclxuXHJcbiAgICByZXR1cm4gY29tcG9uZW50O1xyXG4gIH1cclxufVxyXG5cclxuLyoqIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGRDb21wb25lbnQ8VD4oXHJcbiAgb3B0aW9uczogUGFydGlhbDxJbml0T3B0aW9ucz4gfCB1bmRlZmluZWQsXHJcbiAgZ01vZHVsZTogTGF6eVdhc21Nb2R1bGUsXHJcbiAgQnVpbGRlcjogeyBuZXcgKCk6IFR5cHN0Q29tbW9uQnVpbGRlcjxUPiB9LFxyXG4gIGhvb2tzOiBDb21wb25lbnRCdWlsZEhvb2tzLFxyXG4pOiBQcm9taXNlPFQ+IHtcclxuICAvLy8gaW5pdCB0eXBzdCB3YXNtIG1vZHVsZVxyXG4gIGF3YWl0IGdNb2R1bGUuaW5pdChvcHRpb25zPy5nZXRNb2R1bGU/LigpKTtcclxuXHJcbiAgcmV0dXJuIGF3YWl0IG5ldyBDb21wb25lbnRCdWlsZGVyPFQ+KCkuYnVpbGQob3B0aW9ucywgbmV3IEJ1aWxkZXIoKSwgaG9va3MpO1xyXG59XHJcbiJdfQ==