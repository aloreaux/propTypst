import { kObject } from './internal.types.mjs';
import { TypstDocumentContext, composeDoc, provideDoc, } from './contrib/dom/typst-doc.mjs';
import { TypstCancellationToken } from './contrib/dom/typst-cancel.mjs';
const animationFrame = () => new Promise(resolve => requestAnimationFrame(resolve));
class DomPage {
    dispose() { }
}
var TrackMode;
(function (TrackMode) {
    TrackMode[TrackMode["Doc"] = 0] = "Doc";
    TrackMode[TrackMode["Pages"] = 1] = "Pages";
})(TrackMode || (TrackMode = {}));
var RepaintStage;
(function (RepaintStage) {
    RepaintStage[RepaintStage["Layout"] = 0] = "Layout";
    RepaintStage[RepaintStage["Svg"] = 1] = "Svg";
    RepaintStage[RepaintStage["Semantics"] = 2] = "Semantics";
    RepaintStage[RepaintStage["PrepareCanvas"] = 3] = "PrepareCanvas";
    RepaintStage[RepaintStage["Canvas"] = 4] = "Canvas";
})(RepaintStage || (RepaintStage = {}));
export function provideDomDoc(Base) {
    return class DomDocument extends Base {
        /// The template element for creating DOM by string.
        tmpl = document.createElement('template');
        /// The stub element for replacing an invisible element.
        stub = this.createElement('<stub></stub>');
        /// Typescript side of lib.
        plugin;
        /// Rust side of kernel.
        docKernel;
        /// The element to track.
        resourceHeader = undefined;
        /// Expected exact state of the current DOM.
        /// Initially it is empty meaning no any page is rendered.
        pages = [];
        /// The virtual scale of the document.
        domScale = 1;
        /// Track mode.
        track_mode = TrackMode.Doc;
        /// Current executing task.
        current_task = undefined;
        /// The currently maintained viewport.
        viewport;
        constructor(...args) {
            super(...args);
            this.registerMode('dom');
            this.disposeList.push(() => {
                this.dispose();
            });
            this.plugin = this.opts.renderer;
            if (this.opts.domScale !== undefined) {
                if (this.opts.domScale <= 0) {
                    throw new Error('domScale must be positive');
                }
                this.domScale = this.opts.domScale;
            }
        }
        dispose() {
            for (const page of this.pages) {
                page.dispose();
            }
            if (this.docKernel) {
                this.docKernel.free();
            }
        }
        createElement(tmpl) {
            this.tmpl.innerHTML = tmpl;
            return this.tmpl.content.firstElementChild;
        }
        async mountDom(pixelPerPt) {
            console.log('mountDom', pixelPerPt);
            if (this.docKernel) {
                throw new Error('already mounted');
            }
            // create typst-svg-resources by string
            this.hookedElem.innerHTML = `<svg class="typst-svg-resources" viewBox="0 0 0 0" width="0" height="0" style="opacity: 0; position: absolute;"></svg>`;
            this.resourceHeader = this.hookedElem.querySelector('.typst-svg-resources');
            this.docKernel = await this.plugin.renderer.mount_dom(this.kModule[kObject], this.hookedElem);
            this.docKernel.bind_functions({
                populateGlyphs: (data) => {
                    let svg = this.createElement(data);
                    console.log('populateGlyphs', svg);
                    let content = svg.firstElementChild;
                    this.resourceHeader.append(content);
                },
            });
        }
        async cancelAnyway$dom() {
            console.log('cancelAnyway$dom');
            if (this.current_task) {
                const task = this.current_task;
                this.current_task = undefined;
                await task.cancel();
            }
        }
        retrieveDOMPages() {
            return Array.from(this.hookedElem.querySelectorAll('.typst-dom-page'));
        }
        // doesn't need to postRender
        postRender$dom() { }
        // doesn't need to rescale
        rescale$dom() { }
        getDomViewport(cachedWindow, cachedBoundingRect) {
            const left = cachedBoundingRect.left;
            const top = -cachedBoundingRect.top;
            const right = cachedBoundingRect.right;
            const bottom = cachedWindow.innerHeight - cachedBoundingRect.top;
            const rect = {
                x: 0,
                y: top / this.domScale,
                width: Math.max(right - left, 0) / this.domScale,
                height: Math.max(bottom - top, 0) / this.domScale,
            };
            if (rect.width <= 0 || rect.height <= 0) {
                rect.x = rect.y = rect.width = rect.height = 0;
            }
            // console.log('ccc', basePos, appPos, rect);
            return rect;
        }
        // fast mode
        async rerender$dom() {
            const domState = this.retrieveDOMState();
            // const l = domState.boundingRect.left;
            const { x, y, width, height } = this.getDomViewport(domState.window, domState.boundingRect);
            let dirty = await this.docKernel.relayout(x, y, width, height);
            if (!dirty) {
                return;
            }
            const cancel = new TypstCancellationToken();
            this.doRender$dom(cancel);
            this.current_task = cancel;
        }
        async doRender$dom(ctx) {
            const condOrExit = (needFrame, cb) => {
                if (needFrame && !ctx.isCancelRequested() && cb) {
                    return cb();
                }
            };
            const pages = this.retrieveDOMPages().map(page => {
                const { innerWidth, innerHeight } = window;
                const browserBBox = page.getBoundingClientRect();
                // any part of the page is in the window
                return {
                    inWindow: !(browserBBox.left > innerWidth ||
                        browserBBox.right < 0 ||
                        browserBBox.top > innerHeight ||
                        browserBBox.bottom < 0),
                    page,
                };
            });
            const renderPage = async (i) => {
                await animationFrame();
                if (ctx.isCancelRequested()) {
                    console.log('cancel stage', RepaintStage.Layout, i);
                    return undefined;
                }
                const page = pages[i].page;
                const browserBBox = page.getBoundingClientRect();
                const v = this.getDomViewport(window, browserBBox);
                const needCalc = (stage) => this.docKernel.need_repaint(i, v.x, v.y, v.width, v.height, stage);
                const repaint = (stage) => this.docKernel.repaint(i, v.x, v.y, v.width, v.height, stage);
                const calc = (stage) => {
                    if (ctx.isCancelRequested()) {
                        return undefined;
                    }
                    return condOrExit(needCalc(stage), () => repaint(stage));
                };
                await calc(RepaintStage.Layout);
                const wScale = (browserBBox.width
                    ? Number.parseFloat(page.getAttribute('data-width')) / browserBBox.width
                    : 1) * this.domScale;
                const hScale = (browserBBox.height
                    ? Number.parseFloat(page.getAttribute('data-height')) / browserBBox.height
                    : 1) * this.domScale;
                v.x *= wScale;
                v.y *= hScale;
                v.y -= 100;
                v.width *= wScale;
                v.height *= hScale;
                v.height += 200;
                await calc(RepaintStage.Svg);
                await calc(RepaintStage.Semantics);
                if (ctx.isCancelRequested()) {
                    console.log('cancel stage', RepaintStage.Semantics, i);
                    return undefined;
                }
                if (needCalc(RepaintStage.PrepareCanvas)) {
                    const calcCanvasAfterPreparing = async () => {
                        await repaint(RepaintStage.PrepareCanvas);
                        if (ctx.isCancelRequested()) {
                            return undefined;
                        }
                        return calc(RepaintStage.Canvas);
                    };
                    calcCanvasAfterPreparing();
                }
                else {
                    await calc(RepaintStage.Canvas);
                }
            };
            const renderPages = async (inWindow) => {
                for (let idx = 0; idx < pages.length; ++idx) {
                    if (ctx.isCancelRequested()) {
                        console.log('cancel page', RepaintStage.Layout, idx);
                        return;
                    }
                    if (pages[idx].inWindow === inWindow) {
                        await renderPage(idx);
                    }
                }
            };
            this.cancelAnyway$dom();
            await renderPages(true);
            await renderPages(false);
            if (ctx.isCancelRequested()) {
                return;
            }
            console.log('finished', RepaintStage.Layout);
        }
    };
}
export class TypstDomDocument extends provideDoc(composeDoc(TypstDocumentContext, provideDomDoc)) {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kb20ubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBUSxPQUFPLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVyRCxPQUFPLEVBRUwsb0JBQW9CLEVBQ3BCLFVBQVUsRUFDVixVQUFVLEdBQ1gsTUFBTSw2QkFBNkIsQ0FBQztBQUNyQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUV4RSxNQUFNLGNBQWMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFFcEYsTUFBTSxPQUFPO0lBQ1gsT0FBTyxLQUFJLENBQUM7Q0FDYjtBQUVELElBQVcsU0FHVjtBQUhELFdBQVcsU0FBUztJQUNsQix1Q0FBRyxDQUFBO0lBQ0gsMkNBQUssQ0FBQTtBQUNQLENBQUMsRUFIVSxTQUFTLEtBQVQsU0FBUyxRQUduQjtBQUVELElBQVcsWUFNVjtBQU5ELFdBQVcsWUFBWTtJQUNyQixtREFBVSxDQUFBO0lBQ1YsNkNBQU8sQ0FBQTtJQUNQLHlEQUFhLENBQUE7SUFDYixpRUFBaUIsQ0FBQTtJQUNqQixtREFBVSxDQUFBO0FBQ1osQ0FBQyxFQU5VLFlBQVksS0FBWixZQUFZLFFBTXRCO0FBZUQsTUFBTSxVQUFVLGFBQWEsQ0FDM0IsSUFBVztJQUVYLE9BQU8sTUFBTSxXQUFZLFNBQVEsSUFBSTtRQUNuQyxvREFBb0Q7UUFDcEQsSUFBSSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDMUMsd0RBQXdEO1FBQ3hELElBQUksR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzNDLDJCQUEyQjtRQUMzQixNQUFNLENBQXNCO1FBQzVCLHdCQUF3QjtRQUN4QixTQUFTLENBQW1CO1FBQzVC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LEVBQUU7b0JBQzNDLElBQUksR0FBRyxDQUFDLGlCQUFpQixFQUFFLEVBQUU7d0JBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLFlBQVksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7d0JBQ3JELE9BQU87cUJBQ1I7b0JBQ0QsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRTt3QkFDcEMsTUFBTSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7cUJBQ3ZCO2lCQUNGO1lBQ0gsQ0FBQyxDQUFDO1lBRUYsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFFeEIsTUFBTSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEIsTUFBTSxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDekIsSUFBSSxHQUFHLENBQUMsaUJBQWlCLEVBQUUsRUFBRTtnQkFDM0IsT0FBTzthQUNSO1lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9DLENBQUM7S0FDRixDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxVQUFVLENBQzlDLFVBQVUsQ0FDUixvQkFBMEUsRUFDMUUsYUFBYSxDQUNkLENBQ0Y7Q0FBRyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgSW5jckRvbURvY0NsaWVudCB9IGZyb20gJ0BteXJpYWRkcmVhbWluL3R5cHN0LXRzLXJlbmRlcmVyJztcclxuaW1wb3J0IHsgUmVjdCwga09iamVjdCB9IGZyb20gJy4vaW50ZXJuYWwudHlwZXMubWpzJztcclxuaW1wb3J0IHsgVHlwc3RSZW5kZXJlciwgVHlwc3RSZW5kZXJlckRyaXZlciB9IGZyb20gJy4vcmVuZGVyZXIubWpzJztcclxuaW1wb3J0IHtcclxuICBHQ29uc3RydWN0b3IsXHJcbiAgVHlwc3REb2N1bWVudENvbnRleHQsXHJcbiAgY29tcG9zZURvYyxcclxuICBwcm92aWRlRG9jLFxyXG59IGZyb20gJy4vY29udHJpYi9kb20vdHlwc3QtZG9jLm1qcyc7XHJcbmltcG9ydCB7IFR5cHN0Q2FuY2VsbGF0aW9uVG9rZW4gfSBmcm9tICcuL2NvbnRyaWIvZG9tL3R5cHN0LWNhbmNlbC5tanMnO1xyXG5cclxuY29uc3QgYW5pbWF0aW9uRnJhbWUgPSAoKSA9PiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZShyZXNvbHZlKSk7XHJcblxyXG5jbGFzcyBEb21QYWdlIHtcclxuICBkaXNwb3NlKCkge31cclxufVxyXG5cclxuY29uc3QgZW51bSBUcmFja01vZGUge1xyXG4gIERvYyxcclxuICBQYWdlcyxcclxufVxyXG5cclxuY29uc3QgZW51bSBSZXBhaW50U3RhZ2Uge1xyXG4gIExheW91dCA9IDAsXHJcbiAgU3ZnID0gMSxcclxuICBTZW1hbnRpY3MgPSAyLFxyXG4gIFByZXBhcmVDYW52YXMgPSAzLFxyXG4gIENhbnZhcyA9IDQsXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSVR5cHN0RG9tRG9jdW1lbnQge1xyXG4gIG1vdW50RG9tKHBpeGVsUGVyUHQ6IG51bWJlciB8IHVuZGVmaW5lZCk6IFByb21pc2U8dm9pZD47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSW5pdERvbURvY0FyZ3Mge1xyXG4gIHJlbmRlcmVyOiBUeXBzdFJlbmRlcmVyO1xyXG4gIGRvbVNjYWxlPzogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgUmVuZGVyVGFzayB7XHJcbiAgY2FuY2VsKCk6IFByb21pc2U8dm9pZD47XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlRG9tRG9jPFRCYXNlIGV4dGVuZHMgR0NvbnN0cnVjdG9yPFR5cHN0RG9jdW1lbnRDb250ZXh0PEluaXREb21Eb2NBcmdzPj4+KFxyXG4gIEJhc2U6IFRCYXNlLFxyXG4pOiBUQmFzZSAmIEdDb25zdHJ1Y3RvcjxJVHlwc3REb21Eb2N1bWVudD4ge1xyXG4gIHJldHVybiBjbGFzcyBEb21Eb2N1bWVudCBleHRlbmRzIEJhc2Uge1xyXG4gICAgLy8vIFRoZSB0ZW1wbGF0ZSBlbGVtZW50IGZvciBjcmVhdGluZyBET00gYnkgc3RyaW5nLlxyXG4gICAgdG1wbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJyk7XHJcbiAgICAvLy8gVGhlIHN0dWIgZWxlbWVudCBmb3IgcmVwbGFjaW5nIGFuIGludmlzaWJsZSBlbGVtZW50LlxyXG4gICAgc3R1YiA9IHRoaXMuY3JlYXRlRWxlbWVudCgnPHN0dWI+PC9zdHViPicpO1xyXG4gICAgLy8vIFR5cGVzY3JpcHQgc2lkZSBvZiBsaWIuXHJcbiAgICBwbHVnaW46IFR5cHN0UmVuZGVyZXJEcml2ZXI7XHJcbiAgICAvLy8gUnVzdCBzaWRlIG9mIGtlcm5lbC5cclxuICAgIGRvY0tlcm5lbDogSW5jckRvbURvY0NsaWVudDtcclxuICAgIC8vLyBUaGUgZWxlbWVudCB0byB0cmFjay5cclxuICAgIHJlc291cmNlSGVhZGVyOiBTVkdFbGVtZW50ID0gdW5kZWZpbmVkITtcclxuICAgIC8vLyBFeHBlY3RlZCBleGFjdCBzdGF0ZSBvZiB0aGUgY3VycmVudCBET00uXHJcbiAgICAvLy8gSW5pdGlhbGx5IGl0IGlzIGVtcHR5IG1lYW5pbmcgbm8gYW55IHBhZ2UgaXMgcmVuZGVyZWQuXHJcbiAgICBwYWdlczogRG9tUGFnZVtdID0gW107XHJcbiAgICAvLy8gVGhlIHZpcnR1YWwgc2NhbGUgb2YgdGhlIGRvY3VtZW50LlxyXG4gICAgZG9tU2NhbGUgPSAxO1xyXG4gICAgLy8vIFRyYWNrIG1vZGUuXHJcbiAgICB0cmFja19tb2RlOiBUcmFja01vZGUgPSBUcmFja01vZGUuRG9jO1xyXG4gICAgLy8vIEN1cnJlbnQgZXhlY3V0aW5nIHRhc2suXHJcbiAgICBjdXJyZW50X3Rhc2s/OiBSZW5kZXJUYXNrID0gdW5kZWZpbmVkO1xyXG4gICAgLy8vIFRoZSBjdXJyZW50bHkgbWFpbnRhaW5lZCB2aWV3cG9ydC5cclxuICAgIHZpZXdwb3J0OiBSZWN0O1xyXG4gICAgY29uc3RydWN0b3IoLi4uYXJnczogYW55W10pIHtcclxuICAgICAgc3VwZXIoLi4uYXJncyk7XHJcbiAgICAgIHRoaXMucmVnaXN0ZXJNb2RlKCdkb20nKTtcclxuICAgICAgdGhpcy5kaXNwb3NlTGlzdC5wdXNoKCgpID0+IHtcclxuICAgICAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMucGx1Z2luID0gdGhpcy5vcHRzLnJlbmRlcmVyIGFzIGFueSBhcyBUeXBzdFJlbmRlcmVyRHJpdmVyO1xyXG4gICAgICBpZiAodGhpcy5vcHRzLmRvbVNjYWxlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRzLmRvbVNjYWxlIDw9IDApIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZG9tU2NhbGUgbXVzdCBiZSBwb3NpdGl2ZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmRvbVNjYWxlID0gdGhpcy5vcHRzLmRvbVNjYWxlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGlzcG9zZSgpIHtcclxuICAgICAgZm9yIChjb25zdCBwYWdlIG9mIHRoaXMucGFnZXMpIHtcclxuICAgICAgICBwYWdlLmRpc3Bvc2UoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHRoaXMuZG9jS2VybmVsKSB7XHJcbiAgICAgICAgdGhpcy5kb2NLZXJuZWwuZnJlZSgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlRWxlbWVudCh0bXBsOiBzdHJpbmcpIHtcclxuICAgICAgdGhpcy50bXBsLmlubmVySFRNTCA9IHRtcGw7XHJcbiAgICAgIHJldHVybiB0aGlzLnRtcGwuY29udGVudC5maXJzdEVsZW1lbnRDaGlsZDtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBtb3VudERvbShwaXhlbFBlclB0OiBudW1iZXIgfCB1bmRlZmluZWQpIHtcclxuICAgICAgY29uc29sZS5sb2coJ21vdW50RG9tJywgcGl4ZWxQZXJQdCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5kb2NLZXJuZWwpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FscmVhZHkgbW91bnRlZCcpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBjcmVhdGUgdHlwc3Qtc3ZnLXJlc291cmNlcyBieSBzdHJpbmdcclxuICAgICAgdGhpcy5ob29rZWRFbGVtLmlubmVySFRNTCA9IGA8c3ZnIGNsYXNzPVwidHlwc3Qtc3ZnLXJlc291cmNlc1wiIHZpZXdCb3g9XCIwIDAgMCAwXCIgd2lkdGg9XCIwXCIgaGVpZ2h0PVwiMFwiIHN0eWxlPVwib3BhY2l0eTogMDsgcG9zaXRpb246IGFic29sdXRlO1wiPjwvc3ZnPmA7XHJcbiAgICAgIHRoaXMucmVzb3VyY2VIZWFkZXIgPSB0aGlzLmhvb2tlZEVsZW0ucXVlcnlTZWxlY3RvcignLnR5cHN0LXN2Zy1yZXNvdXJjZXMnKSE7XHJcblxyXG4gICAgICB0aGlzLmRvY0tlcm5lbCA9IGF3YWl0IHRoaXMucGx1Z2luLnJlbmRlcmVyLm1vdW50X2RvbSh0aGlzLmtNb2R1bGVba09iamVjdF0sIHRoaXMuaG9va2VkRWxlbSk7XHJcblxyXG4gICAgICB0aGlzLmRvY0tlcm5lbC5iaW5kX2Z1bmN0aW9ucyh7XHJcbiAgICAgICAgcG9wdWxhdGVHbHlwaHM6IChkYXRhOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIGxldCBzdmcgPSB0aGlzLmNyZWF0ZUVsZW1lbnQoZGF0YSkhO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ3BvcHVsYXRlR2x5cGhzJywgc3ZnKTtcclxuICAgICAgICAgIGxldCBjb250ZW50ID0gc3ZnLmZpcnN0RWxlbWVudENoaWxkITtcclxuICAgICAgICAgIHRoaXMucmVzb3VyY2VIZWFkZXIuYXBwZW5kKGNvbnRlbnQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGNhbmNlbEFueXdheSRkb20oKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdjYW5jZWxBbnl3YXkkZG9tJyk7XHJcbiAgICAgIGlmICh0aGlzLmN1cnJlbnRfdGFzaykge1xyXG4gICAgICAgIGNvbnN0IHRhc2sgPSB0aGlzLmN1cnJlbnRfdGFzaztcclxuICAgICAgICB0aGlzLmN1cnJlbnRfdGFzayA9IHVuZGVmaW5lZDtcclxuICAgICAgICBhd2FpdCB0YXNrLmNhbmNlbCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0cmlldmVET01QYWdlcygpIHtcclxuICAgICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5ob29rZWRFbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJy50eXBzdC1kb20tcGFnZScpKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBkb2Vzbid0IG5lZWQgdG8gcG9zdFJlbmRlclxyXG4gICAgcG9zdFJlbmRlciRkb20oKSB7fVxyXG5cclxuICAgIC8vIGRvZXNuJ3QgbmVlZCB0byByZXNjYWxlXHJcbiAgICByZXNjYWxlJGRvbSgpIHt9XHJcblxyXG4gICAgZ2V0RG9tVmlld3BvcnQoXHJcbiAgICAgIGNhY2hlZFdpbmRvdzogUGljazxXaW5kb3csICdpbm5lckhlaWdodCcgfCAnaW5uZXJXaWR0aCc+LFxyXG4gICAgICBjYWNoZWRCb3VuZGluZ1JlY3Q6IFBpY2s8RE9NUmVjdCwgJ2xlZnQnIHwgJ3RvcCcgfCAncmlnaHQnPixcclxuICAgICkge1xyXG4gICAgICBjb25zdCBsZWZ0ID0gY2FjaGVkQm91bmRpbmdSZWN0LmxlZnQ7XHJcbiAgICAgIGNvbnN0IHRvcCA9IC1jYWNoZWRCb3VuZGluZ1JlY3QudG9wO1xyXG4gICAgICBjb25zdCByaWdodCA9IGNhY2hlZEJvdW5kaW5nUmVjdC5yaWdodDtcclxuICAgICAgY29uc3QgYm90dG9tID0gY2FjaGVkV2luZG93LmlubmVySGVpZ2h0IC0gY2FjaGVkQm91bmRpbmdSZWN0LnRvcDtcclxuICAgICAgY29uc3QgcmVjdCA9IHtcclxuICAgICAgICB4OiAwLFxyXG4gICAgICAgIHk6IHRvcCAvIHRoaXMuZG9tU2NhbGUsXHJcbiAgICAgICAgd2lkdGg6IE1hdGgubWF4KHJpZ2h0IC0gbGVmdCwgMCkgLyB0aGlzLmRvbVNjYWxlLFxyXG4gICAgICAgIGhlaWdodDogTWF0aC5tYXgoYm90dG9tIC0gdG9wLCAwKSAvIHRoaXMuZG9tU2NhbGUsXHJcbiAgICAgIH07XHJcbiAgICAgIGlmIChyZWN0LndpZHRoIDw9IDAgfHwgcmVjdC5oZWlnaHQgPD0gMCkge1xyXG4gICAgICAgIHJlY3QueCA9IHJlY3QueSA9IHJlY3Qud2lkdGggPSByZWN0LmhlaWdodCA9IDA7XHJcbiAgICAgIH1cclxuICAgICAgLy8gY29uc29sZS5sb2coJ2NjYycsIGJhc2VQb3MsIGFwcFBvcywgcmVjdCk7XHJcbiAgICAgIHJldHVybiByZWN0O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGZhc3QgbW9kZVxyXG4gICAgYXN5bmMgcmVyZW5kZXIkZG9tKCkge1xyXG4gICAgICBjb25zdCBkb21TdGF0ZSA9IHRoaXMucmV0cmlldmVET01TdGF0ZSgpO1xyXG5cclxuICAgICAgLy8gY29uc3QgbCA9IGRvbVN0YXRlLmJvdW5kaW5nUmVjdC5sZWZ0O1xyXG4gICAgICBjb25zdCB7IHgsIHksIHdpZHRoLCBoZWlnaHQgfSA9IHRoaXMuZ2V0RG9tVmlld3BvcnQoZG9tU3RhdGUud2luZG93LCBkb21TdGF0ZS5ib3VuZGluZ1JlY3QpO1xyXG5cclxuICAgICAgbGV0IGRpcnR5ID0gYXdhaXQgdGhpcy5kb2NLZXJuZWwucmVsYXlvdXQoeCwgeSwgd2lkdGgsIGhlaWdodCk7XHJcbiAgICAgIGlmICghZGlydHkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGNhbmNlbCA9IG5ldyBUeXBzdENhbmNlbGxhdGlvblRva2VuKCk7XHJcbiAgICAgIHRoaXMuZG9SZW5kZXIkZG9tKGNhbmNlbCk7XHJcbiAgICAgIHRoaXMuY3VycmVudF90YXNrID0gY2FuY2VsO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGRvUmVuZGVyJGRvbShjdHg6IFR5cHN0Q2FuY2VsbGF0aW9uVG9rZW4pIHtcclxuICAgICAgY29uc3QgY29uZE9yRXhpdCA9IDxULD4obmVlZEZyYW1lOiBib29sZWFuLCBjYjogKCkgPT4gUHJvbWlzZTxUPikgPT4ge1xyXG4gICAgICAgIGlmIChuZWVkRnJhbWUgJiYgIWN0eC5pc0NhbmNlbFJlcXVlc3RlZCgpICYmIGNiKSB7XHJcbiAgICAgICAgICByZXR1cm4gY2IoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IHBhZ2VzID0gdGhpcy5yZXRyaWV2ZURPTVBhZ2VzKCkubWFwKHBhZ2UgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgaW5uZXJXaWR0aCwgaW5uZXJIZWlnaHQgfSA9IHdpbmRvdztcclxuICAgICAgICBjb25zdCBicm93c2VyQkJveCA9IHBhZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgLy8gYW55IHBhcnQgb2YgdGhlIHBhZ2UgaXMgaW4gdGhlIHdpbmRvd1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBpbldpbmRvdzogIShcclxuICAgICAgICAgICAgYnJvd3NlckJCb3gubGVmdCA+IGlubmVyV2lkdGggfHxcclxuICAgICAgICAgICAgYnJvd3NlckJCb3gucmlnaHQgPCAwIHx8XHJcbiAgICAgICAgICAgIGJyb3dzZXJCQm94LnRvcCA+IGlubmVySGVpZ2h0IHx8XHJcbiAgICAgICAgICAgIGJyb3dzZXJCQm94LmJvdHRvbSA8IDBcclxuICAgICAgICAgICksXHJcbiAgICAgICAgICBwYWdlLFxyXG4gICAgICAgIH07XHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zdCByZW5kZXJQYWdlID0gYXN5bmMgKGk6IG51bWJlcikgPT4ge1xyXG4gICAgICAgIGF3YWl0IGFuaW1hdGlvbkZyYW1lKCk7XHJcbiAgICAgICAgaWYgKGN0eC5pc0NhbmNlbFJlcXVlc3RlZCgpKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnY2FuY2VsIHN0YWdlJywgUmVwYWludFN0YWdlLkxheW91dCwgaSk7XHJcbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYWdlID0gcGFnZXNbaV0ucGFnZTtcclxuICAgICAgICBjb25zdCBicm93c2VyQkJveCA9IHBhZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3QgdiA9IHRoaXMuZ2V0RG9tVmlld3BvcnQod2luZG93LCBicm93c2VyQkJveCk7XHJcblxyXG4gICAgICAgIGNvbnN0IG5lZWRDYWxjID0gKHN0YWdlOiBSZXBhaW50U3RhZ2UpID0+XHJcbiAgICAgICAgICB0aGlzLmRvY0tlcm5lbC5uZWVkX3JlcGFpbnQoaSwgdi54LCB2LnksIHYud2lkdGgsIHYuaGVpZ2h0LCBzdGFnZSk7XHJcbiAgICAgICAgY29uc3QgcmVwYWludCA9IChzdGFnZTogUmVwYWludFN0YWdlKSA9PlxyXG4gICAgICAgICAgdGhpcy5kb2NLZXJuZWwucmVwYWludChpLCB2LngsIHYueSwgdi53aWR0aCwgdi5oZWlnaHQsIHN0YWdlKTtcclxuICAgICAgICBjb25zdCBjYWxjID0gKHN0YWdlOiBSZXBhaW50U3RhZ2UpID0+IHtcclxuICAgICAgICAgIGlmIChjdHguaXNDYW5jZWxSZXF1ZXN0ZWQoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGNvbmRPckV4aXQobmVlZENhbGMoc3RhZ2UpLCAoKSA9PiByZXBhaW50KHN0YWdlKSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgYXdhaXQgY2FsYyhSZXBhaW50U3RhZ2UuTGF5b3V0KTtcclxuXHJcbiAgICAgICAgY29uc3Qgd1NjYWxlID1cclxuICAgICAgICAgIChicm93c2VyQkJveC53aWR0aFxyXG4gICAgICAgICAgICA/IE51bWJlci5wYXJzZUZsb2F0KHBhZ2UuZ2V0QXR0cmlidXRlKCdkYXRhLXdpZHRoJykhKSAvIGJyb3dzZXJCQm94LndpZHRoXHJcbiAgICAgICAgICAgIDogMSkgKiB0aGlzLmRvbVNjYWxlO1xyXG4gICAgICAgIGNvbnN0IGhTY2FsZSA9XHJcbiAgICAgICAgICAoYnJvd3NlckJCb3guaGVpZ2h0XHJcbiAgICAgICAgICAgID8gTnVtYmVyLnBhcnNlRmxvYXQocGFnZS5nZXRBdHRyaWJ1dGUoJ2RhdGEtaGVpZ2h0JykhKSAvIGJyb3dzZXJCQm94LmhlaWdodFxyXG4gICAgICAgICAgICA6IDEpICogdGhpcy5kb21TY2FsZTtcclxuICAgICAgICB2LnggKj0gd1NjYWxlO1xyXG4gICAgICAgIHYueSAqPSBoU2NhbGU7XHJcbiAgICAgICAgdi55IC09IDEwMDtcclxuICAgICAgICB2LndpZHRoICo9IHdTY2FsZTtcclxuICAgICAgICB2LmhlaWdodCAqPSBoU2NhbGU7XHJcbiAgICAgICAgdi5oZWlnaHQgKz0gMjAwO1xyXG5cclxuICAgICAgICBhd2FpdCBjYWxjKFJlcGFpbnRTdGFnZS5TdmcpO1xyXG4gICAgICAgIGF3YWl0IGNhbGMoUmVwYWludFN0YWdlLlNlbWFudGljcyk7XHJcbiAgICAgICAgaWYgKGN0eC5pc0NhbmNlbFJlcXVlc3RlZCgpKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnY2FuY2VsIHN0YWdlJywgUmVwYWludFN0YWdlLlNlbWFudGljcywgaSk7XHJcbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobmVlZENhbGMoUmVwYWludFN0YWdlLlByZXBhcmVDYW52YXMpKSB7XHJcbiAgICAgICAgICBjb25zdCBjYWxjQ2FudmFzQWZ0ZXJQcmVwYXJpbmcgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGF3YWl0IHJlcGFpbnQoUmVwYWludFN0YWdlLlByZXBhcmVDYW52YXMpO1xyXG4gICAgICAgICAgICBpZiAoY3R4LmlzQ2FuY2VsUmVxdWVzdGVkKCkpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjYWxjKFJlcGFpbnRTdGFnZS5DYW52YXMpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGNhbGNDYW52YXNBZnRlclByZXBhcmluZygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBhd2FpdCBjYWxjKFJlcGFpbnRTdGFnZS5DYW52YXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgY29uc3QgcmVuZGVyUGFnZXMgPSBhc3luYyAoaW5XaW5kb3c6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBmb3IgKGxldCBpZHggPSAwOyBpZHggPCBwYWdlcy5sZW5ndGg7ICsraWR4KSB7XHJcbiAgICAgICAgICBpZiAoY3R4LmlzQ2FuY2VsUmVxdWVzdGVkKCkpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ2NhbmNlbCBwYWdlJywgUmVwYWludFN0YWdlLkxheW91dCwgaWR4KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKHBhZ2VzW2lkeF0uaW5XaW5kb3cgPT09IGluV2luZG93KSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHJlbmRlclBhZ2UoaWR4KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcblxyXG4gICAgICB0aGlzLmNhbmNlbEFueXdheSRkb20oKTtcclxuXHJcbiAgICAgIGF3YWl0IHJlbmRlclBhZ2VzKHRydWUpO1xyXG4gICAgICBhd2FpdCByZW5kZXJQYWdlcyhmYWxzZSk7XHJcbiAgICAgIGlmIChjdHguaXNDYW5jZWxSZXF1ZXN0ZWQoKSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zb2xlLmxvZygnZmluaXNoZWQnLCBSZXBhaW50U3RhZ2UuTGF5b3V0KTtcclxuICAgIH1cclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgVHlwc3REb21Eb2N1bWVudCBleHRlbmRzIHByb3ZpZGVEb2MoXHJcbiAgY29tcG9zZURvYyhcclxuICAgIFR5cHN0RG9jdW1lbnRDb250ZXh0IGFzIEdDb25zdHJ1Y3RvcjxUeXBzdERvY3VtZW50Q29udGV4dDxJbml0RG9tRG9jQXJncz4+LFxyXG4gICAgcHJvdmlkZURvbURvYyxcclxuICApLFxyXG4pIHt9XHJcbiJdfQ==