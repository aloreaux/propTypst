import { patchRoot } from './render/svg/patch.mjs';
export class TypstDocument {
    props;
    session;
    sessionReady;
    disposeSession;
    constructor(props) {
        this.props = props;
        this.init();
    }
    static layoutPagesFullMode(doc) {
        return Promise.resolve(doc.session.retrievePagesInfo().map(() => {
            return {};
        }));
    }
    // copy from typst-preview
    static layoutSvgPagesPartialMode(doc, before) {
        const docRect = doc.shadowRoot.getBoundingClientRect(); // this.cachedBoundingRect;
        // https://measurethat.net/Benchmarks/Show/5392/0/clientwidth-vs-offsetwidth-vs-windowgetcomputedstyle
        // todo: this is only a PoC
        const cachedOffsetWidth = 'offsetWidth' in doc.shadowRoot
            ? doc.shadowRoot.offsetWidth
            : Number.parseInt(window.getComputedStyle(doc.shadowRoot).width.replace('px', ''));
        const currentScaleRatio = 1; // this.currentScaleRatio;
        // scale derived from svg width and container with.
        const computedRevScale = cachedOffsetWidth ? doc.session.docWidth / cachedOffsetWidth : 1;
        // respect current scale ratio
        const revScale = computedRevScale / currentScaleRatio;
        const left = (window.screenLeft - docRect.left) * revScale;
        const top = (window.screenTop - docRect.top) * revScale;
        const width = window.innerWidth * revScale;
        const height = window.innerHeight * revScale;
        void before;
        const patchStr = doc.session.renderSvgDiff({
            window: {
                lo: {
                    x: left,
                    y: top,
                },
                hi: {
                    x: left + width,
                    y: top + height,
                },
            },
        });
        // todo: ideally, we should patch per page separately
        // todo: then, we can call the api doc.renderPieces(pages + windows).
        if (doc.shadowRoot.firstElementChild) {
            const elem = document.createElement('div');
            elem.innerHTML = patchStr;
            const svgElement = elem.firstElementChild;
            patchRoot(doc.shadowRoot.firstElementChild, svgElement);
        }
        else {
            doc.shadowRoot.innerHTML = patchStr;
        }
        return Promise.resolve([]);
    }
    // copy from typst-preview
    // todo: generalize patchRoot here
    static layoutSvgPages(options) {
        return (doc, before) => {
            // todo
            return TypstDocument.layoutSvgPagesPartialMode(doc, before);
        };
    }
    addChangements(change) {
        throw new Error('Method not implemented.');
    }
    renderPieces(pieces) {
        throw new Error('Method not implemented.');
    }
    onSessionReady() {
        return this.sessionReady;
    }
    dispose() {
        if (this.disposeSession !== undefined) {
            this.disposeSession();
        }
    }
    init() {
        if (this.sessionReady !== undefined) {
            throw new Error('Already initialized');
        }
        if (this.props.session !== undefined) {
            this.session = this.props.session;
            return (this.sessionReady = Promise.resolve(this.session));
        }
        return (this.sessionReady = new Promise(resolve => {
            this.props.plugin.runWithSession(session => {
                return new Promise(dispose => {
                    this.session = session;
                    this.disposeSession = dispose;
                    resolve(session);
                });
            });
        }));
    }
}
//   private collectDocProperties(): DocProperties {
//     return {
//       [kRects]: undefined,
//     };
//   }
//   async mutate(
//     cb: (ctx: PageMutationContext) => Promise<void>,
//     // options?: {
//     //   prefetchedDocProperties?: DocProperties;
//     // },
//   ): Promise<void> {
//     await this.sessionReady;
//     // const docProperties = options?.prefetchedDocProperties ?? this.collectDocProperties();
//     const ctx = new PageMutationContextImpl(this.props, docProperties);
//     await cb(ctx);
//     return ctx[kDispose]();
//   }
// import { ManipulateDataOptions } from '../../options.render';
// export interface PageMutationInst<K> {
//   /**
//    * The kind of mutation.
//    * @property {string} kind - The kind of mutation.
//    */
//   kind: K;
//   /**
//    * After/At which element the mutation happens.
//    */
//   sentinel?: Element;
// }
// export type PageMutation = PageMutationInst<'create' | 'delete' | 'change'>;
// const kRects = Symbol('rects');
// class PageMutationContextImpl implements PageMutationContext {
//   mutations: PageMutation[] = [];
//   constructor(
//     private props: TypstDocumentProps,
//     private docProperties: DocProperties,
//   ) {}
//   manipulateData(opts: ManipulateDataOptions) {
//     throw new Error('Method not implemented.');
//   }
//   //   mutateSeq(mutation: PageMutation[]): Promise<Element[]> {
//   //     return Promise.all(mutation.map(this.mutateOne));
//   //   }
//   //   mutateOne(mutation: PageMutation): Promise<Element> {
//   //     throw new Error('Method not implemented. ' + JSON.stringify(mutation));
//   //   }
//   [kDispose](): void {}
// }
// export interface DocProperties {
//   [kRects]: unknown;
// }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jLm1qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kb2MubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQStFbkQsTUFBTSxPQUFPLGFBQWE7SUFLSjtJQUpwQixPQUFPLENBQWdCO0lBQ2YsWUFBWSxDQUF5QjtJQUNyQyxjQUFjLENBQTBCO0lBRWhELFlBQW9CLEtBQXdDO1FBQXhDLFVBQUssR0FBTCxLQUFLLENBQW1DO1FBQzFELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFFRCxNQUFNLENBQUMsbUJBQW1CLENBQUMsR0FBa0I7UUFDM0MsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUNwQixHQUFHLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtZQUN2QyxPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQsMEJBQTBCO0lBQzFCLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxHQUFrQixFQUFFLE1BQWdCO1FBQ25FLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxDQUFDLDJCQUEyQjtRQUNuRixzR0FBc0c7UUFDdEcsMkJBQTJCO1FBQzNCLE1BQU0saUJBQWlCLEdBQ3JCLGFBQWEsSUFBSyxHQUFHLENBQUMsVUFBMEI7WUFDOUMsQ0FBQyxDQUFFLEdBQUcsQ0FBQyxVQUEwQixDQUFDLFdBQVc7WUFDN0MsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZGLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxDQUFDLENBQUMs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QUFrRDtBQUNsRCxNQUFNO0FBRU4sbUVBQW1FO0FBQ25FLDZEQUE2RDtBQUM3RCxXQUFXO0FBRVgsK0RBQStEO0FBQy9ELG1GQUFtRjtBQUNuRixXQUFXO0FBRVgsMEJBQTBCO0FBQzFCLElBQUk7QUFFSixtQ0FBbUM7QUFDbkMsdUJBQXVCO0FBQ3ZCLElBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYWdlSW5mbywgUmVjdCwgVHJhbnNmb3JtTWF0cml4IH0gZnJvbSAnLi9pbnRlcm5hbC50eXBlcy5tanMnO1xyXG5pbXBvcnQgeyBSZW5kZXJPcHRpb25zIH0gZnJvbSAnLi9vcHRpb25zLnJlbmRlci5tanMnO1xyXG5pbXBvcnQgeyBwYXRjaFJvb3QgfSBmcm9tICcuL3JlbmRlci9zdmcvcGF0Y2gubWpzJztcclxuaW1wb3J0IHsgUmVuZGVyU2Vzc2lvbiwgVHlwc3RSZW5kZXJlciB9IGZyb20gJy4vcmVuZGVyZXIubWpzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgTGF5b3V0Q29udGV4dCB7fVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQYWdlVmlldyB7XHJcbiAgcGFnZXM6IFBhZ2VJbmZvW107XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVuZGVyUGllY2Uge1xyXG4gIHBhZ2VPZmZzZXQ/OiBudW1iZXI7XHJcbiAgaW52aXNpYmxlPzogYm9vbGVhbjtcclxuICBhdD86IEVsZW1lbnQ7XHJcbiAgd2luZG93PzogUmVjdDtcclxuICB0cz86IFRyYW5zZm9ybU1hdHJpeDtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBUeXBzdERvY3VtZW50UHJvcHMge1xyXG4gIHBsdWdpbjogVHlwc3RSZW5kZXJlcjtcclxuICBzaGFkb3dSb290OiBFbGVtZW50O1xyXG4gIC8vIGRlZmF1bHQ6IHN2Z1xyXG4gIHJlbmRlck1vZGU/OiAnc3ZnJyB8ICdzdmctZ3JvdXAnIHwgJ2NhbnZhcyc7XHJcblxyXG4gIHNlc3Npb24/OiBSZW5kZXJTZXNzaW9uO1xyXG5cclxuICBsYXlvdXRQYWdlcz8oZG9jOiBUeXBzdERvY3VtZW50LCBiZWZvcmU6IFBhZ2VWaWV3KTogUHJvbWlzZTxSZW5kZXJQaWVjZVtdPjtcclxufVxyXG5cclxuLyoqXHJcbiAqIFRoZSBvcHRpb25zIGZvciBtYW5pcHVsYXRpbmcgdGhlIFR5cHN0IGRvY3VtZW50IGluIHRoZSBzZXNzaW9uLlxyXG4gKi9cclxuaW50ZXJmYWNlIERvY3VtZW50RGF0YUNoYW5nZW1lbnQge1xyXG4gIC8qKlxyXG4gICAqIFRoZSBhY3Rpb24gdG8gbWFuaXB1bGF0ZSB0aGUgZGF0YS5cclxuICAgKiBAZGVzY3JpcHRpb24gYHJlc2V0LWRvY2A6IHJlc2V0IHRoZSBkYXRhIHRvIHRoZSBpbml0aWFsIHN0YXRlLlxyXG4gICAqIEBkZXNjcmlwdGlvbiBgbWVyZ2UtZG9jYDogbWVyZ2UgdGhlIGRhdGEgdG8gdGhlIGN1cnJlbnQgc3RhdGUuXHJcbiAgICovXHJcbiAgYWN0aW9uOiAncmVzZXQtZG9jJyB8ICdtZXJnZS1kb2MnO1xyXG4gIC8qKlxyXG4gICAqIE9wYXF1ZSBkYXRhIHRvIG1hbmlwdWxhdGUgdGhlIFR5cHN0IGRvY3VtZW50IGZyb20gc2VydmVyLlxyXG4gICAqL1xyXG4gIGRhdGE6IFVpbnQ4QXJyYXk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUaGUgb3B0aW9ucyBmb3IgbWFuaXB1bGF0aW5nIHRoZSBUeXBzdCBkb2N1bWVudCBpbiB0aGUgc2Vzc2lvbi5cclxuICovXHJcbmludGVyZmFjZSBEb2N1bWVudFZpZXdwb3J0Q2hhbmdlbWVudCB7XHJcbiAgLyoqXHJcbiAgICogQ2hhbmdlIHRoZSB2aWV3cG9ydCBvZiB0aGUgVHlwc3QgZG9jdW1lbnQuXHJcbiAgICovXHJcbiAgYWN0aW9uOiAndmlld3BvcnQtY2hhbmdlJztcclxufVxyXG5cclxuLyoqXHJcbiAqIFRoZSBvcHRpb25zIGZvciBtYW5pcHVsYXRpbmcgdGhlIFR5cHN0IGRvY3VtZW50IGluIHRoZSBzZXNzaW9uLlxyXG4gKi9cclxuZXhwb3J0IHR5cGUgRG9jdW1lbnRDaGFuZ2VtZW50ID0gRG9jdW1lbnREYXRhQ2hhbmdlbWVudCB8IERvY3VtZW50Vmlld3BvcnRDaGFuZ2VtZW50O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBMYXlvdXRTdmdQYWdlT3B0aW9ucyB7XHJcbiAgLy8vIHdyYXAgaW4gc3ZnLWdyb3VwIG1vZGVcclxuICB3cmFwRz8oZzogW1JlY3QsIFNWR0dFbGVtZW50XSk6IFtSZWN0LCBTVkdHRWxlbWVudF07XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVHlwc3REb2N1bWVudCB7XHJcbiAgc2hhZG93Um9vdDogRWxlbWVudDtcclxuICBzZXNzaW9uOiBSZW5kZXJTZXNzaW9uO1xyXG4gIG9uU2Vzc2lvblJlYWR5KCk6IFByb21pc2U8UmVuZGVyU2Vzc2lvbj47XHJcblxyXG4gIGNoYW5nZUxheW91dChsYXlvdXRTZWxlY3RvcjogUmVjb3JkPHN0cmluZywgYW55Pik6IHZvaWQ7XHJcblxyXG4gIGFkZENoYW5nZW1lbnRzKGNoYW5nZTogRG9jdW1lbnRDaGFuZ2VtZW50W10pOiB2b2lkO1xyXG4gIGFkZFZpZXdwb3J0Q2hhbmdlKCk6IHZvaWQ7XHJcblxyXG4gIHJlbmRlclBpZWNlcyhwaWVjZXM6IFJlbmRlclBpZWNlW10pOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICBkaXNwb3NlKCk6IHZvaWQ7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBUeXBzdERvY3VtZW50IGltcGxlbWVudHMgVHlwc3REb2N1bWVudCB7XHJcbiAgc2Vzc2lvbjogUmVuZGVyU2Vzc2lvbjtcclxuICBwcml2YXRlIHNlc3Npb25SZWFkeTogUHJvbWlzZTxSZW5kZXJTZXNzaW9uPjtcclxuICBwcml2YXRlIGRpc3Bvc2VTZXNzaW9uOiAoLi4uYXJnczogYW55W10pID0+IGFueTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwcm9wczogUmVuZGVyT3B0aW9uczxUeXBzdERvY3VtZW50UHJvcHM+KSB7XHJcbiAgICB0aGlzLmluaXQoKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBsYXlvdXRQYWdlc0Z1bGxNb2RlKGRvYzogVHlwc3REb2N1bWVudCk6IFByb21pc2U8UmVuZGVyUGllY2VbXT4ge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShcclxuICAgICAgZG9jLnNlc3Npb24ucmV0cmlldmVQYWdlc0luZm8oKS5tYXAoKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiB7fTtcclxuICAgICAgfSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gY29weSBmcm9tIHR5cHN0LXByZXZpZXdcclxuICBzdGF0aWMgbGF5b3V0U3ZnUGFnZXNQYXJ0aWFsTW9kZShkb2M6IFR5cHN0RG9jdW1lbnQsIGJlZm9yZTogUGFnZVZpZXcpOiBQcm9taXNlPFJlbmRlclBpZWNlW10+IHtcclxuICAgIGNvbnN0IGRvY1JlY3QgPSBkb2Muc2hhZG93Um9vdC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsgLy8gdGhpcy5jYWNoZWRCb3VuZGluZ1JlY3Q7XHJcbiAgICAvLyBodHRwczovL21lYXN1cmV0aGF0Lm5ldC9CZW5jaG1hcmtzL1Nob3cvNTM5Mi8wL2NsaWVudHdpZHRoLXZzLW9mZnNldHdpZHRoLXZzLXdpbmRvd2dldGNvbXB1dGVkc3R5bGVcclxuICAgIC8vIHRvZG86IHRoaXMgaXMgb25seSBhIFBvQ1xyXG4gICAgY29uc3QgY2FjaGVkT2Zmc2V0V2lkdGg6IG51bWJlciA9XHJcbiAgICAgICdvZmZzZXRXaWR0aCcgaW4gKGRvYy5zaGFkb3dSb290IGFzIEhUTUxFbGVtZW50KVxyXG4gICAgICAgID8gKGRvYy5zaGFkb3dSb290IGFzIEhUTUxFbGVtZW50KS5vZmZzZXRXaWR0aFxyXG4gICAgICAgIDogTnVtYmVyLnBhcnNlSW50KHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGRvYy5zaGFkb3dSb290KS53aWR0aC5yZXBsYWNlKCdweCcsICcnKSk7XHJcbiAgICBjb25zdCBjdXJyZW50U2NhbGVSYXRpbyA9IDE7IC8vIHRoaXMuY3VycmVudFNjYWxlUmF0aW87XHJcbiAgICAvLyBzY2FsZSBkZXJpdmVkIGZyb20gc3ZnIHdpZHRoIGFuZCBjb250YWluZXIgd2l0aC5cclxuICAgIGNvbnN0IGNvbXB1dGVkUmV2U2NhbGUgPSBjYWNoZWRPZmZzZXRXaWR0aCA/IGRvYy5zZXNzaW9uLmRvY1dpZHRoIC8gY2FjaGVkT2Zmc2V0V2lkdGggOiAxO1xyXG4gICAgLy8gcmVzcGVjdCBjdXJyZW50IHNjYWxlIHJhdGlvXHJcbiAgICBjb25zdCByZXZTY2FsZSA9IGNvbXB1dGVkUmV2U2NhbGUgLyBjdXJyZW50U2NhbGVSYXRpbztcclxuICAgIGNvbnN0IGxlZnQgPSAod2luZG93LnNjcmVlbkxlZnQgLSBkb2NSZWN0LmxlZnQpICogcmV2U2NhbGU7XHJcbiAgICBjb25zdCB0b3AgPSAod2luZG93LnNjcmVlblRvcCAtIGRvY1JlY3QudG9wKSAqIHJldlNjYWxlO1xyXG4gICAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aCAqIHJldlNjYWxlO1xyXG4gICAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0ICogcmV2U2NhbGU7XHJcblxyXG4gICAgdm9pZCBiZWZvcmU7XHJcbiAgICBjb25zdCBwYXRjaFN0ciA9IGRvYy5zZXNzaW9uLnJlbmRlclN2Z0RpZmYoe1xyXG4gICAgICB3aW5kb3c6IHtcclxuICAgICAgICBsbzoge1xyXG4gICAgICAgICAgeDogbGVmdCxcclxuICAgICAgICAgIHk6IHRvcCxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGhpOiB7XHJcbiAgICAgICAgICB4OiBsZWZ0ICsgd2lkdGgsXHJcbiAgICAgICAgICB5OiB0b3AgKyBoZWlnaHQsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG4gICAgLy8gdG9kbzogaWRlYWxseSwgd2Ugc2hvdWxkIHBhdGNoIHBlciBwYWdlIHNlcGFyYXRlbHlcclxuICAgIC8vIHRvZG86IHRoZW4sIHdlIGNhbiBjYWxsIHRoZSBhcGkgZG9jLnJlbmRlclBpZWNlcyhwYWdlcyArIHdpbmRvd3MpLlxyXG5cclxuICAgIGlmIChkb2Muc2hhZG93Um9vdC5maXJzdEVsZW1lbnRDaGlsZCkge1xyXG4gICAgICBjb25zdCBlbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgIGVsZW0uaW5uZXJIVE1MID0gcGF0Y2hTdHI7XHJcbiAgICAgIGNvbnN0IHN2Z0VsZW1lbnQgPSBlbGVtLmZpcnN0RWxlbWVudENoaWxkIGFzIFNWR0VsZW1lbnQ7XHJcbiAgICAgIHBhdGNoUm9vdChkb2Muc2hhZG93Um9vdC5maXJzdEVsZW1lbnRDaGlsZCBhcyBTVkdFbGVtZW50LCBzdmdFbGVtZW50KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGRvYy5zaGFkb3dSb290LmlubmVySFRNTCA9IHBhdGNoU3RyO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xyXG4gIH1cclxuXHJcbiAgLy8gY29weSBmcm9tIHR5cHN0LXByZXZpZXdcclxuICAvLyB0b2RvOiBnZW5lcmFsaXplIHBhdGNoUm9vdCBoZXJlXHJcbiAgc3RhdGljIGxheW91dFN2Z1BhZ2VzKFxyXG4gICAgb3B0aW9uczogTGF5b3V0U3ZnUGFnZU9wdGlvbnMsXHJcbiAgKTogKGRvYzogVHlwc3REb2N1bWVudCwgYmVmb3JlOiBQYWdlVmlldykgPT4gUHJvbWlzZTxSZW5kZXJQaWVjZVtdPiB7XHJcbiAgICByZXR1cm4gKGRvYzogVHlwc3REb2N1bWVudCwgYmVmb3JlOiBQYWdlVmlldykgPT4ge1xyXG4gICAgICAvLyB0b2RvXHJcbiAgICAgIHJldHVybiBUeXBzdERvY3VtZW50LmxheW91dFN2Z1BhZ2VzUGFydGlhbE1vZGUoZG9jLCBiZWZvcmUpO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGFkZENoYW5nZW1lbnRzKGNoYW5nZTogRG9jdW1lbnRDaGFuZ2VtZW50W10pOiB2b2lkIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKTtcclxuICB9XHJcblxyXG4gIHJlbmRlclBpZWNlcyhwaWVjZXM6IFJlbmRlclBpZWNlW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKTtcclxuICB9XHJcblxyXG4gIG9uU2Vzc2lvblJlYWR5KCk6IFByb21pc2U8UmVuZGVyU2Vzc2lvbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc2Vzc2lvblJlYWR5O1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIGlmICh0aGlzLmRpc3Bvc2VTZXNzaW9uICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgdGhpcy5kaXNwb3NlU2Vzc2lvbigpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0KCk6IFByb21pc2U8UmVuZGVyU2Vzc2lvbj4ge1xyXG4gICAgaWYgKHRoaXMuc2Vzc2lvblJlYWR5ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbHJlYWR5IGluaXRpYWxpemVkJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMucHJvcHMuc2Vzc2lvbiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHRoaXMuc2Vzc2lvbiA9IHRoaXMucHJvcHMuc2Vzc2lvbjtcclxuICAgICAgcmV0dXJuICh0aGlzLnNlc3Npb25SZWFkeSA9IFByb21pc2UucmVzb2x2ZSh0aGlzLnNlc3Npb24pKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gKHRoaXMuc2Vzc2lvblJlYWR5ID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XHJcbiAgICAgIHRoaXMucHJvcHMucGx1Z2luLnJ1bldpdGhTZXNzaW9uKHNlc3Npb24gPT4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShkaXNwb3NlID0+IHtcclxuICAgICAgICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb247XHJcbiAgICAgICAgICB0aGlzLmRpc3Bvc2VTZXNzaW9uID0gZGlzcG9zZTtcclxuICAgICAgICAgIHJlc29sdmUoc2Vzc2lvbik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSkpO1xyXG4gIH1cclxufVxyXG5cclxuLy8gICBwcml2YXRlIGNvbGxlY3REb2NQcm9wZXJ0aWVzKCk6IERvY1Byb3BlcnRpZXMge1xyXG4vLyAgICAgcmV0dXJuIHtcclxuLy8gICAgICAgW2tSZWN0c106IHVuZGVmaW5lZCxcclxuLy8gICAgIH07XHJcbi8vICAgfVxyXG5cclxuLy8gICBhc3luYyBtdXRhdGUoXHJcbi8vICAgICBjYjogKGN0eDogUGFnZU11dGF0aW9uQ29udGV4dCkgPT4gUHJvbWlzZTx2b2lkPixcclxuLy8gICAgIC8vIG9wdGlvbnM/OiB7XHJcbi8vICAgICAvLyAgIHByZWZldGNoZWREb2NQcm9wZXJ0aWVzPzogRG9jUHJvcGVydGllcztcclxuLy8gICAgIC8vIH0sXHJcbi8vICAgKTogUHJvbWlzZTx2b2lkPiB7XHJcbi8vICAgICBhd2FpdCB0aGlzLnNlc3Npb25SZWFkeTtcclxuXHJcbi8vICAgICAvLyBjb25zdCBkb2NQcm9wZXJ0aWVzID0gb3B0aW9ucz8ucHJlZmV0Y2hlZERvY1Byb3BlcnRpZXMgPz8gdGhpcy5jb2xsZWN0RG9jUHJvcGVydGllcygpO1xyXG4vLyAgICAgY29uc3QgY3R4ID0gbmV3IFBhZ2VNdXRhdGlvbkNvbnRleHRJbXBsKHRoaXMucHJvcHMsIGRvY1Byb3BlcnRpZXMpO1xyXG4vLyAgICAgYXdhaXQgY2IoY3R4KTtcclxuLy8gICAgIHJldHVybiBjdHhba0Rpc3Bvc2VdKCk7XHJcbi8vICAgfVxyXG5cclxuLy8gaW1wb3J0IHsgTWFuaXB1bGF0ZURhdGFPcHRpb25zIH0gZnJvbSAnLi4vLi4vb3B0aW9ucy5yZW5kZXInO1xyXG4vLyBleHBvcnQgaW50ZXJmYWNlIFBhZ2VNdXRhdGlvbkluc3Q8Sz4ge1xyXG4vLyAgIC8qKlxyXG4vLyAgICAqIFRoZSBraW5kIG9mIG11dGF0aW9uLlxyXG4vLyAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBraW5kIC0gVGhlIGtpbmQgb2YgbXV0YXRpb24uXHJcbi8vICAgICovXHJcbi8vICAga2luZDogSztcclxuXHJcbi8vICAgLyoqXHJcbi8vICAgICogQWZ0ZXIvQXQgd2hpY2ggZWxlbWVudCB0aGUgbXV0YXRpb24gaGFwcGVucy5cclxuLy8gICAgKi9cclxuLy8gICBzZW50aW5lbD86IEVsZW1lbnQ7XHJcbi8vIH1cclxuXHJcbi8vIGV4cG9ydCB0eXBlIFBhZ2VNdXRhdGlvbiA9IFBhZ2VNdXRhdGlvbkluc3Q8J2NyZWF0ZScgfCAnZGVsZXRlJyB8ICdjaGFuZ2UnPjtcclxuLy8gY29uc3Qga1JlY3RzID0gU3ltYm9sKCdyZWN0cycpO1xyXG5cclxuLy8gY2xhc3MgUGFnZU11dGF0aW9uQ29udGV4dEltcGwgaW1wbGVtZW50cyBQYWdlTXV0YXRpb25Db250ZXh0IHtcclxuLy8gICBtdXRhdGlvbnM6IFBhZ2VNdXRhdGlvbltdID0gW107XHJcbi8vICAgY29uc3RydWN0b3IoXHJcbi8vICAgICBwcml2YXRlIHByb3BzOiBUeXBzdERvY3VtZW50UHJvcHMsXHJcbi8vICAgICBwcml2YXRlIGRvY1Byb3BlcnRpZXM6IERvY1Byb3BlcnRpZXMsXHJcbi8vICAgKSB7fVxyXG5cclxuLy8gICBtYW5pcHVsYXRlRGF0YShvcHRzOiBNYW5pcHVsYXRlRGF0YU9wdGlvbnMpIHtcclxuLy8gICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKTtcclxuLy8gICB9XHJcblxyXG4vLyAgIC8vICAgbXV0YXRlU2VxKG11dGF0aW9uOiBQYWdlTXV0YXRpb25bXSk6IFByb21pc2U8RWxlbWVudFtdPiB7XHJcbi8vICAgLy8gICAgIHJldHVybiBQcm9taXNlLmFsbChtdXRhdGlvbi5tYXAodGhpcy5tdXRhdGVPbmUpKTtcclxuLy8gICAvLyAgIH1cclxuXHJcbi8vICAgLy8gICBtdXRhdGVPbmUobXV0YXRpb246IFBhZ2VNdXRhdGlvbik6IFByb21pc2U8RWxlbWVudD4ge1xyXG4vLyAgIC8vICAgICB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCBub3QgaW1wbGVtZW50ZWQuICcgKyBKU09OLnN0cmluZ2lmeShtdXRhdGlvbikpO1xyXG4vLyAgIC8vICAgfVxyXG5cclxuLy8gICBba0Rpc3Bvc2VdKCk6IHZvaWQge31cclxuLy8gfVxyXG5cclxuLy8gZXhwb3J0IGludGVyZmFjZSBEb2NQcm9wZXJ0aWVzIHtcclxuLy8gICBba1JlY3RzXTogdW5rbm93bjtcclxuLy8gfVxyXG4iXX0=